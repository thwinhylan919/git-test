/*!
 * Copyright (c) 2018 Oracle. All rights reserved.
 *
 * This material is the confidential property of Oracle Corporation or its
 * licensors and may be used, reproduced, stored or transmitted only in
 * accordance with a valid Oracle license or sublicense agreement.
 */

/*! Oracle Live Experience JS API (Built on: 2019-12-10)
 * version: [support/19.11.2 @ 66603d972d1f37e61f88c512e6016248cc7cd18a] */

!function(){return function e(t,i,n){function o(a,r){if(!i[a]){if(!t[a]){var c="function"==typeof require&&require;if(!r&&c)return c(a,!0);if(s)return s(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var d=i[a]={exports:{}};t[a][0].call(d.exports,function(e){return o(t[a][1][e]||e)},d,d.exports,e,t,i,n)}return i[a].exports}for(var s="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}}()({1:[function(e,t,i){"use strict";function n(e,t,i,n,o){var s=c.writeRtpDescription(e.kind,t);if(s+=c.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=c.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":o||"active"),s+="a=mid:"+e.mid+"\r\n",s+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var r="msid:"+(n?n.id:"-")+" "+a+"\r\n";s+="a="+r,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+r,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+r,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+"\r\n"),s}function o(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},o=function(e,t,i,o){var s=n(e.parameters.apt,i),a=n(t.parameters.apt,o);return s&&a&&s.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach(function(n){for(var s=0;s<t.codecs.length;s++){var a=t.codecs[s];if(n.name.toLowerCase()===a.name.toLowerCase()&&n.clockRate===a.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&a.parameters.apt&&!o(n,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(n.numChannels,a.numChannels),i.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var n=0;n<t.headerExtensions.length;n++){var o=t.headerExtensions[n];if(e.uri===o.uri){i.headerExtensions.push(o);break}}}),i}function s(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function a(e,t){var i=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return i||e.addRemoteCandidate(t),!i}function r(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}var c=e("sdp");t.exports=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function l(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function d(t,i,n,o){var s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=o,e.setTimeout(function(){t._dispatchEvent("track",s)})}var u=function(i){var n=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){n[e]=o[e].bind(o)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw r("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o="string"==typeof n;return o&&(n=[n]),n=n.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(i=!0,!0)}),delete e.url,e.urls=o?n[0]:n,!!n.length}})}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var s=i.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(u.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(u.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),u.prototype.onicecandidate=null,u.prototype.onaddstream=null,u.prototype.ontrack=null,u.prototype.onremovestream=null,u.prototype.onsignalingstatechange=null,u.prototype.oniceconnectionstatechange=null,u.prototype.onconnectionstatechange=null,u.prototype.onicegatheringstatechange=null,u.prototype.onnegotiationneeded=null,u.prototype.ondatachannel=null,u.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},u.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},u.prototype.getConfiguration=function(){return this._config},u.prototype.getLocalStreams=function(){return this.localStreams},u.prototype.getRemoteStreams=function(){return this.remoteStreams},u.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var o=this._createIceAndDtlsTransports();n.iceTransport=o.iceTransport,n.dtlsTransport=o.dtlsTransport}return t||this.transceivers.push(n),n},u.prototype.addTrack=function(t,i){if(this._isClosed)throw r("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");if(this.transceivers.find(function(e){return e.track===t}))throw r("InvalidAccessError","Track already exists.");for(var n,o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==t.kind||(n=this.transceivers[o]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),n.track=t,n.stream=i,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},u.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach(function(t){i.addTrack(t,e)});else{var n=e.clone();e.getTracks().forEach(function(e,t){var i=n.getTracks()[t];e.addEventListener("enabled",function(e){i.enabled=e.enabled})}),n.getTracks().forEach(function(e){i.addTrack(e,n)})}},u.prototype.removeTrack=function(t){if(this._isClosed)throw r("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find(function(e){return e.rtpSender===t});if(!i)throw r("InvalidAccessError","Sender was not created by this connection.");var n=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},u.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var i=t.getSenders().find(function(t){return t.track===e});i&&t.removeTrack(i)})},u.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},u.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},u.prototype._createIceGatherer=function(t,i){var n=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var o=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(o,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;o.state=i?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},o.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),o},u.prototype._gather=function(t,i){var n=this,o=this.transceivers[i].iceGatherer;if(!o.onlocalcandidate){var s=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),o.onlocalcandidate=function(e){if(!(n.usingBundle&&i>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:i};var a=e.candidate,r=!a||0===Object.keys(a).length;if(r)"new"!==o.state&&"gathering"!==o.state||(o.state="completed");else{"new"===o.state&&(o.state="gathering"),a.component=1,a.ufrag=o.getLocalParameters().usernameFragment;var l=c.writeCandidate(a);s.candidate=Object.assign(s.candidate,c.parseCandidate(l)),s.candidate.candidate=l,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var d=c.getMediaSections(n._localDescription.sdp);d[s.candidate.sdpMLineIndex]+=r?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",n._localDescription.sdp=c.getDescription(n._localDescription.sdp)+d.join("");var u=n.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),r||n._dispatchEvent("icecandidate",s),u&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout(function(){s.forEach(function(e){o.onlocalcandidate(e)})},0)}},u.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(i);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:n}},u.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},u.prototype._transceive=function(e,i,n){var s=o(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},u.prototype.setLocalDescription=function(e){var t,i,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(r("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(r("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=c.splitSections(e.sdp),i=t.shift(),t.forEach(function(e,t){var i=c.parseRtpParameters(e);n.transceivers[t].localCapabilities=i}),n.transceivers.forEach(function(e,t){n._gather(e.mid,t)});else if("answer"===e.type){t=c.splitSections(n._remoteDescription.sdp),i=t.shift();var a=c.matchPrefix(i,"a=ice-lite").length>0;t.forEach(function(e,t){var s=n.transceivers[t],r=s.iceGatherer,l=s.iceTransport,d=s.dtlsTransport,u=s.localCapabilities,h=s.remoteCapabilities;if(!(c.isRejected(e)&&0===c.matchPrefix(e,"a=bundle-only").length)&&!s.rejected){var g=c.getIceParameters(e,i),v=c.getDtlsParameters(e,i);a&&(v.role="server"),n.usingBundle&&0!==t||(n._gather(s.mid,t),"new"===l.state&&l.start(r,g,a?"controlling":"controlled"),"new"===d.state&&d.start(v));var p=o(u,h);n._transceive(s,p.codecs.length>0,!1)}})}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()};try{u.prototype.setRemoteDescription=function(n){var u=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(r("TypeError",'Unsupported type "'+n.type+'"'));if(!s("setRemoteDescription",n.type,u.signalingState)||u._isClosed)return Promise.reject(r("InvalidStateError","Can not set remote "+n.type+" in state "+u.signalingState));var h={};u.remoteStreams.forEach(function(e){h[e.id]=e});var g=[],v=c.splitSections(n.sdp),p=v.shift(),m=c.matchPrefix(p,"a=ice-lite").length>0,S=c.matchPrefix(p,"a=group:BUNDLE ").length>0;u.usingBundle=S;var f=c.matchPrefix(p,"a=ice-options:")[0];return u.canTrickleIceCandidates=!!f&&f.substr(14).split(" ").indexOf("trickle")>=0,v.forEach(function(s,r){var d=c.splitLines(s),v=c.getKind(s),f=c.isRejected(s)&&0===c.matchPrefix(s,"a=bundle-only").length,_=d[0].substr(2).split(" ")[2],C=c.getDirection(s,p),E=c.parseMsid(s),R=c.getMid(s)||c.generateIdentifier();if(f||"application"===v&&("DTLS/SCTP"===_||"UDP/DTLS/SCTP"===_))u.transceivers[r]={mid:R,kind:v,protocol:_,rejected:!0};else{!f&&u.transceivers[r]&&u.transceivers[r].rejected&&(u.transceivers[r]=u._createTransceiver(v,!0));var b,T,A,I,y,O,k,L,w,N,P,D=c.parseRtpParameters(s);f||(N=c.getIceParameters(s,p),(P=c.getDtlsParameters(s,p)).role="client"),k=c.parseRtpEncodingParameters(s);var M=c.parseRtcpParameters(s),x=c.matchPrefix(s,"a=end-of-candidates",p).length>0,V=c.matchPrefix(s,"a=candidate:").map(function(e){return c.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===n.type||"answer"===n.type)&&!f&&S&&r>0&&u.transceivers[r]&&(u._disposeIceAndDtlsTransports(r),u.transceivers[r].iceGatherer=u.transceivers[0].iceGatherer,u.transceivers[r].iceTransport=u.transceivers[0].iceTransport,u.transceivers[r].dtlsTransport=u.transceivers[0].dtlsTransport,u.transceivers[r].rtpSender&&u.transceivers[r].rtpSender.setTransport(u.transceivers[0].dtlsTransport),u.transceivers[r].rtpReceiver&&u.transceivers[r].rtpReceiver.setTransport(u.transceivers[0].dtlsTransport)),"offer"!==n.type||f){if("answer"===n.type&&!f)T=(b=u.transceivers[r]).iceGatherer,A=b.iceTransport,I=b.dtlsTransport,y=b.rtpReceiver,O=b.sendEncodingParameters,L=b.localCapabilities,u.transceivers[r].recvEncodingParameters=k,u.transceivers[r].remoteCapabilities=D,u.transceivers[r].rtcpParameters=M,V.length&&"new"===A.state&&(!m&&!x||S&&0!==r?V.forEach(function(e){a(b.iceTransport,e)}):A.setRemoteCandidates(V)),S&&0!==r||("new"===A.state&&A.start(T,N,"controlling"),"new"===I.state&&I.start(P)),!o(b.localCapabilities,b.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&b.sendEncodingParameters[0].rtx&&delete b.sendEncodingParameters[0].rtx,u._transceive(b,"sendrecv"===C||"recvonly"===C,"sendrecv"===C||"sendonly"===C),!y||"sendrecv"!==C&&"sendonly"!==C?delete b.rtpReceiver:(w=y.track,E?(h[E.stream]||(h[E.stream]=new e.MediaStream),i(w,h[E.stream]),g.push([w,y,h[E.stream]])):(h.default||(h.default=new e.MediaStream),i(w,h.default),g.push([w,y,h.default])))}else{(b=u.transceivers[r]||u._createTransceiver(v)).mid=R,b.iceGatherer||(b.iceGatherer=u._createIceGatherer(r,S)),V.length&&"new"===b.iceTransport.state&&(!x||S&&0!==r?V.forEach(function(e){a(b.iceTransport,e)}):b.iceTransport.setRemoteCandidates(V)),L=e.RTCRtpReceiver.getCapabilities(v),t<15019&&(L.codecs=L.codecs.filter(function(e){return"rtx"!==e.name})),O=b.sendEncodingParameters||[{ssrc:1001*(2*r+2)}];var U,B=!1;if("sendrecv"===C||"sendonly"===C){if(B=!b.rtpReceiver,y=b.rtpReceiver||new e.RTCRtpReceiver(b.dtlsTransport,v),B)w=y.track,E&&"-"===E.stream||(E?(h[E.stream]||(h[E.stream]=new e.MediaStream,Object.defineProperty(h[E.stream],"id",{get:function(){return E.stream}})),Object.defineProperty(w,"id",{get:function(){return E.track}}),U=h[E.stream]):(h.default||(h.default=new e.MediaStream),U=h.default)),U&&(i(w,U),b.associatedRemoteMediaStreams.push(U)),g.push([w,y,U])}else b.rtpReceiver&&b.rtpReceiver.track&&(b.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===b.rtpReceiver.track.id});t&&l(t,e)}),b.associatedRemoteMediaStreams=[]);b.localCapabilities=L,b.remoteCapabilities=D,b.rtpReceiver=y,b.rtcpParameters=M,b.sendEncodingParameters=O,b.recvEncodingParameters=k,u._transceive(u.transceivers[r],!1,B)}}}),void 0===u._dtlsRole&&(u._dtlsRole="offer"===n.type?"active":"passive"),u._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?u._updateSignalingState("have-remote-offer"):u._updateSignalingState("stable"),Object.keys(h).forEach(function(t){var i=h[t];if(i.getTracks().length){if(-1===u.remoteStreams.indexOf(i)){u.remoteStreams.push(i);var n=new Event("addstream");n.stream=i,e.setTimeout(function(){u._dispatchEvent("addstream",n)})}g.forEach(function(e){var t=e[0],n=e[1];i.id===e[2].id&&d(u,t,n,[i])})}}),g.forEach(function(e){e[2]||d(u,e[0],e[1],[])}),e.setTimeout(function(){u&&u.transceivers&&u.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()}}catch(e){}u.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},u.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},u.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},u.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},u.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},u.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(r("InvalidStateError","Can not call createOffer after close"));var o=i.transceivers.filter(function(e){return"audio"===e.kind}).length,s=i.transceivers.filter(function(e){return"video"===e.kind}).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(o=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(s=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(i.transceivers.forEach(function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&(--s<0&&(e.wantReceive=!1))});o>0||s>0;)o>0&&(i._createTransceiver("audio"),o--),s>0&&(i._createTransceiver("video"),s--);var l=c.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach(function(n,o){var s=n.track,a=n.kind,r=n.mid||c.generateIdentifier();n.mid=r,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(o,i.usingBundle));var l=e.RTCRtpSender.getCapabilities(a);t<15019&&(l.codecs=l.codecs.filter(function(e){return"rtx"!==e.name})),l.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),l.headerExtensions.forEach(function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var d=n.sendEncodingParameters||[{ssrc:1001*(2*o+1)}];s&&t>=15019&&"video"===a&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,a)),n.localCapabilities=l,n.sendEncodingParameters=d}),"max-compat"!==i._config.bundlePolicy&&(l+="a=group:BUNDLE "+i.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),l+="a=ice-options:trickle\r\n",i.transceivers.forEach(function(e,t){l+=n(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),l+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,l+="a="+c.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(l+="a=end-of-candidates\r\n"))});var d=new e.RTCSessionDescription({type:"offer",sdp:l});return Promise.resolve(d)},u.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(r("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(r("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var s=c.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(s+="a=group:BUNDLE "+i.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var a=c.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach(function(e,r){if(!(r+1>a)){if(e.rejected)return"application"===e.kind?s+="DTLS/SCTP"===e.protocol?"m=application 0 DTLS/SCTP 5000\r\n":"m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var l=o(e.localCapabilities,e.remoteCapabilities);!l.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=n(e,l,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}});var l=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(l)},u.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(n,o){if(!i._remoteDescription)return o(r("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var l=0;l<i.transceivers.length;l++)if(i.transceivers[l].mid===e.sdpMid){s=l;break}var d=i.transceivers[s];if(!d)return o(r("OperationError","Can not add ICE candidate"));if(d.rejected)return n();var u=Object.keys(e.candidate).length>0?c.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return n();if(u.component&&1!==u.component)return n();if((0===s||s>0&&d.iceTransport!==i.transceivers[0].iceTransport)&&!a(d.iceTransport,u))return o(r("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=c.getMediaSections(i._remoteDescription.sdp))[s]+="a="+(u.type?h:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=c.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var g=0;g<i.transceivers.length&&(i.transceivers[g].rejected||(i.transceivers[g].iceTransport.addRemoteCandidate({}),(t=c.getMediaSections(i._remoteDescription.sdp))[g]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=c.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));g++);n()})},u.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)}),!i)throw r("InvalidAccessError","Invalid selector.");return i.getStats()}var n=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&n.push(e[t].getStats())})}),Promise.all(n).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var n=i.prototype.getStats;i.prototype.getStats=function(){return n.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(i){e[i].type=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}(e[i]),t.set(i,e[i])}),t})}}});var h=["createOffer","createAnswer"];h.forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),h=["setLocalDescription","setRemoteDescription","addIceCandidate"];try{h.forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}})}catch(e){}return["getStats"].forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),u}},{sdp:2}],2:[function(e,t,i){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},n.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},n.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1];break;case"ufrag":i.ufrag=t[n+1],i.usernameFragment=t[n+1];break;default:i[t[n]]=t[n+1]}return i},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,i={},n=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<n.length;o++)i[(t=n[o].trim().split("="))[0].trim()]=t[1];return i},n.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)}),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substr(t+1,n-t-1),i.value=e.substr(n+1)):i.attribute=e.substr(t+1),i},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),i},n.getIceParameters=function(e,t){var i=n.splitLines(e);return{usernameFragment:(i=i.concat(n.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=n.splitLines(e)[0].split(" "),o=3;o<i.length;o++){var s=i[o],a=n.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(a){var r=n.parseRtpMap(a),c=n.matchPrefix(e,"a=fmtp:"+s+" ");switch(r.parameters=c.length?n.parseFmtp(c[0]):{},r.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(n.parseRtcpFb),t.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(r.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))}),t},n.writeRtpDescription=function(e,t){var i="";i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){i+=n.writeRtpMap(e),i+=n.writeFmtp(e),i+=n.writeRtcpFb(e)});var o=0;return t.codecs.forEach(function(e){e.maxptime>o&&(o=e.maxptime)}),o>0&&(i+="a=maxptime:"+o+"\r\n"),i+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){i+=n.writeExtmap(e)}),i},n.parseRtpEncodingParameters=function(e){var t,i=[],o=n.parseRtpParameters(e),s=-1!==o.fecMechanisms.indexOf("RED"),a=-1!==o.fecMechanisms.indexOf("ULPFEC"),r=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=r.length>0&&r[0].ssrc,l=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});l.length>0&&l[0].length>1&&l[0][0]===c&&(t=l[0][1]),o.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(n.rtx={ssrc:t}),i.push(n),s&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},i.push(n))}}),0===i.length&&c&&i.push({ssrc:c});var d=n.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(e){e.maxBitrate=d})),i},n.parseRtcpParameters=function(e){var t={},i=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];i&&(t.cname=i.value,t.ssrc=i.ssrc);var o=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=0===o.length;var s=n.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},n.parseMsid=function(e){var t,i=n.matchPrefix(e,"a=msid:");if(1===i.length)return{stream:(t=i[0].substr(7).split(" "))[0],track:t[1]};var o=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return o.length>0?{stream:(t=o[0].value.split(" "))[0],track:t[1]}:void 0},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,i){var o,s=void 0!==t?t:2;return o=e||n.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+o+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,i,o){var s=n.writeRtpDescription(e.kind,t);if(s+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",s+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a="msid:"+o.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+a,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),s},n.getDirection=function(e,t){for(var i=n.splitLines(e),o=0;o<i.length;o++)switch(i[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[o].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),i=0;i<t.length;i++)if(t[i].length<2||"="!==t[i].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=n)},{}],3:[function(e,t,i){(function(i){"use strict";var n=e("./adapter_factory.js");t.exports=n({window:i.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(e,t,i){"use strict";var n=e("./utils");t.exports=function(t,i){var o=t&&t.window,s={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var a in i)hasOwnProperty.call(i,a)&&(s[a]=i[a]);var r=n.log,c=n.detectBrowser(o),l=e("./chrome/chrome_shim")||null,d=e("./edge/edge_shim")||null,u=e("./firefox/firefox_shim")||null,h=e("./safari/safari_shim")||null,g=e("./common_shim")||null,v={browserDetails:c,commonShim:g,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings};switch(c.browser){case"chrome":if(!l||!l.shimPeerConnection||!s.shimChrome)return r("Chrome shim is not included in this adapter release."),v;r("adapter.js shimming chrome."),v.browserShim=l,g.shimCreateObjectURL(o),l.shimGetUserMedia(o),l.shimMediaStream(o),l.shimSourceObject(o),l.shimPeerConnection(o),l.shimOnTrack(o),l.shimAddTrackRemoveTrack(o),l.shimGetSendersWithDtmf(o),l.shimSenderReceiverGetStats(o),l.fixNegotiationNeeded(o),g.shimRTCIceCandidate(o),g.shimMaxMessageSize(o),g.shimSendThrowTypeError(o);break;case"firefox":if(!u||!u.shimPeerConnection||!s.shimFirefox)return r("Firefox shim is not included in this adapter release."),v;r("adapter.js shimming firefox."),v.browserShim=u,g.shimCreateObjectURL(o),u.shimGetUserMedia(o),u.shimSourceObject(o),u.shimPeerConnection(o),u.shimOnTrack(o),u.shimRemoveStream(o),u.shimSenderGetStats(o),u.shimReceiverGetStats(o),u.shimRTCDataChannel(o),g.shimRTCIceCandidate(o),g.shimMaxMessageSize(o),g.shimSendThrowTypeError(o);break;case"edge":if(!d||!d.shimPeerConnection||!s.shimEdge)return r("MS edge shim is not included in this adapter release."),v;r("adapter.js shimming edge."),v.browserShim=d,g.shimCreateObjectURL(o),d.shimGetUserMedia(o),d.shimPeerConnection(o),d.shimReplaceTrack(o),g.shimMaxMessageSize(o),g.shimSendThrowTypeError(o);break;case"safari":if(!h||!s.shimSafari)return r("Safari shim is not included in this adapter release."),v;r("adapter.js shimming safari."),v.browserShim=h,g.shimCreateObjectURL(o),h.shimRTCIceServerUrls(o),h.shimCreateOfferLegacy(o),h.shimCallbacksAPI(o),h.shimLocalStreamsAPI(o),h.shimRemoteStreamsAPI(o),h.shimTrackEventTransceiver(o),h.shimGetUserMedia(o),g.shimRTCIceCandidate(o),g.shimMaxMessageSize(o),g.shimSendThrowTypeError(o);break;default:r("Unsupported browser!")}return v}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],5:[function(e,t,i){"use strict";function n(e,t,i){var n=i?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;var s=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(function(t){e.forEach(function(i){i.type===n&&i.trackId===t.id&&function e(t,i,n){i&&!n.has(i.id)&&(n.set(i.id,i),Object.keys(i).forEach(function(o){o.endsWith("Id")?e(t,t.get(i[o]),n):o.endsWith("Ids")&&i[o].forEach(function(i){e(t,t.get(i),n)})}))}(e,i,o)})}),o}var o=e("../utils.js"),s=o.log;t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)o.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var i=this;return i._ontrackpoly||(i._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(n){var o;o=e.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(e){return e.track&&e.track.id===n.track.id}):{track:n.track};var s=new Event("track");s.track=n.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],i.dispatchEvent(s)}),t.stream.getTracks().forEach(function(n){var o;o=e.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(e){return e.track&&e.track.id===n.id}):{track:n};var s=new Event("track");s.track=n,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],i.dispatchEvent(s)})},i.addEventListener("addstream",i._ontrackpoly)),t.apply(i,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){var o=this,s=i.apply(o,arguments);return s||(s=t(o,e),o._senders.push(s)),s};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;n.apply(t,arguments);var i=t._senders.indexOf(e);-1!==i&&t._senders.splice(i,1)}}var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var i=this;i._senders=i._senders||[],o.apply(i,[e]),e.getTracks().forEach(function(e){i._senders.push(t(i,e))})};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],s.apply(t,[e]),e.getTracks().forEach(function(e){var i=t._senders.find(function(t){return t.track===e});i&&t._senders.splice(t._senders.indexOf(i),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=a.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSenderReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,i=t.apply(e,[]);return i.forEach(function(t){t._pc=e}),i});var i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return n(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var s=e.RTCPeerConnection.prototype.getReceivers;s&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=s.apply(e,[]);return t.forEach(function(t){t._pc=e}),t}),o.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return n(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var t=this;if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var i,n,o,s=arguments[0];return t.getSenders().forEach(function(e){e.track===s&&(i?o=!0:i=e)}),t.getReceivers().forEach(function(e){return e.track===s&&(n?o=!0:n=e),e.track===s}),o||i&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return a.apply(t,arguments)}}}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var i=this;return this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){i.src&&t.revokeObjectURL(i.src),i.src=t.createObjectURL(e)}),void e.addEventListener("removetrack",function(){i.src&&t.revokeObjectURL(i.src),i.src=t.createObjectURL(e)})):void(this.src="")}}))},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){if(t.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")});var n=t.getSenders();i.apply(this,arguments);var o=t.getSenders().filter(function(e){return-1===n.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(o)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(i){var n=t._shimmedLocalStreams[i].indexOf(e);-1!==n&&t._shimmedLocalStreams[i].splice(n,1),1===t._shimmedLocalStreams[i].length&&delete t._shimmedLocalStreams[i]}),o.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){function t(e,t){var i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],o=e._streams[n.id];i=i.replace(new RegExp(o.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:i})}var i=o.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&i.version>=65)return this.shimAddTrackRemoveTrackWithNative(e);var n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=n.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var i=this;if(i._streams=i._streams||{},i._reverseStreams=i._reverseStreams||{},t.getTracks().forEach(function(e){if(i.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!i._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());i._streams[t.id]=n,i._reverseStreams[n.id]=t,t=n}s.apply(i,[t])};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},a.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){var n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(n.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{};var s=n._streams[i.id];if(s)s.addTrack(t),Promise.resolve().then(function(){n.dispatchEvent(new Event("negotiationneeded"))});else{var a=new e.MediaStream([t]);n._streams[i.id]=a,n._reverseStreams[a.id]=i,n.addStream(a)}return n.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(i){var n=e.RTCPeerConnection.prototype[i];e.RTCPeerConnection.prototype[i]=function(){var e=this,i=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(e,[function(n){var o=t(e,n);i[0].apply(null,[o])},function(e){i[1]&&i[1].apply(null,e)},arguments[2]]):n.apply(e,arguments).then(function(i){return t(e,i)})}});var r=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){var i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],o=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),o.id)}),new RTCSessionDescription({type:t.type,sdp:i})}(e,arguments[0]),r.apply(e,arguments)):r.apply(e,arguments)};var c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=c.get.apply(this);return""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,i=this;if("closed"===i.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===i))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");i._streams=i._streams||{},Object.keys(i._streams).forEach(function(n){i._streams[n].getTracks().find(function(t){return e.track===t})&&(t=i._streams[n])}),t&&(1===t.getTracks().length?i.removeStream(i._reverseStreams[t.id]):t.removeTrack(e.track),i.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=o.detectBrowser(e);!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=function(t,i){return s("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,i)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}}));var i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var o=this,s=arguments;if(arguments.length>0&&"function"==typeof e)return i.apply(this,arguments);var a=function(e){var t={};return e.result().forEach(function(e){var i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){i[t]=e.stat(t)}),t[i.id]=i}),t},r=function(e){var t=new Map(Object.keys(e).map(function(t){return[t,e[t]]}));return Object.keys(e).forEach(function(i){t[i]=e[i]}),t};if(arguments.length>=2){return i.apply(this,[function(e){s[1](r(a(e)))},arguments[0]])}return new Promise(function(e,t){i.apply(o,[function(t){e(r(a(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){try{var i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,n=new Promise(function(n,o){i.apply(t,[e[0],n,o])});return e.length<2?n:n.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}catch(e){}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(n,o){i.apply(e,[n,o,t])})}return i.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){try{var i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}}catch(e){}});try{var n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}catch(e){}},fixNegotiationNeeded:function(e){o.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){if("stable"===e.target.signalingState)return e})},shimGetDisplayMedia:function(e,t){if(!("getDisplayMedia"in e.navigator))return"function"!=typeof t?void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void(navigator.getDisplayMedia=function(e){return t(e).then(function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},navigator.mediaDevices.getUserMedia(e)})})}}},{"../utils.js":14,"./getusermedia":6}],6:[function(e,t,i){"use strict";var n=e("../utils.js"),o=n.log;t.exports=function(e){var t=n.detectBrowser(e),i=e&&e.navigator,s=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var s={};"number"==typeof n.ideal?(s[o("min",i)]=n.ideal,t.optional.push(s),(s={})[o("max",i)]=n.ideal,t.optional.push(s)):(s[o("",i)]=n.ideal,t.optional.push(s))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",i)]=n.exact):["min","max"].forEach(function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,i)]=n[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},a=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var a=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};a((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),a(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"==typeof e.video){var r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});var c,l=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||l))if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?c=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(c=["front"]),c)return i.mediaDevices.enumerateDevices().then(function(t){var i=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return c.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!i&&t.length&&-1!==c.indexOf("back")&&(i=t[t.length-1]),i&&(e.video.deviceId=r.exact?{exact:i.deviceId}:{ideal:i.deviceId}),e.video=s(e.video),o("chrome: "+JSON.stringify(e)),n(e)});e.video=s(e.video)}return o("chrome: "+JSON.stringify(e)),n(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};i.getUserMedia=function(e,t,n){a(e,function(e){i.webkitGetUserMedia(e,t,function(e){n&&n(r(e))})})};var c=function(e){return new Promise(function(t,n){i.getUserMedia(e,t,n)})};if(i.mediaDevices||(i.mediaDevices={getUserMedia:c,enumerateDevices:function(){return new Promise(function(t){var i={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:i[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),i.mediaDevices.getUserMedia){var l=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return a(e,function(e){return l(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(r(e))})})}}else i.mediaDevices.getUserMedia=function(e){return c(e)};void 0===i.mediaDevices.addEventListener&&(i.mediaDevices.addEventListener=function(){o("Dummy mediaDevices.addEventListener called.")}),void 0===i.mediaDevices.removeEventListener&&(i.mediaDevices.removeEventListener=function(){o("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":14}],7:[function(e,t,i){"use strict";var n=e("sdp"),o=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var i=new t(e),o=n.parseCandidate(e.candidate),s=Object.assign(i,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,o.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var i=t.createObjectURL.bind(t),n=t.revokeObjectURL.bind(t),s=new Map,a=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++a;return s.set(t,e),o.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return i(e)},t.revokeObjectURL=function(e){n(e),s.delete(e)};var r=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return r.get.apply(this)},set:function(e){return this.srcObject=s.get(e)||null,r.set.apply(this,[e])}});var c=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=s.get(arguments[1])||null),c.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=o.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var i=function(e){var t=n.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=n.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},s=function(e){var i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},a=function(e,i){var o=65536;"firefox"===t.browser&&57===t.version&&(o=65535);var s=n.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?o=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(o=2147483637),o};try{var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;if(e._sctp=null,i(arguments[0])){var t,n=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),o=s(n),c=a(arguments[0],n);t=0===o&&0===c?Number.POSITIVE_INFINITY:0===o||0===c?Math.max(o,c):Math.min(o,c);var l={};Object.defineProperty(l,"maxMessageSize",{get:function(){return t}}),e._sctp=l}return r.apply(e,arguments)}}catch(e){}}},shimSendThrowTypeError:function(e){function t(e,t){var i=e.send;e.send=function(){var n=arguments[0],o=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&o>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=i.apply(this,arguments);return t(e,this),e},o.wrapPeerConnectionEvent(e,"datachannel",function(e){return t(e.channel,e.target),e})}}}},{"./utils":14,sdp:2}],8:[function(e,t,i){"use strict";var n=e("../utils"),o=e("./filtericeservers"),s=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=n.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var i=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){i.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var a=s(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=o(e.iceServers)),new a(e)},e.RTCPeerConnection.prototype=a.prototype},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}}},{"../utils":14,"./filtericeservers":9,"./getusermedia":10,"rtcpeerconnection-shim":1}],9:[function(e,t,i){"use strict";var n=e("../utils");t.exports=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var o=e.urls||e.url;e.url&&!e.urls&&n.deprecated("RTCIceServer.url","RTCIceServer.urls");var s="string"==typeof o;return s&&(o=[o]),o=o.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!i?(i=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=s?o[0]:o,!!o.length}})}},{"../utils":14}],10:[function(e,t,i){"use strict";t.exports=function(e){var t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch(function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))})}}},{}],11:[function(e,t,i){"use strict";var n=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var i=new Event("track");i.track=t,i.receiver={track:t},i.transceiver={receiver:i.receiver},i.streams=[e.stream],this.dispatchEvent(i)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=n.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(i,n){if(t.version<38&&i&&i.iceServers){for(var o=[],s=0;s<i.iceServers.length;s++){var a=i.iceServers[s];if(a.hasOwnProperty("urls"))for(var r=0;r<a.urls.length;r++){var c={url:a.urls[r]};0===a.urls[r].indexOf("turn")&&(c.username=a.username,c.credential=a.credential),o.push(c)}else o.push(i.iceServers[s])}i.iceServers=o}return new e.mozRTCPeerConnection(i,n)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){try{var i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}}catch(e){}});try{var i=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}catch(e){}var o={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,i,n){return s.apply(this,[e||null]).then(function(e){if(t.version<48&&(e=function(e){var t=new Map;return Object.keys(e).forEach(function(i){t.set(i,e[i]),t[i]=e[i]}),t}(e)),t.version<53&&!i)try{e.forEach(function(e){e.type=o[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,i){e.set(i,Object.assign({},t,{type:o[t.type]||t.type}))})}return e}).then(i,n)}}},shimSenderGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,i=t.apply(e,[]);return i.forEach(function(t){t._pc=e}),i});var i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,i=t.apply(e,[]);return i.forEach(function(t){t._pc=e}),i}),n.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;n.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(i){i.track&&-1!==e.getTracks().indexOf(i.track)&&t.removeTrack(i)})})},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(!e||!e.video){var i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return!0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e)})}}},{"../utils":14,"./getusermedia":12}],12:[function(e,t,i){"use strict";var n=e("../utils"),o=n.log;t.exports=function(e){var t=n.detectBrowser(e),i=e&&e.navigator,s=e&&e.MediaStreamTrack,a=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},r=function(e,n,s){var r=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var n=e[i]="object"==typeof e[i]?e[i]:{ideal:e[i]};if(void 0===n.min&&void 0===n.max&&void 0===n.exact||t.push(i),void 0!==n.exact&&("number"==typeof n.exact?n.min=n.max=n.exact:e[i]=n.exact,delete n.exact),void 0!==n.ideal){e.advanced=e.advanced||[];var o={};"number"==typeof n.ideal?o[i]={min:n.ideal,max:n.ideal}:o[i]=n.ideal,e.advanced.push(o),delete n.ideal,Object.keys(n).length||delete e[i]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(o("spec: "+JSON.stringify(e)),e.audio&&(e.audio=r(e.audio)),e.video&&(e.video=r(e.video)),o("ff37: "+JSON.stringify(e))),i.mozGetUserMedia(e,n,function(e){s(a(e))})};if(i.mediaDevices||(i.mediaDevices={getUserMedia:function(e){return new Promise(function(t,i){r(e,t,i)})},addEventListener:function(){},removeEventListener:function(){}}),i.mediaDevices.enumerateDevices=i.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var c=i.mediaDevices.enumerateDevices.bind(i.mediaDevices);i.mediaDevices.enumerateDevices=function(){return c().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var l=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return l(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(a(e))})}}if(!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){var d=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},u=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),d(e.audio,"autoGainControl","mozAutoGainControl"),d(e.audio,"noiseSuppression","mozNoiseSuppression")),u(e)},s&&s.prototype.getSettings){var h=s.prototype.getSettings;s.prototype.getSettings=function(){var e=h.apply(this,arguments);return d(e,"mozAutoGainControl","autoGainControl"),d(e,"mozNoiseSuppression","noiseSuppression"),e}}if(s&&s.prototype.applyConstraints){var g=s.prototype.applyConstraints;s.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),d(e,"autoGainControl","mozAutoGainControl"),d(e,"noiseSuppression","mozNoiseSuppression")),g.apply(this,[e])}}}i.getUserMedia=function(e,o,s){return t.version<44?r(e,o,s):(n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),void i.mediaDevices.getUserMedia(e).then(o,s))}}},{"../utils":14}],13:[function(e,t,i){"use strict";var n=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(i){i.id===e&&(t=i)}),this._remoteStreams&&this._remoteStreams.forEach(function(i){i.id===e&&(t=i)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var i=this;e.getTracks().forEach(function(n){t.call(i,n,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,i){return i&&(this._localStreams?-1===this._localStreams.indexOf(i)&&this._localStreams.push(i):this._localStreams=[i]),t.call(this,e,i)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var i=this,n=e.getTracks();this.getSenders().forEach(function(e){-1!==n.indexOf(e.track)&&i.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}})}),t.apply(e,arguments)}}},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,o=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],o=i.apply(this,[n]);return t?(o.then(e,t),Promise.resolve()):o},t.createAnswer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],o=n.apply(this,[i]);return t?(o.then(e,t),Promise.resolve()):o};var r=function(e,t,i){var n=o.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n};t.setLocalDescription=r,r=function(e,t,i){var n=s.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.setRemoteDescription=r,r=function(e,t,i){var n=a.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.addIceCandidate=r}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){for(var o=[],s=0;s<e.iceServers.length;s++){var a=e.iceServers[s];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),(a=JSON.parse(JSON.stringify(a))).urls=a.url,delete a.url,o.push(a)):o.push(e.iceServers[s])}e.iceServers=o}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var i=this;if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var n=i.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveAudio||n||i.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var o=i.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&o?"sendrecv"===o.direction?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":"recvonly"===o.direction&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):!0!==e.offerToReceiveVideo||o||i.addTransceiver("video")}return t.apply(i,arguments)}}}},{"../utils":14}],14:[function(e,t,i){"use strict";function n(e,t,i){var n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}var o=!0,s=!0;t.exports={extractVersion:n,wrapPeerConnectionEvent:function(e,t,i){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,o=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return o.apply(this,arguments);var s=function(e){var t=i(e);t&&n(t)};return this._eventMap=this._eventMap||{},this._eventMap[n]=s,o.apply(this,[e,s])};var s=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[i])return s.apply(this,arguments);var n=this._eventMap[i];return delete this._eventMap[i],s.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(o=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(s=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(o)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){s&&console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var t=e&&e.navigator,i={browser:null,version:null};if(void 0===e||!e.navigator)return i.browser="Not a browser.",i;if(t.mozGetUserMedia)i.browser="firefox",i.version=n(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)i.browser="chrome",i.version=n(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=n(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return i.browser="Not a supported browser.",i;i.browser="safari",i.version=n(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return i}}},{}]},{},[3]);var live=function(e){function t(e,t,i){var n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}var i=e._private=e._private||{},n=function(){var e={browser:null,version:null};if("undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=t(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=t(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=t(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=t(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}(),o={};o.isFirefox="firefox"===n.browser,o.isChrome="chrome"===n.browser,o.isEdge="edge"===n.browser,o.isIE=!1,o.isSafari=!1,o.version=n.version,o.supportSessionStorage=!1;try{o.supportSessionStorage="sessionStorage"in window&&null!=window.sessionStorage}catch(e){}return(-1!==navigator.userAgent.indexOf("MSIE")?/MSIE (\d+\.\d+);/:/Trident.*rv[ :]*(\d+\.\d+)/).test(navigator.userAgent)&&(o.isIE=!0,o.version=Number(RegExp.$1)),"undefined"==typeof Android&&navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)&&(o.isSafari=!0),-1===navigator.userAgent.indexOf("OPR")||o.isChrome||o.isFirefox||o.isEdge||o.isSafari||(o.isOpera=!0),i.browser=o,e}(live||{}),live=function(e){"use strict";var t={LOGLEVEL:{DEBUG:2,INFO:4,WARN:6,ERROR:8,OFF:10},SESSIONSTATE:{NONE:"NONE",CONNECTED:"CONNECTED",RECONNECTING:"RECONNECTING",RELOADING:"RELOADING",HIBERNATED:"HIBERNATED",SUSPENDED:"SUSPENDED",FAILED:"FAILED",CLOSED:"CLOSED"},CALLSTATE:{NONE:"NONE",STARTED:"STARTED",RESPONDED:"RESPONDED",ESTABLISHED:"ESTABLISHED",UPDATING:"UPDATING",UPDATE_FAILED:"UPDATE_FAILED",UPDATED:"UPDATED",FAILED:"FAILED",ERROR:"ERROR",ENDED:"ENDED"},MEDIASTREAMEVENT:{LOCAL_STREAM_ADDED:"LOCAL_STREAM_ADDED",LOCAL_STREAM_REMOVED:"LOCAL_STREAM_REMOVED",LOCAL_STREAM_ERROR:"LOCAL_STREAM_ERROR",REMOTE_STREAM_ADDED:"REMOTE_STREAM_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_ERROR:"REMOTE_STREAM_ERROR"},MEDIADIRECTION:{SENDONLY:"sendonly",RECVONLY:"recvonly",SENDRECV:"sendrecv",NONE:"inactive",INACTIVE:"inactive"},ERRORCODE:{UNAUTHORIZED:401,FORBIDDEN:403,RESOURCE_UNAVAILABLE:404,PROXYAUTH_REQUIRED:407,TEMPORARILY_UNAVAILABLE:480,BUSY_HERE:486,REQUEST_TERMINATED:487,SYSTEM_ERROR:500,BUSY_EVERYWHERE:600,DECLINED:603,WEBSOCKET_ERROR:1001,PEERCONNECTION_ERROR:1101,SET_LOCAL_SDP_ERROR:1102,SET_REMOTE_SDP_ERROR:1103,GENERATE_SDP_ERROR:1104,MEDIA_ERROR:1201,GET_USER_MEDIA_ERROR:1202,RESTORE_FAILED:1301,SAVE_FAILED:1302,SIGNALING_ERROR:1401,ICE_CONNECTION_ERROR:1501},PROTOCOL:{HOST:"HOST",STUN:"STUN",TURN:"TURN"},LOGTYPE:{EVENT_LOG:"event",ERROR_LOG:"error"},EVENTLOG:{CALL_START:"call starts",CALL_END:"call ends",CALL_UPDATE:"call updates",ESTABLISH_PEER_CONNECTION_START:"establishing peer connection starts",ESTABLISH_PEER_CONNECTION_END:"establishing peer connection ends",PEER_CONNECTION_CREATE_OFFER:"peer connection creates offer",PEER_CONNECTION_CREATE_ANSWER:"peer connection creates answer",NETWORK_SWITCHED:"network switched",GET_USER_MEDIA:"succeed to get user media",ON_ICE_CANDIDATE:"onicecandidate",ON_ADD_STREAM:"onaddstream",ON_REMOVE_STREAM:"onremovestream",ON_SIGNALING_STATE_CHANGE:"onsignalingstatechange",ON_ICE_CONNECTION_STATE_CHANGE:"oniceconnectionstatechange",ON_NEGOTIATION_NEEDED:"onnegotiationneeded",ON_DATA_CHANNEL:"ondatachannel",ON_ICE_GATHERING_STATE_CHANGE:"onicegatheringstatechange"},ERRORLOG:{ERROR_FROM_SERVER:"receive error responded from server",GET_USER_MEDIA_ERROR:"failed to get access to local media",GENERATE_SDP_ERROR:"failed to generate SDP",ICE_CONNECTION_ERROR:"ice connection failed",SET_REMOTE_SDP_ERROR:"failed to set remote SDP"},AUTHTYPE:{SERVICE:"SERVICE",TURN:"TURN"},ConnectionStateEnum:{INIT:"init",ESTABLISHED:"established",ERROR:"error",CLOSED:"closed"},PACKAGE:{ALL:"all",REGISTER:"register",CALL:"call",CONVERSATION:"conversation",MESSAGE_NOTIFICATION:"message_notification",MESSAGING:"messaging",CAPABILITY:"capability",CHAT:"chat",FILE_TRANSFER:"file_transfer"},CONSTCS:{SERVER:"s",CLIENT:"c"},RESUME_STATE:{waittingFinalResp:"waittingFinalResp",reStartingCall:"reStartingCall",updateCallByIceFailure:"updateCallByIceFailure"},OFFER_ANSWER_STATE:{INITIAL:"Initial state",OFFER_SENT:"Offer sent",OFFER_GOT:"Offer received",OFFER_REJECTED:"My offer was rejected by the other peer",OFFER_REJECT:"I Rejected the other peer's offer",ANSWER_SENT:"Answer sent",ANSWER_GOT:"Answer received",ACK_SENT:"Ack sent",ACK_GOT:"Ack received",GLARE:"Glare state"},TYPE:{REQUEST:"request",ACK:"acknowledgement",RESPONSE:"response",MESSAGE:"message",ERROR:"error"},ACTION:{CONNECT:"connect",START:"start",SHUTDOWN:"shutdown",COMPLETE:"complete",NOTIFY:"notify",RELAY:"relay",RELIABLE_RELAY:"reliableRelay",TRICKLE:"trickle",PRACK:"prack",ENQUIRY:"enquiry",MODIFY:"modify",HIBERNATE:"hibernate",ICE_ENQUIRY:"iceEnquiry",RELAY_FAILED:"relayFailed",AUDIT:"audit",SUBSCRIBE:"subscribe"},MESSAGESTATE:{INITIAL:"initial",SUBSEQUENT:"subsequent",FINAL:"final"},CONVERSATION:{ADD_STREAM:"add_stream",REMOVE_STREAM:"remove_stream",BEGIN_RECORD:"begin_record",END_RECORD:"end_record",LIST_PARTICIPANTS:"list_participants",STREAM_OPTIONS:"media_direction",STREAM_LAYOUT:"video_layout",RECORDING_RULES:"recording_rules",PAUSE_RESUME_STREAM:"pause_resume_stream",UPDATE_PROFILE:"update_profile",CANCEL:"cancel",CREATE_SIDEBAR:"create_sidebar",REMOTE_ADD_STREAM:"remote_add_stream",ANNOTATE_CUSTOMER_STREAM:"annotate_customer_stream"},CONVERSATIONSTATE:{STREAM_ADDED:"stream_added",STREAM_REMOVED:"stream_removed",STREAM_REJECTED:"stream_rejected",STREAM_JOINED:"stream_joined",STREAM_STARTED:"stream_started",STREAM_LEFT:"stream_left",STREAM_CHANGED:"stream_changed",STREAM_ACTIVE:"stream_active",RECORDING_STARTED:"recording_started",RECORDING_ENDED:"recording_ended",PROFILE_UPDATED:"profile_updated",SIDEBAR_CREATED:"sidebar_created"},STREAMTYPE:{AUDIOVIDEO:"audiovideo",SCREENSHARE:"screenshare"},STREAMSIZE:{MAX:"maximize",MIN:"minimize",PRIMARY:"primary",NORMAL:"normal"},RELAYTYPE:{COMMAND:"command",TEXT:"text",DATA:"data"},RELAYSTATUS:{ACCEPTED:"accepted",DECLINED:"declined"},PAUSERESUME:{PAUSE:"pause",RESUME:"resume"},PAUSERESUMEREASON:{PAUSE_RESUME:"pause_resume",UPGRADE_DOWNGRADE:"upgrade_downgrade"},ICE_CHECK_PERIOD:2e3,PROTOCOL_VERSION:"4.0",ExperienceFactor:{VIDEO_INBOUND:"video_inbound",VIDEO_OUTBOUND:"video_outbound",AUDIO_INBOUND:"audio_inbound",AUDIO_OUTBOUND:"audio_outbound"},ExperienceStatus:{GOOD:2,BAD:1,NOT_AVAILABLE:0}};return(e._private=e._private||{}).wscConst=t,e.MEDIADIRECTION=t.MEDIADIRECTION,e.SESSIONSTATE=t.SESSIONSTATE,e.CONNECTIONSTATE=t.SESSIONSTATE,e.CALLSTATE=t.CALLSTATE,e.STREAMSTATE=t.CALLSTATE,e.MEDIASTREAMEVENT=t.MEDIASTREAMEVENT,e.ERRORCODE=t.ERRORCODE,e.AUTHTYPE=t.AUTHTYPE,e.ConnectionStateEnum=t.ConnectionStateEnum,e.LOGLEVEL=t.LOGLEVEL,e.MSSAGETYPE=t.TYPE,e.ACTION=t.ACTION,e.CONVERSATION=t.CONVERSATION,e.CONVERSATIONSTATE=t.CONVERSATIONSTATE,e.STREAMTYPE=t.STREAMTYPE,e.STREAMSIZE=t.STREAMSIZE,e.RELAYTYPE=t.RELAYTYPE,e.RELAYSTATUS=t.RELAYSTATUS,e.PAUSERESUME=t.PAUSERESUME,e.PAUSERESUMEREASON=t.PAUSERESUMEREASON,e.ExperienceFactor=t.ExperienceFactor,e.ExperienceStatus=t.ExperienceStatus,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.wscUtils=t.wscUtils||{};return i.Map=function(){"use strict";this.mapSize=0,this.entry={}},i.Map.prototype={put:function(e,t){this.containsKey(e)||(this.mapSize=this.mapSize+1),this.entry[e]=t},get:function(e){var t=null;return this.containsKey(e)&&(t=this.entry[e]),t},remove:function(e){var t=!1;return this.containsKey(e)&&delete this.entry[e]&&(t=!0,this.mapSize=this.mapSize-1),t},clear:function(){for(var e in this.entry)delete this.entry[e];this.mapSize=0},containsKey:function(e){var t=!1;return e in this.entry&&(t=!0),t},containsValue:function(e){for(var t in this.entry)if(this.entry[t]===e)return!0;return!1},values:function(){var e=[];for(var t in this.entry)this.entry.hasOwnProperty(t)&&e.push(this.entry[t]);return e},keys:function(){var e=[];for(var t in this.entry)e.push(t);return e},size:function(){return this.mapSize}},i.Queue=function(){var e=[],t=0;this.toJSON=function(){return{array:e,offset:t}},this.length=function(){return e.length-t},this.enqueue=function(t){e.push(t)},this.dequeue=function(){if(0===e.length)return null;var i=e[t];return 2*++t>=e.length&&(e=e.slice(t),t=0),i},this.peek=function(){return e.length>0?e[t]:null}},e.Map=i.Map,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.wscUtils=t.wscUtils||{},n=t.wscConst,o=console,s=null,a=n.LOGLEVEL.WARN;return i.setLogger=function(e){o=e,i.AspectConfig.aspectClassMap.clear(),i.initAspectConfig()},i.getLogger=function(){return s},i.setLogLevel=function(e){a=e},i.getLogLevel=function(){return a},i.setsessionid=function(e){e},i.printTimeStr=function(e){var t=new Date;return(e?t.getDateStr(e):t.getDateStr())+" "},Date.prototype.getDateStr=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in e||(e="yyyy-MM-dd hh:mm:ss"),/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},i.waveFunc=function(e,t){if(t){if(t.prototype){var n=function(){};n.prototype=t.prototype;var o=e.prototype;e.prototype=new n,o&&i.deepCopy(o,e.prototype),e.prototype.constructor=e}if(t.prototype)e.superclass=t.prototype,e.superclass.constructor=t;else{for(var s in t)e[s]="object"==typeof t&&"error"!=s&&"warn"!=s&&"log"!=s&&"info"!=s&&"debug"!=s?function(e){return function(){t[e](arguments[0])}}(s):t[s];e.superclass=t,e.prototype=void 0}}},i.AspectConfig={},i.getCaller_line=function(){var e=null;try{(e=(new Error).stack.split("\n")[4]).indexOf("Error")>=0&&(e=null)}catch(e){}return e},i.isDebugEnabled=function(){var e=!1;if(a===n.LOGLEVEL.DEBUG&&(e=!0),e&&o){var t=i.getCaller_line();if((t=t?"Debug line:"+t:"Debug:").indexOf("tmpProxyClass")>0)return!0;o.debug(i.printTimeStr()+"[wsc "+t+"]")}return e},i.isInfoEnabled=function(){var e=!1;return a<=n.LOGLEVEL.INFO&&(e=!0),e&&o&&o.info(i.printTimeStr()+"[wsc Info]:"),e},i.isWarnEnabled=function(){var e=!1;if(a<=n.LOGLEVEL.WARN&&(e=!0),e&&o){var t=i.getCaller_line();if((t=t?"Warn line:"+t:"Warn:").indexOf("tmpProxyClass")>0)return!0;o.warn(i.printTimeStr()+"[wsc "+t+"]")}return e},i.isErrorEnabled=function(){var e=!1;if(a<=n.LOGLEVEL.ERROR&&(e=!0),e&&o){var t=null;if((t=(t=i.getCaller_line())?"Error line:"+t:"Error:").indexOf("tmpProxyClass")>0)return!0}return e},i.AspectConfig.aspectClassMap=new i.Map,n.WAVETYPE={BEFORE:"before",AFTER:"after",AFTERRETURN:"afterReturn",AFTERTHROW:"afterThrow"},i.AspectConfig.wavePointcut=function(e,t,a,r){var c,l,d=i.AspectConfig.aspectClassMap.get(e);null==d?(d=function(){d.superclass&&d.superclass.prototype&&d.superclass.constructor.apply(this,arguments)},i.waveFunc(d,e),l=d):(c=function(){c.superclass&&c.superclass.prototype&&c.superclass.constructor.apply(this,arguments)},i.waveFunc(c,d),l=c);var u,h=t.indexOf("*"),g=!1;h>=0&&(u=h>0?new RegExp("^"+t.substr(0,h)):new RegExp(t.substr(1)+"$"));var v=function(i){var n=null,o=l;s.superclass&&(o=s.superclass);try{for(;o.superclass;)o=o.superclass;n=o[t]?o[t].apply(o,i):e[t].apply(e,i)}catch(e){s.warn(e)}return n};if(e.prototype){if(e.prototype[t]){switch(r){case n.WAVETYPE.BEFORE:l.prototype[t]=function(){var e=!1,i=null;try{e=a(arguments)}catch(e){throw e}if(e&&(null!==(i=l.superclass[t].apply(this,arguments))&&void 0!==i))return i};break;case n.WAVETYPE.AFTER:l.prototype[t]=function(){var e=null;try{e=l.superclass[t].apply(this,arguments)}catch(e){throw o.error(t+" exception:"+e),e}if(a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERRETURN:l.prototype[t]=function(){var e;if(e=l.superclass[t].apply(this,arguments),a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERTHROW:l.prototype[t]=function(){var e=null;try{if(null!==(e=l.superclass[t].apply(this,arguments))&&void 0!==e)return e}catch(e){a(t,e)}}}g=!0}else if(h>=0)for(var p in e.prototype)if(u.test(p)){switch(r){case n.WAVETYPE.BEFORE:l.prototype[p]=function(){var e=!1,t=null;try{e=a(arguments)}catch(e){throw e}if(e&&(null!==(t=l.superclass[p].apply(this,arguments))&&void 0!==t))return t};break;case n.WAVETYPE.AFTER:l.prototype[p]=function(){var e=null;try{e=l.superclass[p].apply(this,arguments)}catch(e){throw o.error(p+" exception:"+e),e}if(a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERRETURN:l.prototype[p]=function(){var e;if(e=l.superclass[p].apply(this,arguments),a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERTHROW:l.prototype[p]=function(){var e=null;try{if(null!==(e=l.superclass[p].apply(this,arguments))&&void 0!==e)return e}catch(e){a(p,e)}}}g=!0}}else if(e[t]){switch(r){case n.WAVETYPE.BEFORE:l[t]=function(){if(a(arguments)){var e=v(arguments);if(null!==e&&void 0!==e)return e}};break;case n.WAVETYPE.AFTER:l[t]=function(){try{var e=v(arguments)}catch(e){o.error(t+" exception:"+e)}if(a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERRETURN:l[t]=function(){var e=v(arguments);if(a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERTHROW:l[t]=function(){try{var e=v(arguments);if(null!==e&&void 0!==e)return e}catch(e){a(t,e)}}}g=!0}else if(h>=0)for(var p in e)if(u.test(p)){switch(r){case n.WAVETYPE.BEFORE:l[p]=function(){if(a(arguments)){var e=v(arguments);if(null!==e&&void 0!==e)return e}};break;case n.WAVETYPE.AFTER:l[p]=function(){try{var e=v(arguments);if(null!==e&&void 0!==e)return e}catch(e){o.error(p+" exception:"+e)}return a(arguments),e};break;case n.WAVETYPE.AFTERRETURN:l[p]=function(){var e=v(arguments);if(a(arguments),null!==e&&void 0!==e)return e};break;case n.WAVETYPE.AFTERTHROW:l[p]=function(){try{var e=v(arguments);if(null!==e&&void 0!==e)return e}catch(e){a(p,e)}}}g=!0}g&&i.AspectConfig.aspectClassMap.put(e,l)},i.AspectConfig.before=function(e,t,o){i.AspectConfig.wavePointcut(e,t,o,n.WAVETYPE.BEFORE)},i.AspectConfig.after=function(e,t,o){i.AspectConfig.wavePointcut(e,t,o,n.WAVETYPE.AFTER)},i.AspectConfig.afterReturn=function(e,t,o){i.AspectConfig.wavePointcut(e,t,o,n.WAVETYPE.AFTERRETURN)},i.AspectConfig.afterThrow=function(e,t,o){i.AspectConfig.wavePointcut(e,t,o,n.WAVETYPE.AFTERTHROW)},i.AspectConfig.getWavedObject=function(e){var t=i.AspectConfig.aspectClassMap.get(e);return t||(t=e),new t},i.AspectConfig.getWavedClass=function(e){var t=i.AspectConfig.aspectClassMap.get(e);return t||(t=e),t},i.initAspectConfig=function(){o?(i.AspectConfig.before(o,"info",i.isInfoEnabled),i.AspectConfig.before(o,"debug",i.isDebugEnabled),i.AspectConfig.before(o,"warn",i.isWarnEnabled),i.AspectConfig.before(o,"error",i.isErrorEnabled),i.AspectConfig.before(o,"log",i.isInfoEnabled),s=i.AspectConfig.getWavedClass(o)):s=o={},s.info||(s.info=function(){},o.info=function(){}),s.debug||(s.debug=function(){},o.debug=function(){}),s.warn||(s.warn=function(){},o.warn=function(){}),s.error||(s.error=function(){},o.error=function(){}),s.log||(s.log=function(){},o.log=function(){})},i.initAspectConfig(),e.setLogLevel=i.setLogLevel,e.getLogLevel=i.getLogLevel,e.setLogger=i.setLogger,e.getLogger=i.getLogger,e}(live||{}),live=function(e){function t(e){var t=!1;if(void 0===g)return Promise.reject("Audio context is not supported.");return navigator.mediaDevices.enumerateDevices().then(function(i){var n=[],o=[];return i.forEach(function(t){t.kind===e&&n.push(t)}),u.debug("We have audio sources (for "+e+") as follows:",n),0===n.length?Promise.resolve({available:!1,details:o}):v(n,function(e){return new function(e){this.sourceInfo=e;var t,i,n={},o=null,s=null,a=[],r=0,c=this;for(i=6;i--;)a[i]=[];this.test=function(){return n.sourceId=this.sourceInfo.deviceId,n.label=this.sourceInfo.label,new Promise(function(e,i){c.resolve=e,c.reject=i;var a={audio:{optional:[{echoCancellation:!1},{sourceId:c.sourceInfo.deviceId}]}};u.debug("Calling getUserMedia with constraints",a),navigator.mediaDevices.getUserMedia(a).then(function(i){if(t=i,"undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender){if(!i.track||i.track&&"video"===i.track.kind)return u.warn("There is not audio track in the stream."),n.available=!1,void e(n);i.track&&"audio"===i.track.kind&&(n.label=i.track.label)}else{if(i.getAudioTracks().length<1)return u.warn("There is not audio track in the stream."),n.available=!1,void e(n);var a=i.getAudioTracks();a.length>0&&(n.label=a[0].label)}o=g.createMediaStreamSource(i),s=g.createScriptProcessor(0,6,2),o&&s?(o.connect(s),s.connect(g.destination),s.onaudioprocess=l):(u.warn("AudioStreamSource or ScriptProcessor is invalid."),n.available=!1,e(n))}).catch(i)})};var l=function(e){var l,h,v,p=e.inputBuffer.length,m=e.inputBuffer.numberOfChannels,S=e.inputBuffer.sampleRate;for(l=0;l<m;l++)h=e.inputBuffer.getChannelData(l),(v=new Float32Array(p)).set(h),a[l].push(v);if((r+=p)/S>=2){if("undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender)t.track&&"audio"===t.track.kind&&t.track.stop();else{var f=t.getAudioTracks();for(i=f.length;i--;)f[i].stop()}if(o&&s){u.debug("Try to disconnect the audio node");try{o.disconnect(s)}catch(e){u.debug("Failed to disconnect audio node",e)}try{s.disconnect(g.destination)}catch(e){u.debug("Failed to disconnect audio node",e)}}d(a),c.resolve(n)}},d=function(e){var t=[];if(e.forEach(function(e,i){h(e)&&t.push(i)}),t.length>0?(n.available=!0,u.debug(t.length+" active audio channels are found")):(n.available=!1,u.warn("Can not detect any active channels. Please check if audio device is valid.")),n.channelNumber=t.length,2===t.length){for(var i=e[t[0]],o=e[t[1]],s=0,a=i.length;s<a;s++){var r=i[s],c=o[s];if(r.length!==c.length)return n.isStereo=!0,void u.info("Audio device might be stereo.");for(var l=0;l<r.length;l++)if(Math.abs(r[l]-c[l])>1/65536)return n.isStereo=!0,void u.info("Audio device might be stereo.")}n.isStereo=!1,u.info("Audio device might be mono.")}},h=function(e){for(var t=0,i=e.length;t<i;t++){var n=e[t];if(n.length>0)for(var o=0,s=0;s<n.length;s++)if(Math.abs(n[s])>1/32767){if((o+=1)>10)return!0}else o=0}return!1}}(e).test().then(function(e){return o.push(e),{available:t=t||e.available,details:o}})}).catch(function(e){return u.debug(e),Promise.resolve({available:!1,details:[]})})}).catch(function(e){return u.debug("Device selection is not supported",e),Promise.resolve({available:!1,details:[]})})}function i(e,t,i,n){this.turnURI=e,this.username=t,this.password=i,this.protocol=n,this.test=function(){if(!this.turnURI||!this.username||!this.password)return Promise.reject("TURN URI, username and password are required");if("string"!=typeof this.turnURI||"string"!=typeof this.username||"string"!=typeof this.password)return Promise.reject("TURN URI, username and password must be string type");var e={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};o(e,n);var t={iceServers:[e]};return new Promise(function(e,i){var n;try{var o={};u.debug("Constraints used for peerConnection: "+JSON.stringify(o)),n=new RTCPeerConnection(t,o)}catch(t){return u.error("Fail to create peer connection: "+t),void e(!1)}n.onicecandidate=function(t){{if("closed"!==n.signalingState)return t.candidate?"relay"===p(t.candidate.candidate).type?(u.info("Got a relay candidate",t.candidate),n.close(),void e(!0)):void u.debug("Got a non-relay candidate",t.candidate):(n.close(),u.warn("No relay candidate is got before end of candidates"),void e(!1));e(!1)}},n.addTransceiver("audio"),n.createOffer().then(function(e){u.debug("got offer: ",e),n.setLocalDescription(e).then(function(){console.log("Local description set successfully")}).catch(function(e){console.log("Setting local description failed",e)})}).catch(function(e){console.log("Create offer failed with reason ",e)})})};var o=function(e,t){for(var i="transport="+t,n=[],o=0;o<e.urls.length;o++){var s=e.urls[o];-1!==s.indexOf(i)?n.push(s):-1===s.indexOf("?transport=")&&"turn"===s.slice(0,4)&&n.push(s+"?"+i)}e.urls=n}}function n(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.testResult={}}function o(e,t,i){void 0!==g&&void 0!==g.createScriptProcessor||i&&i("Audio context is not supported.");var n=function(e){var i,n={available:!1,details:[]};0==(i=e.filter(function(e){return"audioinput"===e.kind})).length&&t(n);var o=function(e,i,n){this.available=this.available||n.available,this.details.push(n),e&&i?e.test(i):t(this)},s=i.map(function(e){return new function(e){this.sourceInfo=e;var t,i,n,o,s={},a=[],r=0;for(i=6;i--;)a[i]=[];this.test=function(e){s.sourceId=this.sourceInfo.deviceId,s.label=this.sourceInfo.label;var i={audio:{optional:[{echoCancellation:!1},{sourceId:this.sourceInfo.deviceId}]}};u.debug("Calling getUserMedia with constraints",i),h(i).then(function(i){if(t=i,"undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender){if(!i.track||i.track&&"video"===i.track.kind)return u.warn("There is not audio track in the stream."),s.available=!1,void e(s)}else if(i.getAudioTracks().length<1)return u.warn("There is not audio track in the stream."),s.available=!1,void e(s);return n=g.createMediaStreamSource(i),o=g.createScriptProcessor(0,6,2),n&&o?(n.connect(o),o.connect(g.destination),void(o.onaudioprocess=c.bind(null,e))):(u.warn("AudioStreamSource or ScriptProcessor is invalid."),s.available=!1,void e(s))}).catch(function(){s.available=!1,e(s)})};var c=function(e,c){var d,u,h,v=c.inputBuffer.length,p=c.inputBuffer.numberOfChannels,m=c.inputBuffer.sampleRate;for(d=0;d<p;d++)u=c.inputBuffer.getChannelData(d),(h=new Float32Array(v)).set(u),a[d].push(h);if((r+=v)/m>=2){if("undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender)t.track&&"audio"===t.track.kind&&t.track.stop();else{var S=t.getAudioTracks();for(i=S.length;i--;)S[i].stop()}n.disconnect(o),o.disconnect(g.destination),l(a),e(s)}},l=function(e){var t=[];if(e.forEach(function(e,i){d(e)&&t.push(i)}),t.length>0?(s.available=!0,u.debug(t.length+" active audio input channels are found")):(s.available=!1,u.warn("Can not detect any active input channels. Please check if microphone is valid.")),s.channelNumber=t.length,2===t.length){for(var i=e[t[0]],n=e[t[1]],o=0,a=i.length;o<a;o++){var r=i[o],c=n[o];if(r.length!==c.length)return s.isStereo=!0,void u.info("Audio device might be stereo.");for(var l=0;l<r.length;l++)if(Math.abs(r[l]-c[l])>1/65536)return s.isStereo=!0,void u.info("Audio device might be stereo.")}s.isStereo=!1,u.info("Audio device might be mono.")}},d=function(e){for(var t=0,i=e.length;t<i;t++){var n=e[t];if(n.length>0)for(var o=0,s=0;s<n.length;s++)if(Math.abs(n[s])>1/32767){if((o+=1)>10)return!0}else o=0}return!1}}(e)}),a=s.shift(),r=s.reverse().reduce(function(e,t){return o.bind(n,t,e)},o.bind(n,null,null));a.test(r)};void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(n).catch(function(e){u.debug("Device selection is not supported",e),t&&t({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&void 0!==MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(e){n(e.map(function(e){return{label:e.label,kind:kinds[e.kind],deviceId:e.id,groupId:""}}))}):i("Devices cannot be enumerated.")}function s(e,t,i,n){this.turnURI=e,this.username=t,this.password=i,this.protocol=n;var o=function(e){u.debug("dumbFunc: ",e)};this.test=function(e){var t={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};s(t,n);var i,a={iceServers:[t]};try{var r={};u.debug("Constraints used for peerConnection: "+JSON.stringify(r)),i=new RTCPeerConnection(a,r)}catch(t){return u.error("Fail to create peer connection: "+t),void e(!1)}i.onicecandidate=function(t){{if("closed"!==i.signalingState)return t.candidate?"relay"===p(t.candidate.candidate).type?(u.info("Got a relay candidate",t.candidate),i.close(),void e(!0)):void u.debug("Got a non-relay candidate",t.candidate):(i.close(),u.warn("No relay candidate is got before end of candidates"),void e(!1));e(!1)}};i.createOffer(function(e){u.debug("got offer: ",e),i.setLocalDescription(e,o,o)},o,{offerToReceiveAudio:1})};var s=function(e,t){for(var i="transport="+t,n=[],o=0;o<e.urls.length;o++){var s=e.urls[o];-1!==s.indexOf(i)?n.push(s):-1===s.indexOf("?transport=")&&"turn"===s.slice(0,4)&&n.push(s+"?"+i)}e.urls=n}}function a(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.testResult={}}function r(e,t,i){var n={};u.debug("Constraints used for peerConnection: "+JSON.stringify(n)),u.debug("Config used for peerConnection: "+JSON.stringify(e,null,2)),this.pc1=new RTCPeerConnection(e,n),this.pc2=new RTCPeerConnection(e,n);var o,s=this.pc1,a=this.pc2,r=!1,c=!1,l=this,d=function(e,i){e.candidate?"relay"===p(e.candidate.candidate).type&&(i.addIceCandidate(e.candidate),c=!0):c||t(l,"No relay candidate is got before end of candidates")};s.onicecandidate=function(e){d(e,a)},a.onicecandidate=function(e){d(e,s)};var h=function(e){u.debug("offer answer",e),t(l,e)},g=function(e){return e.replace(/a=candidate:[^\r]*\r\n/g,"").replace(/a=end-of-candidates\r\n/g,"")};const v=function(e){if(r&&(e.sdp=e.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+o+"\r\n")),i){var t=e.sdp;e.sdp=g(t)}a.setLocalDescription(e).then(function(){s.setRemoteDescription(e).then(function(){}).catch(h)}).catch(h)},m=function(e){r&&(t=(t=(t=(t=(t=(t=e.sdp).replace(/(m=video 1 [^\r]+) 116 117\r\n/g,function(e,t){return t.trim()+"\r\n"})).split(/a=rtpmap:116 red\/90000\r\n/g).join("")).split(/a=rtpmap:117 ulpfec\/90000\r\n/g).join("")).split(/a=rtpmap:98 rtx\/90000\r\n/g).join("")).split(/a=fmtp:98 apt=116\r\n/g).join(""),e.sdp=t);if(i){var t=e.sdp;e.sdp=g(t)}s.setLocalDescription(e).then(function(){a.setRemoteDescription(e).then(function(){a.createAnswer().then(v).catch(h)}).catch(h)}).catch(h)};this.start=function(){s.createOffer().then(m).catch(h)},this.end=function(){"closed"!=this.pc1.signalingState&&this.pc1.close(),"closed"!=this.pc2.signalingState&&this.pc2.close()},this.setMaxVideoBitRate=function(e){o=e},this.disableVideoFec=function(){r=!0}}var c=e._private=e._private||{},l=c.wscUtils=c.wscUtils||{},d=c.wscConst,u=e.getLogger(),h=navigator.getUserMedia;navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia&&(h=navigator.mediaDevices.getUserMedia);try{var g=new(window.AudioContext||window.webkitAudioContext)}catch(e){u.debug("Failed to instantiate an audio context, error: "+e)}window.msCrypto&&(window.crypto=window.msCrypto),"function"!=typeof Array.prototype.find&&(Array.prototype.find=function(e){"use strict";if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,i=Object(this),n=i.length>>>0,o=arguments[1],s=0;s<n;s++)if(t=i[s],e.call(o,t,s,i))return t});var v=function(e,t){return e.reduce(function(e,i){return e.then(function(){return t(i)})},Promise.resolve())},p=function(e){var t=e.split(/\s+/);return t.length>7?{type:t[7],protocol:t[2],address:t[4]}:{}},m=[{label:"720p",width:1280,height:720,ratio:"16:9"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p",width:640,height:360,ratio:"16:9"}];if(l.Message=function(e){"use strict";if(this.control={type:void 0,package_type:void 0,session_id:void 0,subsession_id:void 0,sequence:void 0,message_state:void 0,correlation_id:void 0,ack_sequence:void 0,version:void 0},this.header={action:void 0,initiator:void 0,target:void 0,error_code:void 0,reason:void 0,participant:void 0,conversation_key:void 0,instruction:void 0,conversation_topic:void 0,recording_channel:void 0,web_context:void 0,conversation_info:void 0,stream_id:void 0,stream_type:void 0},this.payload={},e)for(var t in"string"==typeof e&&(e=JSON.parse(e)),e)e.hasOwnProperty(t)&&(this[t]=e[t])},l.Message.systemHeaders={action:"action",initiator:"initiator",target:"target",cslr:"cslr",cslw:"cslw",csuw:"csuw",sslr:"sslr",error_code:"error_code",response_code:"response_code",reason:"reason",participant:"participant",enquiry_data:"enquiry_data",authorization:"authorization",authenticate:"authenticate",expiry:"expiry",participants:"participants",conversation_key:"conversation_key",instruction:"instruction",conversation_topic:"conversation_topic",recording_channel:"recording_channel",web_context:"web_context",conversation_info:"conversation_info",stream_id:"stream_id",stream_type:"stream_type"},l.Message.prototype={isRequest:function(){return this.control.type===d.TYPE.REQUEST},isResponse:function(){return this.control.type===d.TYPE.RESPONSE},isEnquiry:function(){return this.header.action===d.ACTION.ENQUIRY},isModify:function(){return this.header.action===d.ACTION.MODIFY},isFinalResponse:function(){var e=this.control.type,t=this.control.message_state;return e===d.TYPE.RESPONSE&&t===d.MESSAGESTATE.FINAL},isError:function(){return this.control.type===d.TYPE.ERROR},isMessage:function(){return this.control.type===d.TYPE.MESSAGE},isReliableRelay:function(){return this.header.action===d.ACTION.RELIABLE_RELAY},isACK:function(){return this.control.type===d.TYPE.ACK},isReconnect:function(){var e=this.control.package_type,t=this.control.session_id,i=this.header.action;return!(e!==d.PACKAGE.REGISTER||!t||i!==d.ACTION.CONNECT)},ack:function(e){var t=new l.Message;t.control.session_id=this.control.session_id,t.control.subsession_id=this.control.subsession_id,t.control.type=d.TYPE.ACK,t.control.package_type=this.control.package_type,t.control.sequence=this.control.sequence,e.sendMessage(t)},complete:function(e){var t=new l.Message;t.control.session_id=this.control.session_id,t.control.subsession_id=this.control.subsession_id,t.control.correlation_id=this.control.correlation_id,t.control.type=d.TYPE.MESSAGE,t.control.package_type=this.control.package_type,t.header.action=d.ACTION.COMPLETE,t.header.stream_id=this.header.stream_id,t.header.stream_type=this.header.stream_type,e.sendMessage(t)},addExtHeaders:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];this.header[t]||(this.header[t]=i)}},getExtHeaders:function(){var e;if(this.header)for(var t in this.header)if(this.header.hasOwnProperty(t)){if(l.Message.systemHeaders[t])continue;e||(e={}),e[t]=this.header[t]}return e},addExtPayloads:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];this.payload[t]||(this.payload[t]=i)}}},l.ErrorInfo=function(e,t){this.code=e,this.reason=t},l.wscLoginWithOAuthToken=function(e,t,i,n,o){var s=n+"?oauth_token="+e+"&final_redirect_uri="+t+"&wsc_app_uri="+o;if(u.debug("Login WebRTC Session Controller by OAuth token to destination -> "+s),!i){var a="The parameter loginWindowType is required.";throw u.error(a),a}"current_window"===i?window.location.href=s:"new_window"===i&&window.open(s,"Wsc Login","width=500,height=500,left=200,top=100")},l.AuthHandler=function(e){"use strict";this.session=e,e.authHandler=this,this.refresh=null,this.toJSON=function(){return l.toJSON({session:""},this)}},l.checkAuthInfo=function(e,t){var i=!1;if(e===d.AUTHTYPE.SERVICE){if(!t)return!1;i=!0}else if(e===d.AUTHTYPE.TURN){if(!t)return!0;null!=t.iceServers&&(i=!0)}return i},l.getRTCConfiguration=function(e){var t,i=e.authHandler,n=0,o=null,s=!0;if(i&&i.refresh)for(;s&&n<3;){n++;try{if(o=i.refresh(d.AUTHTYPE.TURN),l.checkAuthInfo(d.AUTHTYPE.TURN,o))break;if(!1===o){t="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",u.warn(t),s=!1;break}t="No correct information was return from the callback function 'AuthHandler.refresh()'. Please try again.",u.warn(t)}catch(e){u.error("Handle unauthenticated message error: "+e),s=!1}}else u.warn("No AuthHandler object created for this Session, or this AuthHandler does not have the callback function 'AuthHandler.refresh()'."),s=!1;if(!1===s&&(o=null),o||(o={iceServers:[],iceTransportPolicy:"all"}),e.iceServerListFromServer.length>0){var a=e.iceServerListFromServer.concat(o.iceServers);o.iceServers=a}return o},l.calcHa1=function(e,t){return""},l.extend=function(e,t){var i=function(){};i.prototype=t.prototype;var n=e.prototype;e.prototype=new i,n&&l.deepCopy(n,e.prototype),e.prototype.constructor=e,e.superclass=t.prototype,e.superclass&&(e.superclass.constructor=t)},l.deepCopy=function(e,t){for(var i in t=t||{},e)"object"==typeof e[i]?(t[i]=e[i].constructor===Array?[]:{},l.deepCopy(e[i],t[i])):t[i]=e[i];return t},l.toJSON=function(e,t){var i={};for(var n in t)n in e||(i[n]=t[n]);return i},l.testBrowser=function(){var e,t,i,n,o,s,a=!1;if(c.browser.isChrome&&(e="Chrome",a=!0,t=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),i=void 0,n=void 0),c.browser.isFirefox&&(e="Firefox",a=!0,t=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),i=void 0,n=void 0),navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&(e="Edge",a=!0,t=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[1],10),i=void 0,n=void 0),c.browser.isIE&&(e="IE",a=!1,t=parseInt(navigator.userAgent.match(/rv\:([0-9]+)\./)[1],10),i=void 0,n=void 0),c.browser.isSafari&&(e="Safari",a=!0,t=parseInt(navigator.userAgent.match(/Version\/([0-9]+)\./)[1],10),i=void 0,n=void 0),c.browser.isOpera&&(e="Opera",a=!0,t=parseInt(navigator.userAgent.match(/OPR\/([0-9]+)\./)[1],10),i=void 0,n=void 0),s=c.browser.supportSessionStorage,o="WebSocket"in window,void 0===e){var r=navigator.userAgent;r.startsWith("Mozilla")&&(u.debug("Mozilla user agent: "+r),r.includes("CriOS/")&&(e="Chrome",t=parseInt(navigator.userAgent.match(/CriOS\/([0-9]+)\./)[1],10),a=!0,i=void 0,n=void 0,s=!0,o=!0),r.includes("FxiOS/")&&(e="Firefox",t="60",a=!0,i=void 0,n=void 0,s=!0,o=!0),u.debug("iOS browser app:"+e+" v"+t))}return{compatible:a&&o&&s,details:{browserName:e,browserVersion:t,supportedMinimumVersion:i,supportedMaximumVersion:n,supportWebRTC:a,supportWebSocket:o,supportSessionStorage:s}}},l.resumeAudioContext=function(e,t){return void 0===g?t("Audio context is not supported."):void g.resume().then(e).catch(t)},l.testMicrophone=function(){return t("audioinput")},l.testAudio=function(){return t("audiooutput")},l.testCamera=function(){var e=!1;return navigator.mediaDevices.enumerateDevices().then(function(t){var i=[],n=[];return t.forEach(function(e){"videoinput"===e.kind&&i.push(e)}),0==i.length?Promise.resolve({available:!1,details:n}):v(i,function(t){return new function(e){this.sourceInfo=e;var t={};this.test=function(){var e=[];return t.sourceId=this.sourceInfo.deviceId,t.label=this.sourceInfo.label,v(m,function(n){var o={audio:!1,video:{width:{ideal:n.width},height:{ideal:n.height}}};return i(o).then(function(i){if(i){if("undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender)i.track&&"video"===i.track.kind&&(i.track.stop(),t.label=i.track.label);else{var o=i.getVideoTracks();o.length>0&&(o[0].stop(),t.label=o[0].label)}e.push(n.width+"x"+n.height)}return t.availableResolutions=e,e.length>0&&(t.available=!0),t})}).catch(function(e){u.debug(e)})};var i=function(e){return new Promise(function(t,i){u.debug("Calling getUserMedia with constraints",e),navigator.mediaDevices.getUserMedia(e).then(t).catch(function(e){u.warn("getUserMedia error when check resolution of camera",e),t()})})}}(t).test().then(function(t){return n.push(t),{available:e=e||t.available,details:n}})}).catch(function(e){return u.debug(e),Promise.resolve({available:!1,details:[]})})}).catch(function(e){return u.debug("Device selection is not supported",e),Promise.resolve({available:!1,details:[]})})},l.testNetwork=function(e,t,o){var s={details:{}};return new i(e,t,o,"udp").test().then(function(n){return u.debug("udp connectivity test..."),s.details.udpConnectivity=n,new i(e,t,o,"tcp").test()}).then(function(i){return u.debug("tcp connectivity test..."),s.details.tcpConnectivity=i,new function(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.test=function(){var e={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};return new Promise(function(t,i){var n,o=new r(e,function(e,i){u.warn(i),e.end(),t(0)}),s=null,a=0,c=0,l=!1,d="",h=null;d="12345";for(var g=0;g<5;g++)d+=d+d;n=100*d.length,(h=o.pc1.createDataChannel(null)).onopen=function(){s||(s=new Date);var e=function(){for(var t=0;100!==t&&!(h.bufferedAmount>=n);++t)a+=d.length,h.send(d);new Date-s>=3e3?l=!0:setTimeout(e,1)};e()},o.pc2.ondatachannel=function(e){e.channel.onmessage=function(e){if(c+=e.data.length,l&&a===c){o.end();var i=c/(new Date-s);i=Math.round(1e3*i*8)/1e3,o.end(),t(i)}}},o.start()})}}(e,t,o).test()}).then(function(i){return u.debug("data channel connectivity test..."),s.details.dataThroughput=i,new n(e,t,o).test()}).then(function(e){return u.debug("video bandwidth connectivity test..."),s.details.videoBandwidth=e,s.connectivity=(s.details.udpConnectivity||s.details.tcpConnectivity)&&s.details.dataThroughput>0&&s.details.videoBandwidth>0,s}).catch(function(e){return u.error("Error happens when test network. ",e),Promise.reject(e)})},n.prototype={test:function(){var e={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};return new Promise(function(t,i){var n=4e4,o=0,s=0,a=null,c=null,l=new r(e,function(e,i){u.warn(i),g(),t(-1)});l.setMaxVideoBitRate(2e3),l.disableVideoFec();var d={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};u.debug("Calling getUserMedia with constraints",d),h(d).then(function(e){e.getTracks().forEach(function(t){l.pc1.addTrack(t,e)}),l.start(),a=setTimeout(function(){v(),null==c&&(c=setTimeout(function(){g();var e=-1;s>0&&(e=Math.round(o/s)),t(e)},n))},2e3)}).catch(function(e){u.warn("getUserMedia error when testing video bandwidth",e),t(-1)});var g=function(){if(a&&clearTimeout(a),c&&clearTimeout(c),l&&l.pc1){var e=l.pc1.getLocalStreams();e.length>0&&e[0].getTracks().forEach(function(e){e.stop()}),l.end()}},v=function(){l.pc1.getStats(null,function(e){var i;for(var n in e){var a=e[n];if("bweforvideo"===a.id){i=a.googAvailableSendBandwidth/1e3;break}}void 0==i?(u.warn("Cannot get bandwidth from getStats()."),g(),t(-1)):(o+=i,s+=1)},function(e){u.warn("Error when get statistics.",e),g(),t(-1)}),a=setTimeout(v,1e3)}})}},l.testMicrophoneCallback=function(e,t){return o(0,e,t)},l.testAudioCallback=function(e,t){return o(0,e,t)},l.testCameraCallback=function(e,t){var i=function(t){var i,n={available:!1,details:[]};0==(i=t.filter(function(e){return"videoinput"===e.kind})).length&&e(n);var o=function(t,i,n){this.available=this.available||n.available,this.details.push(n),t&&i?t.test(i):e(this)},s=i.map(function(e){return new function(e){this.sourceInfo=e;var t={};this.test=function(e){t.sourceId=this.sourceInfo.deviceId,t.label=this.sourceInfo.label,t.availableResolutions=[];var i=function(i,n,o){o&&("undefined"!=typeof RTCRtpReceiver&&o instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&o instanceof RTCRtpSender?o.track&&"video"===o.track.kind&&o.track.stop():o.getVideoTracks()[0].stop(),t.availableResolutions.push(i.video.mandatory.minWidth+"x"+i.video.mandatory.minHeight)),n?n():(t.available=t.availableResolutions.length>0,e(t))},n=function(i,n){u.warn("getUserMedia error when check resolution of camera",n),i?i():(t.available=t.availableResolutions.length>0,e(t))},o=m.map(function(e){return{audio:!1,video:{mandatory:{minWidth:e.width,minHeight:e.height,maxWidth:e.width,maxHeight:e.height},optional:[{sourceId:t.sourceId}]}}}),s=o.reverse().shift();o.reduce(function(e,t){return u.debug("Calling getUserMedia with constraints",s),h.bind(null,t,i.bind(null,t,e),n.bind(null,e))},h.bind(null,s,i.bind(null,s,null),n.bind(null,null)))()}}(e)}),a=s.shift(),r=s.reverse().reduce(function(e,t){return o.bind(n,t,e)},o.bind(n,null,null));a.test(r)};void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(i).catch(function(t){u.debug("Device selection is not supported",t),e&&e({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&void 0!==MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(e){i(e.map(function(e){return{label:e.label,kind:kinds[e.kind],deviceId:e.id,groupId:""}}))}):t("Devices cannot be enumerated.")},l.testNetworkCallback=function(e,t,i,n,o){e&&t&&i||o("TURN URI, username and password are required"),"string"==typeof e&&"string"==typeof t&&"string"==typeof i||o("TURN URI, username and password must be string type");var r={},c={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};r.connectivity=!1,r.details={},new s(e,t,i,"udp").test(function(o){u.debug("udp connectivity test...Done"),r.details.udpConnectivity=o,new s(e,t,i,"tcp").test(function(o){u.debug("tcp connectivity test...Done"),r.details.tcpConnectivity=o,new l.DataChannelThroughput_CallbackBased(c,3).test(function(o){u.debug("data channel connectivity test...Done"),r.details.dataThroughput=o,new a(e,t,i).test(function(e){u.debug("video bandwidth connectivity test...Done"),r.details.videoBandwidth=e,r.connectivity=(r.details.udpConnectivity||r.details.tcpConnectivity)&&r.details.dataThroughput>0&&r.details.videoBandwidth>0,n(r)})})})})},l.DataChannelThroughput_CallbackBased=function(e,t,i,n){var o=l.DataChannelThroughput_CallbackBased;this.test=function(s,a){var c=new r(e,function(e,t){h&&clearTimeout(h),e.end(),E=!0,"function"==typeof a&&a(t)},!0);o.lastConfig=e;var d,h,g,v,p,m=null,S=0,f=0,_=!1,C=null,E=!1,R=0,b=0,T=[],A=function(e){e&&e.end(),d&&clearTimeout(d)};if(!l.__throughputPayloadData__){l.__throughputPayloadData__="";for(var I=0;I<128;I++)l.__throughputPayloadData__+="12345678"}var y=function(e){v&&clearTimeout(v),p&&clearTimeout(p),"function"==typeof a&&a(e),A(c),E=!0};if("closed"===c.pc1.connectionState||"closed"===c.pc1.signalingState||"closed"===c.pc2.connectionState||"closed"===c.pc2.signalingState)return u.info("Failed to open data channel, connectionState="+c.pc1.connectionState+", signalingState="+c.pc1.signalingState),"function"==typeof a&&a("Cannot get network status.Illegal state for peer connection."),A(c),void(E=!0);(C=c.pc1.createDataChannel(null)).onopen=function(){h&&clearTimeout(h);var e,o=function(){if(Date.now()-e>1100)return u.warn("The timer is executed after additional 1000ms, the page tab may be inactive so that browser tunes the timer interval"),"function"==typeof a&&a("Network diagnostics : Throughput determination failed. The page tab may be inactive so that browser tunes the timer interval."),A(c),void(E=!0);if(C.bufferedAmount<l.__throughputPayloadData__.length){S+=l.__throughputPayloadData__.length;try{C.send(l.__throughputPayloadData__)}catch(e){return void y(e)}}new Date-m>=1e3*t||S-b>307200?_=!0:(e=Date.now(),v=setTimeout(o,1))},s=function(){void 0!==i&&null!==i&&(g=setTimeout(function(){u.debug("Timeout for network status detection, interrupt it and get throughput"),O()},1e3*i)),m||(m=new Date),o()};if(!0===n){var r=function(){if(Date.now()-e>1100)return u.warn("The timer is executed after additional 1000ms, the page tab may be inactive so that browser tunes the timer interval"),"function"==typeof a&&a("Network diagnostics : Latency determination failed. The page tab may be inactive so that browser tunes the timer interval."),A(c),void(E=!0);var t=""+Date.now();try{C.send(t)}catch(e){return void y(e)}b+=t.length,S+=t.length,(R+=1)>=40?s():(e=Date.now(),p=setTimeout(r,100))};r()}else s()};var O=function(){if(!E){E=!0,clearTimeout(v),A(c);var e,t,i,o=new Date-m;if(n){if(T.length>10){var a=T.slice(10),r=0;e=a[0],t=e,a.forEach(function(i){r+=i,i>e&&(e=i),i<t&&(t=i)}),i=Math.round(r/a.length),u.debug("Latency(ms): average: "+i+", min: "+t+", max: "+e+", count: "+a.length+", details: "+a.toString())}u.debug("Warmup details(ms):"+T.slice(0,10))}var l=f-b,d=Math.round(8*l/o);u.debug("Network status detection succeeds. The throughput is: "+d+" kbps, use time (ms): "+o+", received bytes: "+l),"function"==typeof s&&(n?s(d,i,e,t):s(d))}};c.pc2.ondatachannel=function(e){e.channel.onmessage=function(e){if(e.data.length<20){var t=parseInt(e.data),i=Date.now()-t;T.push(i)}f+=e.data.length,_&&S===f&&(g&&clearTimeout(g),O())}};h=setTimeout(function(){u.debug("Takes more than 10000ms to open the data channel. End the call and invoke error callback"),A(c),E=!0,"function"==typeof a&&a("Network diagnostics : ICE failed. Takes more than 10000ms to open the data channel.")},1e4),c.start(),d=setTimeout(function(){A(c)},6e4)}},a.prototype={test:function(e){var t=4e4,i=0,n=0,o=null,s=null,a=new r({iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]},function(t,i){u.warn(i),l(),e(-1)});a.setMaxVideoBitRate(2e3),a.disableVideoFec();var c={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};console.log("Calling getUserMedia with constraints",c),h(c).then(function(r){r.getTracks().forEach(function(e){a.pc1.addTrack(e,r)}),a.start(),o=setTimeout(function(){d(),null==s&&(s=setTimeout(function(){l();var t=-1;n>0&&(t=Math.round(i/n)),e(t)},t))},2e3)}).catch(function(t){u.warn("getUserMedia error when testing video bandwidth",t),e(-1)});var l=function(){if(o&&clearTimeout(o),s&&clearTimeout(s),a&&a.pc1){var e=a.pc1.getLocalStreams();e.length>0&&e[0].getTracks().forEach(function(e){e.stop()}),a.end()}},d=function(){a.pc1.getStats(null,function(t){var o;for(var s in t){var a=t[s];if("bweforvideo"===a.id){o=a.googAvailableSendBandwidth/1e3;break}}void 0==o?(u.warn("Cannot get bandwidth from getStats()."),l(),e(-1)):(i+=o,n+=1)},function(t){u.warn("Error when get statistics.",t),l(),e(-1)}),o=setTimeout(d,1e3)}}},c.browser.isIE){var S=JSON.stringify;JSON.stringify=function(){var e=Array.prototype.slice.call(arguments);return(1===e.length||e.length>1&&(null===e[1]||void 0===e[1]))&&(e[1]=function(e,t){return t&&t.call&&t.apply?void 0:t}),S.apply(this,e)}}return e.extend=l.extend,e.wscLoginWithOAuthToken=l.wscLoginWithOAuthToken,e.Message=l.Message,e.ErrorInfo=l.ErrorInfo,e.AuthHandler=l.AuthHandler,e.testBrowser=l.testBrowser,e.testMicrophone=l.testMicrophone,e.testAudio=l.testAudio,e.testCamera=l.testCamera,e.testNetwork=l.testNetwork,e.testMicrophoneCallback=l.testMicrophoneCallback,e.testAudioCallback=l.testAudioCallback,e.testCameraCallback=l.testCameraCallback,e.testNetworkCallback=l.testNetworkCallback,e.resumeAudioContext=l.resumeAudioContext,e}(live||{}),live=function(e){"use strict";function t(e,t){var i=t.pkgInstance.videoSendBitrate;return i?(p.debug("Prefer video send bitrate: "+i),n(e,i,"video")):e}function i(e,t){var i=t.pkgInstance.videoRecvBitrate;return i?(p.debug("Prefer video receive bitrate: "+i),n(e,i,"video")):e}function n(e,t,i){var n=e.split("\r\n"),o=l(n,"m=",i);if(null===o)return p.debug("Failed to add bandwidth line to sdp, as no m-line found"),e;var s=d(n,o+1,-1,"m=");null===s&&(s=n.length);var a=d(n,o+1,s,"c=");if(null===a)return p.debug("Failed to add bandwidth line to sdp, as no c-line found"),e;var r=d(n,a+1,s,"b=AS");r&&n.splice(r,1);var c="b=AS:"+t;return n.splice(a+1,0,c),n.join("\r\n")}function o(e,t){if(!t.pkgInstance.removeVideoFec)return e;p.debug("Removing FEC-related SDP lines (red / ulpfec / rtx)");var i=e.split("\r\n"),n=l(i,"a=rtpmap","red");if(null===n)return e;var o=c(i[n]);if(null===(n=l(i=s(i=a(i,o),"ulpfec"),"a=fmtp",o.toString())))return e;var r=function(e){var t={},i=e.indexOf(" "),n=e.substring(i+1).split("; "),o=new RegExp("a=fmtp:(\\d+)"),s=e.match(o);if(!s||2!==s.length)return null;t.pt=s[1];for(var a={},r=0;r<n.length;++r){var c=n[r].split("=");2===c.length&&(a[c[0]]=c[1])}return t.params=a,t}(i[n]).pt;return null===r?e:(i.splice(n,1),(i=a(i,r)).join("\r\n"))}function s(e,t){var i=l(e,"a=rtpmap",t);if(null===i)return e;var n=c(e[i]);e.splice(i,1);var o=l(e,"m=","video");return null===o?e:(e[o]=r(e[o],n),e)}function a(e,t){var i=l(e,"a=rtpmap",t.toString());if(null===i)return e;e.splice(i,1);var n=l(e,"m=","video");return null===n?e:(e[n]=r(e[n],t),e)}function r(e,t){e=e.split(" ");for(var i=0;i<e.length;++i)e[i]===t.toString()&&e.splice(i,1);return e.join(" ")}function c(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null}function l(e,t,i){return d(e,0,-1,t,i)}function d(e,t,i,n,o){for(var s=-1!==i?i:e.length,a=t;a<s;++a)if(0===e[a].indexOf(n)&&(!o||-1!==e[a].toLowerCase().indexOf(o.toLowerCase())))return a;return null}var u=e._private=e._private||{},h={},g=u.wscConst,v=u.browser,p=e.getLogger();return h.collectHostIPsByPc=function(e,t){function i(e){p.error("Create offer error while collect Host IP, "+e);n([])}function n(i){try{s&&(s.close(),s=null),a&&(a.close(),a=null),i.length>0?(p.debug("Collected hostIPs: "+JSON.stringify(i,null,2)),e&&e(i)):t()}catch(e){p.error(e)}}var o={};p.debug("Constraints used for peerConnection: "+JSON.stringify(o));var s=new window.RTCPeerConnection(null,o),a=new window.RTCPeerConnection(null,o);try{s.onicecandidate=function(e){if(e.candidate)p.debug("Collected candidate: candidate- "+JSON.stringify(e.candidate));else if(s&&s.localDescription){var i=s.localDescription.sdp;p.debug("Collecting host ips from sdp -"+i),n(function(e){for(var t=[],i=e.split("\r\n"),n=0;n<i.length;n++){var o=i[n],s=null;if(o.match(/^c=/i)){var a=o.split(/\s+/);s=a[2]}else if(o.match(/^a=candidate:.*typ host/i)){var r=o.split(/\s+/);s=r[4]}s&&-1===t.indexOf(s)&&t.push(s)}return t}(i))}else t()},s.createDataChannel("");s.createOffer().then(function(e){s&&a&&(s.setLocalDescription(e),a.setRemoteDescription(e),a.createAnswer().then(function(e){a.setLocalDescription(e),s.setRemoteDescription(e)}).catch(function(e){i(e)}))}).catch(function(e){i(e)})}catch(e){p.error("Got exception when trying to get host IPs: "+e);n([])}},h.addCandidatesFromSdp=function(e,t){var i,n=h.getMediaFromSDP(t),o=[],s={},a=n.length,r=0,c=0;for(r=0;r<a;r++)for(i=(o=n[r].candidates).length,c=0;c<i;c++)s=new RTCIceCandidate({sdpMLineIndex:r,candidate:o[c]}),e.addIceCandidate(s)},h.createPeerConnection=function(t,i){var n,o=null,s=u.wscUtils;try{o=s.getRTCConfiguration(t.session);var a={};a.optional=[{googIPv6:t.pkgInstance.ipv6},{googDscp:t.pkgInstance.dscp}],p.debug("Constraints used for peerConnection: "+JSON.stringify(a)),p.debug("authInfo: "+JSON.stringify(o));var r={};r.start=(new Date).getTime(),t.timeRecording.timeToNewPeerConnection=r,t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ESTABLISH_PEER_CONNECTION_START),n=new window.RTCPeerConnection(o,a),t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ESTABLISH_PEER_CONNECTION_END),t.timeRecording.timeToNewPeerConnection.end=(new Date).getTime();n.onremovestream=function(e){p.info("Remote stream removed."),t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ON_REMOVE_STREAM+":"+e.stream),t.fireMediaStreamEvent(g.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED,e.stream)},n.ontrack=function(e){p.info("Remote stream added via onAddStream.",e),e.streams.length>0&&(t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ON_ADD_STREAM+":"+e.streams[0]),t.timeRecording.timeToGetRemoteMedia.end=(new Date).getTime(),t.fireMediaStreamEvent(g.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED,e.streams[0]),n.___wsc_onaddstream_called=!0)},n.onconnecting=function(e){p.info("Session connecting.")},n.onopen=function(e){p.info("Session opened.")},t.peerConnection=n,i?(p.debug("Adding local to streams to ",i),h.addLocalStreams(t,i)):h.addLocalStream(t),n.onstatechange=function(e){p.debug("iceConnectionState : "+e.currentTarget.iceConnectionState+"\niceGatheringState : "+e.currentTarget.iceGatheringState+"\n")}}catch(i){p.error("Create peer connection: "+i),h.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)}},h.createNewPeerConnection=function(e){if(e.peerConnection){var t=h.getLocalStreams(e.peerConnection);if(e.temporarySavedStreams=t,t)for(var i=0;i<t.length;i++){var n=t[i];h.removeLocalStream(e,n)}e.peerConnection.close(),e.peerConnection=null}h.createPeerConnection(e)},h.clearPeerConnection=function(e){var t=e.peerConnection,i=0;if(t){var n=h.getLocalStreams(t),o=h.getRemoteStreams(t);if(n)for(i=0;i<n.length;i++){var s=n[i];h.removeLocalStream(e,s)}if(o)for(i=0;i<o.length;i++)v.isFirefox;t.close(),e.peerConnection=null}},h.setLocalDescription=function(i,n,s,a){p.debug("rtcHelper.setLocalDescription, newSdp:",n);var r=null,c=null;if(i&&i.peerConnection&&n){s||(s=function(){p.debug("Set localDescription succeed!")}),c=function(){i.timeRecording.timeToGetIceCandidates.start=(new Date).getTime(),s.apply(this,arguments)},r=a?function(t){a(t),h.invokeCallError(i,e.ERRORCODE.SET_LOCAL_SDP_ERROR,t)}:function(t){p.warn("Set local description failed: ",t),h.invokeCallError(i,e.ERRORCODE.SET_LOCAL_SDP_ERROR,t)};var l=i.peerConnection.localDescription;p.debug("iceConnectionState/iceGatheringState is: "+i.getIceConnectionState()+"/"+i.peerConnection.iceGatheringState),p.debug("Updating SDP parameters by reconstruction (in case sdp is read only)..",n);var d=n.sdp;if(d=o(d=t(d,i),i),!v.isFirefox&&"offer"===n.type&&d.includes("m=video")){var u=d.indexOf("m=video");d.includes("a=ssrc",u)||(d+="a=ssrc:1 cname:AAAa0AaA0AaAaaaO\r\n")}var g=new RTCSessionDescription({type:n.type,sdp:d});p.debug("setLocalDescription: type: "+g.type+", sdp: \n"+JSON.stringify(g,null,2)),i.peerConnection.setLocalDescription(g).then(c).catch(r),i.peerConnection.__wscLastLocalSdp=l}},h.setRemoteDescription=function(t,n,s,a){var r=null;if(t&&t.peerConnection&&n){s||(s=function(){p.debug("Set remote description succeed!")}),r=a?function(i){a(i),h.invokeCallError(t,e.ERRORCODE.SET_REMOTE_SDP_ERROR,i)}:function(i){p.warn("Set remote description failed!",i),t.collectClientLog(g.LOGTYPE.ERROR_LOG,g.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+n),h.invokeCallError(t,e.ERRORCODE.SET_REMOTE_SDP_ERROR,i)},p.debug("Updating (remote) SDP parameters by reconstruction (in case sdp is read only)..",n);var c=n.sdp;if(c=function(e){return p.debug("Pre H264 fixes sdp: "+e),e=(e=(e=e.replace("profile-level-id=42001f","profile-level-id=42e01f")).replace("profile-level-id=420c1f","profile-level-id=42e01f")).replace("packetization-mode=0","packetization-mode=1"),v.isSafari&&(e=e.replace("h264","H264")),p.debug("Post H264 fixes sdp: "+e),e}(c=o(c=i(c=function(e,t){return p.debug("Browser is: "+JSON.stringify(v,null,2)),v.isIE&&(p.debug("Filtering SDP to remove 'rtcp-fb:* nack' support"),t=t.split("\r\n").filter(function(e){return!e.match(/rtcp-fb:\* nack.*/)}).join("\r\n"),p.debug("Filtering SDP to remove b=AS:0"),t=t.split("\r\n").filter(function(e){return"b=AS:0"!==e}).join("\r\n")),t.split("\r\n").map(function(t){var i=t.match(/a=setup:.*/g);return"offer"===e&&i?(p.debug("SDP offer contains: "+i),"a=setup:actpass"!==i[0]?(p.debug("SDP offer should not contain "+i),"a=setup:actpass"):t):t}).join("\r\n")}(n.type,c),t),t)),v.isFirefox&&"offer"===n.type&&c.includes("m=audio")&&!c.includes("m=video")&&!c.includes("m=application")){var l=c.indexOf("m=audio");c.includes("a=mid",l)||(c+="a=mid:audio\r\n")}p.debug("setRemoteDescription: type: "+n.type+", sdp: \n"+JSON.stringify(c,null,2));var d=new RTCSessionDescription({type:n.type,sdp:c});t.peerConnection.setRemoteDescription(d).then(s).catch(r)}},h.removeLocalStream=function(e,t){t&&(t.peerConnectionNum&&(t.peerConnectionNum--,p.debug("removeLocalStream, peerConnectionNum: "+t.peerConnectionNum)),v.isFirefox||("undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?e.peerConnection.removeTrack(t):e.peerConnection.removeStream(t)),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED,t))},h.addLocalStream=function(e,t){var i=e.peerConnection,n=0;if(t){t.peerConnectionNum?t.peerConnectionNum++:t.peerConnectionNum=1,"undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?(t.track&&"video"===t.track.kind&&!e.callConfig.shouldSendVideo()&&(t.track.enabled=!1),t.track&&"audio"===t.track.kind&&(p.debug("Adding audio track to new stream",t.track),i.addTrack(t.track,t),p.debug("addLocalStream (video: 0, audio: 1), peerConnectionNum: "+t.peerConnectionNum,t)),t.track&&"video"===t.track.kind&&(p.debug("Adding video track to new stream",t.track),i.addTrack(t.track,t),p.debug("addLocalStream (video: 1, audio: 0), peerConnectionNum: "+t.peerConnectionNum,t))):(t.getVideoTracks().length>0&&!e.callConfig.shouldSendVideo()&&t.getVideoTracks().map(function(e){e.enabled=!1}),t.getAudioTracks().forEach(function(e){p.debug("Adding audio track to new stream",e),i.addTrack(e,t)}),t.getVideoTracks().forEach(function(e){p.debug("Adding video track to new stream",e),i.addTrack(e,t)}),p.debug("addLocalStream (video: "+t.getVideoTracks().length+", audio: "+t.getAudioTracks().length+"), peerConnectionNum: "+t.peerConnectionNum,t));var o=!0,s=e.localMediaStreams;for(n=0;n<s.length;n++){if(s[n]===t){o=!1;break}}o&&(e.localMediaStreams||(e.localMediaStreams=[]),e.localMediaStreams.push(t)),i.__wscIsAudioStreamAdded||(i.__wscIsAudioStreamAdded=h.streamHasMediaTracks([t],"audio")),i.__wscIsVideoStreamAdded||(i.__wscIsVideoStreamAdded=h.streamHasMediaTracks([t],"video")),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,t)}else{for(n=0;n<e.temporarySavedStreams.length;n++){var a=e.temporarySavedStreams[n];a.peerConnectionNum?a.peerConnectionNum++:a.peerConnectionNum=1,"undefined"!=typeof RTCRtpReceiver&&a instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&a instanceof RTCRtpSender?(a.track&&"audio"===a.track.kind&&(p.debug("Adding audio track to existing stream",a.track),i.addTrack(a.track,a)),a.track&&"video"===a.track.kind&&(p.debug("Adding video track to existing stream",a.track),i.addTrack(a.track,a))):(a.getAudioTracks().forEach(function(e){p.debug("Adding audio track to existing stream",e),i.addTrack(e,a)}),a.getVideoTracks().forEach(function(e){p.debug("Adding video track to existing stream",e),i.addTrack(e,a)})),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,a),p.debug("addLocalStream, peerConnectionNum: "+a.peerConnectionNum)}i.__wscIsAudioStreamAdded||(i.__wscIsAudioStreamAdded=h.streamHasMediaTracks(e.localMediaStreams,"audio")),i.__wscIsVideoStreamAdded||(i.__wscIsVideoStreamAdded=h.streamHasMediaTracks(e.localMediaStreams,"video"))}p.debug("call local media streams length : "+e.localMediaStreams.length)},h.addLocalStreams=function(e,t){if(t)for(var i=0;i<t.length;i++){var n=t[i];h.addLocalStream(e,n)}},h.calculateMediaChange=function(e,t){var i=!1,n=[],o=[];if(e.forEach(function(e){"inactive"!==e.mode&&0!==e.port&&n.push(e)}),t.forEach(function(e){"inactive"!==e.mode&&0!==e.port&&o.push(e)}),n.length<o.length)i=!0;else if(n.length>o.length)i=!0;else for(var s=0;s<o.length;s++){for(var a=o[s],r=!1,c=0;c<n.length;c++)if(a.equals(n[c])){r=!0;break}if(!r){i=!0;break}}return i},h.isMediaChanged=function(e,t){return h.calculateMediaChange(e,t)},h.getMediaFromSDP=function(e){var t,i,n,o,s,a,r,c,l=e.split("\r\n"),d=0,u="sendrecv",g=[],v=l.length;for(t=0;t<v;t++)switch(i=l[t].split("="),i[0]){case"a":"sendonly"===(n=i[1])||"sendrecv"===n||"recvonly"===n||"inactive"===n?0===d?u=i[1]:g[d-1].mode=i[1]:0===n.indexOf("candidate:")?g[d-1].candidates.push(l[t]):0===n.indexOf("mid:")&&(g[d-1].mid=l[t]);break;case"m":s=(o=i[1].split(" "))[0],a=o[1],r=new h.Media(s,u,a),g[d++]=r;break;case"o":c=(n=i[1]).split(" ")[1],g.sessionId=c}return g},h.Media=function(e,t,i){this.type=e,this.mode=t,this.port=i,this.candidates=[],this.mid="",this.toJSON=function(){return{type:this.type,mode:this.mode,port:this.port}},this.equals=function(e){return 0===this.port&&(this.mode="inactive"),0===e.port&&(e.mode="inactive"),this.type===e.type&&this.mode===e.mode}},h.getCallConfigFromRemoteSDP=function(t,i){var n=g.MEDIADIRECTION.NONE,o=g.MEDIADIRECTION.NONE,s=null,a=function(e,t){switch(e.toLowerCase()){case"sendonly":return t?g.MEDIADIRECTION.SENDONLY:g.MEDIADIRECTION.RECVONLY;case"recvonly":return t?g.MEDIADIRECTION.RECVONLY:g.MEDIADIRECTION.SENDONLY;case"sendrecv":return g.MEDIADIRECTION.SENDRECV;case"inactive":return g.MEDIADIRECTION.NONE}};if(t){for(var r=h.getMediaFromSDP(t),c=null,l=0;l<r.length;l++)"audio"===r[l].type.toLowerCase()?o=a(r[l].mode,i):"video"===r[l].type.toLowerCase()?n=a(r[l].mode,i):"application"===r[l].type.toLowerCase()&&(c=[]);s=new e.CallConfig(o,n,c)}return s},h.streamHasMediaTracks=function(e,t){var i=!1;if(null===e||"audio"!==t&&"video"!==t)return i;for(var n=0;n<e.length;n++)if("audio"===t)if("undefined"!=typeof RTCRtpReceiver&&e[n]instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e[n]instanceof RTCRtpSender)e[n].track&&"audio"===e[n].track.kind&&(i=!0);else{var o=e[n].getAudioTracks();if(null!==o&&o.length>0){i=!0;break}}else if("undefined"!=typeof RTCRtpReceiver&&e[n]instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e[n]instanceof RTCRtpSender)e[n].track&&"video"===e[n].track.kind&&(i=!0);else{var s=e[n].getVideoTracks();if(null!==s&&s.length>0){i=!0;break}}return i},h.changeSdpByCallConfig=function(e,t){function i(e){var t=a;switch(e){case g.MEDIADIRECTION.RECVONLY:t=v[1];break;case g.MEDIADIRECTION.SENDONLY:t=v[2];break;case g.MEDIADIRECTION.SENDRECV:t=v[0];break;case g.MEDIADIRECTION.NONE:t=v[3]}return t}function n(i,n,o){if(!(i<=-1)){var s="",a="";(d=e.indexOf(l,i+n.length))>-1?(a=e.substring(i,d),s=e.substring(d)):a=e.substring(i);for(var r=0;r<v.length;r++){a.indexOf(v[r])>=0&&(a=a.replace(v[r],o))}var c=t.pkgInstance.trickleIceMode;"full"!==c&&"half"!==c||(a.indexOf("ice-options:google-ice")>0?a=a.replace(/ice-options:google-ice/g,"ice-options:trickle"):a.indexOf("ice-options:trickle")<0&&(a+="a=ice-options:trickle\r\n")),e=e.substring(0,i)+a+s}}var o,s,a="a=inactive",r="m=video",c="m=audio",l="m=",d=-1,u=t.callConfig.audioConfig,h=t.callConfig.videoConfig,v=[];return v[0]="a=sendrecv",v[1]="a=recvonly",v[2]="a=sendonly",v[3]=a,(s=e.indexOf(c))>-1&&n(s,c,i(u)),(o=e.indexOf(r))>-1&&n(o,r,i(h)),e},h.getLocalStreams=function(e){return e?"function"==typeof e.getLocalStreams?e.getLocalStreams():u.browser.isFirefox?e.localStreams:void 0:[]},h.getRemoteStreams=function(e){return e?"function"==typeof e.getRemoteStreams?e.getRemoteStreams():u.browser.isFirefox?e.remoteStreams:void 0:[]},h.invokeCallError=function(t,i,n){if(t.onCallError){var o=new e.ErrorInfo(i,n);try{t.onCallError(o)}catch(e){p.error("The callback function 'Call.onCallError()' exception:"+e)}}},u.rtcHelper=h,e}(live||{}),live=function(e){function t(){this.value,this.statistics={peak:0,bottom:0,count:0,sdv:0,mean:0,oldMean:0,S:0,oldS:0}}var i=e._private=e._private||{},n={},o=i.wscConst,s=i.wscUtils,a=e.getLogger(),r=function(i,r,u,h,g,v,p,m){"use strict";if(v&&(this.extHeaders=v),g){var S=n.rehydrateSession(i,r,u,h,g,v,p,m);if(null==S){var f="Failed to reload session data.",_=new s.ErrorInfo(o.ERRORCODE.RESTORE_FAILED,f);a.warn(f);try{h&&h(_)}catch(e){a.error("onError callback exception: "+e)}}return a.debug("Completed session rehydration: "+g),S}this.webSocketUri=r,this.wscWebsocket=null,this.sessionId=null,this.userName=i,this.sessionState=o.SESSIONSTATE.NONE,this.timeToInitWebSocket=0;try{n.initWebSocket(this)}catch(e){if(a.error("Websocket initialization exception: "+e),h){_=new s.ErrorInfo(o.ERRORCODE.WEBSOCKET_ERROR,e);try{h(_)}catch(e){a.error("The callback function 'Session.failureCallback()' returned the exception: "+e)}}}this.subSessionsMap=new e.Map,this.unACKedMsgQueue=new c,this.successCallback=u,this.failureCallback=h,this.lastOutboundSeq=0,this.lastInboundSeq=0,this.lastUnHandledInboundReq=null,this.lastUnACKedInboundMsg=null,this.hostIPs=[],this.onSessionStateChange=null,this.packagesMap=new e.Map,this.busyPingInterval=3e3,this.idlePingInterval=1e4,this.pingMessage="ping",this.pongMessage="pong",this.pingInterval=this.idlePingInterval,this.reConnectInterval=2e3,this.ackInterval=6e4,this.reConnectTime=6e4,this.retryCount=2,this.retryTimes=0,this.timeToLive=0,this.hibernateSuccessCallback=null,this.hibernateFailureCallback=null,this.onHibernationRequest=null,this.iceServerListFromServer=[],this.iceServerAccessToken=null,p&&(this.extPayloads=p,this.timeToLive=3600,this.clientCapability=new l),this.sessionTimeOut=null,this.reConnectTimeOut=null,this.pingTimeOut=null,this.periodlyACKChecker=new function(e){var t,i,n=e,r=this;this.start=function(){if(n.sessionState===o.SESSIONSTATE.CONNECTED){t&&window.clearTimeout(t);var e=n.lastUnACKedInboundMsg;if(e){var c=e.control.sequence;c&&c!==i&&(typeof e!==s.Message&&(e=new s.Message(e)),e.ack(n),a.debug("PeriodlyACKChecker ack the message in sequence "+c),i=c)}t=window.setTimeout(function(){r.start()},n.ackInterval)}else r.stop()},this.stop=function(){t&&(a.debug("Stop PeriodlyACKChecker"),window.clearTimeout(t))}}(this),this.iceServerEnquirer=new function(e){var t,i,s=e,r=[],c=!1,l=function(){r.forEach(function(e){e()}),r=[],c=!1};this.stop=function(){t&&(a.debug("Stop IceServerEnquiry Timer"),window.clearTimeout(t),t=void 0)},this.scheduleIceEnquiry=function(e){t&&window.clearTimeout(t),t=window.setTimeout(function(){a.debug("Enquiring...."),n.sendIceEnquiry(s)},Math.max(e,0))},this.doIceEnquiry=function(e){if(r.push(e),!c){c=!0;var t=this,o=t.handleIceEnquiry;t.handleIceEnquiry=function(e,n){t.handleIceEnquiry=o,o(e,n),clearTimeout(i),l()},a.debug("Enquiring...."),n.sendIceEnquiry(s),i=setTimeout(function(){a.warn("Timeout of IceServerEnquirer is triggered..."),t.handleIceEnquiry=o,l()},3e3)}},this.handleIceEnquiry=function(e,t){var i=t.control.type;if(i===o.TYPE.RESPONSE){a.debug("Receive Response for ICE-Enquiry "),e.iceServerListFromServer=[];var n=t.payload.iceServers,s=-1;if(n)for(var r=0;r<n.length;r++){var c="",l="",d=-1;if(n[r].username&&(c=n[r].username,e.iceServerAccessToken=c),n[r].credential&&(l=n[r].credential),n[r].lifetime&&(d=1e3*n[r].lifetime),n[r].urls)for(var u=0;u<n[r].urls.length;u++){var h={urls:n[r].urls[u],username:c,credential:l};a.debug("Retrieve an ICE Server from response: "+JSON.stringify(h)),e.iceServerListFromServer.push(h),d>0&&(d<s||s<=0)&&(s=d)}}s<=0?a.warn("The minimum lifetime retrieved from response is "+s+" ms, so stop ICE Enquiry"):(s=2*s/3,a.debug("Schedule an ICE Enquiry in "+s+" ms"),e.iceServerEnquirer.scheduleIceEnquiry(s),e.iceServerEnquiryLifetime=s,e.iceServerEnquiryNextTime=Date.now()+s),e.saveToStorage()}else i===o.TYPE.ERROR&&a.error("Receive an error for ICE-Enquiry Request");if(a.debug("session.callUpdateOnIceResponse="+e.callUpdateOnIceResponse),e.callUpdateOnIceResponse){var g=e.getAllSubSessions();if(g&&g.length>0)for(r=0;r<g.length;r++){var v=g[r],p=v.peerConnection,m=v.getStreams();if(!p||"relay"!==p.sessionType&&"relayed"!==p.sessionType){if(m)for(a.debug("Updating conversation due to Relay Failure"),r=0;r<m.length;r++){var S=m[r];"relayed"!==S.call.sessionType&&"relay"!==S.call.sessionType||S.update(S.getStreamOptions())}}else a.debug("Updating the call due to Relay Failure"),e.allowRetry=!0,v.update(v.callConfig)}e.callUpdateOnIceResponse=!1}}}(this),this.iceServerEnquiryLifetime=0,this.iceServerEnquiryNextTime=0,this.connectSubSessionId=null,this.lastActiveTime=null,this.pingSentTime=null,this.expectedTimeLimitToReceivePong=3e3,this.callUpdateOnIceResponse=!1,this.allowRetry=!1,this.enableVerbose=!1,this.isGetNetworkStatusInProgress=!1,this.getNetworkStatusListeners={successCBs:[],errorCBs:[]},this.networkStatusFactor=new t,this.throughputFactor=new t,this.avgLatencyFactor=new t,this.subscribeErrorCallback=null,this.subscribeNotifyCallback=null,this.__externalAuditData__=[],new d(this),this.toJSON=function(){return{sessionId:this.sessionId,userName:this.userName,unACKedMsgQueue:this.unACKedMsgQueue,lastOutboundSeq:this.lastOutboundSeq,lastInboundSeq:this.lastInboundSeq,lastUnHandledInboundReq:this.lastUnHandledInboundReq,subSessionsMap:this.subSessionsMap,packagesMap:this.packagesMap,iceServerListFromServer:this.iceServerListFromServer,iceServerEnquiryNextTime:this.iceServerEnquiryNextTime}}};r.prototype={getAllSubSessions:function(){for(var e=[],t=this.subSessionsMap.values(),i=0,n=0;n<t.length;n++)for(var o=t[n].values(),s=0;s<o.length;s++)e[i]=o[s],i++;return e},getSubSessionsByPackageType:function(e){return this.subSessionsMap.get(e)},putSubSession:function(t,i,o){var s=this.subSessionsMap.get(t);s||(s=new e.Map,this.subSessionsMap.put(t,s)),s.put(i,o),n.updateActivityMarker(this),n.schedulePing(this,!1)},getSubSession:function(e){"use strict";for(var t=null,i=this.subSessionsMap.values(),n=0;n<i.length&&null==(t=i[n].get(e));n++);return t},removeSubSession:function(e){"use strict";a.debug("Removing sub-session: "+e);for(var t=this.subSessionsMap.values(),i=0;i<t.length;i++)t[i].remove(e);var o=this.getAllSubSessions();o&&0===o.length&&n.updateActivityMarker(this),this.saveToStorage()},saveToStorage:function(){if(this.sessionState!==o.SESSIONSTATE.CLOSED&&this.sessionState!==o.SESSIONSTATE.FAILED&&this.sessionState!==o.SESSIONSTATE.RELOADING)if(i.browser.supportSessionStorage)if(this.sessionId)try{sessionStorage.setItem(this.sessionId,JSON.stringify(this));var t=JSON.parse(sessionStorage.getItem(this.sessionId));a.debug("saved ..."),a.debug(t)}catch(t){a.error("Failed to save. Error = "+t),n.invokeSessionError(this,e.ERRORCODE.SAVE_FAILED,t)}else a.debug("Not saving. No sessionId");else a.warn("Sorry, web storage is not supported...");else a.debug("Do not save session data with session state: "+this.sessionState)},setSessionState:function(e){"use strict";this.sessionState=e,null!=this.sessionId&&this.saveToStorage(),this.onSessionStateChange&&this.onSessionStateChange(e)},close:function(){n.clearSession(this),this.wscWebsocket&&(this.wscWebsocket.close(1e3,"Normal close"),this.wscWebsocket=null,a.info("Websocket normally closed")),this.setSessionState(o.SESSIONSTATE.CLOSED)},getPackage:function(e){return this.packagesMap.get(e)},registerPackage:function(t){var i=t.packageType;if(!i)throw"There is no packageType defined in the package.";try{if(this.packagesMap.get(i))throw"Duplicated package type in Session.";this.packagesMap.put(i,t);var n=new e.Map;this.subSessionsMap.put(i,n)}catch(e){a.error("Package registration failed:"+e)}},getUserName:function(){return this.userName},getSessionId:function(){return this.sessionId},getLastOutboundSeq:function(){return this.lastOutboundSeq},setIdlePingInterval:function(e){this.idlePingInterval=e<1e3?1e3:e},setBusyPingInterval:function(e){this.busyPingInterval=e<1e3?1e3:e},setPingPongMessages:function(e,t){this.pingMessage=e,this.pongMessage=t},setReconnectInterval:function(e){this.reConnectInterval=e},setReconnectTime:function(e){this.reConnectTime=e},sendMessage:function(e){"use strict";var t,i=e.control.package_type,n=this.sessionId,s=e.control.type;if(n&&(e.control.session_id=n),e.control.version=o.PROTOCOL_VERSION,e.isReconnect()||s!==o.TYPE.ACK&&(e.control.sequence=this.lastOutboundSeq+1),t=JSON.stringify(e),this.sessionState===o.SESSIONSTATE.CLOSED||this.sessionState===o.SESSIONSTATE.FAILED)throw a.debug("Cannot send message; session state: "+this.sessionState),"Cannot send message; session state: "+this.sessionState;if(this.sessionState===o.SESSIONSTATE.CONNECTED||i===o.PACKAGE.REGISTER)try{this.wscWebsocket.send(t),a.debug("Session: "+n+", Sending message: "+JSON.stringify(e,null,2))}catch(e){a.error("Received an exception when sending message: "+e)}e.isACK()||e.isReconnect()||this.lastOutboundSeq++,a.debug("Send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.unACKedMsgQueue.addMessage(e),(e.isFinalResponse()||e.isError()||"complete"===e.header.action)&&(this.lastUnHandledInboundReq&&this.lastUnHandledInboundReq.control.sequence<=e.control.ack_sequence&&(this.lastUnHandledInboundReq=null),this.lastUnACKedInboundMsg&&this.lastUnACKedInboundMsg.control.sequence===e.control.ack_sequence&&(this.lastUnACKedInboundMsg=null)),this.saveToStorage()},reSendMessage:function(e){var t=JSON.stringify(e);try{this.wscWebsocket.send(t),a.debug("Re-send message: "+JSON.stringify(e,null,4))}catch(e){a.error("Received an exception when re-sending message: "+e)}this.unACKedMsgQueue.addMessage(e),a.debug("Re-send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.saveToStorage()},genNewCorrelationId:function(){return o.CONSTCS.CLIENT+(this.getLastOutboundSeq()+1)},generateSubSessionId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=window.crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return("x"===e?t:3&t|8).toString(16)})},hibernate:function(t,i,o){var s=this.getAllSubSessions();t&&t>0&&(this.timeToLive=t),this.hibernateSuccessCallback=i,this.hibernateFailureCallback=o,n.updateActivityMarker(this),s&&s.length>0?n.invokeHibernateError(this,e.ERRORCODE.BUSY_EVERYWHERE,"session on busy"):n.sendHibernate(this,t)},getNetworkStatus:function(e,t){var i=this;if(i.getNetworkStatusListeners.successCBs.push(e),i.getNetworkStatusListeners.errorCBs.push(t),!0!==i.isGetNetworkStatusInProgress)if(0!==this.iceServerListFromServer.length){i.isGetNetworkStatusInProgress=!0;var n={iceServers:[].concat(this.iceServerListFromServer)},r=function(e){a.warn("Error happens when get network status: "+e);try{i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Cannot get network status.")})}finally{i.getNetworkStatusListeners.successCBs=[],i.getNetworkStatusListeners.errorCBs=[],i.isGetNetworkStatusInProgress=!1}},c=n.iceServers;Array.isArray(c)&&(n.iceServers=[].concat(c.filter(function(e){return e.urls&&(0===e.urls.toLowerCase().indexOf("turn:")||0===e.urls.toLowerCase().indexOf("turns:"))})));try{new s.DataChannelThroughput_CallbackBased(n,4,8,!0).test(function(e,t,n,r){var c=1,l={};try{if(e>=0){if(l.throughput=e,c=e<=25?1:e>25&&e<=150?2:e>150&&e<=300?3:e>300&&e<=1e3?4:5,void 0!==t&&void 0!==n&&void 0!==r&&(t>1e3&&(c=1),l.avgLatency=t,l.maxLatency=n,l.minLatency=r),i.getNetworkStatusListeners.successCBs.forEach(function(e){"function"==typeof e&&e(c,l)}),i.networkStatusFactor.put(c),i.throughputFactor.put(e),i.avgLatencyFactor.put(t),i.enableVerbose&&i.sessionState===o.SESSIONSTATE.CONNECTED){var d=new s.Message;d.control.type=o.TYPE.MESSAGE,d.control.package_type=o.PACKAGE.REGISTER,d.control.subsession_id=i.connectSubSessionId,d.control.session_id=i.sessionId,d.control.ack_sequence=i.lastInboundSeq,d.header.initiator=i.userName,d.header.action=o.ACTION.AUDIT,d.header.module="WEB";var u=null,h=i.getSubSessionsByPackageType(o.PACKAGE.CONVERSATION);h&&h.size()>0&&(u=h.values()[0].conversationKey),u&&(d.header.conversation_key=u),d.header.access_token=i.iceServerAccessToken;var g={network_test:{mos:c,bandwidth:e,rtt:t}};d.payload={audit_data:g},i.sendMessage(d)}}else i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Throughput is less than zero.")})}catch(e){a.error("Error happens when getNetworkStatus..."+e),i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Throughput is less than zero.")})}finally{i.getNetworkStatusListeners.successCBs=[],i.getNetworkStatusListeners.errorCBs=[],i.isGetNetworkStatusInProgress=!1}},r)}catch(e){a.info("Network test failed..",e),r(e)}}else a.warn("ICE servers is not ready. The callbacks will be invoked by next effective invocation");else a.warn("getNetworkStatus is already in progress.")},getNetworkTestStatisticsData:function(){return{mos:this.networkStatusFactor.toJSON(),bandwidth:this.throughputFactor.toJSON(),rtt:this.avgLatencyFactor.toJSON()}},setTimeToLive:function(e){e&&e>0&&(this.timeToLive=e)},suspend:function(){return this.wscWebsocket&&(this.wscWebsocket.close(3001,"Abnormal close"),this.wscWebsocket=null,a.info("Websocket abnormal closed")),this.setSessionState(o.SESSIONSTATE.SUSPENDED),i.browser.supportSessionStorage?sessionStorage.getItem(this.sessionId):(a.warn("The browser does not support SessionStorage, there is no stateInfo stored."),null)},subscribeToEntity:function(e,t,i,o){return this.subscribeErrorCallback=i,this.subscribeNotifyCallback=o,n.sendSubscribe(this,null,e,t)},unsubscribeFromEntity:function(e){n.sendSubscribe(this,e.subsession_id,e.entity,0)},logEventTimestamp:function(e,t){var i={};i[e]=t||Date.now(),this.__externalAuditData__.push(i)}},t.prototype={put:function(e){return void 0===e||isNaN(e)?void(this.value=void 0):e<0?void(this.value=e):(e*=1,this.value=e,this.statistics.count++,1===this.statistics.count?(this.statistics.peak=e,this.statistics.bottom=e):(this.statistics.peak<e&&(this.statistics.peak=e),this.statistics.bottom>e&&(this.statistics.bottom=e)),void(1==this.statistics.count?this.statistics.oldMean=this.statistics.mean=e:(this.statistics.mean=this.statistics.oldMean+(e-this.statistics.oldMean)/this.statistics.count,this.statistics.S=this.statistics.oldS+(e-this.statistics.oldMean)*(e-this.statistics.mean),this.statistics.oldMean=this.statistics.mean,this.statistics.oldS=this.statistics.S,this.statistics.sdv=this.statistics.count>1?Math.sqrt(this.statistics.S/(this.statistics.count-1)):0)))},toJSON:function(){return{peak:void 0===this.statistics.peak?void 0:this.statistics.peak%1==0?this.statistics.peak:1*this.statistics.peak.toFixed(2),bottom:void 0===this.statistics.bottom?void 0:this.statistics.bottom%1==0?this.statistics.bottom:1*this.statistics.bottom.toFixed(2),count:this.statistics.count,sdv:void 0===this.statistics.sdv?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.sdv.toFixed(2),mean:void 0===this.statistics.mean?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.mean.toFixed(2)}}},n.handleWsOpen=function(e){function t(){var t=e.getAllSubSessions();if(t&&t.length>0)for(var s=0;s<t.length;s++){var r=t[s],c=r.peerConnection;if(c){a.debug("Cleanup call between caller ["+r.getCaller()+"] and callee ["+r.getCallee()+"]");var l=o.getLocalStreams(c),d=o.getRemoteStreams(c);if(r.temporarySavedStreams=l,l)for(s=0;s<l.length;s++)o.removeLocalStream(r,l[s]);if(d)for(s=0;s<d.length;s++)i.browser.isFirefox||c.removeStream(d[s]);"closed"!==c.iceConnectionState&&(c.close(),r.peerConnection=null)}}n.sendRegister(e,null)}a.debug("Session opened with id: "+e.sessionId+", Old IPs: "+JSON.stringify(e.hostIPs,null,2));var o=i.rtcHelper;o.collectHostIPsByPc(function(i){a.debug("New IPs: "+JSON.stringify(i,null,2)+"\nOld IPs: "+JSON.stringify(e.hostIPs,null,2)),0!==e.hostIPs.length?function(e,t){for(var i=!0,n=0;n<t.length;n++){var o=t[n];if(e.indexOf(o)>-1){i=!1;break}}return i}(e.hostIPs,i)?(a.debug("Host IPs have changed"),e.clientIpNotChangedAfterReconnect=!1,t()):(a.debug("Host IPs have NOT changed"),e.clientIpNotChangedAfterReconnect=!0,n.sendRegister(e,null)):n.sendRegister(e,null),e.hostIPs=i,a.debug("New IPs: "+JSON.stringify(e.hostIPs,null,2))},function(){a.error("Failed to get host IPs."),t()})},n.handleWsClose=function(t,i){a.debug("Session closed with id: "+t.sessionId),n.clearWebSocket(t.wscWebsocket,i),t.wscWebsocket=null,t.sessionState===o.SESSIONSTATE.CONNECTED?(t.periodlyACKChecker.stop(),t.iceServerEnquirer.stop(),t.setSessionState(o.SESSIONSTATE.RECONNECTING),window.clearTimeout(t.pingTimeOut),t.sessionTimeOut=window.setTimeout(function(){a.warn("reconnect timeout."),n.clearSession(t),t.setSessionState(o.SESSIONSTATE.FAILED),window.clearTimeout(t.reConnectTimeOut)},t.reConnectTime),n.reInitWebSocket(t)):t.sessionState===o.SESSIONSTATE.RELOADING?n.invokeSessionError(t,e.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"):t.sessionState===o.SESSIONSTATE.NONE&&(n.clearSession(t),n.invokeSessionError(t,e.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"))},n.reInitWebSocket=function(e){a.debug("Session reinitialised with id: "+e.sessionId);var t=e.sessionState;a.debug("reInitWebSocket with state: "+t),t!==o.SESSIONSTATE.CONNECTED&&t!==o.SESSIONSTATE.CLOSED&&(e.reConnectTimeOut&&window.clearTimeout(e.reConnectTimeOut),e.sessionTimeOut&&window.clearTimeout(e.sessionTimeOut),n.initWebSocket(e),e.reConnectTimeOut=window.setTimeout(function(){n.reInitWebSocket(e)},e.reConnectInterval))},n.schedulePing=function(e,t){if(e.sessionState===o.SESSIONSTATE.CONNECTED){e.pingTimeOut&&window.clearTimeout(e.pingTimeOut),t&&n.sendPing(e);var i=e.getAllSubSessions();i&&i.length>0?e.pingInterval=e.busyPingInterval:e.pingInterval=e.idlePingInterval,e.pingInterval>0&&(e.pingTimeOut=window.setTimeout(function(){n.schedulePing(e,!0)},e.pingInterval))}},n.sendPing=function(e){try{null!=e.wscWebsocket&&(e.wscWebsocket.send(e.pingMessage),e.pingSentTime=Date.now(),n.isAlive(e))}catch(e){a.debug("can not send ping now: "+e)}},n.isAlive=function(e){setTimeout(function(){var t=e.lastActiveTime-e.pingSentTime;t<0||t>e.expectedTimeToGetResponseFromServer?(e.retryTimes++,a.debug("The ping-pong retryTimes/retryCount: "+e.retryTimes+"/"+e.retryCount),e.retryTimes===e.retryCount&&(e.retryTimes=0,a.warn("Client reconnecting..."),n.handleWsClose(e,!0))):e.retryTimes=0},e.expectedTimeLimitToReceivePong)},n.updateActivityMarker=function(e){e.lastActiveTime=Date.now()},n.clearSession=function(e,t){var n=1e3,o=[];e.packagesMap&&(o=e.packagesMap.values());for(var a=0;a<o.length;a++)o[a].clear&&o[a].clear();t&&(n=t),1e3==n&&i.browser.supportSessionStorage&&sessionStorage&&sessionStorage.removeItem(e.sessionId),e.periodlyACKChecker&&e.periodlyACKChecker.stop(),e.iceServerEnquirer&&e.iceServerEnquirer.stop(),s.setsessionid("")};var c=function(){var e=null,t=null,i=new s.Queue;this.toJSON=function(){return{lowerSeq:e,upperSeq:t,msgQueue:i}},this.getLowerSeq=function(){return e},this.setLowerSeq=function(t){e=t},this.getUpperSeq=function(){return t},this.setUpperSeq=function(e){t=e},this.getMsgQueue=function(){return i},this.addMessage=function(n){if(!n.isACK()&&!n.isReconnect()){var o=n.control.sequence;null==e&&(e=o),t=o,i.enqueue(n),a.debug("addMessage - queue size = "+i.length()+", cslw: "+e+", csuw: "+t)}},this.ackMessages=function(n){if(a.debug("ackMessages - (before) ackSeq = "+n+", queue size = "+i.length()+", cslw = "+e+", csuw = "+t),0!==i.length()&&n>=e&&n<=t){for(var o=i.dequeue(),s=o.control.sequence;o&&s<n;)s=(o=i.dequeue()).control.sequence;return a.debug("ackMessages - queued message sequence = "+s),null==i.peek()?(e=t+1,a.debug("ackMessages - Reset cslw to csuw+1 = "+e)):(o=i.peek(),e=o.control.sequence,a.debug("ackMessages - Reset cslw to incoming seq = "+e)),a.debug("ackMessages - (after) queue size = "+i.length()+", cslw = "+e+", csuw = "+t),!0}return!1},this.reSendMessage=function(n,o){for(var s=i.length(),r=0;r++<s;){(c=i.dequeue()).control.sequence>=o+1?(c.control.sequence=n.lastOutboundSeq+1,n.reSendMessage(c),n.lastOutboundSeq=c.control.sequence):a.debug("skip message: "+JSON.stringify(c))}if(null==i.peek())e=t+1,a.debug("reSendMessage - Reset cslw to csuw+1 = "+e);else{var c=i.peek();e=c.control.sequence,a.debug("reSendMessage - Reset cslw to incoming seq = "+e)}a.debug("reSendMessage - cslw: "+this.getLowerSeq()+", csuw: "+this.getUpperSeq()+", queue size = "+i.length())}};n.handleWsData=function(e,t){"use strict";if(n.updateActivityMarker(t),e===t.pongMessage);else{n.schedulePing(t,!1);var i;i="string"==typeof e?JSON.parse(e):e,a.debug("Session: "+t.sessionId+", Received data from server: "+JSON.stringify(i,null,2));var r=new s.Message(i),c=null,l=null,d=null,u=null,h=null;if(r&&(c=r.control.sequence,l=r.control.ack_sequence,d=r.control.type,u=r.header.action,h=r.control.package_type),c&&(t.lastInboundSeq=c),l?(t.unACKedMsgQueue.ackMessages(l),a.debug("handleWsData: lastInboundSeq = "+t.lastInboundSeq+", lastOutboundSeq = "+t.lastOutboundSeq)):d===o.TYPE.RESPONSE&&null!=c&&(t.unACKedMsgQueue.ackMessages(c),a.debug("handleWsData: lastInboundSeq = "+t.lastInboundSeq+", lastOutboundSeq = "+t.lastOutboundSeq)),h||(h=o.PACKAGE.REGISTER),d===o.TYPE.REQUEST&&(t.lastUnHandledInboundReq=r),t.lastUnACKedInboundMsg=r,u===o.ACTION.SHUTDOWN&&null!=t.lastUnHandledInboundReq)t.lastUnHandledInboundReq.control.subsession_id===r.control.subsession_id&&(t.lastUnHandledInboundReq=null);var g=t.getPackage(h);g?g.onMessage(r):a.warn("package_type '"+h+"' is not defined!"),t.saveToStorage()}},n.invokeSessionError=function(t,i,n){if(t.failureCallback){var o=new e.ErrorInfo(i,n);try{t.failureCallback(o)}catch(e){a.error("The callback function 'Session.failureCallback()' returned an exception: "+e)}}},n.invokeHibernateError=function(t,i,n){if(t.hibernateFailureCallback){var o=new e.ErrorInfo(i,n);try{t.hibernateFailureCallback(o)}catch(e){a.error("The callback function 'Session.hibernateFailureCallback()' returned an exception: "+e)}}},n.initWebSocket=function(e){"use strict";if(null==e.wscWebsocket){a.debug("creating the websocket..."),e.timeToInitWebSocket=(new Date).getTime();try{e.wscWebsocket=new WebSocket(e.webSocketUri,"webrtc.oracle.com")}catch(e){throw a.debug("sessionHelper.initWebSocket(): new WebSocket() returns error: ",e),new Error("sessionHelper.initWebSocket(): new WebSocket() returns error: "+JSON.stringify(e))}if(null==e.wscWebsocket)throw new Error("sessionHelper.initWebSocket(): new WebSocket() returns null.");e.wscWebsocket.onopen=function(t){e.timeToInitWebSocket=(new Date).getTime()-e.timeToInitWebSocket,a.debug("websocket event handler onopen is invoked."),n.handleWsOpen(e)},e.wscWebsocket.onclose=function(t){a.debug("websocket event handler onclose is invoked.",t),n.handleWsClose(e)},e.wscWebsocket.onmessage=function(t){t.data&&n.handleWsData(t.data,e)},e.wscWebsocket.onerror=function(e){a.info("websocket onerror",e)}}},n.clearWebSocket=function(e,t){if(null!=e){a.debug("Closing web socket",e),e.onopen=null,e.onclose=null,e.onmessage=null,e.onerror=null;var i=1e3,n="Normal close";t&&(i=3001,n="Abnormal close"),a.debug("Closing web socket with code: "+i,e),e.close(i,n)}},n.sendRegister=function(e,t){"use strict";var i=new s.Message;if(i.control.type=o.TYPE.REQUEST,i.control.package_type=o.PACKAGE.REGISTER,e.userName&&(i.header.initiator=e.userName,i.header.target=e.userName),i.header.action=o.ACTION.CONNECT,t&&(i.header.authorization=t),e.extHeaders&&i.addExtHeaders(e.extHeaders),e.extPayloads&&i.addExtPayloads(e.extPayloads),e.clientCapability){var n={family:e.clientCapability.family,version:e.clientCapability.version};if(i.payload.capability)for(var a in n){var r=n[a];i.payload.capability[a]||(i.payload.capability[a]=r)}else i.payload.capability=n}e.sessionId?t?e.sendMessage(i):(i.header.cslr=e.lastInboundSeq,i.header.cslw=e.unACKedMsgQueue.getLowerSeq(),i.header.csuw=e.unACKedMsgQueue.getUpperSeq(),e.sendMessage(i)):e.sendMessage(i)},n.sendHibernate=function(e,t){"use strict";var i,n=new s.Message;n.control.type=o.TYPE.REQUEST,n.control.package_type=o.PACKAGE.REGISTER,n.control.subsession_id=e.generateSubSessionId(),n.control.correlation_id=e.genNewCorrelationId(),n.header.action=o.ACTION.HIBERNATE,i=t&&t>0?{ttl:t}:{ttl:3600},n.addExtHeaders(i),e.sendMessage(n)},n.respondHibernate=function(e,t){"use strict";var i=new s.Message;if(e.timeToLive&&e.timeToLive>0){i.control.type=o.TYPE.RESPONSE,i.header.response_code=200,i.control.message_state=o.MESSAGESTATE.FINAL;var n={ttl:e.timeToLive};i.addExtHeaders(n),i.header.response_code}else i.control.type=o.TYPE.ERROR,i.header.error_code=o.ERRORCODE.FORBIDDEN,i.header.reason="Not supported",i.header.error_code;i.control.package_type=o.PACKAGE.REGISTER,i.control.subsession_id=t.control.subsession_id,i.control.correlation_id=t.control.correlationId,i.control.ack_sequence=e.lastInboundSeq,i.header.action=o.ACTION.HIBERNATE,e.sendMessage(i)},n.sendIceEnquiry=function(e){"use strict";var t=new s.Message;t.control.type=o.TYPE.REQUEST,t.control.package_type=o.PACKAGE.REGISTER,t.control.subsession_id=e.connectSubSessionId,t.control.correlation_id=e.genNewCorrelationId(),t.header.action=o.ACTION.ICE_ENQUIRY,e.sendMessage(t)},n.rehydrateSession=function(e,t,s,c,d,u,h,g){if(g){if(d&&d!==g.sessionId)return a.error("SessionId is inconsistent, sessionId in stateInfo is: "+g.sessionId+", but the given sessionId is: "+d),null;i.browser.supportSessionStorage?sessionStorage.setItem(g.sessionId,JSON.stringify(g)):a.warn("Sorry, web storage is not supported...")}var v=n.getStoredSession(d);if(a.debug("Get stored session: "+JSON.stringify(v)),v){var p=new r(e,t,s,c);p.userName=v.userName,p.sessionId=v.sessionId,p.lastOutboundSeq=v.lastOutboundSeq,p.lastInboundSeq=v.lastInboundSeq,p.lastUnHandledInboundReq=v.lastUnHandledInboundReq,p.iceServerListFromServer=v.iceServerListFromServer,p.iceServerEnquiryNextTime=v.iceServerEnquiryNextTime,p.extHeaders=u,h&&(p.extPayloads=h,p.timeToLive=3600,p.clientCapability=new l),p.unACKedMsgQueue.setUpperSeq(v.unACKedMsgQueue.upperSeq),p.unACKedMsgQueue.setLowerSeq(v.unACKedMsgQueue.lowerSeq);for(var m=v.unACKedMsgQueue.msgQueue.array,S=0;S<m.length;S++)p.unACKedMsgQueue.getMsgQueue().enqueue(m[S]);return p.rehydrationData={subSessionsMap:v.subSessionsMap,packagesMap:v.packagesMap},p.setSessionState(o.SESSIONSTATE.RELOADING),p}return null},n.getStoredSession=function(e){if(i.browser.supportSessionStorage){var t=sessionStorage.getItem(e);if(t)return JSON.parse(t)}return null},n.removeStoredSession=function(e){i.browser.supportSessionStorage&&sessionStorage.removeItem(e)},n.handleAuthenticateChallenge=function(e,t,i,n){var r=e.authHandler,c=null,l=!0,d=0;if(r&&r.refresh)for(;l&&d<3;)try{d++;var u=t.header.authenticate,h=r.refresh(o.AUTHTYPE.SERVICE,null);if(s.checkAuthInfo(o.AUTHTYPE.SERVICE,h)){u.ha1=s.calcHa1(h,u),u.username=h.username,i(u),l=!1;break}if(null==h||""===h){c="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",a.warn(c);break}c="No correct information was returned from the callback function 'AuthHandler.refresh()'. Please try again.",a.warn(c)}catch(e){c="Handle unauthenticated message error:"+e,a.error(c),l=!0}else c="No AuthHandler object was created for this Session or this AuthHandler did not implement the callback function 'AuthHandler.refresh()'!",a.warn(c);l&&n(c)},n.handleConnection=function(e,t){var i=t.control.type,r=t.getExtHeaders();if(i===o.TYPE.RESPONSE){e.sessionId&&e.sessionId!==t.control.session_id&&(a.warn("Local session id does not match remote session id - local: "+e.sessionId+", remote: "+t.control.session_id),n.clearSession(e),e.lastOutboundSeq=1,e.lastUnHandledInboundReq=null,e.lastUnACKedInboundMsg=null,e.sessionState=o.SESSIONSTATE.NONE),e.sessionId=t.control.session_id,a.debug("Retrieve verbose log flag from connect/response message : "+t.header.enable_verbose),t.header.enable_verbose&&(e.enableVerbose=t.header.enable_verbose),e.connectSubSessionId=t.control.subsession_id;var c=function(){var i=e.sessionState;switch(a.debug("doAfterIceEnquiry: session state = "+i),e.setSessionState(o.SESSIONSTATE.CONNECTED),i){case o.SESSIONSTATE.NONE:if(e.userName=t.header.initiator,s.setsessionid(e.sessionId),e.successCallback)try{e.successCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception:"+e)}break;case o.SESSIONSTATE.RECONNECTING:a.info("Session re-connected."),e.sessionTimeOut&&window.clearTimeout(e.sessionTimeOut),e.reConnectTimeOut&&window.clearTimeout(e.reConnectTimeOut),(v=t.header.sslr)&&v>e.unACKedMsgQueue.getUpperSeq&&e.unACKedMsgQueue.setUpperSeq(v),e.unACKedMsgQueue.reSendMessage(e,v);var c=e.packagesMap.entry,l=e.subSessionsMap.entry;for(var d in c){var u=e.getPackage(d),h=l[d];if(u&&u.onResurrect)for(var g in h.entry)u.onResurrect(h.get(g))}break;case o.SESSIONSTATE.RELOADING:a.info("Session re-loaded.");var v=t.header.sslr;if(e.successCallback)try{e.successCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception:"+e)}var p=e.rehydrationData;if(p){c=p.packagesMap.entry,l=p.subSessionsMap.entry;for(var d in c){u=e.getPackage(d),h=l[d];u&&u.onRehydration&&u.onRehydration(h)}}var m=e.lastUnHandledInboundReq;m&&n.handleWsData(m,e)}n.updateActivityMarker(e),n.schedulePing(e,!1),e.periodlyACKChecker.start()},l=t.header.sslr;if(void 0===l)a.debug("sslr is undefined and this is the first time register, do ice enquiry..."),e.iceServerEnquirer.doIceEnquiry(c);else{if(a.debug("sslr is NOT undefined and this is the reconnecting register, skip ice enquiry."),e.lastOutboundSeq=l,e.iceServerEnquiryNextTime>0){var d=e.iceServerEnquiryNextTime-Date.now();a.debug("Schedule ice enquiry after: "+d+"ms."),e.iceServerEnquirer.scheduleIceEnquiry(d)}c()}}else if(i===o.TYPE.ERROR){var u=t.header.error_code,h=t.header.reason,g=new s.ErrorInfo(u,h),v=function(t){t&&(h=h+"("+t+")"),a.warn("Session connect failed:"+h),n.invokeSessionError(e,u,h),e.close()};if(u===o.ERRORCODE.UNAUTHORIZED||u===o.ERRORCODE.PROXYAUTH_REQUIRED){a.debug("Authentication failed: "+g.code);n.handleAuthenticateChallenge(e,t,function(t){n.sendRegister(e,t)},v)}else v()}},n.handleHibernation=function(e){n.clearSession(e,3001),e.wscWebsocket&&(e.wscWebsocket.close(3001,"Session hibernated"),e.wscWebsocket=null,a.info("Websocket closed for hibernation")),e.lastUnHandledInboundReq=null,e.lastUnACKedInboundMsg=null,e.pingTimeOut&&window.clearTimeout(e.pingTimeOut),e.reConnectTimeOut&&window.clearTimeout(e.reConnectTimeOut),e.sessionTimeOut&&window.clearTimeout(e.sessionTimeOut),e.setSessionState(o.SESSIONSTATE.HIBERNATED)},n.sendSubscribe=function(e,t,i,n){"use strict";var a=new s.Message,r=null===t?e.generateSubSessionId():t;a.control.type=o.TYPE.REQUEST,a.control.package_type=o.PACKAGE.REGISTER,a.control.subsession_id=r,a.control.correlation_id=e.genNewCorrelationId(),a.header.action=o.ACTION.SUBSCRIBE,a.header.initiator=e.userName;var c=i.split("@"),l={tenant:c.length>1?c[1]:"unknown",entity:i,expires:n};return a.header.presence_data=l,e.sendMessage(a),{entity:i,subsession_id:r}},n.handleSubscribeResponse=function(e,t){"use strict";var i=t.control.type;if(i===o.TYPE.RESPONSE)a.debug("Subscription success");else if(i===o.TYPE.ERROR&&e.subscribeErrorCallback){var n=t.header.error_code,r=t.header.reason,c=new s.ErrorInfo(n,r);a.warn("Subscription failed: "+JSON.stringify(c));try{e.subscribeErrorCallback(c)}catch(e){a.warn("The callback function 'session.subscribeErrorCallback()' exception: "+e)}}},n.handleSubscribeNotify=function(e,t){"use strict";var i=t.header.presence_data;if(a.debug("Subscription notify: "+JSON.stringify(i)),void 0!==i&&e.subscribeNotifyCallback)try{e.subscribeNotifyCallback(i)}catch(e){a.warn("The callback function 'session.subscribeNotifyCallback()' exception: "+e)}};var l=function(){"use strict";var e,t,i,n=navigator.userAgent,o=navigator.appName,s=""+parseFloat(navigator.appVersion);n&&(-1!=(t=n.indexOf("Opera"))?(o="Opera",s=n.substring(t+6),-1!=(t=n.indexOf("Version"))&&(s=n.substring(t+8))):-1!=(t=n.indexOf("MSIE"))?(o="Microsoft Internet Explorer",s=n.substring(t+5)):-1!=(t=n.indexOf("Chrome"))?(o="Chrome",s=n.substring(t+7)):-1!=(t=n.indexOf("Safari"))?(o="Safari",s=n.substring(t+7),-1!=(t=n.indexOf("Version"))&&(s=n.substring(t+8))):-1!=(t=n.indexOf("Firefox"))?(o="Firefox",s=n.substring(t+8)):(e=n.lastIndexOf(" ")+1)<(t=n.lastIndexOf("/"))&&(o=n.substring(e,t),s=n.substring(t+1),o.toLowerCase()==o.toUpperCase()&&(o=navigator.appName)),-1!=(i=s.indexOf(";"))&&(s=s.substring(0,i)),-1!=(i=s.indexOf(" "))&&(s=s.substring(0,i))),this.family=o,this.version=s},d=function(e){"use strict";this.session=e,this.packageType=o.PACKAGE.REGISTER,e.packagesMap.put(this.packageType,this)};return d.prototype={toJSON:function(){"use strict";return s.toJSON({session:""},this)},onMessage:function(t){"use strict";var i=t.control.type,s=t.header.action;if(t.getExtHeaders(),delete e._private,s===o.ACTION.HIBERNATE)if(i===o.TYPE.REQUEST)this.session.onHibernationRequest&&this.session.onHibernationRequest(t),n.respondHibernate(this.session,t),this.session.timeToLive&&this.session.timeToLive>0&&n.handleHibernation(this.session);else{var r,c;if(n.handleHibernation(this.session),i===o.TYPE.RESPONSE?r=t.header.response_code:i===o.TYPE.ERROR&&(r=t.header.error_code),c=t.header.reason,null==r||r>=200&&r<300){if(this.session.hibernateSuccessCallback)try{this.session.hibernateSuccessCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception: "+e)}}else n.invokeHibernateError(this.session,r,c)}else s===o.ACTION.CONNECT?n.handleConnection(this.session,t):s===o.ACTION.ICE_ENQUIRY?this.session.iceServerEnquirer.handleIceEnquiry(this.session,t):s===o.ACTION.RELAY_FAILED?(a.warn("Received relayFailed message: "+t),this.session.callUpdateOnIceResponse=!0,n.sendIceEnquiry(this.session)):s===o.ACTION.SUBSCRIBE?n.handleSubscribeResponse(this.session,t):s===o.ACTION.NOTIFY?n.handleSubscribeNotify(this.session,t):a.warn("Receive an unexpected message: "+t)}},i.sessionHelper=n,e.Session=r,e.ExtensibleSession=r,e}(live||{}),live=function(e){"use strict";var t,i=e._private=e._private||{},n={},o={},s=i.wscConst,a=i.wscUtils,r=i.rtcHelper,c=e.getLogger();return e.CallConfig=function(e,t,i){this.audioConfig=e,this.videoConfig=t,this.dataChannelConfig=i},e.CallConfig.prototype={hasAudio:function(){return this.shouldSendAudio()||this.shouldReceiveAudio()},hasVideo:function(){return this.shouldSendVideo()||this.shouldReceiveVideo()},shouldSendAudio:function(){return null!==this.audioConfig&&(this.audioConfig===s.MEDIADIRECTION.SENDRECV||this.audioConfig===s.MEDIADIRECTION.SENDONLY)},shouldSendVideo:function(){return null!==this.videoConfig&&(this.videoConfig===s.MEDIADIRECTION.SENDRECV||this.videoConfig===s.MEDIADIRECTION.SENDONLY)},shouldReceiveAudio:function(){return null!==this.audioConfig&&(this.audioConfig===s.MEDIADIRECTION.SENDRECV||this.audioConfig===s.MEDIADIRECTION.RECVONLY)},shouldReceiveVideo:function(){return null!==this.videoConfig&&(this.videoConfig===s.MEDIADIRECTION.SENDRECV||this.videoConfig===s.MEDIADIRECTION.RECVONLY)},isPaused:function(){return this.audioConfig===s.MEDIADIRECTION.NONE&&this.videoConfig===s.MEDIADIRECTION.NONE},getChannelType:function(){return this.shouldSendVideo()?"video":this.shouldSendAudio()?"audio":this.shouldReceiveVideo()?"video":"audio"},toJSON:function(){return{audioConfig:this.audioConfig,videoConfig:this.videoConfig,dataChannelConfig:this.dataChannelConfig}},asJSON:function(){return{audio:this.audioConfig,video:this.videoConfig}}},e.CallConfig.fromJSON=function(t){return new e.CallConfig(t.audio,t.video)},e.StreamOptions=function(t,i){e.StreamOptions.superclass.constructor.apply(this,[t,i])},a.extend(e.StreamOptions,e.CallConfig),e.CallState=function(e,t,i,n){this.state=e,this.status={code:t,reason:i},this.streamId=n},e.CallState.prototype={isFinalState:function(){var e=!1;return this.state!==s.CALLSTATE.ENDED&&this.state!==s.CALLSTATE.FAILED||(e=!0),e},is180Ringing:function(){return!(!this.status||this.state!==s.CALLSTATE.RESPONDED||180!==this.status.code)},hasEstablished:function(){return this.state===s.CALLSTATE.ESTABLISHED||this.state===s.CALLSTATE.UPDATE_FAILED||this.state===s.CALLSTATE.UPDATED||this.state===s.CALLSTATE.UPDATING}},e.StreamState=function(t,i,n,o){e.StreamState.superclass.constructor.apply(this,[t,i,n,o])},a.extend(e.StreamState,e.CallState),n.doRequest=function(e,t){function i(){c.debug("=== doStartCallRequest ==="),o.isValidSdp(e,p)?(e.caller=h,e.callee=g,e.setCallState(s.CALLSTATE.STARTED,null,"receive call"),e.subSessionId=v,e.startReqCorrId=u,e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_GOT,p),e._template.doStartCallRequest&&e._template.doStartCallRequest(t)):o.sendReject(e,603,"Invalid Sdp")}function n(){c.debug("=== doUpdateCallRequest ==="),e.callState.state===s.CALLSTATE.UPDATING&&(c.debug("Got update message when call state is UPDATING, that is, my offer lost the glare then."),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_REJECTED),e._template.rollbackUpdate&&(c.debug("Roll back the update initiated by me and accept the update from the other peer."),e._template.rollbackUpdate())),o.isValidSdp(e,p)?(e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_GOT,p),e._template.doUpdateCallRequest&&e._template.doUpdateCallRequest(t)):o.sendReject(e,603,"Invalid Sdp")}var a=e.callState,r=a.state,l=a.status.code,d=t.header.action,u=t.control.correlation_id,h=t.header.initiator,g=t.header.target,v=t.control.subsession_id,p=t.payload.sdp;switch(u&&(e.lastServerCorrelationId=u),t.payload&&t.payload.sdp&&c.debug("The SDP in the request is :\r\n"+t.payload.sdp),r){case s.CALLSTATE.NONE:case s.CALLSTATE.STARTED:switch(d){case s.ACTION.START:i();break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.RESPONDED:switch(d){case s.ACTION.START:switch(l){case 180:i();break;case 183:c.debug("=== doUpdateCallReqInEarlyPhase ==="),n(),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ACK_GOT)}break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.ESTABLISHED:case s.CALLSTATE.UPDATED:case s.CALLSTATE.UPDATE_FAILED:case s.CALLSTATE.ERROR:case s.CALLSTATE.UPDATING:switch(d){case s.ACTION.START:n();break;default:o.doUnexpectedMsg(e,t)}break;default:o.doUnexpectedMsg(e,t)}},n.doResponse=function(e,t){function i(){t.complete(d),e.callState.state===s.CALLSTATE.UPDATING?e.setCallState(s.CALLSTATE.UPDATED,null,"sent complete"):e.setCallState(s.CALLSTATE.ESTABLISHED,null,"sent complete"),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ACK_SENT),o.checkResumeState(e)}function n(e){var t="";return 180===e&&(t="Ringing"),181===e&&(t="Call Is Being Forwarded"),182===e&&(t="Queued"),183===e&&(t="Session Progress"),t}var a=e.callState.state,r=t.header.action,l=t.header.response_code,d=e.session;switch(t.payload&&t.payload.sdp&&c.debug("The SDP in the response is :\r\n"+t.payload.sdp),a){case s.CALLSTATE.NONE:o.doUnexpectedMsg(e,t);break;case s.CALLSTATE.STARTED:case s.CALLSTATE.RESPONDED:switch(r){case s.ACTION.START:l>100&&l<200?t.payload&&t.payload.sdp?t.header.reliable?(c.debug("=== doStartReliableProvRespWithSDP ==="),e.earlyMediaState=s.OFFER_ANSWER_STATE.INITIAL,e.setCallState(s.CALLSTATE.RESPONDED,l,n(l)),e._template.doStartReliableProvRespWithSDP&&e._template.doStartReliableProvRespWithSDP(t)):(c.debug("=== doStartUnReliableProvRespWithSDP ==="),e.setCallState(s.CALLSTATE.RESPONDED,l,n(l)),e.gotAnsweredInProvResp=!0,e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp),e._template.doStartUnReliableProvRespWithSDP&&e._template.doStartUnReliableProvRespWithSDP(t)):t.header.reliable?(c.debug("=== doStartReliableProvRespWithoutSDP ==="),e._template.doStartReliableProvRespWithoutSDP&&e._template.doStartReliableProvRespWithoutSDP(t)):(c.debug("=== doStartUnReliableProvRespWithoutSDP ==="),e.setCallState(s.CALLSTATE.RESPONDED,l,n(l))):l>=200&&l<300&&function(){if(e.earlyMediaState)switch(e.earlyMediaState){case s.OFFER_ANSWER_STATE.ACK_SENT:case s.OFFER_ANSWER_STATE.ACK_GOT:c.debug("=== doStart200RespInEarlyPahse ==="),e._template.doStart200RespInEarlyPhase&&e._template.doStart200RespInEarlyPhase(t);break;case s.OFFER_ANSWER_STATE.OFFER_SENT:c.debug("=== doUpdate200RespInEarlyPhase ==="),e._template.doUpdate200RespInEarlyPhase&&e._template.doUpdate200RespInEarlyPhase(t)}else c.debug("=== doStart2XXResponse ==="),e.extHeaders&&delete e.extHeaders,e.gotAnsweredInProvResp?e.gotAnsweredInProvResp=null:e._template.doStart2XXResponse&&(e._template.doStart2XXResponse(t),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp)),e.setCallState(s.CALLSTATE.RESPONDED,l,"got success response"),i()}();break;case s.ACTION.PRACK:c.debug("=== doPrack200Response ==="),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ACK_SENT);break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.ESTABLISHED:case s.CALLSTATE.UPDATING:case s.CALLSTATE.UPDATED:case s.CALLSTATE.UPDATE_FAILED:case s.CALLSTATE.ERROR:switch(r){case s.ACTION.START:200===l&&(c.debug("=== doUpdate200Response ==="),e.extHeaders&&delete e.extHeaders,t.payload.sdp?(e._template.doUpdate200Response&&e._template.doUpdate200Response(t),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp),i()):c.error("Failed to handle update response with no SDP"));break;default:o.doUnexpectedMsg(e,t)}break;default:o.doUnexpectedMsg(e,t)}},n.doMessage=function(e,t){function n(){c.debug("=== doCancelCallMessage ==="),e.setCallState(s.CALLSTATE.ENDED,"","cancelled"),e.end()}function a(){c.debug("=== doShutdownMessage ==="),e.setCallState(s.CALLSTATE.ENDED,"","shutdown"),e._template.doShutdownMessage&&e._template.doShutdownMessage()}function r(){c.debug("=== doCompleteMessage ==="),e.setCallState(s.CALLSTATE.ESTABLISHED,null,"got complete"),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ACK_GOT)}function l(){if(c.debug("=== doTrickleIce ==="),t.payload.candidates&&e.peerConnection){var i,n=t.payload.candidates.split("\r\n");if(n.length>0){var o=(i=n.shift()).split(":");0===i.indexOf("a=mid")&&2===o.length?d(o[1],n):c.warn("invalid trickle ice candidate")}}}function d(t,n){var o={};null!==e.peerConnection.remoteSDP&&void 0!==e.peerConnection.remoteSDP||e.peerConnection.remoteDescription&&(e.peerConnection.remoteSDP=e.peerConnection.remoteDescription.sdp);for(var s=e.peerConnection.remoteSDP;n.length>0;){var a=n.shift();if(a&&0===a.indexOf("a=mid:")){var r=a.split(":");2===r.length&&(t=r[1])}else if(a&&0===a.indexOf("a=candidate:")){var l={};if(l.candidate=a,l.sdpMid=t,i.browser.isFirefox||i.browser.isEdge||i.browser.isSafari){if(void 0===o[t]){var d=s.split("a=mid:"),u=-1;d.length>1&&(d.shift(),d.every(function(e,i){return 0!==e.indexOf(t+"\r\n")||(u=i,!1)})),o[t]=u}o[t]>-1&&(l.sdpMLineIndex=o[t])}var h=new RTCIceCandidate(l);e.peerConnection.addIceCandidate(h).then(function(){c.debug("addIceCandidate succeed, "+JSON.stringify(h))}).catch(function(e){c.warn("For candidate: "+JSON.stringify(h)+", addIceCandidate gets error: "+e.name)})}else a&&0===a.indexOf("a=end-of-candidates")?c.debug("Get end-of-candidates when handling trickle ice candidate"):""!==a.trim()&&c.debug("Get unknown line of trickle ice candidate: "+a)}}var u=e.callState.state,h=t.header.action;switch(u){case s.CALLSTATE.NONE:o.doUnexpectedMsg(e,t);break;case s.CALLSTATE.STARTED:switch(h){case s.ACTION.SHUTDOWN:n();break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.RESPONDED:switch(h){case s.ACTION.SHUTDOWN:n();break;case s.ACTION.COMPLETE:r();break;case s.ACTION.TRICKLE:l();break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.ESTABLISHED:case s.CALLSTATE.UPDATED:case s.CALLSTATE.UPDATE_FAILED:case s.CALLSTATE.ERROR:switch(h){case s.ACTION.SHUTDOWN:a();break;case s.ACTION.COMPLETE:r();break;case s.ACTION.TRICKLE:l();break;default:o.doUnexpectedMsg(e,t)}break;case s.CALLSTATE.UPDATING:switch(h){case s.ACTION.SHUTDOWN:c.debug("=== doUpdateShutdownMessage ==="),"##re-invite_cancel@server##"===t.header.initiator?(e.setCallState(s.CALLSTATE.UPDATE_FAILED,null,"canceled by server"),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_REJECT)):a();break;case s.ACTION.COMPLETE:c.debug("=== doUpdateComplete ==="),e.setCallState(s.CALLSTATE.UPDATED,null,"got complete"),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.ACK_GOT);break;case s.ACTION.TRICKLE:l();break;default:o.doUnexpectedMsg(e,t)}break;default:h===s.ACTION.TRICKLE?l():o.doUnexpectedMsg(e,t)}},n.doError=function(e,t){var i=e.callState,n=t.header.action,r=t.header.error_code,l=t.header.reason,d=e.session;switch(n){case s.ACTION.START:switch(r){case 401:case 407:!function(){c.debug("=== doAuthentication ===");var i,n=!0,o=0,d=e.session.authHandler,u=t.header.authenticate;if(d&&d.refresh)for(;n&&o<3;){o++;try{if(i=d.refresh(s.AUTHTYPE.SERVICE,null),a.checkAuthInfo(s.AUTHTYPE.SERVICE,i))u.ha1=a.calcHa1(i,u),u.username=i.username,e.authInfo=u,e._template.sendOffer(),n=!1;else{if(null===i||""===i){c.warn("No valid authentication information");break}c.warn("No valid authentication information")}}catch(e){c.error("Got exception: "+e),n=!0}}else c.warn("No AuthHandler for this Session");!0===n&&(e.setCallState(s.CALLSTATE.FAILED,r,l),e._template.clearCall())}();break;case 491:c.debug("Got 491, ACK and do nothing."),t.ack(d);break;default:!function(){c.debug("=== doErrorMessage ==="),t.ack(d);var n=new a.ErrorInfo(r,l);if(d.sessionState===s.SESSIONSTATE.CONNECTED)e.callState.state!==s.CALLSTATE.NONE&&(i.hasEstablished()?function(){if(c.debug("=== doUpdateCallError ==="),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_REJECTED),e.callState.state===s.CALLSTATE.UPDATING&&e.setCallState(s.CALLSTATE.UPDATE_FAILED,r,l),e._template.rollbackUpdate&&e._template.rollbackUpdate(),e.session.allowRetry){c.debug("Retry update due to Relay failure");var t=Math.floor(500*Math.random());window.setTimeout(e.update(e.callConfig),t)}e.session.allowRetry=!1,o.checkResumeState(e)}():(c.debug("=== doStartCallError ==="),e.setCallState(s.CALLSTATE.FAILED,r,l),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_REJECTED),e._template.doStartCallError&&e._template.doStartCallError()));else try{d.failureCallback(n)}catch(e){c.error("Exception in Session failureCallback: "+e)}}()}break;default:o.doUnexpectedMsg(e,t)}},n.doACK=function(e,t){c.debug("ACK")},t=function(t){var i=s.OFFER_ANSWER_STATE.INITIAL,n=s.OFFER_ANSWER_STATE.INITIAL,a=t,l="",d="",u="";this.trickledCandidatesMap=new e.Map,this.getMasterState=function(){return i},this.getSlaveState=function(){return n},this.updateCallRemoteMedias=function(e){a.remoteMedias=r.getMediaFromSDP(e)},this.updateState=function(e,t){switch(c.debug("Trying to update offer-answer state to : "+e),e){case s.OFFER_ANSWER_STATE.OFFER_SENT:d=t,i=e;break;case s.OFFER_ANSWER_STATE.OFFER_GOT:l=t,n=e;break;case s.OFFER_ANSWER_STATE.ANSWER_SENT:n=e,d=t,u=l,this.updateCallRemoteMedias(u);break;case s.OFFER_ANSWER_STATE.ANSWER_GOT:i=e,u=t,this.updateCallRemoteMedias(u);break;case s.OFFER_ANSWER_STATE.ACK_SENT:i=e,t&&(d=t),o.sendTrickledCandidates(a);break;case s.OFFER_ANSWER_STATE.ACK_GOT:n=e,o.sendTrickledCandidates(a);break;case s.OFFER_ANSWER_STATE.OFFER_REJECTED:i=e;break;case s.OFFER_ANSWER_STATE.OFFER_REJECT:n=e}a.offerAnswerManager.masterState=i,a.offerAnswerManager.slaveState=n,a.earlyMediaState&&(a.earlyMediaState=e)},this.canSendOffer=function(){var e=!1;if(a.callState){var t=a.callState.state;t!==s.CALLSTATE.END&&t!==s.CALLSTATE.FAILED||(e=!0)}var o=!(i!==s.OFFER_ANSWER_STATE.ACK_SENT&&i!==s.OFFER_ANSWER_STATE.INITIAL&&i!==s.OFFER_ANSWER_STATE.OFFER_REJECTED||n!==s.OFFER_ANSWER_STATE.ACK_GOT&&n!==s.OFFER_ANSWER_STATE.OFFER_REJECT&&n!==s.OFFER_ANSWER_STATE.INITIAL&&n!==s.OFFER_ANSWER_STATE.ANSWER_SENT||e);return c.debug((o?"Can":"Cannot")+" send offer now. The offer-answer master/slave state is: "+a.offerAnswerManager.getMasterState()+" / "+a.offerAnswerManager.getSlaveState()+", call State: "+a.callState.state+", session State: "+a.session.sessionState+", ICE connection state: "+(a.peerConnection?a.getIceConnectionState():"peerConnection is null")),o},this.reset=function(){i=s.OFFER_ANSWER_STATE.INITIAL,n=s.OFFER_ANSWER_STATE.INITIAL,l=""},this.getLatestActiveRemoteSdp=function(){return u},this.getLatestActiveLocalSdp=function(){return d}},o.isValidSdp=function(e,t){return!(void 0===t||null===t||t.indexOf("a=")<0&&t.indexOf("m=")<0)},o.getInitiator=function(e){return e.session.userName},o.getTarget=function(e){return e.session.userName===e.caller?e.callee:e.caller},o.send180Ringing=function(e){var t=o.createResponse(e);t.control.message_state=s.MESSAGESTATE.SUBSEQUENT,t.header.action=s.ACTION.START,e.session.sendMessage(t),e.setCallState(s.CALLSTATE.RESPONDED,180,"Ringing")},o.sendReject=function(e,t,i,n){var a=o.createError(e),r=s.ERRORCODE.DECLINED;a.header.error_code=t||r,i&&(a.header.reason=i),a.header.action=s.ACTION.START,n&&a.addExtHeaders(n),e.session.sendMessage(a),e.offerAnswerManager.updateState(s.OFFER_ANSWER_STATE.OFFER_REJECT)},o.sendPrack=function(e){var t=o.createRequest(e);t.control.correlation_id=e.lastServerCorrelationId,t.header.action=s.ACTION.PRACK,e.session.sendMessage(t)},o.createRequest=function(e){var t=new a.Message,i=e.session.lastInboundSeq,n=o.getInitiator(e),r=o.getTarget(e);return t.control.type=s.TYPE.REQUEST,t.control.subsession_id=e.subSessionId,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=i,t.header.initiator=n,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},o.createResponse=function(e){var t=new a.Message,i=e.lastServerCorrelationId,n=e.session.lastInboundSeq,o=e.caller,r=e.callee,c=e.subSessionId;return t.control.type=s.TYPE.RESPONSE,t.control.subsession_id=c,t.control.package_type=e.pkgInstance.packageType,t.control.correlation_id=i,t.control.ack_sequence=n,t.header.initiator=o,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},o.createError=function(e){var t=o.createResponse(e);return t.control.type=s.TYPE.ERROR,t},o.createMessage=function(e){var t=new a.Message,i=e.session.lastInboundSeq,n=o.getInitiator(e),r=o.getTarget(e),c=e.subSessionId;return t.control.type=s.TYPE.MESSAGE,t.control.subsession_id=c,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=i,t.header.initiator=n,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},o.sendTrickledCandidates=function(e){var t=e.offerAnswerManager.trickledCandidatesMap,i="";if(t.size()>0){for(var n=t.keys();n.length>0;){var s=n.shift();i+=s;for(var a=t.get(s);a.length>0;){var r=a.shift();if(r){i+=r.match(/^a=.*\r\n$/i)?r:"a="+r+"\r\n"}else c.warn("sendTrickledCandidates found invalid candidate in candidatesArray; skipping")}}o.sendTrickleMessage(e,i)}},o.sendTrickleMessage=function(e,t){var i=o.createMessage(e);i.header.action=s.ACTION.TRICKLE,i.payload={candidates:t},e.session.sendMessage(i),t.indexOf("end-of-candidates")>-1&&e.offerAnswerManager.trickledCandidatesMap.clear()},o.checkResumeState=function(e){if(e.resumeState)switch(e.resumeState){case s.RESUME_STATE.waittingFinalResp:e.resumeState=null,e.resume();break;case s.RESUME_STATE.reStartingCall:e.resumeSuccessCallback&&(e.resumeSuccessCallback(),e.resumeState=null);break;case s.RESUME_STATE.updateCallByIceFailure:e.resumeState=null}},o.setCallState=function(e,t,i,n){var o=e.callState,a=o.state;if(!o.isFinalState()&&(!o.hasEstablished()||t!==s.CALLSTATE.NONE&&t!==s.CALLSTATE.STARTED&&t!==s.CALLSTATE.RESPONDED)){var r=o.status.code;if(a!==t||a===t&&r!==i){e.callState.state=t,e.callState.status.code=i,e.callState.status.reason=n;try{if(e.onCallStateChange)if(e.lastServerExtHeader){var l=e.lastServerExtHeader;e.onCallStateChange(e.callState,l),delete e.lastServerExtHeader}else e.onCallStateChange(e.callState);else if(e.onStateChange)if(e.lastServerExtHeader){var d=e.lastServerExtHeader;e.onStateChange(e.callState,d),delete e.lastServerExtHeader}else e.onStateChange(e.callState)}catch(e){c.warn("The callback function 'Call.onCallStateChange()' exception: "+e)}e.session.saveToStorage()}}},o.onMessage=function(e,t){if(e.isEnquiry()){if(!t.capabilityExchange){var i="No CapabilityExchange registered with Chat";throw c.error(i),i}t.capabilityExchange.onMessage(e)}else e.isRequest()?n.doRequest(t,e):e.isResponse()?n.doResponse(t,e):e.isMessage()?n.doMessage(t,e):e.isACK()?n.doACK(t,e):e.isError()&&n.doError(t,e)},o.clearMsrpSubSession=function(e){e.session.removeSubSession(e.subSessionId),e.msrpSession&&e.msrpSession.close()},o.msrpSubSessionDecline=function(e,t,i,n){var a,r;a=t||s.ERRORCODE.DECLINED,r=i||"Decline",e.callState.state===s.CALLSTATE.UPDATING?e.setCallState(s.CALLSTATE.UPDATE_FAILED,a,r):(o.clearMsrpSubSession(e),e.setCallState(s.CALLSTATE.FAILED,a,r)),o.sendReject(e,a,r,n)},o.sendAcceptResponse=function(e,t,i,n){var a=o.createResponse(e);a.control.message_state=s.MESSAGESTATE.FINAL,a.header.action=s.ACTION.START,a.control.correlation_id=t,n&&a.addExtHeaders(n),a.payload={sdp:i},e.session.sendMessage(a)},o.addParticipants2MsrpSubSession=function(e,t){if(t.callState.state!==s.CALLSTATE.NONE)throw{name:"IllegalStateException",message:"Cannot add participants at subSession state: "+t.callState.state};if(!(e instanceof Array))throw{name:"IllegalArgumentException",message:"parameter participants is not array type"};t.participants=e},o.doUnexpectedMsg=function(e,t){c.warn("Unexpected message is received: "+JSON.stringify(t,null,4))},e._private.CallStateMachine=n,e._private.offerAnswerManager=t,e._private.CallCommonUtils=o,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.browser,n=e.getLogger(),o=function(){this.dataChannel=null,this.origDataChannel=null,this.state="none",this.label=null,this.onOpen=null,this.onClose=null,this.onError=null,this.dataSender=null,this.dataReceiver=null;var e=this,t=function(){e.dataSender=new s(e.dataChannel),n.info("Sender of DataTransfer created.")},o=function(t){n.debug("DataTransfer: Received data:"+t.data),e.dataReceiver?e.dataReceiver.onMessage(t):n.warn("The default data receiver is still initialized to receive data.")},r=function(i){e.origDataChannel&&(e.origDataChannel=null),e.state="open",t(),e.dataReceiver=new a,n.info("Receiver of DataTransfer created.");var s=e.dataChannel.readyState;null==e.label&&(e.label=e.dataChannel.label),n.debug('Data Channel "'+e.dataChannel.label+'" is open; current readyState: '+s),e.dataChannel.disabled=!1,e.dataChannel.onmessage=o,e.onOpen&&e.onOpen(i)},c=function(t){if(e.origDataChannel&&t.target&&e.origDataChannel.id!=t.target.id)return e.dataChannel=e.origDataChannel,void(e.origDataChannel=null);e.state="closed";var i=e.dataChannel.readyState;null==e.label&&(e.label=e.dataChannel.label),n.debug('Data Channel "'+e.dataChannel.label+'" is closing; current readyState is: '+i),e.dataChannel.disabled=!0,e.onClose&&e.onClose(t)},l=function(t){n.debug("Received dataChannel error event for DataTransfer: "+e.dataChannel.label),e.onError&&e.onError(t)};this.initDataChannel=function(t,o){if(n.debug("DataTransfer object initialized by the dataChannel."),o&&(e.origDataChannel=e.dataChannel),e.dataChannel=t,e.state="starting",e.label=t.label,e.dataChannel)try{e.dataChannel.onopen=r,i.isIE&&"open"==e.dataChannel.readyState&&setTimeout(function(){var t=null;try{t=new Event("open")}catch(e){(t=document.createEvent("Event")).initEvent("open",!1,!1)}r.call(e.dataChannel,t)},0),e.dataChannel.onerror=l,e.dataChannel.onclose=c}catch(e){n.error("Exception occured when initializing the callback functions of the data channel: "+e)}else n.error("Could not initialize the data channel with null.")},this.clear=function(){try{null!=e.dataChannel&&(e.dataChannel.close(),e.dataChannel.disabled=!0,n.info("DataTransfer closed its data channel; current readyState is: "+e.dataChannel.readyState)),n.info("DataTransfer object cleared")}catch(e){n.error("Recieved an exception when cleaning the DataTransfer object: "+e)}},this.toJSON=function(){var e={},t={session:"",pkgInstance:""};for(var i in this)i in t||(e[i]=this[i]);return e}};o.prototype={getState:function(){return this.state},getSender:function(){return this.dataSender},getReceiver:function(){return this.dataReceiver}};var s=function(e){this.dataChannel=e};s.prototype={send:function(e){if(null!=this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(e)}catch(e){throw n.debug("Exception when sending data by dataChannel: "+e),e}else n.error("Error when sending data. The dataChannel is not in a valid state.")}};var a=function(){this.onMessage=function(e){n.info("onMessage function is not overridden by the application. New received data is handle by the default DataReceiver object."+e.data)}};return a.prototype={},t.DataTransfer=o,t.DataSender=s,t.DataReceiver=a,e}(live||{});window.console||(console={log:function(){},info:function(){},debug:function(){},warn:function(){},error:function(){}}),"function"!=typeof Date.prototype.now&&(Date.now=function(){return+new Date}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),void 0===Error.prototype.stack&&(Error.prototype.stack="Error:\n\n\n\n\n"),Array.prototype.some||(Array.prototype.some=function(e){"use strict";if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof e)throw new TypeError;for(var t=Object(this),i=t.length>>>0,n=arguments.length>=2?arguments[1]:void 0,o=0;o<i;o++)if(o in t&&e.call(n,t[o],o,t))return!0;return!1});var browserIsIE=!1,IEversion=null;if(-1!=navigator.userAgent.indexOf("MSIE"))var ie_regexp=/MSIE (\d+\.\d+);/;else var ie_regexp=/Trident.*rv[ :]*(\d+\.\d+)/;ie_regexp.test(navigator.userAgent)&&(browserIsIE=!0,IEversion=new Number(RegExp.$1),console.log("Browser is IE, version "+IEversion)),browserIsIE&&IEversion<=9&&(baseconsole=console,9==IEversion&&(console={log:function(e){baseconsole.log(e)},info:function(e){baseconsole.info(e)},debug:function(e){baseconsole.log(e)},warn:function(e){baseconsole.warn(e)},error:function(e){baseconsole.error(e)},clear:function(e){baseconsole.clear(e)},assert:function(e){baseconsole.assert(e)},dir:function(e){baseconsole.dir(e)},profile:function(e){baseconsole.profile(e)},profileEnd:function(e){baseconsole.profileEnd(e)}}),IEversion<=8&&(console={log:function(e){baseconsole.log(e)},info:function(e){baseconsole.info(e)},debug:function(e){baseconsole.log(e)},warn:function(e){baseconsole.warn(e)},error:function(e){baseconsole.error(e)},clear:function(e){baseconsole.clear(e)},assert:function(e){baseconsole.assert(e)}}));var live=function(e){function t(e,t){if(e.session.sessionState===l.SESSIONSTATE.CONNECTED){var i=new d.Message;i.control.type=l.TYPE.MESSAGE,i.control.package_type=l.PACKAGE.REGISTER,i.control.subsession_id=e.session.connectSubSessionId,i.control.session_id=e.session.sessionId,i.control.ack_sequence=e.session.lastInboundSeq,i.header.initiator=e.session.userName,i.header.action=l.ACTION.AUDIT,i.header.module="WEB",i.header.conversation_key=e.conversation.conversationKey,i.header.access_token=e.session.iceServerAccessToken,i.payload={audit_data:t},e.session.sendMessage(i)}}function i(e){function i(){function t(e){return e.getType()===l.STREAMTYPE.AUDIOVIDEO}this.audio={inbound:{bitRate:new y(P,D),rtt:new y(P,D),jitter:new y(P,D),packetLossRate:new y(P,D)},outbound:{bitRate:new y(P,M),rtt:new y(P,M),jitter:new y(P,M),packetLossRate:new y(P,M)}},this.video={inbound:{bitRate:new y(N,D),rtt:new y(N,D),jitter:new y(N,D),packetLossRate:new y(N,D),frameRate:new y(N,D),resolutionWidth:new y(N,D),resolutionHeight:new y(N,D),firsSent:new O(N,D),nacksSent:new O(N,D),plisSent:new O(N,D)},outbound:{bitRate:new y(N,M),rtt:new y(N,M),jitter:new y(N,M),packetLossRate:new y(N,M),frameRate:new y(N,M),resolutionWidth:new y(N,M),resolutionHeight:new y(N,M),firsReceived:new O(N,M),nacksReceived:new O(N,M),plisReceived:new O(N,M)}},this.mos={inbound:{transmission:new y,video:new y(N,D),audio:new y(P,D)},outbound:{transmission:new y,video:new y(N,M),audio:new y(P,M)}},this.calculateInboundVideoMOS=function(){var e,i=this.video.inbound.packetLossRate.value,n=this.video.inbound.frameRate.value;e=void 0!==i&&void 0!==n?t(f.streamInfo)&&n<=f.__frameRateThreshold?l.ExperienceStatus.BAD:l.ExperienceStatus.GOOD:l.ExperienceStatus.NOT_AVAILABLE,this.mos.inbound.video.alarmPut(e,l.ExperienceFactor.VIDEO_INBOUND,{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value})},this.calculateOutboundVideoMOS=function(){var e,i=this.video.outbound.packetLossRate.value,n=this.video.outbound.frameRate.value,o=this.video.outbound.rtt.value;e=void 0!==i&&void 0!==n&&void 0!==o?t(f.streamInfo)&&n<=f.__frameRateThreshold?l.ExperienceStatus.BAD:o>=f.__videoOutboundRttThreshold?l.ExperienceStatus.BAD:l.ExperienceStatus.GOOD:l.ExperienceStatus.NOT_AVAILABLE,this.mos.outbound.video.alarmPut(e,l.ExperienceFactor.VIDEO_OUTBOUND,{packetLossRate:i,frameRate:n,rtt:o})},this.calculateInboundAudioMOS=function(){if(!o.browser.isFirefox){var e,t=this.audio.inbound.jitter.value,i=this.audio.inbound.packetLossRate.value;e=void 0!==t&&void 0!==i?t>=f.__jitterThreshold?l.ExperienceStatus.BAD:l.ExperienceStatus.GOOD:l.ExperienceStatus.NOT_AVAILABLE,this.mos.inbound.audio.alarmPut(e,l.ExperienceFactor.AUDIO_INBOUND,{packetLossRate:i,jitter:t})}},this.calculateOutboundAudioMOS=function(){if(!o.browser.isFirefox){var e,t=this.audio.outbound.jitter.value,i=this.audio.outbound.packetLossRate.value,n=this.audio.outbound.rtt.value;e=void 0!==t&&void 0!==i&&void 0!==n?t>=f.__jitterThreshold?l.ExperienceStatus.BAD:n>=f.__audioOutboundRttThreshold?l.ExperienceStatus.BAD:l.ExperienceStatus.GOOD:l.ExperienceStatus.NOT_AVAILABLE,this.mos.outbound.audio.alarmPut(e,l.ExperienceFactor.AUDIO_OUTBOUND,{packetLossRate:i,jitter:t,rtt:n})}},this.calculateMOS=function(){if(this.calculateInboundVideoMOS(),this.calculateOutboundVideoMOS(),this.calculateInboundAudioMOS(),this.calculateOutboundAudioMOS(),Object.keys(m).length>0);else{var t=[];e.conversation.getParticipants().forEach(function(e){-1===p.indexOf(e)&&t.push.apply(t,e.getStreamInfos())}),t.length>0&&(m={},void 0!==this.mos.inbound.audio.publishedValue&&(m[l.ExperienceFactor.AUDIO_INBOUND]={value:this.mos.inbound.audio.publishedValue,hints:{packetLossRate:this.audio.inbound.packetLossRate.value,jitter:this.audio.inbound.jitter.value}}),void 0!==this.mos.inbound.video.publishedValue&&(m[l.ExperienceFactor.VIDEO_INBOUND]={value:this.mos.inbound.video.publishedValue,hints:{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value}}),void 0!==this.mos.outbound.audio.publishedValue&&(m[l.ExperienceFactor.AUDIO_OUTBOUND]={value:this.mos.outbound.audio.publishedValue,hints:{packetLossRate:this.audio.outbound.packetLossRate.value,jitter:this.audio.outbound.jitter.value,rtt:this.audio.outbound.rtt.value}}),void 0!==this.mos.outbound.video.publishedValue&&(m[l.ExperienceFactor.VIDEO_OUTBOUND]={value:this.mos.outbound.video.publishedValue,hints:{packetLossRate:this.video.outbound.packetLossRate.value,frameRate:this.video.outbound.frameRate.value,rtt:this.video.outbound.rtt.value}}))}p=e.conversation.getParticipants(),m={}},this.cleanProperties=function(){delete this.audio.inbound.packetsReceived,delete this.audio.inbound.packetsLost,delete this.audio.outbound.packetsSent,delete this.audio.outbound.packetsLost,delete this.video.inbound.packetsReceived,delete this.video.inbound.packetsLost,delete this.video.outbound.packetsSent,delete this.video.outbound.packetsLost}}function n(e,t,i){if(void 0!==e&&void 0!==t){var o,s,a=n[i]=n[i]||{lastPacketsLost:void 0,lastPacketsTransmitted:void 0,lastEffectivePacketsTransmitted:void 0,keepCount:999};return o=i.indexOf("audio.")>-1?f.__audioPacketsLostKeepLimit:f.__videoPacketsLostKeepLimit,void 0!==a.lastPacketsLost?e<=a.lastPacketsLost?(a.keepCount=a.keepCount+1,s=a.keepCount<=o?-1:0):(s=a.keepCount<=o?(e-a.lastPacketsLost)/(e-a.lastPacketsLost+(t-a.lastEffectivePacketsTransmitted)):-1,a.lastEffectivePacketsTransmitted=t,a.keepCount=0):s=-1,a.lastPacketsLost=e,a.lastPacketsTransmitted=t,s}}function s(t,i,o){var s=L;if(o&&(s=o),"audio"==t.mediaType){if(t.id.indexOf("_recv")>-1){var a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.audio.inbound.bitRate.put(a),s.audio.inbound.jitter.put(t.googJitterReceived);var r=void 0;if(v&&v[t.id]){var c=t.packetsLost-v[t.id].packetsLost,l=t.packetsReceived-v[t.id].packetsReceived;r=n(t.packetsLost,t.packetsReceived,"audio.inbound")}if(s.audio.inbound.packetsLost=c,s.audio.inbound.packetsReceived=l,s.audio.inbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){var d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;var u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("_send")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.audio.outbound.bitRate.put(a),s.audio.outbound.rtt.put(t.googRtt);r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost;var h=t.packetsSent-v[t.id].packetsSent;r=n(t.packetsLost,t.packetsSent,"audio.outbound")}if(s.audio.outbound.packetsLost=c,s.audio.outbound.packetsSent=h,s.audio.outbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}}else if("video"==t.mediaType)if(t.id.indexOf("_recv")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.video.inbound.bitRate.put(a),s.video.inbound.jitter.put(t.googJitterReceived);r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost,l=t.packetsReceived-v[t.id].packetsReceived;r=n(t.packetsLost,t.packetsReceived,"video.inbound")}if(s.video.inbound.packetsLost=c,s.video.inbound.packetsReceived=l,s.video.inbound.packetLossRate.put(r),s.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),s.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthReceived,"onNewInboundResolution",[t.googFrameWidthReceived,t.googFrameHeightReceived]),s.video.inbound.resolutionHeight.put(t.googFrameHeightReceived),s.video.inbound.firsSent.put(1*t.googFirsSent),s.video.inbound.nacksSent.put(1*t.googNacksSent),s.video.inbound.plisSent.put(1*t.googPlisSent),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("_send")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.video.outbound.bitRate.put(a),s.video.outbound.rtt.put(t.googRtt);r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost,h=t.packetsSent-v[t.id].packetsSent;r=n(t.packetsLost,t.packetsSent,"video.outbound")}if(s.video.outbound.packetsLost=c,s.video.outbound.packetsSent=h,s.video.outbound.packetLossRate.put(r),s.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),s.video.outbound.resolutionWidth.triggerPut(t.googFrameWidthSent,"onNewOutboundResolution",[t.googFrameWidthSent,t.googFrameHeightSent]),s.video.outbound.resolutionHeight.put(t.googFrameHeightSent),s.video.outbound.firsReceived.put(1*t.googFirsReceived),s.video.outbound.nacksReceived.put(1*t.googNacksReceived),s.video.outbound.plisReceived.put(1*t.googPlisReceived),t.transportId&&t.transportId.indexOf("Channel-")>-1){var g;d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}}function a(t,i,o){var s=L;if(o&&(s=o),t.id.indexOf("inbound_rtp_audio")>-1){var a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.audio.inbound.bitRate.put(a),s.audio.inbound.jitter.put(1e3*t.jitter);var r=void 0;if(v&&v[t.id]){var c=t.packetsLost-v[t.id].packetsLost,l=t.packetsReceived-v[t.id].packetsReceived;r=n(t.packetsLost,t.packetsReceived,"audio.inbound")}if(s.audio.inbound.packetsLost=c,s.audio.inbound.packetsReceived=l,s.audio.inbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){var d=i[m=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[m].googRemoteAddress;var u=i[m].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("outbound_rtp_audio")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.audio.outbound.bitRate.put(a),jitter=void 0,i[t.remoteId]&&(jitter=1e3*i[t.remoteId].jitter);r=void 0;if(v&&v[t.id]&&i[t.remoteId]&&v[t.remoteId]){c=i[t.remoteId].packetsLost-v[t.remoteId].packetsLost;var h=i[t.remoteId].packetsReceived-v[t.remoteId].packetsReceived;r=n(i[t.remoteId].packetsLost,i[t.remoteId].packetsReceived,"audio.outbound")}if(s.audio.outbound.packetsLost=c,s.audio.outbound.packetsSent=h,s.audio.outbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[m=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[m].googRemoteAddress;u=i[m].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("inbound_rtp_video")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.video.inbound.bitRate.put(a),s.video.inbound.jitter.put(1e3*t.jitter);r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost,l=t.packetsReceived-v[t.id].packetsReceived;r=n(t.packetsLost,t.packetsReceived,"video.inbound")}s.video.inbound.packetsLost=c,s.video.inbound.packetsReceived=l,s.video.inbound.packetLossRate.put(r);var p=void 0;if(v&&v[t.id]&&(p=(t.framesDecoded-v[t.id].framesDecoded)/(g/1e3)),s.video.inbound.frameRate.triggerPut(p,"onNewInboundFrameRate"),s.video.inbound.firsSent.put(1*t.firCount),s.video.inbound.nacksSent.put(1*t.nackCount),s.video.inbound.plisSent.put(1*t.pliCount),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[m=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[m].googRemoteAddress;u=i[m].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("outbound_rtp_video")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.video.outbound.bitRate.put(a);r=void 0;if(v&&v[t.id]&&i[t.remoteId]&&v[t.remoteId]){c=i[t.remoteId].packetsLost-v[t.remoteId].packetsLost,h=i[t.remoteId].packetsReceived-v[t.remoteId].packetsReceived;r=n(i[t.remoteId].packetsLost,i[t.remoteId].packetsReceived,"video.outbound")}s.video.outbound.packetsLost=c,s.video.outbound.packetsSent=h,s.video.outbound.packetLossRate.put(r);p=void 0;if(v&&v[t.id]&&(p=(t.framesEncoded-v[t.id].framesEncoded)/(g/1e3)),s.video.outbound.frameRate.triggerPut(p,"onNewOutboundFrameRate"),s.video.outbound.firsReceived.put(1*t.firCount),s.video.outbound.nacksReceived.put(1*t.nackCount),s.video.outbound.plisReceived.put(1*t.pliCount),t.transportId&&t.transportId.indexOf("Channel-")>-1){var m;d=i[m=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[m].googRemoteAddress;u=i[m].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if("candidatepair"===t.type&&"succeeded"===t.state&&t.selected){var S=t.localCandidateId;u=i[S].candidateType;e.userIp=i[S].ipAddress,e.url=i[S].ipAddress+":"+i[S].portNumber,e.sessionType=u,e.protocol=x(u)}}function r(t,i,o){var s=L;if(o&&(s=o),t.id.indexOf("RTCInboundRTPAudioStream")>-1){var a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.audio.inbound.bitRate.put(a),s.audio.inbound.jitter.put(1e3*t.jitter);var r=void 0;if(v&&v[t.id]){var c=t.packetsLost-v[t.id].packetsLost,l=t.packetsReceived-v[t.id].packetsReceived;r=n(t.packetsLost,t.packetsReceived,"audio.inbound")}s.audio.inbound.packetsLost=c,s.audio.inbound.packetsReceived=l,s.audio.inbound.packetLossRate.put(r)}else if(t.id.indexOf("RTCOutboundRTPAudioStream")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.audio.outbound.bitRate.put(a),s.audio.outbound.rtt.put(t.googRtt);r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost;var d=t.packetsSent-v[t.id].packetsSent;r=n(t.packetsLost,t.packetsSent,"audio.outbound")}s.audio.outbound.packetsLost=c,s.audio.outbound.packetsSent=d,s.audio.outbound.packetLossRate.put(r)}else if(t.id.indexOf("RTCInboundRTPVideoStream")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesReceived-v[t.id].bytesReceived)),s.video.inbound.bitRate.put(a),s.video.inbound.jitter.put(1e3*t.jitter);r=void 0;if(v&&v[t.id]){c=1*t.packetsLost-1*v[t.id].packetsLost,l=1*t.packetsReceived-1*v[t.id].packetsReceived;r=n(1*t.packetsLost,1*t.packetsReceived,"video.inbound")}s.video.inbound.packetsLost=c,s.video.inbound.packetsReceived=l,s.video.inbound.packetLossRate.put(r),t.googFrameRateInput?s.video.inbound.frameRate.triggerPut(t.googFrameRateInput,"onNewInboundFrameRate"):t.googFrameRateReceived&&s.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),i[u=t.trackId].frameHeight&&i[u].frameWidth&&(s.video.inbound.resolutionWidth.triggerPut(i[u].frameWidth,"onNewInboundResolution",[i[u].frameWidth,i[u].frameHeight]),s.video.inbound.resolutionHeight.put(i[u].frameHeight)),s.video.inbound.firsReceived.put(1*t.firCount),s.video.inbound.nacksReceived.put(1*t.nackCount),s.video.inbound.plisReceived.put(1*t.pliCount)}else if(t.id.indexOf("RTCOutboundRTPVideoStream")>-1){a=void 0;v&&v[t.id]&&(a=8*(t.bytesSent-v[t.id].bytesSent)),s.video.outbound.bitRate.put(a);var u;r=void 0;if(v&&v[t.id]){c=t.packetsLost-v[t.id].packetsLost,d=t.packetsSent-v[t.id].packetsSent;r=n(t.packetsLost,t.packetsSent,"video.outbound")}s.video.outbound.packetsLost=c,s.video.outbound.packetsSent=d,s.video.outbound.packetLossRate.put(r),s.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),i[u=t.trackId].frameHeight&&i[u].frameWidth&&(s.video.outbound.resolutionWidth.triggerPut(i[u].frameWidth,"onNewInboundResolution",[i[u].frameWidth,i[u].frameHeight]),s.video.outbound.resolutionHeight.put(i[u].frameHeight)),s.video.outbound.firsSent.put(1*t.firCount),s.video.outbound.nacksSent.put(1*t.nackCount),s.video.outbound.plisSent.put(1*t.pliCount)}if(t.id.indexOf("RTCIceCandidatePair_")>-1&&(t.transportId.indexOf("audio")>-1?s.audio.outbound.rtt.put(1e3*t.totalRoundTripTime):t.transportId.indexOf("video")>-1&&s.video.outbound.rtt.put(1e3*t.totalRoundTripTime)),t.id.indexOf("RTCIceCandidate_")>-1&&t.type.indexOf("local-candidate")>-1){var h=t.candidateType;e.sessionType=h,e.protocol=x(h)}}function c(t,i){if(t.googFrameRateReceived||t.googFrameRateSent){if(t.googFrameRateReceived||t.googFrameRateSent)if(t.id.indexOf("_recv")>-1){var o=void 0;v&&v[t.id]&&(o=8*(t.bytesReceived-v[t.id].bytesReceived)),factorReports.video.inbound.bitRate.put(o),factorReports.video.inbound.jitter.put(t.googJitterReceived);var s=void 0;if(v&&v[t.id]){var a=1*t.packetsLost-1*v[t.id].packetsLost,r=1*t.packetsReceived-1*v[t.id].packetsReceived;s=n(1*t.packetsLost,1*t.packetsReceived,"video.inbound")}if(factorReports.video.inbound.packetsLost=a,factorReports.video.inbound.packetsReceived=r,factorReports.video.inbound.packetLossRate.put(s),t.googFrameRateInput?factorReports.video.inbound.frameRate.triggerPut(t.googFrameRateInput,"onNewInboundFrameRate"):t.googFrameRateReceived&&factorReports.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),t.googFrameWidthInput&&t.googFrameHeightInput?(factorReports.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthInput,"onNewInboundResolution",[t.googFrameWidthInput,t.googFrameHeightInput]),factorReports.video.inbound.resolutionHeight.put(t.googFrameHeightInput)):t.googFrameWidthReceived&&t.googFrameHeightReceived&&(factorReports.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthReceived,"onNewInboundResolution",[t.googFrameWidthReceived,t.googFrameHeightReceived]),factorReports.video.inbound.resolutionHeight.put(t.googFrameHeightReceived)),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){var c=i[u].googLocalAddress.split(":");e.userIp=c[0],e.url=i[u].googRemoteAddress;var l=i[u].googLocalCandidateType;e.sessionType=l,e.protocol=x(l)}}else if(t.id.indexOf("_send")>-1){o=void 0;v&&v[t.id]&&(o=8*(t.bytesSent-v[t.id].bytesSent)),factorReports.video.outbound.bitRate.put(o),factorReports.video.outbound.rtt.put(t.googRtt);s=void 0;if(v&&v[t.id]){a=t.packetsLost-v[t.id].packetsLost;var d=t.packetsSent-v[t.id].packetsSent;s=n(t.packetsLost,t.packetsSent,"video.outbound")}if(factorReports.video.outbound.packetsLost=a,factorReports.video.outbound.packetsSent=d,factorReports.video.outbound.packetLossRate.put(s),factorReports.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),factorReports.video.outbound.resolutionWidth.triggerPut(t.googFrameWidthSent,"onNewOutboundResolution",[t.googFrameWidthSent,t.googFrameHeightSent]),factorReports.video.outbound.resolutionHeight.put(t.googFrameHeightSent),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){c=i[u].googLocalAddress.split(":");e.userIp=c[0],e.url=i[u].googRemoteAddress;l=i[u].googLocalCandidateType;e.sessionType=l,e.protocol=x(l)}}}else if(t.id.indexOf("_recv")>-1){o=void 0;v&&v[t.id]&&(o=8*(t.bytesReceived-v[t.id].bytesReceived)),factorReports.audio.inbound.bitRate.put(o),factorReports.audio.inbound.jitter.put(t.googJitterReceived);s=void 0;if(v&&v[t.id]){a=t.packetsLost-v[t.id].packetsLost,r=t.packetsReceived-v[t.id].packetsReceived;s=n(t.packetsLost,t.packetsReceived,"audio.inbound")}if(factorReports.audio.inbound.packetsLost=a,factorReports.audio.inbound.packetsReceived=r,factorReports.audio.inbound.packetLossRate.put(s),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){c=i[u].googLocalAddress.split(":");e.userIp=c[0],e.url=i[u].googRemoteAddress;l=i[u].googLocalCandidateType;e.sessionType=l,e.protocol=x(l)}}else if(t.id.indexOf("_send")>-1){o=void 0;v&&v[t.id]&&(o=8*(t.bytesSent-v[t.id].bytesSent)),factorReports.audio.outbound.bitRate.put(o),factorReports.audio.outbound.rtt.put(t.googRtt);var u;s=void 0;if(v&&v[t.id]){a=t.packetsLost-v[t.id].packetsLost,d=t.packetsSent-v[t.id].packetsSent;s=n(t.packetsLost,t.packetsSent,"audio.outbound")}if(factorReports.audio.outbound.packetsLost=a,factorReports.audio.outbound.packetsSent=d,factorReports.audio.outbound.packetLossRate.put(s),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){c=i[u].googLocalAddress.split(":");e.userIp=c[0],e.url=i[u].googRemoteAddress;l=i[u].googLocalCandidateType;e.sessionType=l,e.protocol=x(l)}}}var d="initial",u=null,g=1e3,v=null,p=e.conversation.getParticipants(),m={},S={},f=e.conversation.getLocalParticipant().getStreamInfo(e.avStream.getId()).getQualityMonitor(),_=f.factorMonitors,C=e.callConfig,E=null,R=null,b=null;var T=!1,A=!1,I=!1,y=function(e,t){this.value,this.isVideo=e,this.isInbound=t,this.statistics={peak:0,bottom:0,count:0,sdv:0,mean:0,oldMean:0,S:0,oldS:0}};y.prototype={put:function(e){return void 0===e||isNaN(e)?void(this.value=void 0):e<0?void(this.value=e):(e*=1,this.value=e,this.statistics.count++,1===this.statistics.count?(this.statistics.peak=e,this.statistics.bottom=e):(this.statistics.peak<e&&(this.statistics.peak=e),this.statistics.bottom>e&&(this.statistics.bottom=e)),void(1===this.statistics.count?(this.statistics.oldMean=e,this.statistics.mean=e):(this.statistics.mean=this.statistics.oldMean+(e-this.statistics.oldMean)/this.statistics.count,this.statistics.S=this.statistics.oldS+(e-this.statistics.oldMean)*(e-this.statistics.mean),this.statistics.oldMean=this.statistics.mean,this.statistics.oldS=this.statistics.S,this.statistics.sdv=this.statistics.count>1?Math.sqrt(this.statistics.S/(this.statistics.count-1)):0)))},alarmPut:function(t,i,n,o){void 0===this.publishedValue&&(this.publishedValue=l.ExperienceStatus.NOT_AVAILABLE,this.lastValue=l.ExperienceStatus.NOT_AVAILABLE,this.keepCount=0);var s=this.publishedValue;if(k(this))t!==this.publishedValue&&(t===this.lastValue?(this.keepCount=this.keepCount+1,this.keepCount===f.__keepCount&&(this.publishedValue=t)):this.keepCount=1,!0===o&&(this.publishedValue=t));else{var a=e.callState.state===l.CALLSTATE.UPDATING?e.lastCallConfig:e.callConfig;if(a.audioConfig===C.audioConfig&&a.videoConfig===C.videoConfig)return;this.publishedValue=l.ExperienceStatus.NOT_AVAILABLE,n={},t=l.ExperienceStatus.NOT_AVAILABLE}var r=_[i];s!==this.publishedValue?("function"==typeof r&&r.call(f,this.publishedValue,n),m[i]={value:this.publishedValue,hints:n}):"function"==typeof r&&"function"!=typeof S[i]&&r.call(f,this.publishedValue,n),S[i]=r,this.lastValue=t,this.put(t)},triggerPut:function(e,t,i){var n=e&&Math.floor(e),o=this.value&&Math.floor(this.value),s=f[t];i||(i=[n]),o!==n?"function"==typeof s&&(s.apply(f,i),S[t]=s):"function"==typeof s&&"function"!=typeof S[t]&&(s.call(f,i),S[t]=s),this.put(e)},toJSON:function(){return 0==this.statistics.count?{peak:"N/A",bottom:"N/A",count:"N/A",sdv:"N/A",mean:"N/A"}:{peak:void 0===this.statistics.peak?void 0:this.statistics.peak%1==0?this.statistics.peak:1*this.statistics.peak.toFixed(2),bottom:void 0===this.statistics.bottom?void 0:this.statistics.bottom%1==0?this.statistics.bottom:1*this.statistics.bottom.toFixed(2),count:this.statistics.count,sdv:void 0===this.statistics.sdv?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.sdv.toFixed(2),mean:void 0===this.statistics.mean?void 0:this.statistics.mean%1==0?this.statistics.mean:1*this.statistics.mean.toFixed(2)}}};var O=function(e,t){this.value,this.isVideo=e,this.isInbound=t};O.prototype={put:function(e){this.value=e},toJSON:function(){return this.value}};var k=function(t){var i=e.callConfig;return e.callState.state===l.CALLSTATE.UPDATING&&(i=e.lastCallConfig),t.isInbound&&t.isVideo&&i.shouldReceiveVideo()||t.isInbound&&!t.isVideo&&i.shouldReceiveAudio()||!t.isInbound&&t.isVideo&&i.shouldSendVideo()||!t.isInbound&&!t.isVideo&&i.shouldSendAudio()},L=new i,w=new i,N=!0,P=!1,D=!0,M=!1,x=function(e){var t=void 0;return"local"===e||"host"===e?t=l.PROTOCOL.HOST:"srflx"===e?t=l.PROTOCOL.STUN:"relay"!==e&&"relayed"!==e||(t=l.PROTOCOL.TURN),t},V=0,U=function(n){if(0!==Object.keys(n).length){if(null!=v)try{if(V>=20){var d=e.generateIntermidateAuditData();if(t(e,d),e.avStream&&e.avStream.onQualityMetrics){var u=d.streams[0];e.avStream.onQualityMetrics(u.stream_id,u.data)}w=new i,V=0}else V++;for(var g in n){var p=n[g];o.browser.isChrome?(s(p,n,w),s(p,n)):o.browser.isFirefox?(a(p,n,w),a(p,n)):o.browser.isSafari?(r(p,n,w),r(p,n)):o.browser.isIE&&c(p,n)}L.calculateMOS(),w.calculateMOS(),void 0!==window.__debug_monitor_data_detail__&&!0===window.__debug_monitor_data_detail__&&function e(t,i){e.__headerPrinted||(e.__headerPrinted=!0,h.debug("==audio==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos"),h.debug("==video==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,inbound.frameRate,inbound.resolutionWidth*inbound.resolutionHeight,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,outbound.frameRate,outbound.resolutionWidth*outbound.resolutionHeight,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos")),h.debug("==audio=="+i.audio.inbound.bitRate.value+","+i.audio.inbound.rtt.value+","+i.audio.inbound.packetsReceived+","+i.audio.inbound.packetsLost+","+i.audio.inbound.jitter.value+","+i.audio.inbound.packetLossRate.value+","+i.audio.outbound.bitRate.value+","+i.audio.outbound.rtt.value+","+i.audio.outbound.packetsSent+","+i.audio.outbound.packetsLost+","+i.audio.outbound.jitter.value+","+i.audio.outbound.packetLossRate.value+","+i.mos.inbound.audio.lastValue+","+i.mos.outbound.audio.lastValue+","+i.mos.inbound.audio.publishedValue+","+i.mos.outbound.audio.publishedValue),h.debug("==video=="+i.video.inbound.bitRate.value+","+i.video.inbound.rtt.value+","+i.video.inbound.packetsReceived+","+i.video.inbound.packetsLost+","+i.video.inbound.jitter.value+","+i.video.inbound.packetLossRate.value+","+i.video.inbound.frameRate.value+","+i.video.inbound.resolutionWidth.value+"*"+i.video.inbound.resolutionHeight.value+","+i.video.outbound.bitRate.value+","+i.video.outbound.rtt.value+","+i.video.outbound.packetsSent+","+i.video.outbound.packetsLost+","+i.video.outbound.jitter.value+","+i.video.outbound.packetLossRate.value+","+i.video.outbound.frameRate.value+","+i.video.outbound.resolutionWidth.value+"*"+i.video.outbound.resolutionHeight.value+","+i.mos.inbound.video.lastValue+","+i.mos.outbound.video.lastValue+","+i.mos.inbound.video.publishedValue+","+i.mos.outbound.video.publishedValue),h.debug("==stats==",t)}(n,L)}catch(e){h.debug("Error happens when extractDataFromStats: ",e)}C=e.callState.state===l.CALLSTATE.UPDATING?e.lastCallConfig:e.callConfig,v=n}},B=function(){var t=e.getPeerConnection();null==t||"connected"!==t.iceConnectionState&&"completed"!==t.iceConnectionState||(E=t.iceConnectionState,t.getStats(null).then(function(e){var t={};o.browser.isFirefox||o.browser.isSafari?e.forEach(function(e){t[e.id]=e}):t=e,U(t)}).catch(function(e){h.warn("Error when get statistics.",e)})),null!=t&&"disconnected"===t.iceConnectionState&&"disconnected"!==E&&(E="disconnected",function(){var e=l.ExperienceStatus.NOT_AVAILABLE;o.browser.isFirefox||factorReports.mos.inbound.audio.alarmPut(e,l.ExperienceFactor.AUDIO_INBOUND,{},!0),factorReports.mos.inbound.video.alarmPut(e,l.ExperienceFactor.VIDEO_INBOUND,{},!0),o.browser.isFirefox||factorReports.mos.outbound.audio.alarmPut(e,l.ExperienceFactor.AUDIO_OUTBOUND,{},!0),factorReports.mos.outbound.video.alarmPut(e,l.ExperienceFactor.VIDEO_OUTBOUND,{},!0),mosNotify("*")}())},F=function(){h.debug("getDiagnosticMetricsPeriodically.");var t=e.getPeerConnection();null==t||"connected"!==t.iceConnectionState&&"completed"!==t.iceConnectionState?(h.debug("getDiagnosticMetricsPeriodically... schedule next process for pc.iceConnectionState is: ",null!==t?t.iceConnectionState:"unknown, no peer connection"),R=setTimeout(function(){F()},50)):t.getStats(null).then(function(t){try{for(var i in T||e.getCallConfig().shouldReceiveAudio()||(T=!0),A&&I||e.getCallConfig().shouldReceiveVideo()||(A=!0,I=!0),t){var n=t[i];o.browser.isChrome?"audio"==n.mediaType&&n.id.indexOf("_recv")>-1?(h.debug("audio packetsReceived...",n.packetsReceived),!T&&n.packetsReceived&&n.packetsReceived>1&&(e.session.logEventTimestamp("avFirstAudioPktReceived",n.timestamp.getTime()),T=!0)):"video"==n.mediaType&&n.id.indexOf("_recv")>-1&&(h.debug("video packetsReceived...",n.packetsReceived),!A&&n.packetsReceived&&n.packetsReceived>1&&(e.session.logEventTimestamp("avFirstVideoPktReceived",n.timestamp.getTime()),A=!0),h.debug("framesDecoded...",n.framesDecoded),!I&&n.framesDecoded&&n.framesDecoded>1&&(e.session.logEventTimestamp("avFirstVideoDecoded",n.timestamp.getTime()),I=!0)):o.browser.isFirefox||o.browser.isIE||o.browser.isSafari}}catch(e){h.debug("Error happens when getDiagnosticMetricsPeriodically: ",e)}}).catch(function(e){h.debug("Error when get statistics in getDiagnosticMetricsPeriodically.",e)}).finally(function(){T&&A&&I?(h.debug("getDiagnosticMetricsPeriodically... Done."),q()):(h.debug("getDiagnosticMetricsPeriodically... schedule next process."),R=setTimeout(function(){F()},50))})},q=function(){h.debug("getDiagnosticMetricsPeriodically... stop timers."),clearTimeout(R),clearTimeout(b)};this.getReports=function(){return L.cleanProperties(),e.callConfig.hasAudio()||delete L.audio,e.callConfig.hasVideo()||delete L.video,L},this.getIntermidateReports=function(){return w.cleanProperties(),delete w.mos,e.callConfig.hasAudio()||delete w.audio,e.callConfig.hasVideo()||delete w.video,w},this.start=function(){"running"!==d&&(d="running",o.browser.isChrome&&"audiovideo"==e.streamType&&(F(),h.debug("Start timeout for getDiagnosticMetrics."),b=setTimeout(function(){q()},1e4)),u=setInterval(B,g))},this.stop=function(){d="stopped",clearInterval(u),q()}}function n(e){var t=0,i=function(i){if(i&&(null===e.peerConnection||void 0===e.peerConnection))return h.debug("call.peerConnection: "+e.peerConnection+", the call may need to be updated."),!0;var n=e.getIceConnectionState();return"connected"===n&&t>0&&(h.debug("ICE connection state gets to 'connected', reset the counter to 0."),t=0),t>=3?(h.debug("No more updating. Have updated call to restore ICE failure for "+t+" times."),!1):"failed"===n||i&&"closed"===n},n=function(){var t=e.callState;return t.state===l.CALLSTATE.ESTABLISHED||t.state===l.CALLSTATE.UPDATE_FAILED||t.state===l.CALLSTATE.UPDATED||t.state===l.CALLSTATE.ERROR},o=function(){var o="Call state: "+e.callState.state+", ICE connection state: "+(e.peerConnection?e.getIceConnectionState():"peerConnection is null")+", Retry number: "+(t+1);n()&&i(!0)?(e.resumeState=l.RESUME_STATE.updateCallByIceFailure,t+=1,h.debug("Do call update to fix the ICE failure. "+o),e.update(e.callConfig)):h.debug("No update is needed to fix the ICE failure. "+o)};this.updateIceConnectionState=function(t){t.target===e.peerConnection&&i()&&n()&&(h.debug("Waiting for receiving any message from session web socket... "),function(t){var i=e.session.lastActiveTime,n=function(){i!=e.session.lastActiveTime?(h.debug("Waiting for receiving any message from session web socket... Done"),t()):setTimeout(function(){n()},50)};n()}(function(){var t=e.session.sessionState;if(t===l.SESSIONSTATE.CONNECTED)o();else{h.debug("Session state: "+t+", waiting for session state CONNECTED.");var i=e.session.setSessionState.bind(e.session);e.session.setSessionState=function(t){return t===l.SESSIONSTATE.CONNECTED&&(e.session.setSessionState=i,o()),i(t)}}}))}}var o=e._private=e._private||{},s={},a=o.CallStateMachine,r=o.CallCommonUtils,c=o.rtcHelper,l=o.wscConst,d=o.wscUtils,u=o.DataTransfer,h=e.getLogger(),g=(e.getLogLevel(),new WeakMap),v=function(e,t){"use strict";if(!e){var i="The parameter 'session' cannot be null!";throw h.error(i),i}this.packageType=t||l.PACKAGE.CALL,e.registerPackage(this),this.session=e,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.onIncomingCall=null,this.onResurrect=null};v.prototype={getCalls:function(){"use strict";var e=[],t=this.session.getSubSessionsByPackageType(this.packageType),i=null;if(t){i=t.values();for(var n=0;n<i.length;n++)e[n]=i[n]}return e},createCall:function(e,t,i){"use strict";var n,o,s=this.session,a=this.session.userName;if(null==e||""===e)throw o="The callee cannot be empty!",h.warn(o),"CallPackage.createCall(): Empty callee exception.";return(n=this.prepareCall(s,t,a,e)).subSessionId=s.generateSubSessionId(),n.onCallError=i,n.pkgInstance=this,this.putCall(n.subSessionId,n),n},close:function(){"use strict";for(var e=this.getCalls(),t=0;t<e.length;t++){var i=e[t];i.end(),i=null}},clear:function(){for(var e=this.getCalls(),t=0;t<e.length;t++){var i=e[t];s.clearCall(i),i=null}},onMessage:function(e){"use strict";var t=this.session,i=e.control.subsession_id,n=this.session.getSubSession(i),o=e.getExtHeaders();null==n&&((n=this.prepareCall(t)).pkgInstance=this),o&&(n.lastServerExtHeader=o),n.onMessage(e)},onRehydration:function(t){"use strict";for(var i in t.entry){var n,o=t.entry[i],s=o.caller,a=o.callee,r=o.callConfig,l=new e.CallConfig(r.audioConfig,r.videoConfig,r.dataChannelConfig),d=this.prepareCall(this.session,l,s,a);if(d.pkgInstance=this,d.callState=new e.CallState(o.callState.state,o.callState.status.code,o.callState.status.reason),d.earlyMediaState=o.earlyMediaState,d.subSessionId=o.subSessionId,o.remoteMedias&&o.remoteMedias.length){n=[];for(var u=0;u<o.remoteMedias.length;u++){var h=o.remoteMedias[u],g=new c.Media(h.mode,h.port,h.type);n[u]=g}}d.remoteMedias=n,d.offerAnswerManager.updateState(o.offerAnswerManager.masterState),d.offerAnswerManager.updateState(o.offerAnswerManager.slaveState),d.iceTimeout=o.iceTimeout,d.streamId=o.streamId,d.streamType=o.streamType,d.shortCircuitMode=o.shortCircuitMode,this.putCall(i,d),this.onResurrect(d)}},prepareCall:function(e,t,i,n){"use strict";return new p(e,t,i,n)},putCall:function(e,t){this.session.putSubSession(this.packageType,e,t)},setTrickleIceMode:function(e){this.trickleIceMode=e},setIPv6:function(e){this.ipv6=e},setDSCP:function(e){this.dscp=e},setVideoSendBitrate:function(e){this.videoSendBitrate=e},setVideoRecvBitrate:function(e){this.videoRecvBitrate=e},setRemoveVideoFec:function(e){this.removeVideoFec=e},toJSON:function(){var e={},t={session:""};for(var i in this)i in t||(e[i]=this[i]);return e}};var p=function(t,i,a,d){this.session=t,this.caller=a,this.callee=d,this.callConfig=i,this.dataTransfers=new e.Map,this.lastCallConfig=null,this.callState=new e.CallState(l.CALLSTATE.NONE,null,""),this.earlyMediaState=null,this.resumeState=null,this.peerConnection=null,this.onMediaStreamEvent=null,this.onCallStateChange=null,this.onIceConnectionStateChange=null,this.onDataTransfer=null,this.errorLog=[],this.eventLog=[],this.onUpdate=null,this.onCallError=null,this.streamAddTimes=0,this.hungupCallback=null,this.subSessionId=null,this.conversation=null,this.avStream=null,this.streamId="default",this.streamType="audiovideo",this.shortCircuitMode=!1,this.startReqCorrId=null,this.newRemoteSDP=null,this.newRemoteMedias=null,this.remoteMedias=null,this.localMediaStreams=[],this.temporarySavedStreams=[],this.offerAnswerManager=new o.offerAnswerManager(this),this.userIp=null,this.sessionType=null,this.protocol=null,this.url=null,this.callStartOnIceResponse=!1,this.timeRecording={timeToNewPeerConnection:{},timeToGetUserMedia:{},timeToMakeCall:{},timeToGetIceConnection:{},timeToGetIceCandidates:{},timeToGetRemoteMedia:{}};var u=2e3;this.setIceCheckInterval=function(e){if(e<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};u=e},this.getIceCheckInterval=function(){return u},this.setCapabilityExchange=function(e){this.capabilityExchange=e},this._template={doStartCallRequest:function(e){var t=e.payload.sdp,i=this.parent,n=c.getCallConfigFromRemoteSDP(t,!1),o=c.getCallConfigFromRemoteSDP(t,!0),s=this.parent.callState,a=e.control.subsession_id,l=e.getExtHeaders();i.callConfig=n,i.newRemoteSDP=e.payload,i.newRemoteMedias=c.getMediaFromSDP(t),i.conversation?i.pkgInstance.putCall(a,i.conversation):i.pkgInstance.putCall(a,i),s.is180Ringing()||r.send180Ringing(i);var d=i.pkgInstance.onIncomingCall;d&&(i.conversation?d(i.conversation,i.avStream,o,l):d(i,o,l))},doUpdateCallRequest:function(e){var t=e.payload.sdp,i=this.parent,n=c.getCallConfigFromRemoteSDP(t),o=e.getExtHeaders();i.lastCallConfig=i.callConfig,i.callConfig=n,i.newRemoteMedias=c.getMediaFromSDP(t),i.newRemoteSDP=e.payload,s.handleUpdateCallRequest(i,o)},doStartUnReliableProvRespWithSDP:function(e){s.handleAnswer(this.parent,e.payload)},doStart2XXResponse:function(e){s.handleAnswer(this.parent,e.payload)},doUpdate200Response:function(e){s.handleAnswer(this.parent,e.payload)},doShutdownMessage:function(){s.clearCall(this.parent)},clearCall:function(){s.clearCall(this.parent)},rollbackUpdate:function(){s.rollbackUpdate(this.parent)},doStartCallError:function(){s.clearCall(this.parent)},doStartReliableProvRespWithSDP:function(e){var t=e.payload,i=this.parent;if(t.type="answer",i.offerAnswerManager.getMasterState()===l.OFFER_ANSWER_STATE.OFFER_SENT){c.setRemoteDescription(i,new RTCSessionDescription(t),function(){i.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ANSWER_GOT,t.sdp),i.lastServerCorrelationId=e.control.correlation_id,r.sendPrack(i),i.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ACK_SENT)},s.srdError(i))}},doStartReliableProvRespWithoutSDP:function(e){var t=(e.payload,this.parent);t.lastServerCorrelationId=e.control.correlation_id,r.sendPrack(t)},doStart200RespInEarlyPhase:function(e){var i=this.parent;i.earlyMediaState=null,i.setCallState(l.CALLSTATE.RESPONDED,200,"got success response"),e.complete(t),i.setCallState(l.CALLSTATE.ESTABLISHED,null,"sent complete"),r.checkResumeState(i)},doUpdate200RespInEarlyPhase:function(e){var t=this.parent;s.handleAnswer(t,e.payload),t.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ANSWER_GOT,e.payload.sdp),e.complete(t.session),t.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ACK_SENT),r.checkResumeState(t)},sendOffer:function(){s.sendOfferImpl(this.parent)}},this._template.parent=this;var h={iceFailureHandler:new n(this),statsCollector:null};g.set(this,h)};return p.prototype={start:function(t,i){function n(t){try{o.callConfig.dataChannelConfig&&s.initDataTransfers(o),s.initOfferCtx(o,t,i)}catch(t){h.error("Start exception: "+t),o.onCallError&&c.invokeCallError(o,e.ERRORCODE.PEERCONNECTION_ERROR,t)}}var o=this;if(o.callState.state!==l.CALLSTATE.NONE&&o.resumeState!==l.RESUME_STATE.reStartingCall)throw"The call has already been started";if(i&&(o.extHeaders=i),t&&(o.localMediaStreams=[].concat(t)),this.callStartOnIceResponse||0!==this.session.iceServerListFromServer.length){this.callStartOnIceResponse=!1,this.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.CALL_START);var a=o.callConfig.shouldSendAudio(),r=o.callConfig.shouldSendVideo();a||r?o.localMediaStreams&&o.localMediaStreams.length>0?n(o.localMediaStreams):s.initUserMedia(o,function(e){n([e])},function(e){h.error("Cannot get local stream... ",e),o.fireMediaStreamEvent(l.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null)}):n(o.localMediaStreams)}else h.info("There are no TURN candidates available when starting call"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){o.start(o.localMediaStreams,o.extHeaders)})},getDataTransfer:function(e){return this.dataTransfers.get(e)},getCaller:function(){return this.caller},getCallee:function(){return this.callee},getCallState:function(){return this.callState},getCallConfig:function(){return this.callConfig?new e.CallConfig(this.callConfig.audioConfig,this.callConfig.videoConfig,this.callConfig.dataChannelConfig):null},getPeerConnection:function(){return this.peerConnection},getIceConnectionState:function(){return this.peerConnection?""+this.peerConnection.iceConnectionState:"closed"},canUpdate:function(){return h.debug("canUpdate() - ICE connection state is: "+this.getIceConnectionState()+", call state is: "+this.callState.state),this.callState.state===l.CALLSTATE.ESTABLISHED||this.callState.state===l.CALLSTATE.UPDATE_FAILED||this.callState.state===l.CALLSTATE.UPDATED?"checking"===this.getIceConnectionState()?(h.debug("canUpdate() - Update denied, invalid ICE state: "+this.getIceConnectionState()),!1):(h.debug("canUpdate() - Update allowed"),!0):(h.debug("canUpdate() - Update denied, invalid call state: "+this.callState.state),!1)},toJSON:function(){return{caller:this.caller,callee:this.callee,callConfig:this.callConfig,callState:this.callState,earlyMediaState:this.earlyMediaState,subSessionId:this.subSessionId,remoteMedias:this.remoteMedias,offerAnswerManager:this.offerAnswerManager,iceTimeout:this.iceTimeout,onDataTransfer:this.onDataTransfer,onCallError:this.onCallError,onUpdate:this.onUpdate,onCallStateChange:this.onCallStateChange,onMediaStreamEvent:this.onMediaStreamEvent,streamId:this.streamId,streamType:this.streamType}},setCallState:function(e,n,o){if(!this.callState.isFinalState()){try{if(null!=this.conversation&&e===l.CALLSTATE.ESTABLISHED)null==(s=g.get(this).statsCollector)&&(s=g.get(this).statsCollector=new i(this)).start();else if(null!=this.conversation&&(e===l.CALLSTATE.ENDED||e===l.CALLSTATE.FAILED)){var s;null!=(s=g.get(this).statsCollector)&&s.stop()}}catch(e){h.warn("Error happens when doing peer connection stats collector start/stop: "+e)}r.setCallState(this,e,n,o);try{if(null!=this.conversation&&(e===l.CALLSTATE.ENDED||e===l.CALLSTATE.FAILED)){h.debug("verbose logging is enabled? "+this.session.enableVerbose);var a=this.generateAuditData();if(this.session.__externalAuditData__&&this.conversation.streams.size()<=1){var c=a.externalData||{};c.events=this.session.__externalAuditData__.slice(0),a.externalData=c,this.session.__externalAuditData__.length=0}t(this,a)}}catch(e){h.warn("Error happens when sending audit data to server: "+e)}}},fireMediaStreamEvent:function(e,t){"use strict";if(this.onMediaStreamEvent)try{if(this.lastServerExtHeader){var i=this.lastServerExtHeader;this.onMediaStreamEvent(e,t,i),delete this.lastServerExtHeader}else this.onMediaStreamEvent(e,t)}catch(e){h.warn("The callback function 'Call.onMediaStreamEvent()' exception:"+e)}},mute:function(e){return null===this.peerConnection?(h.error("Cannot get the audio track. failed to mute audio!"),!1):(c.getLocalStreams(this.peerConnection).map(function(t){"undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"audio"===t.track.kind&&(t.track.enabled=!e):t.getAudioTracks().map(function(t){t.enabled=!e})}),!0)},isMuted:function(){return null===this.peerConnection?(h.debug("Cannot get the audio track, assuming not muted"),!1):c.getLocalStreams(this.peerConnection).some(function(e){return"undefined"!=typeof RTCRtpReceiver&&e instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e instanceof RTCRtpSender?e.track&&"audio"===e.track.kind?!1===e.track.enabled:void 0:e.getAudioTracks().some(function(e){return!1===e.enabled})})},getRemoteStreams:function(){return c.getRemoteStreams(this.peerConnection)},decline:function(e,t){"use strict";try{null==e&&(e=l.ERRORCODE.DECLINED),this.callState.state===l.CALLSTATE.UPDATING?(h.debug("Update declined"),this.callConfig=this.lastCallConfig,this.setCallState(l.CALLSTATE.UPDATE_FAILED,e,"Decline")):(h.debug("Call declined"),c.clearPeerConnection(this),this.peerConnection=null,this.session.removeSubSession(this.subSessionId),this.setCallState(l.CALLSTATE.FAILED,e,"Decline")),r.sendReject(this,e,null,t),h.info("decline call.")}catch(e){h.error("answer error: "+e)}},accept:function(t,i,n){"use strict";function o(t){try{s.initAnswerCtx(a,t,n)}catch(t){h.error("Got exception when accept the call: "+t),a.onCallError&&c.invokeCallError(a,e.ERRORCODE.PEERCONNECTION_ERROR,t)}}var a=this;t||(t=this.callConfig);try{if(this.setCallState(l.CALLSTATE.STARTED,null,"receive call"),!s.isValidAnswerCallConfig(this.callConfig,t))throw{name:"InvalidCallConfig",message:"The parameter 'callConfig' is invalid."};if(this.callState.state===l.CALLSTATE.UPDATING&&null!=this.peerConnection)s.onUpdateCall(this,t,i,n);else{t&&(this.callConfig=t);var r=t.shouldSendAudio(),d=t.shouldSendVideo();r||d?i?o(i):s.initUserMedia(a,function(e){o([e])},function(e){h.error("Cannot get local stream... ",e),a.fireMediaStreamEvent(l.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),a.decline()}):o()}h.debug("accept call")}catch(e){throw h.error("answer error: "+e),e}},end:function(e){this.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.CALL_END);var t=r.createMessage(this),i="cancelled";t.header.action=l.ACTION.SHUTDOWN,t.addExtHeaders(e),this.callState.state===l.CALLSTATE.NONE||this.callState.isFinalState()||(this.callState.hasEstablished()?(t.control.correlation_id=this.session.genNewCorrelationId(),i="shutdown"):(t.control.correlation_id=this.startReqCorrId,i="cancelled"),this.session.sendMessage(t)),s.clearCall(this),this.setCallState(l.CALLSTATE.ENDED,"",i)},update:function(e,t,i){this.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.CALL_UPDATE),this.setCallState(l.CALLSTATE.UPDATING,"","update"),s.updateCall(this,e,t,i)},resume:function(e,t){h.info("Begin to resume call");var i=this,n=i.temporarySavedStreams;if(i.resumeSuccessCallback=e,i.resumeFailureCallback=t,i.session.clientIpNotChangedAfterReconnect)return h.debug("Client network was not changed, no further action needed."),void(i.resumeSuccessCallback&&i.resumeSuccessCallback());if(i.resumeState===l.RESUME_STATE.updateCallByIceFailure)return h.debug("The call is under updated by IceFailureHandler, no further action needed."),void(i.resumeSuccessCallback&&i.resumeSuccessCallback());i.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.NETWORK_SWITCHED);var o=i.offerAnswerManager.getMasterState(),s=i.offerAnswerManager.getSlaveState(),a=l.OFFER_ANSWER_STATE;switch(h.debug("The m/s offer-answer states are: "+o+"/"+s),o){case a.INITIAL:switch(s){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n);break;case a.ACK_GOT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n)}break;case a.OFFER_SENT:switch(s){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:case a.ACK_GOT:i.resumeState=l.RESUME_STATE.waittingFinalResp,i.resumeSuccessCallback&&i.resumeSuccessCallback()}break;case a.ANSWER_GOT:switch(s){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:case a.GLARE:case a.ACK_GOT:case a.ANSWER_SENT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n)}break;case a.ACK_SENT:switch(s){case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n);break;case a.INITIAL:case a.OFFER_REJECT:case a.ACK_GOT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n)}break;case a.OFFER_REJECTED:switch(s){case a.OFFER_REJECT:case a.INITIAL:case a.ACK_GOT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n);break;case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=l.RESUME_STATE.reStartingCall,i.start(n)}}},onMessage:function(e){var t=this,i=[];if(this.session.iceServerListFromServer.length>0&&(i=this.session.iceServerListFromServer),h.debug("iceServers="+JSON.stringify(i,null,2)),this.callStartOnIceResponse||0!==i.length)if(e.isEnquiry()){if(!this.capabilityExchange){var n="No CapabilityExchange registered with this call";throw h.error(n),n}this.capabilityExchange.onMessage(e)}else e.isRequest()?a.doRequest(this,e):e.isResponse()?a.doResponse(this,e):e.isMessage()?a.doMessage(this,e):e.isError()?a.doError(this,e):r.doUnexpectedMsg(this,e);else h.info("There are no TURN candidates available on receiving start"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){t.onMessage(e)})},collectClientLog:function(e,t){var i=new Date;t="["+(("0"+(i.getMonth()+1)).slice(-2)+"/"+("0"+i.getDate()).slice(-2)+"/"+i.getFullYear()+" "+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2)+":"+("0"+i.getSeconds()).slice(-2)+"."+("00"+i.getMilliseconds()).slice(-3))+"]"+t,"error"===e?this.errorLog.push(t):"event"===e&&this.eventLog.push(t)},generateIntermidateAuditData:function(){var e={};e.stream_id=this.avStream.getId();var t=g.get(this).statsCollector,i=null==t?{}:t.getIntermidateReports();for(var n in e.data={},i)e.data[n]=i[n];var o={};return o["conversation-id"]=this.conversation.getLocalId(),o.streams=[],o.streams.push(e),o},generateAuditData:function(){var e={};e.stream_id=this.avStream.getId();var t=g.get(this).statsCollector,i=null==t?{}:t.getReports();for(var n in e.data={},i)e.data[n]=i[n];e.data.timeToNewPeerConnection=this.timeRecording.timeToNewPeerConnection.end-this.timeRecording.timeToNewPeerConnection.start,e.data.timeToGetUserMedia=this.timeRecording.timeToGetUserMedia.end-this.timeRecording.timeToGetUserMedia.start,e.data.timeToSetupSignalingChannel=this.session.timeToInitWebSocket,void 0!==this.timeRecording.timeToMakeCall.end&&void 0!==this.timeRecording.timeToMakeCall.start&&(e.data.timeToMakeCall=this.timeRecording.timeToMakeCall.end-this.timeRecording.timeToMakeCall.start),e.data.timeToGetIceCandidates=this.timeRecording.timeToGetIceCandidates.end-this.timeRecording.timeToGetIceCandidates.start,e.data.timeToGetIceCandidates<0&&(e.data.timeToGetIceCandidates=0),e.data.timeToGetIceConnection=this.timeRecording.timeToGetIceConnection.end-this.timeRecording.timeToGetIceConnection.start,e.data.timeToGetIceConnection<0&&(e.data.timeToGetIceConnection=0);var s=this.timeRecording.timeToGetRemoteMedia.end-this.timeRecording.timeToGetIceCandidates.start;s>=0&&(e.data.timeToGetRemoteMedia=s),e.data.errorLog=this.errorLog,e.data.eventLog=this.eventLog,e.data.userId=this.session.userName,e.data.userIp=this.userIp,e.data.sessionId=this.session.sessionId,e.data.sessionType=this.sessionType,e.data.protocol=this.protocol,e.data.url=this.url;var a={};o.browser.isFirefox?a.clientType="firefox":o.browser.isChrome?a.clientType="chrome":o.browser.isEdge?a.clientType="edge":o.browser.isIE?a.clientType="ie":o.browser.isSafari&&(a.clientType="safari"),a.version=o.browser.version,e.data.deviceInformation=a,e.data.participants=this.conversation.__participantsHistory;var r={};return r["conversation-id"]=this.conversation.getLocalId(),r.streams=[],r.streams.push(e),r}},s.sendOffer=function(e,t){e.offerAnswerManager.canSendOffer()?e.peerConnection&&e.peerConnection.localDescription&&e.peerConnection.localDescription.sdp&&s.sendOfferImpl(e,t):h.debug("Cannot send offer")},s.sendOfferImpl=function(e,t){if(e.callState.state===l.CALLSTATE.ENDED||e.callState.state===l.CALLSTATE.FAILED)h.warn("Call has ended while sending offer, clear the call."),s.clearCall(e);else{var i,n=r.createRequest(e),o=e.session.genNewCorrelationId();if(!e.peerConnection)return void h.warn("The peerConnection of the call is null");i=e.peerConnection.localDescription.sdp,n.header.action=l.ACTION.START,n.control.correlation_id=o,n.payload={sdp:i},t?n.addExtHeaders(t):e.extHeaders&&(n.addExtHeaders(e.extHeaders),e.extHeaders=null);e.authInfo&&(n.header.authorization=e.authInfo,!0,e.authInfo=null);try{e.session.sendMessage(n),e.startReqCorrId=n.control.correlation_id,e.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.OFFER_SENT,i),e.callState.state===l.CALLSTATE.NONE&&e.setCallState(l.CALLSTATE.STARTED,null,"start call")}catch(e){}}},s.sendAnswer=function(e,t){if(e.callState.state===l.CALLSTATE.ENDED||e.callState.state===l.CALLSTATE.FAILED)h.warn("Call has ended while sending answer, clear the call."),s.clearCall(e);else if(e&&e.peerConnection&&e.peerConnection.localDescription&&e.peerConnection.localDescription.sdp){var i=r.createResponse(e),n=e.peerConnection.localDescription.sdp,o=e.lastServerCorrelationId;i.control.message_state=l.MESSAGESTATE.FINAL,i.header.action=l.ACTION.START,i.control.correlation_id=o,t&&i.addExtHeaders(t),i.payload={sdp:n},e.session.sendMessage(i),h.debug("Answer is sent...\r\n"+n),e.setCallState(l.CALLSTATE.RESPONDED,200,"sent success response"),e.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ANSWER_SENT,n)}},s.sendAnswerInComplete=function(e,t){var i=e.peerConnection.localDescription.sdp,n=r.createMessage(e);n.header.action=l.ACTION.COMPLETE,n.control.correlation_id=e.startReqCorrId,n.payload={sdp:i},t&&n.addExtHeaders(t),e.session.sendMessage(n),e.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.ACK_SENT,i),e.setCallState(l.CALLSTATE.ESTABLISHED,null,"sent complete")},s.initOfferCtx=function(t,i,n){"use strict";var o=t.peerConnection,a=function(){s.sendOffer(t,n),t.timeRecording.timeToMakeCall.end=(new Date).getTime()};null==t.peerConnection&&(c.createPeerConnection(t,i),o=t.peerConnection),t.callConfig.dataChannelConfig&&s.initDataChannel(t);var r={offerToReceiveAudio:t.callConfig.shouldReceiveAudio()?1:0,offerToReceiveVideo:t.callConfig.shouldReceiveVideo()?1:0};h.debug("Creating offer with constraints ",r),t.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.PEER_CONNECTION_CREATE_OFFER+":"+JSON.stringify(r,null,2)),t.timeRecording.timeToMakeCall.start=(new Date).getTime(),o.createOffer(r).then(function(e){var i=c.changeSdpByCallConfig(e.sdp,t);s.bindIceConnectionStateChangeHandler(t),c.setLocalDescription(t,new RTCSessionDescription({type:"offer",sdp:i}),function(){s.bindIceHandler(t,a,!0)})}).catch(function(i){h.error("Offer error:"+i),c.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i)}),t.peerConnection=o},s.initAnswerCtx=function(t,i,n){"use strict";var o=t.peerConnection;null==t.peerConnection&&(c.createPeerConnection(t,i),o=t.peerConnection),t.callConfig.dataChannelConfig&&s.initReceivedDataChannel(t);var a=t.newRemoteSDP;a.type="offer";var r=new RTCSessionDescription(a);s.bindIceConnectionStateChangeHandler(t),c.setRemoteDescription(t,r,function(){var i=function(){s.sendAnswer(t,n)};t.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.PEER_CONNECTION_CREATE_ANSWER),o.createAnswer().then(function(n){h.debug("Answer SDP",n);var o=c.changeSdpByCallConfig(n.sdp,t);c.setLocalDescription(t,new RTCSessionDescription({type:"answer",sdp:o}),function(){s.bindIceHandler(t,i,!1)},function(i){h.warn("Set localDescription failed!"),c.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)})}).catch(function(i){h.error("Answer error:"+i),c.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i)})},s.srdError(t))},s.clearCall=function(e){"use strict";e&&s.clearDataTransfers(e.dataTransfers);try{c.clearPeerConnection(e),e.peerConnection=null}catch(e){h.error("clear call error: "+e)}var t=e.localMediaStreams;if(t)for(var i=0;i<t.length;i++){var n=t[i];h.debug("Media stream "+i+": used by "+n.peerConnectionNum+" peer connections."),n&&(null==n.peerConnectionNum||n.peerConnectionNum<=0)&&("undefined"!=typeof RTCRtpReceiver&&n instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&n instanceof RTCRtpSender?(n.track&&"video"===n.track.kind&&(h.debug("Stop this media stream: [video tracks: 1, audio tracks: 0]"),n.track.enabled=!1,n.track.stop()),n.track&&"audio"===n.track.kind&&(h.debug("Stop this media stream: [video tracks: 0, audio tracks: 1]"),n.track.enabled=!1,n.track.stop())):(h.debug("Stop this media stream: [video tracks: "+n.getVideoTracks().length+", audio tracks: "+n.getAudioTracks().length+"]"),n.getAudioTracks().forEach(function(e){e.enabled=!1,e.stop()}),n.getVideoTracks().forEach(function(e){e.enabled=!1,e.stop()})))}e.conversation||e.session.removeSubSession(e.subSessionId)},s.clearDataTransfers=function(e){"use strict";if(e&&0!==e.size())for(var t=e.values(),i=0;i<t.length;i++)t[i].clear()},s.rollbackUpdate=function(e){"use strict";if(e&&e.peerConnection){var t=e.peerConnection.remoteDescription;if(t){h.debug("Altering type of remote SDP via reconstruction (in case original object is ready only)");var i=new RTCSessionDescription({type:"answer",sdp:t.sdp});c.setRemoteDescription(e,i)}e.lastCallConfig&&(e.callConfig=e.lastCallConfig)}},s.updateCall=function(e,t,i,n){e.lastCallConfig=e.callConfig,e.callConfig=t;s.bindIceConnectionStateChangeHandler(e),s.doUpdate(e,t,i,function(t,i,n){h.debug("createOffer with media constraints: "+JSON.stringify(n,null,2)),e.peerConnection.createOffer(t,i,n)},function(){},function(){s.bindIceHandler(e,function(){s.sendOffer(e,n)},!0)},!0)},s.closePcForUpdate=function(e,t){for(var i=c.getLocalStreams(e),n=0;n<i.length;n++){var o=i[n];o.peerConnectionNum&&o.peerConnectionNum--}"closed"!==e.signalingState&&e.close()},s.handleMediaStreamForUpdate=function(e,t,i,n){var o=!1,s=!1,a=(e.peerConnection,e.localMediaStreams),r=!1,l=function(t,i,n){for(var o=!1,s=0;s<t.length;s++){h.debug("round the loop: "+s+" s is "+a);var a=t[s];if(a){var r=!1,l=!1;if("undefined"!=typeof RTCRtpReceiver&&a instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&a instanceof RTCRtpSender)a.track&&"audio"===a.track.kind&&(r=!0),a.track&&"video"===a.track.kind&&(l=!0);else{var d=a.getAudioTracks(),u=a.getVideoTracks();r=d&&d.length>0,l=u&&u.length>0}h.debug("hasAudio: "+r),h.debug("hasVideo: "+l),h.debug("handleMediaStreamForUpdate: needAudio="+i+", hasAudio="+r+", needVideo="+n+", hasVideo="+l),i===r&&n===l&&(c.addLocalStream(e,a),o=!0)}}return o};return t&&(r=l(t,i,n)),!r&&a&&(r=l(a,i,n)),i&&!n?o=!r:!i&&n?s=!r:i&&n&&(r||(o=s=!0,t&&(o=!l(t,!0,!1),s=!l(t,!1,!0)),(o||s)&&a&&(o&&(o=!l(a,!0,!1)),s&&(s=!l(a,!1,!0))))),h.debug("handleMediaStreamForUpdate: needNewAudioStream="+o+", needNewVideoStream="+s),{needNewAudioStream:o,needNewVideoStream:s}},s.initUserMedia=function(t,i,n,o){"use strict";o||(o={audio:t.callConfig.shouldSendAudio(),video:t.callConfig.shouldSendVideo()}),h.debug("getUserMedia with media options: "+JSON.stringify(o,null,2));try{var s={};s.start=(new Date).getTime(),t.timeRecording.timeToGetUserMedia=s,navigator.mediaDevices.getUserMedia(o).then(function(e){if(t.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.GET_USER_MEDIA),t.timeRecording.timeToGetUserMedia.end=(new Date).getTime(),t.callState){var n=t.callState.state;if(n===l.CALLSTATE.END||n===l.CALLSTATE.FAILED)return void h.debug("Got media stream, but the call state is failed or end. So do nothing then.")}i(e)}).catch(function(i){if(h.error("Failed to get access to local media. Error name was "+i.name),t.collectClientLog(l.LOGTYPE.ERROR_LOG,l.ERRORLOG.GET_USER_MEDIA_ERROR+":"+i.name+(""===i.message?"":":"+i.message)),t.callState){var o=t.callState.state;if(o===l.CALLSTATE.END||o===l.CALLSTATE.FAILED)return void h.debug("Failed to get access to local media, but the call state is failed or end. So do nothing then.")}c.invokeCallError(t,e.ERRORCODE.GET_USER_MEDIA_ERROR,i.name+": "+i.message),n&&n(i)})}catch(e){throw h.error("The callConfig is invalid, cause initialize user media exception:"+e),e}},s.handleUpdateCallRequest=function(e,t){"use strict";var i=e.offerAnswerManager.getLatestActiveRemoteSdp();h.debug("The latest active remote SDP is: "+i),h.debug("The latest active remote medias is: "+e.remoteMedias),c.isMediaChanged(e.newRemoteMedias,e.remoteMedias)?(e.setCallState(l.CALLSTATE.UPDATING,null,"onUpdate"),e.onUpdate?e.onUpdate(e.callConfig,t):h.warn("No callback for update call request")):null==e.peerConnection||null==e.peerConnection.localDescription?(h.info("Client is not ready. Reject incoming call."),r.sendReject(e)):(c.createNewPeerConnection(e),e.offerAnswerManager.reset(),e.offerAnswerManager.updateState(l.OFFER_ANSWER_STATE.OFFER_GOT,e.newRemoteSDP.sdp),s.initAnswerCtx(e))},s.handleAnswer=function(e,t){"use strict";if(t.type="answer",e.peerConnection&&t.sdp){c.setRemoteDescription(e,new RTCSessionDescription(t),function(){e&&e.peerConnection&&e.peerConnection.remoteDescription})}},s.onUpdateCall=function(e,t,i,n){s.bindIceConnectionStateChangeHandler(e),s.doUpdate(e,t,i,function(t,i,n){var o=new RTCSessionDescription({type:"offer",sdp:e.newRemoteSDP.sdp});c.setRemoteDescription(e,o,function(){h.debug("[UPDATE] offer is set as remote description...\r\n"+e.newRemoteSDP.sdp),e.peerConnection.createAnswer().then(t).catch(function(t){i(t),e.decline()})},s.srdError(e))},function(){e.decline()},function(){s.bindIceHandler(e,function(){s.sendAnswer(e,n)},!1)},!1)},s.doUpdate=function(t,i,n,o,a,r,d){"use strict";var u=i,g=!1,v=!1,p=!1,m=!1,S=t.peerConnection;s.rollbackUpdate=function(e){var t=e.peerConnection;e.peerConnection=S,s.closePcForUpdate(t,e),e.lastCallConfig&&(e.callConfig=e.lastCallConfig)};var f=t.temporarySavedStreams;t.temporarySavedStreams=[],c.createPeerConnection(t),t.callConfig.dataChannelConfig&&(d?(s.initDataTransfers(t),s.initDataChannel(t)):s.initReceivedDataChannel(t)),t.temporarySavedStreams=f,u.audioConfig!==l.MEDIADIRECTION.NONE&&(g=!0),u.videoConfig!==l.MEDIADIRECTION.NONE&&(v=!0),u.audioConfig!==l.MEDIADIRECTION.RECVONLY&&u.audioConfig!==l.MEDIADIRECTION.SENDRECV||(p=!0),u.videoConfig!==l.MEDIADIRECTION.RECVONLY&&u.videoConfig!==l.MEDIADIRECTION.SENDRECV||(m=!0),h.debug("doUpdate: needAudioStream="+g+", needVideoStream="+v),h.debug("doUpdate: receiveAudio="+p+", receiveVideo="+m);var _=t.peerConnection,C=_.signalingHandlerForUpdate;_.signalingHandlerForUpdate=function(e){h.debug("signalingState : ",_.signalingState),"stable"===_.signalingState&&(s.closePcForUpdate(S,t),h.debug("Upgrade: the old peer connection is closed.",S),_.signalingHandlerForUpdate=C)};var E=s.handleMediaStreamForUpdate(t,n,g,v),R=function(){if(!t.peerConnection)throw h.error("Peer connection of the call is null."),{name:"Error",message:"Peer connection of the call is null."};o(function(e){t.callConfig=u;var i=c.changeSdpByCallConfig(e.sdp,t);e=new RTCSessionDescription({type:e.type,sdp:i}),h.debug("Updating call: "+e.type+" created... "+e.sdp),c.setLocalDescription(t,e,r)},function(i){h.error("Browser failed to create sdp! The error is: ",i),t.collectClientLog(l.LOGTYPE.ERROR_LOG,l.ERRORLOG.GENERATE_SDP_ERROR),t.setCallState(l.CALLSTATE.UPDATE_FAILED,e.ERRORCODE.PEERCONNECTION_ERROR,i),c.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i),s.rollbackUpdate(t)},{OfferToReceiveAudio:p?1:0,OfferToReceiveVideo:m?1:0})};if(E.needNewAudioStream||E.needNewVideoStream){var b={audio:E.needNewAudioStream,video:E.needNewVideoStream};s.initUserMedia(t,function(i){var n=e.getLogLevel();n===l.LOGLEVEL.DEBUG?h.debug("[UPDATE] got local stream..."+i):n<=l.LOGLEVEL.INFO&&h.info("[UPDATE] got local stream..."),c.addLocalStream(t,i),R()},function(e){h.error("[Update] Cannot get local stream... ",e),t.fireMediaStreamEvent(l.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),a&&a(),s.rollbackUpdate(t)},b)}else R()},s.initDataTransfers=function(e){var t,i=e.callConfig.dataChannelConfig,n=i.length;if(0!==n)for(t=0;t<n;t++){var o=i[t],s=e.dataTransfers.get(o.label);s||(s=new u,e.dataTransfers.put(o.label,s));try{e.onDataTransfer?e.onDataTransfer(s):h.warn("The onDataTransfer() callback function is not set when starting.")}catch(e){h.warn("The callback function 'Call.onDataTransfer()' encountered an exception: "+e)}}},s.initDataChannel=function(e){var t,i=e.peerConnection,n=e.callConfig.dataChannelConfig,o=n.length;if(0!==o)for(t=0;t<o;t++){var s=n[t],a=JSON.parse(JSON.stringify(s));for(var r in delete a.label,a)a.hasOwnProperty(r)&&-1===a[r]&&delete a[r];var c=i.createDataChannel(s.label,a);e.dataTransfers.get(s.label).initDataChannel(c,e.callState.state==l.CALLSTATE.UPDATING)}h.debug("DataChannel is initiated")},s.initReceivedDataChannel=function(e){e.peerConnection.ondatachannel=function(t){h.debug("Data channel is received"),e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_DATA_CHANNEL+":"+t.channel.label);for(var i=t.channel.label,n=!1,o=0;o<e.callConfig.dataChannelConfig.length;o++)i===e.callConfig.dataChannelConfig[o]&&(n=!0);n||e.callConfig.dataChannelConfig.push({label:i,ordered:t.channel.ordered,maxPacketLifeTime:t.channel.maxPacketLifeTime,maxRetransmits:t.channel.maxRetransmits,protocol:t.channel.protocol,negotiated:t.channel.negotiated,id:t.channel.id});var s=e.getDataTransfer(i);s?h.debug("Data channel is updating."):(s=new u,h.debug("The dataTransfer object with label "+i+" is created"),e.dataTransfers.put(i,s));var a=t.channel;s.initDataChannel(a,!1);try{e.onDataTransfer?e.onDataTransfer(s):h.warn("The onDataTransfer() callback function is not set.")}catch(e){h.warn("The callback function 'Call.onDataTransfer()' exception: "+e)}e.session.saveToStorage()}},s.bindIceHandler=function(e,t,i){function n(){g.onicecandidate=a}function o(){e.peerConnection.onicecandidate=s,t()}function s(t){e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(t.candidate));var i=t.candidate;i?(h.debug("handleNewIceCandidate: candidate- "+JSON.stringify(i)),function(t){var i,n,o=e.offerAnswerManager.trickledCandidatesMap;if(t.sdpMid)i="a=mid:"+t.sdpMid+"\r\n";else{if(null==t.sdpMLineIndex)return void h.warn("ICE Candidate is invalid, ignore it!");var s=e.offerAnswerManager.getLatestActiveLocalSdp();if(s){var a=c.getMediaFromSDP(s);if(a.length>0){var l=a[t.sdpMLineIndex];i=l.mid+"\r\n"}}}t.candidate&&(n=t.candidate),function(){var e=o.get(i);n?e?e.push(n):((e=[]).push(n),o.put(i,e)):h.warn("sdpCandidate is not valid; not adding to candidatesArray")}(),e.offerAnswerManager.canSendOffer()&&r.sendTrickledCandidates(e)}(i)):(e.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),h.debug("handleNewIceCandidate: got 'end of candidates' event."),function(){for(var t=e.offerAnswerManager.trickledCandidatesMap,i=t.keys();i.length>0;){var n=i.shift(),o=t.get(n);o.push("end-of-candidates")}e.offerAnswerManager.canSendOffer()&&r.sendTrickledCandidates(e)}())}function a(i){e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(i.candidate));var n=i.candidate;h.debug("ICE gathering state: "+g.iceGatheringState),n?h.debug("handleEndOfCandidate: candidate- "+JSON.stringify(n)):(e.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),h.debug("handleEndOfCandidate: got 'end of candidates' event."),t(),g&&(g.onicecandidate=d))}function d(t){e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(t.candidate)),t.candidate?h.debug("logIceCandidates : candidate- "+JSON.stringify(t.candidate)):h.debug("logIceCandidates : end of candidates.")}function u(e){return e.search("a=ice-options:.*trickle")>-1?(h.debug("SDP supports trickle ICE"),!0):(h.debug("SDP does NOT support trickle ICE"),!1)}var g=(e.offerAnswerManager,e.peerConnection);if(!g)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};switch(h.debug("Bind ICE handler with trickle ICE mode: "+e.pkgInstance.trickleIceMode),e.pkgInstance.trickleIceMode){case"off":n();break;case"half":i?n():u(e.newRemoteSDP.sdp)?o():n();break;case"full":i||u(e.newRemoteSDP.sdp)?o():n();break;default:n()}g.onsignalingstatechange=function(t){var i=g.signalingHandlerForUpdate;"function"==typeof i&&i(t),e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_SIGNALING_STATE_CHANGE+":"+t.target.signalingState)},g.onnegotiationneeded=function(t){e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_NEGOTIATION_NEEDED+":"+t.target.signalingState)},g.onicegatheringstatechange=function(t){e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_ICE_GATHERING_STATE_CHANGE+":"+t.target.iceGatheringState),function(e){h.debug("ICE gathering state: "+e.target.iceGatheringState)}(t)}},s.bindIceConnectionStateChangeHandler=function(e){var t=e.peerConnection;if(!t)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};t.oniceconnectionstatechange=function(t){if(e.collectClientLog(l.LOGTYPE.EVENT_LOG,l.EVENTLOG.ON_ICE_CONNECTION_STATE_CHANGE+":"+t.target.iceConnectionState),"failed"===t.target.iceConnectionState){e.collectClientLog(l.LOGTYPE.ERROR_LOG,l.ERRORLOG.ICE_CONNECTION_ERROR+": To "+e.callee);var n=e.onCallError;if(n)n(new d.ErrorInfo(l.ERRORCODE.ICE_CONNECTION_ERROR,"ICE connection state gets failed"))}else if("new"===t.target.iceConnectionState||"checking"===t.target.iceConnectionState)e.timeRecording.timeToGetIceConnection.start=(new Date).getTime();else if("connected"===t.target.iceConnectionState){e.timeRecording.timeToGetIceConnection.end=(new Date).getTime();var o=g.get(e).statsCollector;null==o&&(o=g.get(e).statsCollector=new i(e)).start()}else t.target.iceConnectionState;(function(t){h.debug("ICE connection state: "+t.target.iceConnectionState),e.onIceConnectionStateChange&&e.onIceConnectionStateChange(t.target.iceConnectionState)})(t),e.getCallState().isFinalState()||g.get(e).iceFailureHandler.updateIceConnectionState(t)}},s.isValidAnswerCallConfig=function(e,t){var i={sendrecv:6,sendonly:4,recvonly:2,inactive:1,none:1},n=t.audioConfig,o=t.videoConfig,s=e.audioConfig,a=e.videoConfig,r=!1,c=!1;return h.debug("Old audio = "+s+", video = "+a),h.debug("New audio = "+n+", video = "+o),h.debug("Audio direction values: newAudio="+i[n]+", oldAudio="+i[s]+", newAudio <= oldAudio: "+(i[n]<=i[s])),h.debug("Video direction values: newVideo="+i[o]+", oldVideo="+i[a]+", newVideo <= oldVideo: "+(i[o]<=i[a])),s===l.MEDIADIRECTION.SENDONLY||s===l.MEDIADIRECTION.RECVONLY||s===l.MEDIADIRECTION.NONE?s!==n&&n!==l.MEDIADIRECTION.NONE||(r=!0):i[n]<=i[s]&&(r=!0),a===l.MEDIADIRECTION.SENDONLY||a===l.MEDIADIRECTION.RECVONLY||a===l.MEDIADIRECTION.NONE?a!==o&&o!==l.MEDIADIRECTION.NONE||(c=!0):i[o]<=i[a]&&(c=!0),h.debug("isValidAudio="+r+", isValidVideo="+c),!0},s.srdError=function(t){return function(i){h.warn("Error when set remote description: "+i),t.collectClientLog(l.LOGTYPE.ERROR_LOG,l.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+i),c.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)}},o.CallPackageHelper=s,e.Call=p,e.CallPackage=v,console.log("wsc-call initialized."),e}(live||{}),live=function(e){"use strict";var t=e._private=e._private||{},i=t.CallPackageHelper,n=t.wscConst,o=t.wscUtils,s=t.rtcHelper,a=e.getLogger(),r={};e.timeoutIfEocNotHappen=1e3;var c=function(t,i,n,o){a.debug("Creating connection for user: '"+t+"' with uri: "+i),this.localParticipantUri=t,this.webSocketUri=i,this.onConnectionSuccess=n,this.onConnectionError=o,this.connectionId=null,this.refresh=!1,this.extHeaders=null,this.extPayloads=null,this.stateInfo=null,this.withConnectionId=function(e){return this.connectionId=e,this.refresh=!!e,this},this.withEarlyCallbacks=function(e,t){return this.onConnectionStateChange=e,this.onAuthRefresh=t,this},this.withExtHeaders=function(e){return this.extHeaders=e,this},this.withExtPayloads=function(e){return this.extPayloads=e,this},this.withStateInfo=function(e){return this.stateInfo=e,this},this.start=function(){a.debug("Starting connection to URI = "+this.webSocketUri+", ID = "+this.connectionId),this.connectionId&&null===sessionStorage.getItem(this.connectionId)&&(a.info("Warning: No stored session found for id: "+this.connectionId),this.connectionId=null,this.refresh=!1),this.session=new e.Session(this.localParticipantUri,this.webSocketUri,this.onConnectionSuccess,this.onConnectionError,this.connectionId,this.extHeaders,this.extPayloads,this.stateInfo),a.debug("Session created with id: "+this.session.sessionId),this.session.onSessionStateChange=this.onConnectionStateChange,this.package=new e.ConversationPackage(this.session,null),this.authHandler=new e.AuthHandler(this.session),this.authHandler.refresh=this.onAuthRefresh;var t=function(e,t){e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}("jwt",this.webSocketUri);if(t){a.debug("JWT token: ",t);var i=t.split(".")[1];if(i){var n=i.replace("-","+").replace("_","/");if(n){var o=JSON.parse(atob(n));o&&(a.debug("Parsed JWT:"+JSON.stringify(o,null,2)),a.debug("Found username in JWT: "+o.username),o.username&&(this.package.clientId=o.username))}}}return this}};c.prototype={getLocalParticipantUri:function(){return this.session.userName},getConnectionId:function(){return this.session.sessionId},close:function(){this.session.close()},setTrickleIceMode:function(e){this.package.setTrickleIceMode(e)},setIPv6:function(e){this.package.setIPv6(e)},setShortCircuit:function(e){this.package.setShortCircuit(e)},setDSCP:function(e){this.package.setDSCP(e)},setVideoSendBitrate:function(e){this.package.setVideoSendBitrate(e)},setVideoRecvBitrate:function(e){this.package.setVideoRecvBitrate(e)},setRemoveVideoFec:function(e){this.package.setRemoveVideoFec(e)},setIntervals:function(e,t,i,n){e&&e>0&&this.session.setBusyPingInterval(e),t&&e>0&&this.session.setIdlePingInterval(t),i&&i>0&&this.session.setReconnectInterval(i),n&&n>=0&&(this.session.retryCount=n)},setPingPongMessages:function(e,t){this.session.setPingPongMessages(e,t)},updateWebSocketUri:function(e){a.debug("updateWebSocketUri: "+e),this.webSocketUri=e,this.session&&(this.session.webSocketUri=e)},isRefresh:function(){return this.refresh},initCallbacks:function(e,t,i){this.package.initCallbacks(e,t),i&&(this.onConnectionStateChange=i,this.session.onSessionStateChange=this.onConnectionStateChange)},makeConversation:function(){return this.package.createConversation(null,null,null,null)},getConversations:function(){return this.package.getConversations()},hibernate:function(e,t,i){this.session.hibernate(e,t,i)},getNetworkStatus:function(e,t){this.session.getNetworkStatus(e,t)},subscribeToEntity:function(e,t,i,n){return this.session.subscribeToEntity(e,t,i,n)},unsubscribeFromEntity:function(e){this.session.unsubscribeFromEntity(e)},logEventTimestamp:function(e){r.logEventTimestamp(this.session,e)},setAuditDataModule:function(e){this.session.__auditDataModule__=e}};var l=function(e,t){if(!e){var i="The parameter 'session' cannot be null!";throw a.error(i),i}this.packageType=t||n.PACKAGE.CONVERSATION,e.registerPackage(this),this.session=e,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.shortCircuitMode=!1,this.onIncoming=null,this.onResurrect=null,this.getConversations=function(){var e=[],t=this.session.getSubSessionsByPackageType(this.packageType),i=null;if(t){i=t.values();for(var n=0;n<i.length;n++)e[n]=i[n]}return e},this.encodeConversationTopic=function(e){return e?((e=e.replace(/[\W]+/g,"_")).indexOf("@")<0&&(e+="@conversation.topic"),e):null}};l.prototype={initCallbacks:function(e,t){this.onIncoming=e,this.onResurrect=t},createConversation:function(e,t,i,n){i||(i="video");var o=this.prepareConversation(e,this.encodeConversationTopic(t),this.session,this.session.userName,i),s=o.localAddParticipant(this.session.userName);return n&&s.localAddStreamInfo(null,null,n,null),o.subSessionId=this.session.generateSubSessionId(),this.putConversation(o.subSessionId,o),e&&(a.debug("Conversation Key provided ("+e+") - joining existing conversation"),o.joiningConversation=!0),this.shortCircuitMode&&(a.debug("Enabling short-circuit communication in conversation"),o.withShortCircuit()),o},clear:function(){var e,t=this.session.getSubSessionsByPackageType(this.packageType).values();for(e=0;e<t.length;e++){for(var n=t[e],o=n.streams.values(),s=0;s<o.length;s++)i.clearCall(o[s].call);n=null}},remove:function(e){var t=this,i=e.subSessionId;e.removed||(e.removed=!0,setTimeout(function(){a.debug("Removing conversation: "+i),t.session.removeSubSession(i)},1e3))},onMessage:function(e){var t=this.session,i=e.control.subsession_id,o=e.header.stream_id,r=e.header.stream_type,c=this.session.getSubSession(i);if(e.isRequest()&&"start"===e.header.action){var l=e.payload.sdp,d=s.getCallConfigFromRemoteSDP(l,!1);if(null===c){var u="video";d&&(u=d.getChannelType()),(c=this.prepareConversation(e.header.conversation_key,e.header.conversation_topic,t,e.header.initiator,u)).subSessionId=i,c.joiningConversation=!0,c.localAddParticipant(t.userName),this.putConversation(c.subSessionId,c),a.debug("Have incoming conversation from: "+e.header.initiator,c)}else a.debug("Have incoming start request from: "+e.header.initiator,c);c&&!c.getStreamForId(o)&&(a.debug("No existing stream for the stream id: "+o+", type: "+r),r===n.STREAMTYPE.SCREENSHARE?c.createScreenShareStream(o):c.createAudioVideoStream(d,o))}c?c.onMessage(e):a.info("Ignoring "+e.control.type+" with action: '"+e.header.action+"' for unknown conversation: "+i)},onRehydration:function(t){function i(t,i){var n,o=t.call,a=i.call;if(o.callState=new e.CallState(a.callState.state,a.callState.status.code,a.callState.status.reason,a.callState.streamId),o.earlyMediaState=a.earlyMediaState,a.remoteMedias&&a.remoteMedias.length){n=[];for(var r=0;r<a.remoteMedias.length;r++){var c=a.remoteMedias[r];n[r]=new s.Media(c.mode,c.port,c.type)}}o.remoteMedias=n,o.offerAnswerManager.updateState(a.offerAnswerManager.masterState),o.offerAnswerManager.updateState(a.offerAnswerManager.slaveState),o.iceTimeout=a.iceTimeout,o.onCallError=a.onCallError,o.onUpdate=a.onUpdate,o.onCallStateChange=a.onCallStateChange,o.onMediaStreamEvent=a.onMediaStreamEvent,o.onIceConnectionStateChange=a.onIceConnectionStateChange}for(var o in t.entry)if(t.entry.hasOwnProperty(o)){var r=t.entry[o];a.debug("onRehydration invoked for conversation: "+r.subSessionId);var c=this.prepareConversation(r.conversationKey,r.conversationTopic,this.session,r.initiator,r.conversationChannel);if(c.joiningConversation=r.joiningConversation,c.shortCircuitMode=r.shortCircuitMode,c.onRecordingStatusChange=r.onRecordingStatusChange,c.onParticipantChange=r.onParticipantChange,c.onError=r.onError,c.onEnquiryResponse=r.onEnquiryResponse,c.subSessionId=r.subSessionId,c.recording=r.recording,c.recordingRules=r.recordingRules,c.alwaysRecordOnCreation=r.alwaysRecordOnCreation,c.neverRecordOnCreation=r.neverRecordOnCreation,c.sentAutomaticRecordingRequest=r.sentAutomaticRecordingRequest,c.recordingStyle=r.recordingStyle,c.lastRemovedParticipant=r.lastRemovedParticipant,c.pendingTargetURI=r.pendingTargetURI,c.pendingTargetStreamId=r.pendingTargetStreamId,c.pendingTargetStreamOptions=r.pendingTargetStreamOptions,c.pendingTargetStreamProfile=r.pendingTargetStreamProfile,c.webContext=r.webContext,c.pendingAVStreams=r.pendingAVStreams,c.iceCheckInterval=r.iceCheckInterval,c.pendingAddStreamRelay=r.pendingAddStreamRelay,c.sidebarId=r.sidebarId,c.clientId=r.clientId,c.clientVersion=r.clientVersion,c.postCallRating=r.postCallRating,c.participants=new e.Map,r.participants){var l=[];for(var d in r.participants.entry)r.participants.entry.hasOwnProperty(d)&&l.push(r.participants.entry[d]);for(var u=0;u<l.length;u++){var h=l[u],v=new e.Participant(c,h.uri);if(v.onParticipantStateChange=h.onParticipantStateChange,v.onAddStream=h.onAddStream,v.onAddRemoteStream=h.onAddRemoteStream,h.uri!==this.session.userName){var p=[];for(var m in h.streams.entry)h.streams.entry.hasOwnProperty(m)&&p.push(h.streams.entry[m]);for(var S=0;S<p.length;S++){var f=g.createStreamOptions(p[S].streamOptions.audioConfig,p[S].streamOptions.videoConfig),_=v.localAddStreamInfo(p[S].streamId,p[S].streamType,f,p[S].streamProfile);_.recording=p[S].recording,_.streamLayout=p[S].streamLayout,_.active=p[S].active}}c.participants.put(h.uri,v)}}if(c.streams=new e.Map,r.streams){var C=[];for(var E in r.streams.entry)r.streams.entry.hasOwnProperty(E)&&C.push(r.streams.entry[E]);for(var R=0;R<C.length;R++){var b,T=C[R];if(T.call.streamType===n.STREAMTYPE.AUDIOVIDEO){var A=g.createStreamOptions(T.call.callConfig.audioConfig,T.call.callConfig.videoConfig);b=c.createAudioVideoStream(A,T.streamId,T.streamInfo.streamProfile)}else{var I=g.createStreamOptions(T.call.callConfig.audioConfig,T.call.callConfig.videoConfig);b=c.createScreenShareStream(T.streamId,I,T.streamInfo.streamProfile)}i(b,T),b.localMediaStreams=T.localMediaStreams,b.extHeaders=T.extHeaders,b.onPauseResumeStream=T.onPauseResumeStream,b.onUpdateStreamOptions=T.onUpdateStreamOptions,b.streamInfo.recording=T.streamInfo.recording,b.streamInfo.streamLayout=T.streamInfo.streamLayout,b.streamInfo.active=T.streamInfo.active,a.debug("Rehydrated stream: "+JSON.stringify(b,null,2))}}if(c.relays=new e.Map,r.relays){var y=[];for(var O in r.relays.entry)r.relays.entry.hasOwnProperty(O)&&y.push(r.relays.entry[O]);for(var k=0;k<y.length;k++){var L=y[k];"string"!=typeof L.relayDest&&(L.relayDest=c.getParticipant(L.relayDest.uri).getStreamInfo(L.relayDest.streamId));var w=new e.Relay(c,L.streamId,L.relayDest,L.relayId);w.responseHandler=L.responseHandler,w.retryHandler=L.retryHandler,w.timeoutHandler=L.timeoutHandler,w.errorHandler=L.errorHandler,w.retries=L.retries,w.timeout=L.timeout,w.timer=L.timer,w.startTime=L.startTime;var N=[];for(var P in L.relayMessages.entry)L.relayMessages.entry.hasOwnProperty(P)&&N.push(L.relayMessages.entry[P]);for(var D=0;D<N.length;D++){var M=new e.RelayMessage(w,N[D].messageType,N[D].messageId);M.responseHandler=N[D].responseHandler,M.retryHandler=N[D].retryHandler,M.timeoutHandler=N[D].timeoutHandler,M.errorHandler=N[D].errorHandler,M.retries=N[D].retries,M.retryCount=N[D].retryCount,M.timeout=N[D].timeout,M.final=N[D].final,M.relayDestinations=N[D].relayDestinations,M.gotRelayResponses=N[D].gotRelayResponses,M.gotAllResponses=N[D].gotAllResponses,M.timestamp=N[D].timestamp,M.message=N[D].message,M.text=N[D].text,M.data=N[D].data,M.commands=N[D].commands,w.relayMessages.put(M.messageId,M)}c.relays.put(w.relayId,w)}}this.putConversation(o,c),a.debug("Completed rehydration of conversation: "+o),this.onResurrect?(a.debug("Conversation has been rehydrated - calling onResurrect"),this.onResurrect(c)):a.debug("onResurrect is not set")}},prepareConversation:function(t,i,o,s,a){var r=new e.Conversation(t,i,o,s,a),c=new Date;return r.startTime=""+c.getHours()+c.getMinutes()+c.getSeconds()+c.getMilliseconds(),r.callPackage=o.getPackage(n.PACKAGE.CALL),r.callPackage||(r.callPackage=new e.CallPackage(o)),r.callPackage.packageType=this.packageType,r.callPackage.setTrickleIceMode(this.trickleIceMode),r.callPackage.setIPv6(this.ipv6),r.callPackage.setDSCP(this.dscp),r.callPackage.setVideoSendBitrate(this.videoSendBitrate),r.callPackage.setVideoRecvBitrate(this.videoRecvBitrate),r.callPackage.setRemoveVideoFec(this.removeVideoFec),r.callPackage.onIncomingCall=this.onIncoming,r.callPackage.onResurrect=this.onResurrect,r.pkgInstance=this,r.clientId=this.clientId,r},putConversation:function(e,t){this.session.putSubSession(this.packageType,e,t)},setTrickleIceMode:function(e){this.trickleIceMode=e},setIPv6:function(e){this.ipv6=e},setDSCP:function(e){this.dscp=e},setVideoSendBitrate:function(e){this.videoSendBitrate=e},setVideoRecvBitrate:function(e){this.videoRecvBitrate=e},setRemoveVideoFec:function(e){this.removeVideoFec=e},setShortCircuit:function(e){this.shortCircuitMode=e},toJSON:function(){var e={},t={session:""};for(var i in this)this.hasOwnProperty(i)&&(i in t||(e[i]=this[i]));return e}};var d=function(t,i,o,s,c){this.conversationKey=t,this.conversationTopic=i,this.session=o,this.initiator=s,this.conversationChannel=c,this.joiningConversation=!1,this.pkgInstance=null,this.callPackage=null,this.streams=new e.Map,this.relays=new e.Map,this.startTime="",this.__participantsHistory=[],this.onRecordingStatusChange=null,this.onParticipantChange=null,this.onError=null,this.onEnquiryResponse=null,this.onRelayCommand=null,this.onRelayText=null,this.onRelayData=null,this.subSessionId=null,this.participants=new e.Map,this.recording=!1,this.recordingRules=null,this.alwaysRecordOnCreation=!1,this.neverRecordOnCreation=!1,this.sentAutomaticRecordingRequest=!1,this.shortCircuitMode=!1,this.recordingStyle="single",this.lastRemovedParticipant=null,this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null,this.webContext=null,this.pendingAVStreams=[],this.removed=!1,this.pendingAddStreamRelay=null,this.sidebarId=null,this.clientId=null,this.clientVersion=null,this.postCallRating=!1,this.statusCheckTimeout=null,this.statusCheckSuccess=null,this.addStreamScreenSharePromise=null,this.addStreamShareResolve=null,this.screenShareValues=null,this.shortCircuitModeAllowed=!0;var l=2e3;this.setIceCheckInterval=function(e){if(e<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};l=e},this.getIceCheckInterval=function(){return l},this.getLocalId=function(){return this.subSessionId},this.generateStreamId=function(e){var t=this.streams.values().filter(function(t){return t.getType()===e}).length;a.debug("Found "+t+" streams with type: "+e);var i="av";return e===n.STREAMTYPE.SCREENSHARE&&(i="ss"),i+(t+1)+"-"+this.startTime},this.generateRelayId=function(){var e=this.relays.size();a.debug("Found "+e+" relays");return"r"+(e+1)+"-"+this.startTime},this.withParticipant=function(e,t,i,o){this.pendingTargetURI=e;var s=this.localAddParticipant(e);return t||(t=this.getDefaultStreamOptions()),this.pendingTargetStreamId=s.localAddStreamInfo(null,o||null,t,i).getId(),this.pendingTargetStreamOptions=t,this.pendingTargetStreamProfile=i,this.onParticipantChange&&this.onParticipantChange(this,n.CONVERSATIONSTATE.STREAM_ADDED,s),this},this.withChannel=function(e){return this.conversationChannel=e,this},this.withKey=function(e){return e&&(a.debug("Joining conversation with key="+e),this.conversationKey=e,this.joiningConversation=!0),this},this.withTopic=function(e){return this.conversationTopic=this.pkgInstance.encodeConversationTopic(e),this},this.withContext=function(e){return this.webContext=e,this},this.withVersion=function(e){return this.clientVersion=e,this},this.withCallbacks=function(e,t,i,o,s,a,r){if(this.onRecordingStatusChange=e,this.onParticipantChange=t,this.onError=i,this.onRelayCommand=o,this.onRelayText=s,this.onRelayData=a,this.onEnquiryResponse=r,this.onParticipantChange)for(var c=this.participants.values(),l=0;l<c.length;l++)this.onParticipantChange(this,n.CONVERSATIONSTATE.STREAM_ADDED,c[l]);return this},this.withShortCircuit=function(){return a.debug("Conversation withShortCircuit setting SCM to (allowed): "+this.shortCircuitModeAllowed),this.shortCircuitMode=this.shortCircuitModeAllowed,this},this.withoutShortCircuit=function(){return a.debug("Conversation withoutShortCircuit setting SCM allowed to false"),this.shortCircuitModeAllowed=!1,this},this.isShortCircuit=function(){return this.shortCircuitMode},this.getSidebar=function(){return this.sidebarId},this.withRecording=function(){return this.alwaysRecordOnCreation=!0,this},this.withoutRecording=function(){return this.neverRecordOnCreation=!0,this},this.localSetRecording=function(e){this.recording=e,this.recording?a.debug("Conversation is being recorded"):a.debug("Conversation is not being recorded")},this.localAddParticipant=function(t){var i=new e.Participant(this,t);return this.participants.put(t,i),i},this.localRemoveParticipant=function(e){return this.lastRemovedParticipant=this.getParticipant(e),this.participants.remove(e)&&a.debug("Removed Participant with uri="+e),this.lastRemovedParticipant},this.decodeConversationTopic=function(){if(!this.conversationTopic)return null;var e=this.conversationTopic,t=e.indexOf("@");return t&&(e=e.substring(0,t)),e.replace(/_/g," ")},this.setRecordingStyle=function(e){this.recordingStyle=e},this.getRecordingStyle=function(){return this.recordingStyle},this.setPostCallRating=function(e){a.debug("Post-call rating is required"),this.postCallRating=e},this.isPostCallRatingRequired=function(){return this.postCallRating},this.setRecordingRules=function(e){this.recordingRules=e},this.getRecordingRules=function(){return this.recordingRules},this.getPendingTarget=function(){return{uri:this.pendingTargetURI,streamId:this.pendingTargetStreamId,streamOptions:this.pendingTargetStreamOptions,streamProfile:this.pendingTargetStreamProfile}},this.clearPendingTarget=function(){this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null},this.replacePendingTarget=function(e){var t=this.getPendingTarget();a.debug("Replacing pending destination: '"+t.uri+"' with actual destination: '"+e+"'"),this.getParticipant(t.uri)&&this.localRemoveParticipant(t.uri);var i=this.localAddParticipant(e);i.localAddStreamInfo(t.streamId,n.STREAMTYPE.AUDIOVIDEO,t.streamOptions,t.streamProfile),a.debug("Replaced pending destination with actual destination: '"+e+"'"),this.clearPendingTarget(),this.onParticipantChange&&this.onParticipantChange(this,n.CONVERSATIONSTATE.STREAM_ADDED,i)},this.defaultEnquiryResponse=function(e){var t=null;if(e){t=JSON.parse("{}"),a.debug("Processing recording rules for conversation: "+JSON.stringify(e,null,2));var i=e.destination_uri;i&&this.replacePendingTarget(i);var n=e.recording_style;n&&(a.debug("Will record using style: "+n),this.setRecordingStyle(n)),e.post_call_rating&&(a.debug("Will request a post-call rating"),this.setPostCallRating(!0));var o=e.exclude_conversation,s=e.include_conversation,r=e.include_associations,c=e.exclude_associations,l=e.include_participants;o?(a.debug("Not recording conversation"),this.withoutRecording().withShortCircuit()):s?(a.debug("Recording conversation"),t.participants=["*"],this.withRecording()):(r&&(a.debug("Including associations: "+JSON.stringify(r,null,2)),t.include_associations=[].concat(r),this.withRecording()),c&&(a.debug("Excluding associations: "+JSON.stringify(c,null,2)),t.exclude_associations=[].concat(c),this.withRecording()),l&&(a.debug("Including participants: "+JSON.stringify(l,null,2)),t.participants=[].concat(l),this.withRecording()))}this.setRecordingRules(t)},this.onIceConnectionStateChange=function(e,t){a.debug("onIceConnectionStateChange: "+t,e);var i=this.getLocalParticipant();if(i){var o=i.getStreamInfo(e.streamId);if(o)if("connected"===t||"completed"===t){if(!o.isActive()){o.localSetActive(!0);var s=[{uri:i.getUri(),streams:[{stream_id:e.getId(),stream_type:e.getType(),stream_options:e.getStreamOptions()}]}];r.relayStreamEvent(e,n.CONVERSATIONSTATE.STREAM_ACTIVE,s),r.handleParticipantChange(this,n.CONVERSATIONSTATE.STREAM_ACTIVE,s[0].uri,s[0].streams)}}else o.isActive()&&o.localSetActive(!1),"failed"===t&&e.call.onCallStateChange&&(a.info("onIceConnectionStateChange: failed - updating stream state to: "+n.CALLSTATE.FAILED),e.call.setCallState(n.CALLSTATE.ERROR,n.ERRORCODE.ICE_CONNECTION_ERROR,"ICE state failed"))}},this.createStreamOfType=function(t,i,o,s){var r=this.callPackage.prepareCall(this.session,o,this.initiator,null);r.subSessionId=this.subSessionId,r.pkgInstance=this.callPackage,r.conversation=this,r.streamId=t,r.streamType=i,r.callState.streamId=t,r.shortCircuitMode=this.shortCircuitMode;var c,l=this.getLocalParticipant().localAddStreamInfo(t,i,o,s);switch(i){case n.STREAMTYPE.AUDIOVIDEO:c=new e.AudioVideoStream(this,r,t,l);break;case n.STREAMTYPE.SCREENSHARE:c=new e.ScreenShareStream(this,r,t,l);break;default:return a.error("Unknown stream type: "+i),null}return this.streams.put(t,c),c.call.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this,c),c},this.createAudioVideoStream=function(e,t,i){return e||(e=this.getDefaultStreamOptions()),t||(t=this.generateStreamId(n.STREAMTYPE.AUDIOVIDEO)),this.createStreamOfType(t,n.STREAMTYPE.AUDIOVIDEO,e,i)},this.createScreenShareStream=function(t,i,o){return i||(i=new e.StreamOptions(n.MEDIADIRECTION.NONE,n.MEDIADIRECTION.SENDRECV)),t||(t=this.generateStreamId(n.STREAMTYPE.SCREENSHARE)),this.createStreamOfType(t,n.STREAMTYPE.SCREENSHARE,i,o)},this.addScreenShareStream=function(e,t,i){var n=this.createScreenShareStream(e,t,i);if(this.isShortCircuit()){a.debug("Short-circuit conversation - creating sidebar before adding stream"),r.sendCreateSidebar(this),this.screenShareValues={stream:n,options:t};var o=this;return this.addStreamScreenSharePromise=new Promise(function(e,t){a.debug("created addStreamScreenSharePromise"),o.addStreamShareResolve=e}),this.addStreamScreenSharePromise}return Promise.resolve({stream:n,options:t})},this.getDefaultStreamOptions=function(){return"audio"===this.conversationChannel?new e.StreamOptions(n.MEDIADIRECTION.SENDRECV,n.MEDIADIRECTION.NONE):new e.StreamOptions(n.MEDIADIRECTION.SENDRECV,n.MEDIADIRECTION.SENDRECV)},this.getStreamForId=function(e){var t=this.streams.get(e);return t||"default"!==e||(t=this.streams.get("av1-"+this.startTime)),t},this.remove=function(){this.pkgInstance.remove(this)},this.createRelay=function(t,i,n){n||(n=this.generateRelayId());var o=new e.Relay(this,t,i,n);return this.relays.put(n,o),a.debug("Created relay for stream: "+t+" with id: "+n+" and destination: "+JSON.stringify(i,null,2)),o},this.getRelayForId=function(e){var t=this.relays.get(e);return t||"default"!==e||(t=this.getRelay()),t},this.getRelayForStream=function(e){var t=this.relays.values().filter(function(t){return e.getId&&t.getStreamId()===e.getId()},this);return t.length>0?t[0]:null},this.getSpecificRelayForStream=function(e){var t=this.relays.values().filter(function(t){return e.getId&&t.getStreamId()===e.getId()&&t.getDestination()===e.uri},this);return t.length>0?(a.debug("getSpecificRelayForStream ("+e+")found a relay of "+t[0]),t[0]):null},this.getRelayForDestUrl=function(e){var t=function(t){return!(!t.getParticipant||t.getParticipant().getUri()!==e)||t===e},i=this.relays.values().filter(function(e){var i=e.getDestination();return Array.isArray(i)?i.filter(t).length>0:t(i)},this);return i.length>0?i[0]:null},this.getRelay=function(){return this.relays.get("r1-"+this.startTime)}};d.prototype={end:function(e){this.session.sessionState!==n.SESSIONSTATE.CLOSED&&this.session.sessionState!==n.SESSIONSTATE.FAILED&&this.streams.size()>0&&(a.info("Begin to remove all participants",this),r.sendRemoveAllParticipants(this),this.streams.values().forEach(function(t){t.end(e)})),this.participants.clear(),this.remove()},getInitiator:function(){return this.initiator},getTopic:function(){return this.decodeConversationTopic()},getKey:function(){return this.conversationKey},getChannel:function(){return this.conversationChannel},getContext:function(){return this.webContext},addParticipant:function(e,t,i){var n=this.localAddParticipant(e);return t||(t=this.getDefaultStreamOptions()),n.localAddStreamInfo(null,null,t,i),this.streams.size()>0&&(a.info("Begin to add participant: "+e,this),r.sendAddParticipant(this,n)),n},getParticipants:function(){return this.participants.values()},getParticipant:function(e){return this.participants.values().find(function(t){return t.uri===e},this)},getLocalParticipant:function(){return this.getParticipant(this.getLocalParticipantUri())},getRemoteParticipant:function(){for(var e=this.getParticipants(),t=0;t<e.length;t++)if(this.getLocalParticipantUri()!==e[t].getUri())return e[t];return null},getLocalParticipantUri:function(){return this.session.userName},showParticipantsAndStreams:function(e){console.log("---\x3e "+e);for(var t=this.getParticipants(),i=0;i<t.length;i++){var n;n=this.getLocalParticipantUri()===t[i].getUri()?"- Local Participant ["+i+"]: ":"- Remote Participant ["+i+"]: ",a.debug(n);for(var o=0;o<t[i].getStreamInfos().length;o++)a.debug("    - Stream["+o+"]: "+JSON.stringify(t[i].getStreamInfos()[o].toJSON()))}},getAudioVideoStream:function(e){if(!e){var t=this.streams.values().filter(function(e){return e.getType()===n.STREAMTYPE.AUDIOVIDEO&&!e.getStreamState().isFinalState()});t.length>0&&(e=t[0].streamId)}return this.getStreamForId(e)},getScreenShareStream:function(e){if(!e){var t=this.streams.values().filter(function(e){return e.getType()===n.STREAMTYPE.SCREENSHARE&&!e.getStreamState().isFinalState()});t.length>0&&(e=t[0].streamId)}return this.getStreamForId(e)},offerOutboundScreenShare:function(e,t,i){var o=i||this.getRemoteParticipant();if(o){var s=o.getStreamInfos()[0],c=o.getUri();a.debug("offerOutboundScreenShare to remote participant: "+c);var l=this.getRelayForStream(s);null===l?l=this.createRelay(s.getId(),s):a.debug("Found relay with id: "+l.getId());var d=[{stream_type:n.STREAMTYPE.SCREENSHARE,stream_options:{audio:n.MEDIADIRECTION.NONE,video:n.MEDIADIRECTION.SENDONLY}}],u=l.createCommand(n.CONVERSATION.REMOTE_ADD_STREAM,d).withCallbacks(e,t);this.isShortCircuit()?(a.debug("offerOutboundScreenShare: Short-circuit conversation - creating sidebar before requesting outbound stream"),r.sendCreateSidebar(this),this.pendingAddStreamRelay=u):(a.debug("offerOutboundScreenShare: Sending relay to request outbound stream"),u.send())}else a.info("offerOutboundScreenShare: no remote participant - cannot request outbound stream"),"function"==typeof t&&t("no remote participant")},annotateCustomerStream:function(e,t,i,o,s,r){a.debug("annotateCustomerStream");var c=o||this.getRemoteParticipant();if(c){var l=c.getUri();a.debug("annotateCustomerStream to remote participant: "+l),c.conversation.showParticipantsAndStreams("AnnotateCustomerStream");var d=null;r&&(d=c.getStreamInfos().find(r)),d||(a.debug("No stream found; Selecting first stream (Index: [0])"),d=c.getStreamInfos()[0]),a.debug("remoteParticipant stream found: "+JSON.stringify(d.asJSON()));var u=this.getRelayForStream(d);null===u?(a.debug("creating new relay with streamId: "+d.getId()),u=this.createRelay(d.getId(),d)):a.debug("Found relay with id: "+u.getId()),u.createCommand(n.CONVERSATION.ANNOTATE_CUSTOMER_STREAM,e).withOrigStreamOptionsCallback(s).withDestStreamOptionsCallback(r).withCallbacks(t,i).send()}},getStreams:function(){return this.streams.values()},isEstablished:function(){var e=this.streams.values().some(function(e){return e.getStreamState().hasEstablished()});return a.debug("Conversation.isEstablished: "+e),e},updateStreamId:function(e,t){this.streams.remove(t),this.streams.put(e.streamId,e)},toJSON:function(){return{conversationKey:this.conversationKey,conversationTopic:this.conversationTopic,initiator:this.initiator,conversationChannel:this.conversationChannel,joiningConversation:this.joiningConversation,shortCircuitMode:this.shortCircuitMode,streams:this.streams,relays:this.relays,startTime:this.startTime,onRecordingStatusChange:this.onRecordingStatusChange,onParticipantChange:this.onParticipantChange,onError:this.onError,onEnquiryResponse:this.onEnquiryResponse,subSessionId:this.subSessionId,participants:this.participants,recording:this.recording,recordingRules:this.recordingRules,alwaysRecordOnCreation:this.alwaysRecordOnCreation,neverRecordOnCreation:this.neverRecordOnCreation,sentAutomaticRecordingRequest:this.sentAutomaticRecordingRequest,recordingStyle:this.recordingStyle,lastRemovedParticipant:this.lastRemovedParticipant,pendingTargetURI:this.pendingTargetURI,pendingTargetStreamId:this.pendingTargetStreamId,pendingTargetStreamOptions:this.pendingTargetStreamOptions,pendingTargetStreamProfile:this.pendingTargetStreamProfile,webContext:this.webContext,pendingAVStreams:this.pendingAVStreams,iceCheckInterval:this.iceCheckInterval,pendingAddStreamRelay:this.pendingAddStreamRelay,sidebarId:this.sidebarId,clientId:this.clientId,clientVersion:this.clientVersion}},onMessage:function(e){if(a.debug("Received "+e.control.type+" with action: "+e.header.action,this),e.isReliableRelay())r.doReliableRelay(this,e);else if(e.isRequest())r.doRequest(this,e);else if(e.isResponse())r.doResponse(this,e);else if(e.isMessage())r.doMessage(this,e);else if(e.isError())r.doError(this,e);else{var t=this.getAudioVideoStream().call;t&&t.onMessage(e)}},startRecording:function(){a.info("Begin to start recording",this),this.streams.size()>0?r.sendBeginRecording(this):(a.debug("Will start recording conversation on creation"),this.alwaysRecordOnCreation=!0)},stopRecording:function(){a.info("Begin to stop recording",this),this.streams.size()>0?r.sendEndRecording(this):(a.debug("Will NOT start recording conversation on creation"),this.neverRecordOnCreation=!0)},isRecording:function(){return this.recording},switchToSidebar:function(){r.sendCreateSidebar(this)},checkStatus:function(e,t){this.statusCheckSuccess=e,this.statusCheckTimeout&&clearTimeout(this.statusCheckTimeout),this.statusCheckTimeout=setTimeout(function(){a.info("Failed to get status check response"),"function"==typeof t&&t("Timeout")},5e3),r.sendConversationEnquiry(this)},addRemainingStreams:function(){var e=this;if(this.pendingAddStreamRelay){a.debug("addRemainingStreams: pendingAddStreamRelay");var t=this.getRemoteParticipant(),i=null;t&&((i=t.getStreamInfos().find(function(t){return null!==e.getRelayForStream(t)}))&&t.getStreamInfos().forEach(function(t){e.createRelay(t.getId(),t,i.getId())})),r.sendDelayedAddStreamRequest(this)}else this.addStreamShareResolve?(a.debug("addRemainingStreams: addStreamScreenSharePromise"),this.addStreamShareResolve(this.screenShareValues),this.addStreamScreenSharePromise=null,this.addStreamShareResolve=null,this.screenShareValues=null):a.debug("addRemainingStreams: default else")},relayCommandTo:function(e,t,i,n){if(!this.conversationKey)return a.warn("Failed to relay command: "+i+" - conversation not established"),null;if(!e){var o=this.getAudioVideoStream();o&&(e=o.getId())}if(!e){var s=this.getScreenShareStream();s&&(e=s.getId())}return e?this.createRelay(e,t).createRelayMessage().withCommand(i,n).send():(a.warn("Failed to relay command: "+i+" - invalid stream"),null)},relayTextTo:function(e,t,i,n){return this.conversationKey?(e||(e=this.getAudioVideoStream().getId()),this.createRelay(e,t).createRelayMessage().withText(i,n).send()):(a.warn("Failed to relay text: "+n+" - conversation not established"),null)},relayDataTo:function(e,t,i,n){return this.conversationKey?(e||(e=this.getAudioVideoStream().getId()),this.createRelay(e,t).createRelayMessage().withData(i,n).send()):(a.warn("Failed to relay data: "+i+" - conversation not established"),null)}};var u=function(e,t,i){this.audio=e,this.video=t,this.reason=i,this.pausedBy=null};u.prototype={toJSON:function(){return{audio:this.audio,video:this.video,reason:this.reason?this.reason:""}}};var h=function(e,t,i,n){this.upgraded=e&&"true"===e.toString(),this.paused=t&&"true"===t.toString(),this.paused_by=i||"",this.pauseResume=n};h.create=function(t){var i=new e.PauseResume(n.PAUSERESUME.RESUME,n.PAUSERESUME.RESUME,null);if(t){var o=t.paused_by?t.paused_by:"";return t.pause_resume_audio&&t.pause_resume_video?i=new e.PauseResume(t.pause_resume_audio,t.pause_resume_video,t.pause_resume_reason):t.pauseResume&&t.pauseResume.audio&&t.pauseResume.video?i=new e.PauseResume(t.pauseResume.audio,t.pauseResume.video,t.pauseResume.reason):(t.upgraded=!0,t.paused=!1),new e.StreamProfile(t.upgraded,t.paused,o,i)}return new e.StreamProfile(!0,!1,"",i)},h.prototype={toJSON:function(){return{upgraded:this.upgraded,paused:this.paused,paused_by:this.paused_by,pause_resume_audio:this.pauseResume.audio,pause_resume_video:this.pauseResume.video,pause_resume_reason:this.pauseResume.reason?this.pauseResume.reason:""}},updateForPauseResume:function(t,i){var o=t.audio===n.PAUSERESUME.PAUSE&&t.video===n.PAUSERESUME.PAUSE;this.pauseResume=new e.PauseResume(t.audio,t.video,t.reason),t.reason===n.PAUSERESUMEREASON.UPGRADE_DOWNGRADE?this.upgraded=t.video===n.PAUSERESUME.RESUME:(this.paused=o,this.paused_by=i&&o?i:"")}};var g=function(t,i,o,s,r){this.participant=t,this.uri=this.participant.getUri(),this.streamId=i,this.streamType=o,this.streamLayout=n.STREAMSIZE.MIN,this.recording=!1,this.PAUSED=new e.StreamOptions(n.MEDIADIRECTION.NONE,n.MEDIADIRECTION.NONE),this.streamProfile=h.create(r),this.streamOptions=this.PAUSED,this.qualityMonitor=null,this.active=!1,this.localSetStreamOptions=function(e){if(e){var t=e.audio,i=e.video,n=e.audioConfig,o=e.videoConfig;e=t&&i?g.createStreamOptions(t,i):n&&o?g.createStreamOptions(n,o):this.participant.conversation.getDefaultStreamOptions()}else e=this.participant.conversation.getDefaultStreamOptions();a.debug("Changing options for stream: "+this.streamId+", options="+JSON.stringify(e,null,2)),this.streamOptions=e},this.localSetStreamOptions(s),this.localSetStreamLayout=function(e){null!==e&&a.debug("Changing layout '"+e+"' for stream: "+this.streamId),this.streamLayout=e},this.localSetStreamProfile=function(t){a.debug("Changing profile '"+JSON.stringify(t,null,2)+"' for stream: "+this.streamId),this.streamProfile=e.StreamProfile.create(t)},this.localSetRecording=function(e){this.recording=e,this.recording?a.debug("Participant "+this.participant.uri+" is being recorded"):a.debug("Participant "+this.participant.uri+" is not being recorded")},this.localSetActive=function(e){this.active=e,a.debug("Participant "+this.participant.uri+" stream: "+this.streamId+(e?" is active":" is not active"))},this.asJSON=function(){return{stream_id:this.streamId,stream_type:this.streamType,stream_options:this.streamOptions.asJSON(),stream_profile:this.streamProfile}}};g.prototype={toJSON:function(){return{uri:this.uri,streamId:this.streamId,streamType:this.streamType,streamLayout:this.streamLayout,recording:this.recording,streamOptions:this.streamOptions,active:this.active,streamProfile:this.streamProfile}},getParticipant:function(){return this.participant},getId:function(){return this.streamId},getType:function(){return this.streamType},getStreamOptions:function(){return this.streamOptions},getStreamProfile:function(){return this.streamProfile},pauseResumeStream:function(e,t,i){a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2));var n=this.participant.conversation.getLocalParticipantUri();return this.participant.getUri()!==n?r.sendPauseResume(this.participant.conversation,this,e,t,i):(a.debug("Pausing/Resuming audio/video tracks in stream: "+this.streamId,e),void this.participant.conversation.getAudioVideoStream(this.streamId).pauseResumeStream(e,t,i))},cancelPauseResumeStream:function(e,t){return a.debug("cancelPauseResumeStream"),r.sendCancelRequest(this.participant.conversation,this,n.CONVERSATION.PAUSE_RESUME_STREAM,e,t)},cancelAddStream:function(e,t){return a.debug("cancelAddStream"),r.sendCancelRequest(this.participant.conversation,this,n.CONVERSATION.ADD_STREAM,e,t)},setStreamOptions:function(e,t,i){if(e||(a.debug("Pausing media for stream: "+this.streamId),e=this.PAUSED),r.isPauseResume(this.streamOptions,e))return this.pauseResumeStream(r.getPauseResumeTargets(e),t,i);var o,s=this.participant.getStreamInfos().some(function(e){return e.getStreamOptions().videoConfig===n.MEDIADIRECTION.SENDONLY||e.getStreamOptions().videoConfig===n.MEDIADIRECTION.RECVONLY}),c=e.videoConfig===n.MEDIADIRECTION.SENDONLY;return this.participant.getUri()!==this.participant.conversation.getLocalParticipantUri()?this.participant.conversation.isShortCircuit()?(a.debug("Short-circuit, checking video options: "+e.videoConfig),o=g.createStreamOptions(e.audioConfig,e.videoConfig),s&&c?o.videoConfig=n.MEDIADIRECTION.SENDRECV:s&&!c&&(a.debug("Single video downgrade, do not swap directions"),o.videoConfig=n.MEDIADIRECTION.NONE),r.sendStreamOptions(this.participant.conversation,this,o,t,i)):r.sendStreamOptions(this.participant.conversation,this,e,t,i):(a.debug("Updating local AV stream with new stream options: "+JSON.stringify(e,null,2)),o=g.createStreamOptions(e.audioConfig,e.videoConfig),this.participant.conversation.isShortCircuit()&&(s&&c?o.videoConfig=n.MEDIADIRECTION.SENDRECV:s&&!c&&(o.videoConfig=n.MEDIADIRECTION.NONE)),void this.participant.conversation.getAudioVideoStream(this.streamId).update(o,t,i))},getLayout:function(){return this.streamLayout},setLayout:function(e,t){this.localSetStreamLayout(e),r.sendStreamLayout(this.participant.conversation,this,e,t)},isRecording:function(){return this.recording},isActive:function(){return this.active},startRecording:function(){a.info("Begin to start recording stream: "+this.streamId,this),r.sendBeginRecording(this.participant.conversation,this)},stopRecording:function(){a.info("Begin to stop recording stream: "+this.streamId,this),r.sendEndRecording(this.participant.conversation,this)},remove:function(){this.participant.streams.size()>1?(a.info("Begin to remove stream: "+this.streamId,this),r.sendRemoveParticipant(this.participant.conversation,this.participant,this)):this.participant.remove()},isAudioPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.audio===n.PAUSERESUME.PAUSE},isVideoPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.video===n.PAUSERESUME.PAUSE},getQualityMonitor:function(){return this.qualityMonitor||(this.qualityMonitor=new e.QualityMonitor(this))}},g.createStreamOptions=function(t,i){var o=function(e){var t=n.MEDIADIRECTION.NONE;switch(e.toLowerCase()){case"inactive":case"none":t=n.MEDIADIRECTION.NONE;break;case"sendonly":t=n.MEDIADIRECTION.SENDONLY;break;case"recvonly":t=n.MEDIADIRECTION.RECVONLY;break;case"sendrecv":t=n.MEDIADIRECTION.SENDRECV}return t},s=o(t),a=o(i);return new e.StreamOptions(s,a)};var v=function(t,i){this.streams=new e.Map,this.removedStreams=[],this.conversation=t,this.uri=i,a.debug("Participant with URI: "+this.uri),this.onParticipantStateChange=null,this.onAddStream=null,this.onAddRemoteStream=null,this.localAddStreamInfo=function(t,i,o,s){t||(t=this.conversation.generateStreamId(i)),i||(i=n.STREAMTYPE.AUDIOVIDEO),o||(o=this.conversation.getDefaultStreamOptions()),s?s=e.StreamProfile.create(s):(s=e.StreamProfile.create()).upgraded=o.shouldSendVideo(),a.debug("Creating StreamInfo: id="+t+", URI="+this.uri+", type="+i+", options="+JSON.stringify(o,null,2)+", profile="+JSON.stringify(s,null,2));var r=new e.StreamInfo(this,t,i,o,s);return this.streams.put(t,r),a.debug("Found stream length after adding "+this.streams.values().length),r},this.notRemovedStream=function(e){return-1===this.removedStreams.indexOf(e)},this.localRemoveStreamInfo=function(e){return this.streams.remove(e)&&(this.removedStreams.push(e),a.debug("Removed StreamInfo with ="+this.uri+"/"+e)),this.streams.size()}};v.prototype={initCallbacks:function(e,t,i){a.debug("Initialise callbacks for participant: "+this.uri),this.onParticipantStateChange=e,this.onAddStream=t,this.onAddRemoteStream=i},remove:function(e){this.conversation.localRemoveParticipant(this.uri),this.conversation.streams.size()>0&&(this.uri===this.conversation.getLocalParticipantUri()?(this.conversation.streams.values().forEach(function(t){t.end(e)}),this.conversation.remove()):(a.info("Begin to remove participant: "+this.uri,this),r.sendRemoveParticipant(this.conversation,this)))},asJSONArray:function(e){for(var t=this.streams.values(),i=[],n=0;n<t.length;n++){var o={uri:this.uri,stream_id:t[n].getId(),stream_type:e||t[n].getType(),stream_options:t[n].getStreamOptions().asJSON(),stream_profile:t[n].getStreamProfile()},s=t[n].getLayout();s&&(o.size=s),i.push(o)}return i},toJSON:function(){return{streams:this.streams,uri:this.uri,onParticipantStateChange:this.onParticipantStateChange,onAddStream:this.onAddStream,onAddRemoteStream:this.onAddRemoteStream}},getUri:function(){return this.uri},getStreamInfos:function(){return this.streams.values()},getStreamInfo:function(e){var t=this.streams.get(e);return t||"default"!==e||(t=this.streams.get("av1")),t},isRecording:function(){var e=!1;return this.streams.values().forEach(function(t){t.isRecording()&&(e=!0)}),e},addScreenShareStream:function(e,t,i,o,s){if(this.uri===this.conversation.getLocalParticipantUri())return this.conversation.createScreenShareStream(e,o,s);var a=g.createStreamOptions(n.MEDIADIRECTION.INACTIVE,n.MEDIADIRECTION.SENDONLY);return r.sendAddStream(this.conversation,this,n.STREAMTYPE.SCREENSHARE,a,t,i),!0},addAudioVideoStream:function(e,t,i,o,s){return this.uri===this.conversation.getLocalParticipantUri()?this.conversation.createAudioVideoStream(e,t,s):(r.sendAddStream(this.conversation,this,n.STREAMTYPE.AUDIOVIDEO,e,i,o),!0)}};var p=function(e,t,i,n){this.conversation=e,this.call=t,this.call.avStream=this,this.streamId=i,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=n,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null,this.onQualityMetrics=null};p.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo,onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(e,t,i,n,o,s){return this.call.onCallStateChange=e,this.call.onMediaStreamEvent=t,this.call.onUpdate=i,this.call.onCallError=n,this.onPauseResumeStream=o,this.onUpdateStreamOptions=s,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return n.STREAMTYPE.AUDIOVIDEO},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(e){return a.debug("Muting stream? "+e),this.call.mute(e)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return s.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return s.getLocalStreams(this.call.peerConnection)},extractVideoForPreview:function(){var e=this.call.peerConnection;e.getSenders().map(function(t){t.track&&"video"===t.track.kind&&e.removeTrack(t)});var t=this.call.localMediaStreams[0];return"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"video"===t.track.kind&&(t.track.enabled=!0):t.getVideoTracks().map(function(e){e.enabled=!0}),t},addbackVideoAfterPreview:function(e){var t=this.call.localMediaStreams[0],i=this.call.peerConnection;"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"video"===t.track.kind&&(t.track.enabled=e,i.addTrack(t.track,t)):t.getVideoTracks().map(function(n){n.enabled=e,i.addTrack(n,t)})},start:function(e,t){return this.localMediaStreams=e,this.extHeaders=t,!this.conversation.recordingRules&&r.retrieveRecordingRules(this.conversation)?this.conversation.pendingAVStreams.push(this):r.sendStartRequest(this),this},end:function(e){r.sendEndRequest(this,e)},decline:function(e,t){r.sendDeclineResponse(this,e,t)},accept:function(e,t,i){r.sendAcceptResponse(this,e,t,i)},update:function(e,t,i,n,o){return a.debug("Attempting to update AV stream"),this.call.canUpdate()?(r.isPauseResume(this.getStreamOptions(),e)?this.pauseResumeStream(r.getPauseResumeTargets(e),n,o):(r.sendUpdateRequest(this,e,t,i),"function"==typeof n&&n(!0)),!0):(a.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof o&&o(!1),!1)},pauseResumeStream:function(e,t,i){var o=e.audio===n.PAUSERESUME.PAUSE,s=e.video===n.PAUSERESUME.PAUSE;return a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2)),a.debug((o?"Pausing":"Resuming")+" audio tracks in AV stream"),a.debug((s?"Pausing":"Resuming")+" video tracks in AV stream"),r.pauseResumeLocalAVStream(this,e),"function"==typeof t&&t(!0),!0},resume:function(e,t){var i=this;a.info("Begin to resume AV stream",i),new Promise(function(e,t){i.call.resume(e,t)}).then(function(){if(a.info("AV stream resumed"),i.isVideoPaused()||i.isAudioPaused()){var t=i.getStreamInfo().getStreamProfile().pauseResume;r.enableDisableTracks(i,t),a.info("Resumed AV stream is paused")}e()}).catch(t)}};var m=function(e,t,i,n){this.conversation=e,this.call=t,this.call.avStream=this,this.streamId=i,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=n,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null};m.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo,onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(e,t,i,n,o,s){return this.call.onCallStateChange=e,this.call.onMediaStreamEvent=t,this.call.onUpdate=i,this.call.onCallError=n,this.onPauseResumeStream=o,this.onUpdateStreamOptions=s,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return n.STREAMTYPE.SCREENSHARE},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(e){return a.debug("Muting stream? "+e),this.call.mute(e)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return s.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return s.getLocalStreams(this.call.peerConnection)},start:function(e,t){return this.localMediaStreams=e,t||(t=JSON.parse("{}")),this.extHeaders=t,this.conversation.joiningConversation||this.conversation.recordingRules?r.sendStartRequest(this):r.retrieveRecordingRules(this.conversation)&&this.conversation.pendingAVStreams.push(this),this},end:function(e){r.sendEndRequest(this,e)},accept:function(e,t,i){r.sendAcceptResponse(this,e,t,i)},decline:function(e,t){r.sendDeclineResponse(this,e,t)},update:function(e,t,i,n,o){return a.debug("Attempting to update SS stream"),this.call.canUpdate()?(r.isPauseResume(this.getStreamOptions(),e)?this.pauseResumeStream(r.getPauseResumeTargets(e),n,o):(r.sendUpdateRequest(this,e,t,i),"function"==typeof n&&n(!0)),!0):(a.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof o&&o(!1),!1)},pauseResumeStream:function(e,t,i){var o=e.audio===n.PAUSERESUME.PAUSE,s=e.video===n.PAUSERESUME.PAUSE;return a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2)),this.streamInfo&&this.streamInfo.streamProfile&&this.streamInfo.streamProfile.pauseResume&&e.audio===this.streamInfo.streamProfile.pauseResume.audio&&e.video===this.streamInfo.streamProfile.pauseResume.video?(e.audio===this.streamInfo.streamProfile.pauseResume.audio&&a.debug("AV stream audio tracks already "+(o?"paused":"resumed")),e.video===this.streamInfo.streamProfile.pauseResume.video&&a.debug("AV stream video tracks already "+(s?"paused":"resumed")),r.enableDisableTracks(this,e)):(a.debug((o?"Pausing":"Resuming")+" audio tracks in AV stream"),a.debug((s?"Pausing":"Resuming")+" video tracks in AV stream"),r.pauseResumeLocalAVStream(this,e)),"function"==typeof t&&t(!0),!0},resume:function(e,t){var i=this;a.info("Begin to resume SS stream",i),new Promise(function(e,t){i.call.resume(e,t)}).then(function(){if(a.info("SS stream resumed"),i.isVideoPaused()||i.isAudioPaused()){var t=i.getStreamInfo().getStreamProfile().pauseResume;r.enableDisableTracks(i,t),a.info("Resumed SS stream is paused")}e()}).catch(t)}};var S=function(t,i,n,o){this.conversation=t,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.relayId=o,this.retries=1,this.timeout=10,this.streamId=i,this.relayDest=n,this.relayMessages=new e.Map,this.timer=null;var s=new Date;this.startTime=""+s.getHours()+s.getMinutes()+s.getSeconds()+s.getMilliseconds()};S.prototype={toJSON:function(){return{responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,relayId:this.relayId,retries:this.retries,timeout:this.timeout,streamId:this.streamId,relayDest:this.relayDest,relayMessages:this.relayMessages,timer:this.timer,startTime:this.startTime}},withCallbacks:function(e,t){return this.responseHandler=e,this.errorHandler=t,this},withTimeout:function(e,t){return t&&(this.timeoutHandler=t),this.timeout=e,this},withRetries:function(e,t){t&&(this.retryHandler=t),this.retries=e},getConversation:function(){return this.conversation},getId:function(){return this.relayId},getDestination:function(){return this.relayDest},getStreamId:function(){return this.streamId},createRelayRequest:function(t){t||(a.debug("Calling generateRelayMessageId with type: "+n.TYPE.REQUEST),t=this.generateRelayMessageId(n.TYPE.REQUEST));var i=new e.RelayMessage(this,n.TYPE.REQUEST,t);return this.relayMessages.put(t,i),i},createRelayMessage:function(t){return t||(a.debug("Calling generateRelayMessageId with type: "+n.TYPE.MESSAGE),t=this.generateRelayMessageId(n.TYPE.MESSAGE)),new e.RelayMessage(this,n.TYPE.MESSAGE,t)},createSubsequentRelayResponse:function(t){return new e.RelayMessage(this,n.TYPE.RESPONSE,t.header.relay.msgId)},createFinalRelayResponse:function(t){return new e.RelayMessage(this,n.TYPE.RESPONSE,t).asFinalMessage()},createRelayError:function(t){return new e.RelayMessage(this,n.TYPE.ERROR,t)},generateRelayMessageId:function(e){var t=this.relayMessages.values().filter(function(t){return t.getMessageType()===e}).length;a.debug("Found "+t+" messages with type: "+e);var i="rly-";return e===n.TYPE.REQUEST?i+="req":e===n.TYPE.RESPONSE?i+="res":e===n.TYPE.ERROR?i+="err":e===n.TYPE.MESSAGE&&(i+="msg"),i+(t+1)+"-"+this.startTime},getRelayMessageForId:function(e){return this.relayMessages.get(e)},end:function(){clearInterval(this.timer),this.conversation.relays.remove(this.relayId)},send:function(e){if(e.isRequest()&&(e.updateTimestamp(),void 0===e.retryCount||null===e.retryCount?(e.retryCount=0,a.debug("Relay sending message: id="+e.getId())):(e.retryCount++,a.debug("Relay sending message: id="+e.getId()+", retry="+e.retryCount))),this.conversation.session.sendMessage(e.getMessage(!1)),e.isRequest()){var t=this;this.timer||(a.debug("Relay "+this.relayId+" starting interval timer for tracking timeouts"),this.timer=setInterval(function(){t.handleIntervalTimeout()},1e3))}return e},handleIntervalTimeout:function(){a.debug("handleIntervalTimeout...");var e=Date.now();if(0===this.relayMessages.size())a.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null;else{var t,i,n=this.relayMessages.keys(),o=n.length;a.debug("Relay.handleIntervalTimeout tracking "+o+" relay messages"),n.forEach(function(n){a.debug("Found key="+n+" in relayMessages cache");var s=this.relayMessages.get(n);if(s.gotAllResponses)return a.debug("Got all responses"),void(o-=1);var r=!1,c=1,l=[];if(s&&s.gotRelayResponses)for(c=(l=Object.keys(s.gotRelayResponses)).length,a.debug("Message sent to "+c+" destinations"),t=0;t<l.length;t++)i=l[t],a.debug("relayMessage.gotRelayResponses["+i+"] is set to '"+s.gotRelayResponses[i]+"'"),!0===s.gotRelayResponses[i]&&(r=!0);if(s){var d=e-s.getTimestamp(),u=d/1e3,h=s.timeout;null===h&&(h=this.timeout);var g=s.retries;if(null===g&&(g=this.retries),a.debug("elapsedSeconds="+u),a.debug("       timeout="+h),r){if(u>=h){for(a.debug("Only some relay destinations have responded. Creating separate relays for re-sends"),t=0;t<l.length;t++)if(i=l[t],!1===s.gotRelayResponses[i]){var v=this.getConversation().createRelay(this.streamId,i),p=this.createRelayRequest().withMessage(s);v.send(p)}a.debug("Removing Relay Message "+n+" from cache"),this.relayMessages.remove(n)}}else l.length>1&&a.debug("All relay destinations have not responded"),a.debug("Found cached relay with msgId="+s.getId()+" key="+n),u>=h&&(a.debug("relayMessage.retryCount="+s.retryCount),a.debug("                retries="+g),s.retryCount>=g?(a.debug("Relay: relay message has timed out after "+s.retryCount+" reattempt(s): id="+s.getId()),s.timeoutHandler&&s.timeoutHandler(d,s.retryCount,s),this.timeoutHandler&&this.timeoutHandler(d,s.retryCount,s),s.resetCount(),a.debug("Removing Relay Message "+n+" from cache"),this.relayMessages.remove(n)):(a.debug("Relay: About to retry sending timed out message. Calling retry handlers..."),s.retryHandler&&s.retryHandler(d,s.retryCount,s),this.retryHandler&&this.retryHandler(d,s.retryCount,s),a.debug("relay: re-sending timed out relay message: id="+s.getId()+", reattempts="+s.retryCount),this.send(s)))}},this),o<=0&&(a.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null)}},createCommand:function(e,t){return this.createRelayRequest().withCommand(e,t)},createText:function(e,t){return this.createRelayRequest().withText(e,t)},createData:function(e,t){return this.createRelayRequest().withData(e,t)},close:function(){var e=this.createRelayRequest().asFinalMessage();this.send(e)},respond:function(e){var t=this.createSubsequentRelayResponse(e);this.send(t)},processSubsequentResponse:function(e){a.debug("Relay "+this.getId()+" processing subsequent response...");var t=e.header.relay.msgId,i=e.header.relay.from;a.debug("  msgId = "+t);var n=this.getRelayMessageForId(t),o=[],s=1;if(n){n.gotRelayResponses&&(s=(o=Object.keys(n.gotRelayResponses)).length,a.debug("Message was sent to "+s+" destinations")),n.receivedResponseFrom(i);var r=0;if(s>1)for(var c=0;c<o.length;c++){var l=o[c];a.debug("processSubsequentResponse: gotRelayResponses["+l+"] is set to '"+n.gotRelayResponses[l]+"'"),n.gotRelayResponses[l]&&r++}1===s||r===s?(a.debug("Got all expected responses"),n.gotAllResponses=!0):a.debug("Number of destinations="+s+", number of responses received="+r)}},processFinalResponse:function(e){a.debug("Relay "+this.getId()+" processing final response...");var t=e.header.relay.msgId,i=e.header.relay.from,n=e.header.relay.messages[0].commands[0];null===n&&(n=e.header.relay.messages[0].text[0]),null===n&&(n=e.header.relay.messages[0].data[0]),a.debug("  msgId = "+t);var o=this.getRelayMessageForId(t),s=[],r=1;if(o){o.gotRelayResponses&&(r=(s=Object.keys(o.gotRelayResponses)).length,a.debug("Message was sent to "+r+" destinations")),o.receivedResponseFrom(i),o.responseHandler&&(a.debug("  Calling user defined RelayMessage.responseHandler"),o.responseHandler(n)),this.responseHandler&&(a.debug("  Calling user defined Relay.responseHandler"),this.responseHandler(n));var c=0;if(r>1)for(var l=0;l<s.length;l++){var d=s[l];a.debug("processFinalResponse: gotRelayResponses["+d+"] is set to '"+o.gotRelayResponses[d]+"'"),o.gotRelayResponses[d]&&c++}a.debug("Number of destinations="+r+", number of responses received="+c),1!==r&&c!==r||(a.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(t))}},processError:function(e){a.debug("Relay "+this.getId()+" processing error...");var t=e.header.relay.msgId,i=e.header.relay.from,n=e.header.relay.messages[0].commands[0];null===n&&(n=e.header.relay.messages[0].text[0]),null===n&&(n=e.header.relay.messages[0].data[0]),!n.reason&&e.header.reason&&(n.reason=e.header.reason),e.header.error_code&&(n.error_code=e.header.error_code),a.debug("  msgId = "+t);var o=this.getRelayMessageForId(t),s=[],r=1;if(o){o.gotRelayResponses&&(r=(s=Object.keys(o.gotRelayResponses)).length,a.debug("Message was sent to "+r+" destinations")),o.receivedResponseFrom(i),o.errorHandler&&(a.debug("  Calling user defined RelayMessage.errorHandler with: "+JSON.stringify(n,null,2)),o.errorHandler(n)),this.errorHandler&&(a.debug("  Calling user defined Relay.errorHandler with: "+JSON.stringify(n,null,2)),this.errorHandler(n));var c=0;if(r>1)for(var l=0;l<s.length;l++){var d=s[l];a.debug("processError: gotRelayResponses["+d+"] is set to '"+o.gotRelayResponses[d]+"'"),o.gotRelayResponses[d]&&c++}a.debug("Number of destinations="+r+", number of responses received="+c),1!==r&&c!==r||(a.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(t))}}};var f=function(e,t,i){this.relay=e,this.messageId=i,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.retries=null,this.retryCount=null,this.timeout=null,this.final=!1,this.relayDestinations=[],this.excludeDest=null,this.gotRelayResponses=null,this.gotAllResponses=!1,this.timestamp=Date.now(),this.origStreamOptionsCallback=null,this.destStreamOptionsCallback=null,this.messageType=void 0!==t?t:n.TYPE.REQUEST,this.message=null,this.text=null,this.data=null,this.commands=null};f.prototype={toJSON:function(){return{messageId:this.messageId,responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,retries:this.retries,retryCount:this.retryCount,timeout:this.timeout,final:this.final,relayDestinations:this.relayDestinations,gotRelayResponses:this.gotRelayResponses,gotAllResponses:this.gotAllResponses,timestamp:this.timestamp,messageType:this.messageType,message:this.message,origStreamOptionsCallback:this.origStreamOptionsCallback,destStreamOptionsCallback:this.destStreamOptionsCallback,text:this.text,data:this.data,commands:this.commands}},withCallbacks:function(e,t){return a.debug("RelayMessage.withCallbacks: responseHandler="+e),this.responseHandler=e,this.errorHandler=t,this},withTimeout:function(e,t){return t&&(this.timeoutHandler=t),this.timeout=e,this},withRetries:function(e,t){return t&&(this.retryHandler=t),this.retries=e,this},buildMessage:function(e){if(null===this.gotRelayResponses&&(this.relayDestinations=r.determineRelayDestinations(this.getRelay().getConversation(),this.getRelay().getDestination(),this.excludeDest),this.excludeDest=null,this.isRequest())){this.gotRelayResponses={};for(var t=0;t<this.relayDestinations.length;t++){var i=this.relayDestinations[t].uri;this.gotRelayResponses[i]=!1}}null===this.message&&(this.message=r.buildReliableRelayMsg(this,e))},receivedResponseFrom:function(e){a.debug("receivedResponseFrom "+e),e in this.gotRelayResponses&&(a.debug("Marking tracked destination "+e+" as responded"),this.gotRelayResponses[e]=!0)},getConversation:function(){return this.relay.getConversation()},getRelay:function(){return this.relay},getId:function(){return this.messageId},getMessageType:function(){return this.messageType},isRequest:function(){return this.messageType===n.TYPE.REQUEST},isResponse:function(){return this.messageType===n.TYPE.RESPONSE},isError:function(){return this.messageType===n.TYPE.ERROR},isMessage:function(){return this.messageType===n.TYPE.MESSAGE},asFinalMessage:function(){return this.final=!0,this},isFinalMessage:function(){return this.final},getMessage:function(e){return this.buildMessage(e),this.message},resetCount:function(){this.retryCount=null},withText:function(e,t){return a.debug("text relay on thread: "+e+" with content: "+t),this.text||(this.text=[]),this.text.push({thread:e,content:t}),a.debug("total text messages = "+this.text.length),this},withData:function(e,t){return a.debug("data relay for tag: "+e),this.data||(this.data=[]),this.data.push({tag:e,content:t}),a.debug("total data messages = "+this.data.length),this},withCommand:function(e,t){return a.debug("command relay with directive: "+e),this.commands||(this.commands=[]),this.commands.push({directive:e,arguments:[].concat(t)}),a.debug("total command messages = "+this.commands.length),this},withMessage:function(e){return this.message=e.getMessage(!0),this},withOrigStreamOptionsCallback:function(e){return this.origStreamOptionsCallback=e,this},withDestStreamOptionsCallback:function(e){return this.destStreamOptionsCallback=e,this},excludeDestination:function(e){return this.excludeDest=e,this},getOrigStreamOptionsCallback:function(){return this.origStreamOptionsCallback},getDestStreamOptionsCallback:function(){return this.destStreamOptionsCallback},updateTimestamp:function(){this.timestamp=Date.now()},getTimestamp:function(){return this.timestamp},send:function(){this.relay.send(this)},end:function(){a.debug("Removing message id "+this.messageId+" from relay"),this.relay.relayMessages.remove(this.messageId)}};var _=function(e,t,i,n,o){this.relay=e,this.command=t,this.isRequest=i,this.relayMsgId=n,this.relayFrom=o};_.prototype={from:function(){return this.relayFrom},accept:function(e){this.isRequest&&this.relay&&(a.debug("Accepting relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createFinalRelayResponse(this.relayMsgId).withCommand(this.command,[{status:n.RELAYSTATUS.ACCEPTED,info:e}]).send())},decline:function(e){if(this.isRequest&&this.relay){var t=e;t||(t=n.RELAYSTATUS.DECLINED),a.debug("Declining relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createRelayError(this.relayMsgId).withCommand(this.command,[{status:n.RELAYSTATUS.DECLINED,reason:t}]).send()}}};var C=function(e){this.factorMonitors={},this.streamInfo=e,this.onNewInboundFrameRate=null,this.onNewOutboundFrameRate=null,this.onNewInboundResolution=null,this.onNewOutboundResolution=null,this.__audioOutboundRttThreshold=500,this.__videoOutboundRttThreshold=500,this.__videoPacketLossRateThreshold=.3,this.__audioPacketLossRateThreshold=.3,this.__frameRateThreshold=10,this.__jitterThreshold=500,this.__keepCount=3,this.__audioPacketsLostKeepLimit=7,this.__videoPacketsLostKeepLimit=3};return C.prototype={onNewStatus:function(e,t){var i=!1;for(var o in n.ExperienceFactor)if(n.ExperienceFactor.hasOwnProperty(o)&&n.ExperienceFactor[o]===e){this.factorMonitors[e]=t,i=!0;break}i||a.warn("The given factor: "+e+" is not valid.")},withCallbacks:function(e,t,i,n){return this.onNewInboundFrameRate=e,this.onNewOutboundFrameRate=t,this.onNewInboundResolution=i,this.onNewOutboundResolution=n,this},getStreamInfo:function(){return this.streamInfo}},r.isPauseResume=function(e,t){var i=e.shouldSendVideo(),n=t.shouldSendVideo(),o=e.shouldReceiveVideo(),s=t.shouldReceiveVideo(),r=e.shouldSendAudio(),c=t.shouldSendAudio(),l=t.isPaused();return a.debug("isPauseResume: isPaused="+l+", oldAudio="+r+", oldVideo="+i+", oldVideoRecv="+o+", newAudio="+c+", newVideo="+n+", newVideoRecv="+s),!!l||r===c&&i===n&&o===s},r.enableDisableTracks=function(e,t){var i=t.audio===n.PAUSERESUME.PAUSE,o=t.video===n.PAUSERESUME.PAUSE;a.debug((i?"Disable":"Enable")+" audio tracks for stream: "+e.getId()),a.debug((o?"Disable":"Enable")+" video tracks for stream: "+e.getId()),e.paused=t,e.getLocalStreams().map(function(e){"undefined"!=typeof RTCRtpReceiver&&e instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e instanceof RTCRtpSender?e.track&&"audio"===e.track.kind?e.track.enabled=!i:e.track&&"video"===e.track.kind&&(e.track.enabled=!o):(e.getAudioTracks().map(function(e){e.enabled=!i}),e.getVideoTracks().map(function(e){e.enabled=!o}))})},r.pauseResumeLocalAVStream=function(e,t){r.enableDisableTracks(e,t);var i=e.conversation.getLocalParticipantUri();t.pausedBy&&(i=t.pausedBy,t.pausedBy=null),e.streamInfo.streamProfile.updateForPauseResume(t,i),r.sendProfileUpdate(e.conversation,e.streamInfo)},r.relayStreamEvent=function(e,t,i){var n=e.conversation.getRelayForDestUrl("*");null===n&&(n=e.conversation.createRelay(e.getId(),"*")),n.createRelayMessage().withCommand(t,i).send()},r.handleParticipantChange=function(t,i,o,s,r){a.debug("handleParticipantChange: uri="+o+", change="+i,s);var c,l,d,u=!1,h=n.CONVERSATIONSTATE.STREAM_CHANGED;switch(i){case n.CONVERSATION.ADD_STREAM:if(t.__participantsHistory.indexOf(o)<0&&t.__participantsHistory.push(o),(c=t.getParticipant(o))||(u=!0,c=t.localAddParticipant(o)),s&&s.length>0)for(a.debug("Adding streams: "+JSON.stringify(s,null,2)),l=0;l<s.length;l++)s[l].stream_id&&((d=c.getStreamInfo(s[l].stream_id))||(h=n.CONVERSATIONSTATE.STREAM_ADDED,d=c.localAddStreamInfo(s[l].stream_id,s[l].stream_type,s[l].stream_options,s[l].stream_profile)),d&&(void 0!==s[l].stream_options&&d.localSetStreamOptions(s[l].stream_options),void 0!==s[l].stream_profile&&d.localSetStreamProfile(s[l].stream_profile),void 0!==s[l].size&&d.localSetStreamLayout(s[l].size),void 0!==s[l].recording_status&&d.localSetRecording(s[l].recording_status),c.onParticipantStateChange&&!u&&(a.debug("Invoking onParticipantStateChange callback for change: "+h),c.onParticipantStateChange(h,d))));t.onParticipantChange&&u&&(a.debug("Invoking onParticipantChange callback for change: "+n.CONVERSATIONSTATE.STREAM_ADDED),t.onParticipantChange(t,n.CONVERSATIONSTATE.STREAM_ADDED,c));break;case n.CONVERSATION.REMOVE_STREAM:var g=0;if((c=t.getParticipant(o))&&s&&s.length>0)for(a.debug("Removing streams: "+JSON.stringify(s,null,2)),l=0;l<s.length;l++)s[l].stream_id&&(a.debug("Removing stream ("+s[l].stream_id+") from participant: "+JSON.stringify(c,null,2)),(d=c.getStreamInfo(s[l].stream_id))||(d=new e.StreamInfo(c,s[l].stream_id,s[l].stream_type,s[l].stream_options,s[l].stream_profile)),g=c.localRemoveStreamInfo(s[l].stream_id),c.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+n.CONVERSATIONSTATE.STREAM_REMOVED),c.onParticipantStateChange(n.CONVERSATIONSTATE.STREAM_REMOVED,d)));if(g<=0&&(t.localRemoveParticipant(o),t.onParticipantChange)){c||(c=new e.Participant(t,o));var v=n.CONVERSATIONSTATE.STREAM_REMOVED;r&&(v=n.CONVERSATIONSTATE.STREAM_REJECTED),a.debug("Invoking onParticipantChange callback for change: "+v),t.onParticipantChange(t,v,c)}break;case n.CONVERSATION.STREAM_OPTIONS:case n.CONVERSATIONSTATE.STREAM_JOINED:case n.CONVERSATIONSTATE.STREAM_CHANGED:case n.CONVERSATIONSTATE.STREAM_ACTIVE:case n.CONVERSATIONSTATE.PROFILE_UPDATED:case n.CONVERSATIONSTATE.SIDEBAR_CREATED:if(i===n.CONVERSATIONSTATE.SIDEBAR_CREATED&&(a.debug("Sidebar created - disable short-circuit mode"),t.shortCircuitMode=!1),(c=t.getParticipant(o))&&s&&s.length>0)for(a.debug("Updating streams: "+JSON.stringify(s,null,2)),l=0;l<s.length;l++)s[l].stream_id&&(!(d=c.getStreamInfo(s[l].stream_id))&&c.notRemovedStream(s[l].stream_id)&&(d=c.localAddStreamInfo(s[l].stream_id,s[l].stream_type,s[l].stream_options,s[l].stream_profile)),d&&(void 0!==s[l].stream_options&&d.localSetStreamOptions(s[l].stream_options),void 0!==s[l].stream_profile&&d.localSetStreamProfile(s[l].stream_profile),void 0!==s[l].size&&d.localSetStreamLayout(s[l].size),void 0!==s[l].recording_status&&d.localSetRecording(s[l].recording_status),i===n.CONVERSATIONSTATE.STREAM_ACTIVE&&(d.localSetActive(!0),d.streamType===n.STREAMTYPE.AUDIOVIDEO&&s[l].stream_type===n.STREAMTYPE.SCREENSHARE&&(d.streamType=s[l].stream_type,a.debug("Stream "+d.getId()+" is active (updating type to: "+d.getType()+")"))),c.onParticipantStateChange&&(i===n.CONVERSATION.STREAM_OPTIONS?(a.debug("Invoking onParticipantStateChange callback for change: "+n.CONVERSATIONSTATE.STREAM_CHANGED,d),c.onParticipantStateChange(n.CONVERSATIONSTATE.STREAM_CHANGED,d)):(a.debug("Invoking onParticipantStateChange callback for change: "+i,d),c.onParticipantStateChange(i,d)))));else console.log("Failed to process instruction - no participant found for: "+o)}},r.doRequest=function(e,t){var i=t.header,o=i.action,s=i.conversation_key,c=i.conversation_topic,l=i.instructions,d=i.conversation_info,u=i.stream_id,h=i.sidebar,g=i.allow_direct_calls,v=null,p=[],m=0;switch(a.debug("Have conversation request with action: "+o),l&&(p=[].concat(l),a.debug("Have conversation instructions: "+JSON.stringify(p,null,2))),u?(a.debug("Have conversation request for stream: "+u),(v=e.getStreamForId(u))||(v=e.getAudioVideoStream())):v=e.getAudioVideoStream(),o){case n.ACTION.START:for(a.debug("Conversation start request with conversation key: "+s),e.conversationKey=s,c&&(a.debug("Have conversation name: "+c),e.conversationTopic=c),void 0!==g&&a.debug("Have short-circuit mode: "+g),g&&e.withShortCircuit(),h&&(a.debug("Have sidebar: "+h),e.sidebarId=h),m=0;m<p.length;m++)if(p[m].participants){a.debug("Conversation start request with participants: "+p[m].participants);for(var S=[].concat(p[m].participants),f=0;f<S.length;f++)r.handleParticipantChange(e,n.CONVERSATION.ADD_STREAM,S[f].uri,S[m].streams)}d&&r.processConversationInfo(e,d),a.debug("Conversation has "+e.getParticipants().length+" participants (including initiator)"),v.call.onMessage(t);break;case n.ACTION.MODIFY:p.length>0&&function(){var t,i;for(m=0;m<p.length;m++)switch(a.debug("Conversation modify request with instruction: "+p[m].instruction_name),p[m].instruction_name){case n.CONVERSATION.ADD_STREAM:case n.CONVERSATION.REMOVE_STREAM:if(p[m].participants)for(a.debug("Conversation modify request with participants: "+p[m].participants),t=[].concat(p[m].participants),i=0;i<t.length;i++)r.handleParticipantChange(e,p[m].instruction_name,t[i].uri,t[m].streams);break;case n.CONVERSATION.BEGIN_RECORD:e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0);break;case n.CONVERSATION.END_RECORD:e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1)}}();break;default:v.call.onMessage(t)}},r.doResponse=function(e,t){var i=t.header,o=i.action,s=i.conversation_key,c=i.conversation_topic,l=i.response_code,d=t.control.message_state,u=i.conversation_info,h=i.enquiry_data,g=i.stream_id,v=i.allow_direct_calls,p=i.sidebar,m=null;switch(a.debug("Have conversation response with action: "+o+" and code: "+l),g?(a.debug("Have conversation response for stream: "+g),(m=e.getStreamForId(g))||(m=e.getAudioVideoStream())):m=e.getAudioVideoStream(),o){case n.ACTION.START:a.debug("Conversation start response with conversation key: "+s),!e.conversationKey&&s&&(e.conversationKey=s),c&&(a.debug("Have conversation name: "+c),e.conversationTopic=c),void 0!==v&&a.debug("Have short-circuit mode: "+v),v&&e.withShortCircuit(),p&&(a.debug("Have sidebar: "+p),e.sidebarId=p),m.call.onMessage(t);var S=200===l&&"final"===d;u?r.processConversationInfo(e,u):S&&r.sendConversationEnquiry(e);break;case n.ACTION.ENQUIRY:a.debug("Conversation enquiry response with conversation key: "+s),!e.conversationKey&&s&&(e.conversationKey=s),u||h?(r.processConversationInfo(e,u),r.processEnquiryResponse(e,h),"function"==typeof e.statusCheckSuccess&&(a.debug("Successful status check response"),e.statusCheckSuccess(),clearTimeout(e.statusCheckTimeout),e.statusCheckTimeout=null,e.statusCheckSuccess=null)):m.call.onMessage(t);break;case n.ACTION.MODIFY:a.debug("Received modify response with code: "+l);break;default:m.call.onMessage(t)}},r.processConversationInfo=function(e,t){if(t){if(a.debug("Have some conversation info: "+JSON.stringify(t,null,2)),t.participants&&t.participants.length>0){var i=[].concat(t.participants);a.debug("Have some participants: "+JSON.stringify(i,null,2));for(var o=0;o<i.length;o++){var s=i[o].uri,c=i[o].streams;r.handleParticipantChange(e,n.CONVERSATION.ADD_STREAM,s,c)}if(e.isEstablished())for(var l=e.getParticipants(),d=0;d<l.length;d++){var u=l[d].getUri();a.debug("Checking if participant is present: "+u),i.some(function(e){return e.uri===u})||(a.info("Participant left the conversation: "+u),r.handleParticipantChange(e,n.CONVERSATION.REMOVE_STREAM,u,l[d].getStreamInfos()))}}t.recording_status&&(e.localSetRecording(t.recording_status),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,e.isRecording())),t.web_context&&!e.webContext&&(a.debug("Have some web context information: "+JSON.stringify(t.web_context)),e.webContext=t.web_context)}},r.processEnquiryResponse=function(e,t){if(t){var i=JSON.parse(t);a.debug("Received some enquiry data: "+JSON.stringify(i,null,2)),e.defaultEnquiryResponse(i),e.onEnquiryResponse&&(a.debug("Invoking conversation.onEnquiryResponse",e),e.onEnquiryResponse(i)),r.sendDelayedStartRequests(e)}},r.processInstructions=function(e,t,i){var o,s,c,l=[];for(o=0;o<t.length;o++){a.debug("Processing conversation instruction: "+t[o].instruction_name);var d,u=null;switch(t[o].instruction_name){case n.CONVERSATION.ADD_STREAM:case n.CONVERSATIONSTATE.STREAM_ADDED:case n.CONVERSATIONSTATE.STREAM_STARTED:if(i)for(l=[].concat(i),a.debug("Adding participants to conversation: "+JSON.stringify(l,null,2)),s=0;s<l.length;s++)(c=l[s].streams)||(c=[{stream_id:l[s].stream_id,stream_type:l[s].stream_type,stream_options:l[s].stream_options,recording_status:l[s].recording_status}]),r.handleParticipantChange(e,n.CONVERSATION.ADD_STREAM,l[s].uri,c);break;case n.CONVERSATION.REMOVE_STREAM:case n.CONVERSATIONSTATE.STREAM_REMOVED:case n.CONVERSATIONSTATE.STREAM_LEFT:case n.CONVERSATIONSTATE.STREAM_REJECTED:if(i)for(l=[].concat(i),a.debug("Removing participants from conversation: "+JSON.stringify(l,null,2)),s=0;s<l.length;s++)(c=l[s].streams)&&(c=c.filter(function(e){return e.stream_id===l[s].stream_id})),d&&0!==c.length||(c=[{stream_id:l[s].stream_id,stream_type:l[s].stream_type}]),r.handleParticipantChange(e,n.CONVERSATION.REMOVE_STREAM,l[s].uri,c,t[o].instruction_name===n.CONVERSATIONSTATE.STREAM_REJECTED);break;case n.CONVERSATION.BEGIN_RECORD:case n.CONVERSATIONSTATE.RECORDING_STARTED:if(i)if((l=[].concat(i)).length>0&&"*"!==l[0].uri)for(s=0;s<l.length;s++)(u=e.getParticipant(l[s].uri))?(d=u.getStreamInfo(l[s].stream_id))?(d.localSetRecording(!0),u.onParticipantStateChange&&u.onParticipantStateChange(n.CONVERSATIONSTATE.RECORDING_STARTED,d)):console.log("Failed to process instruction - no stream with id: "+l[s].stream_id+" found for participant: "+l[s].uri):console.log("Failed to process instruction - no participant found for: "+l[s].uri);else e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0);break;case n.CONVERSATION.END_RECORD:case n.CONVERSATIONSTATE.RECORDING_ENDED:if(e.localSetRecording(!1),i)if((l=[].concat(i)).length>0&&"*"!==l[0].uri)for(s=0;s<l.length;s++)(u=e.getParticipant(l[s].uri))?(d=u.getStreamInfo(l[s].stream_id))?(d.localSetRecording(!1),u.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+n.CONVERSATIONSTATE.RECORDING_ENDED),u.onParticipantStateChange(n.CONVERSATIONSTATE.RECORDING_ENDED,d))):console.log("Failed to process instruction - no stream with id: "+l[s].stream_id+" found for participant: "+l[s].uri):console.log("Failed to process instruction - no participant found for: "+l[s].uri);else e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1);break;case n.CONVERSATION.STREAM_OPTIONS:case n.CONVERSATIONSTATE.STREAM_JOINED:case n.CONVERSATIONSTATE.STREAM_CHANGED:case n.CONVERSATIONSTATE.PROFILE_UPDATED:case n.CONVERSATIONSTATE.SIDEBAR_CREATED:if(i)for(l=[].concat(i),a.debug("Updating participants in conversation: "+JSON.stringify(l,null,2)),s=0;s<l.length;s++)(c=l[s].streams)||(c=[{stream_id:l[s].stream_id,stream_type:l[s].stream_type,stream_options:l[s].stream_options,recording_status:l[s].recording_status}]),r.handleParticipantChange(e,t[o].instruction_name,l[s].uri,c);break;case n.CONVERSATIONSTATE.STREAM_ACTIVE:if(i)for(l=[].concat(i),a.debug("Processing participants in conversation: "+JSON.stringify(l,null,2)),s=0;s<l.length;s++)c=[{stream_id:l[s].stream_id,stream_type:l[s].stream_type}],r.handleParticipantChange(e,t[o].instruction_name,l[s].uri,c);break;default:a.info("Unknown conversation instruction: "+t[o].instruction_name)}}},r.doMessage=function(e,t){var i=t.header,o=i.action,c=i.conversation_key,l=i.conversation_topic,d=i.conversation_info,u=i.participant,h=i.event,g=i.relay,v=i.stream_id,p=i.stream_type,m=i.sidebar,S=null,f=!1,_=[],C=[];switch(a.debug("Have conversation message with action: "+o),v?(a.debug("Have conversation message for stream: "+v+" (type: "+p+")"),f=null!==(S=e.getStreamForId(v)),S||(S=e.getAudioVideoStream())):S=e.getAudioVideoStream(),i.instructions&&(C=[].concat(i.instructions)),i.instruction_name&&(C=[].concat({instruction_name:i.instruction_name})),h&&h.event_name&&(C=[].concat({instruction_name:h.event_name})),C&&C.length>0&&a.debug("Have conversation instructions: "+JSON.stringify(C,null,2)),h&&h.participants&&(a.debug("Have event participants: "+JSON.stringify(h.participants,null,2)),_=[].concat(h.participants)),u&&(a.debug("Have target participant: "+u+", stream: "+v+"/"+p),_=[].concat({uri:u,stream_id:v,stream_type:p})),o){case n.ACTION.COMPLETE:null===e.conversationKey&&null!==c?e.conversationKey=c:null!==e.conversationKey&&(c=e.conversationKey),a.debug("Conversation complete message with key: "+c),l&&(a.debug("Have conversation name: "+l),e.conversationTopic=l),m&&(a.debug("Have sidebar: "+m),e.sidebarId=m);for(var E=0;E<C.length;E++)switch(a.debug("Conversation message with instruction: "+C[E].instruction_name),C[E].instruction_name){case n.CONVERSATION.BEGIN_RECORD:case n.CONVERSATIONSTATE.RECORDING_STARTED:e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0)}S.call.onMessage(t),d?r.processConversationInfo(e,d):r.sendConversationEnquiry(e);break;case n.ACTION.NOTIFY:C.length>0?r.processInstructions(e,C,_):c?a.warn("Ignoring notify message with no conversation instructions"):S.call.onMessage(t);break;case n.ACTION.RELAY:e.getLocalParticipantUri();g.from&&g.from,[].concat(g.messages).forEach(function(i){r.processRelay(e,S,t,i)});break;case n.ACTION.SHUTDOWN:f&&function(i){if(!i)return a.debug("Failed to process shutdown for invalid AV stream - ending conversation"),void e.end();var o=i.getStreamState().state;if(a.debug("Processing shutdown for conversation with "+e.streams.size()+" streams, AV stream to shutdown has id: "+i.getId()+", type:"+i.getType()+", state: "+o),e.streams.size()>1)switch(o){case n.CALLSTATE.ESTABLISHED:case n.CALLSTATE.UPDATED:case n.CALLSTATE.UPDATE_FAILED:case n.CALLSTATE.ERROR:a.debug("=== (conversation) doShutdownMessage ==="),i.call.setCallState(n.CALLSTATE.ENDED,"","shutdown");try{s.clearPeerConnection(i.call),i.call.peerConnection=null}catch(e){a.error("clear peer connection error: "+e)}for(var r=i.call.localMediaStreams,c=0;c<r.length;c++){var l=r[c];a.debug("Media stream "+c+": used by "+l.peerConnectionNum+" peer connections."),l&&(null===l.peerConnectionNum||l.peerConnectionNum<=0)&&("undefined"!=typeof RTCRtpReceiver&&l instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&l instanceof RTCRtpSender?(l.track&&"video"===l.track.kind&&(a.debug("Stop this media stream: [video tracks: 1, audio tracks: 0]"),l.track.stop()),l.track&&"audio"===l.track.kind&&(a.debug("Stop this media stream: [video tracks: 0, audio tracks: 1]"),l.track.stop())):(a.debug("Stop this media stream: [video tracks: "+l.getVideoTracks().length+", audio tracks: "+l.getAudioTracks().length+"]"),l.getTracks().forEach(function(e){e.stop()})))}e.streams.remove(i.getId());var d=e.getLocalParticipant();d&&(a.debug("Remove stream from local participants: "+i.getId()),d.localRemoveStreamInfo(i.getId())),0===e.streams.size()&&e.remove();break;default:i.call.onMessage(t)}else i.call.onMessage(t)}(S);break;default:S.call.onMessage(t)}},r.processRelay=function(t,i,o,s){var c=o.header,l=c.relay,d=l.from,u=l.msgId,h=l.relayId,v=c.stream_id,p=t.getRelayForId(h);a.debug("Processing Relay: Relay message from "+d,s);var m=s.commands;if(m){var S=[].concat(m);S.length>0&&a.debug("Have relay command message: "+JSON.stringify(S,null,2)),S.forEach(function(s){a.debug("Processing relay command: "+JSON.stringify(s,null,2));var c,l,h,v=s.directive,m=new e.StreamRequest(p,v,o.isRequest(),u,d),S=[].concat(s.arguments);switch(v){case n.CONVERSATION.STREAM_OPTIONS:var f=g.createStreamOptions(S[0].audio,S[0].video);a.debug("Request to modify media direction: "+JSON.stringify(f,null,2)),i.onUpdateStreamOptions?(a.debug("Calling onUpdateStreamOptions callback with arguments: options="+JSON.stringify(f,null,2)+", streamRequest="+JSON.stringify(m,null,2)),i.onUpdateStreamOptions(t,i,m,f)):m.decline("Not implemented");break;case n.CONVERSATION.PAUSE_RESUME_STREAM:(c=S[0]).pausedBy=m.from(),a.debug((c?"Pausing":"Resuming")+" local AV stream"),i.onPauseResumeStream?(a.debug("Calling onPauseResumeStream callback with arguments: paused="+JSON.stringify(c,null,2)+", streamRequest="+JSON.stringify(m,null,2)),i.onPauseResumeStream(t,i,m,c)):m.decline("Not implemented");break;case n.CONVERSATIONSTATE.STREAM_ACTIVE:h=S[0],r.handleParticipantChange(t,n.CONVERSATIONSTATE.STREAM_ACTIVE,h.uri,h.streams);break;case n.CONVERSATION.ADD_STREAM:h=t.getLocalParticipant(),l=S[0],a.debug("Adding "+l.stream_type+" stream to local participant with options: "+l.stream_options),h.onAddStream?(a.debug("Calling onAddStream callback with arguments: type="+l.stream_type+", options="+l.stream_options+", from="+d),h.onAddStream(t,h,m,l.stream_type,l.stream_options)):m.decline("Not implemented");break;case n.CONVERSATION.REMOTE_ADD_STREAM:l=S[0],(h=t.getParticipant(d))?(a.debug("Request to add "+l.stream_type+" stream to remote participant ("+d+") with options: "+l.stream_options),h.onAddRemoteStream?(a.debug("Calling onAddRemoteStream callback with arguments: type="+l.stream_type+", options="+l.stream_options+", from="+d),h.onAddRemoteStream(t,h,m,l.stream_type,l.stream_options)):m.decline("Not implemented")):(a.debug("No remote participant - cannot handle 'remote add stream' request"),m.decline("No remote participant"));break;default:a.debug("Unknown relay command directive: "+v),t.onRelayCommand&&t.onRelayCommand(t,i,m,v,S)}})}var f=s.text;if(f){var _=[].concat(f);_.length>0&&a.debug("Have relay text message: "+JSON.stringify(_,null,2)),_.forEach(function(e){a.debug("Processing relay text: "+e);var i=e.thread,n=e.content;t.onRelayText&&t.onRelayText(t,d,i,n)})}var C=s.data;if(C){var E=[].concat(C);E.length>0&&a.debug("Have relay data message: "+JSON.stringify(E,null,2)),E.forEach(function(e){a.debug("Processing relay data: "+e);var i=e.tag,n=e.content;if(0===i.indexOf("__wsc_internal_")){if("__wsc_internal_quality_monitor_new_status__"===i){var o=t.getParticipant(d);if(o){var s=o.getStreamInfo(v);if(s){var r=s.getQualityMonitor();for(var c in n)if(n.hasOwnProperty(c)){var l=r.factorMonitors[c];"function"==typeof l&&l.call(r,n[c].value,n[c].hints)}}}}}else t.onRelayData&&t.onRelayData(t,d,i,n)})}},r.doReliableRelay=function(e,t){var i=t.header,n=i.relay,o=n.from,s=n.relayId;a.debug("doReliableRelay received relay message from: "+o+" (with id: "+s+")",t);var c=null,l=i.stream_id,d=i.stream_type,u=null;return l?(a.debug("Have reliable relay message for stream: "+l+" (type: "+d+")"),(c=e.getStreamForId(l))||(c=e.getAudioVideoStream())):c=e.getAudioVideoStream(),t.isFinalResponse()?(a.debug("Processing reliable relay final response..."),void((u=e.getRelayForId(s))&&u.processFinalResponse(t))):t.isResponse()?(a.debug("Processing reliable relay subsequent response..."),void((u=e.getRelayForId(s))&&u.processSubsequentResponse(t))):t.isError()?(a.debug("Processing reliable relay error..."),void((u=e.getRelayForId(s))&&u.processError(t))):(t.isRequest()&&(a.debug("Attempting to respond to reliable relay request..."),void 0!==(u=e.getRelayForId(s))&&null!==u||(a.debug("Creating new relay to respond to new incoming message"),u=e.createRelay(c.getId(),o,s)),a.debug("Responding to request message:"),u.respond(t)),a.debug("Iterating over relay messages..."),void[].concat(n.messages).forEach(function(i){r.processRelay(e,c,t,i)}))},r.doError=function(e,t){function i(){for(a.debug("=== doErrorMessage ==="),t.ack(e.session),m=0;m<p.length;m++){a.debug("Conversation error with instruction: "+p[m].instruction_name);var i;switch(p[m].instruction_name){case n.CONVERSATION.ADD_STREAM:h&&r.handleParticipantChange(e,n.CONVERSATION.REMOVE_STREAM,h,null);break;case n.CONVERSATION.REMOVE_STREAM:if(e.lastRemovedParticipant&&e.lastRemovedParticipant.uri===h){var c=e.lastRemovedParticipant.streams;r.handleParticipantChange(e,n.CONVERSATION.ADD_STREAM,h,c)}break;case n.CONVERSATION.BEGIN_RECORD:h&&"*"!==h?(s=e.getParticipant(h))&&((i=s.getStreamInfo(g)).localSetRecording(!1),s.onParticipantStateChange&&s.onParticipantStateChange(n.CONVERSATIONSTATE.RECORDING_ENDED,i)):(e.localSetRecording(!1),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1)),n.CONVERSATION.END_RECORD;break;case n.CONVERSATION.END_RECORD:h&&"*"!==h?(s=e.getParticipant(h))&&((i=s.getStreamInfo(g)).localSetRecording(!0),s.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+n.CONVERSATIONSTATE.RECORDING_STARTED),s.onParticipantStateChange(n.CONVERSATIONSTATE.RECORDING_STARTED,i))):(e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0))}}var l=new o.ErrorInfo(d,u);try{e.onError(l)}catch(e){a.error("Exception occurred while invoking onError callback: "+e)}}var s,c=t.header,l=c.action,d=c.error_code,u=c.reason,h=String(c.participant),g=c.stream_id,v=null,p=[],m=0;if(a.warn("Have conversation error with action: "+l+", code: "+d+" and reason: "+u),g)if(a.debug("Have conversation error for stream: "+g),v=e.getStreamForId(g)){v&&v.call&&v.call.collectClientLog(n.LOGTYPE.ERROR_LOG,n.ERRORLOG.ERROR_FROM_SERVER+":"+JSON.stringify(t));var S=v.call&&v.call.onCallError;if(S)S(new o.ErrorInfo(n.ERRORCODE.SIGNALING_ERROR,d+"/"+u))}else v=e.getAudioVideoStream();else v=e.getAudioVideoStream();switch(c.instructions&&(p=[].concat(c.instructions)),c.instruction_name&&(p=[].concat({instruction_name:c.instruction_name})),p&&p.length>0&&a.debug("Have conversation instructions: "+JSON.stringify(p,null,2)),h&&a.debug("Have target participant: "+h),l){case n.ACTION.START:v?v.call.onMessage(t):(a.error("Failed to forward error message to stream"),i());break;default:i()}},r.retrieveRecordingRules=function(e){return e.joiningConversation?(a.debug("Joining conversation, not retrieving recording rules"),!1):(a.info("Begin to retrieve recording rules",e),r.logEventTimestamp(e.session,"enquiryRequestSent"),r.sendConversationEnquiry(e),!0)},r.sendDelayedStartRequests=function(e){for(a.debug("Sending "+e.pendingAVStreams.length+" delayed start requests");e.pendingAVStreams.length>0;){var t=e.pendingAVStreams.pop();t&&r.sendStartRequest(t)}},r.sendStartRequest=function(e){var t=e.conversation;a.debug("Starting stream with key: "+t.conversationKey);var i,o=JSON.parse("{}");e.extHeaders&&(o=e.extHeaders);var s=[];if(t.joiningConversation)a.debug("Joining conversation - not adding participants");else if(t.streams.size()<=1){var r=t.getParticipants().filter(function(e){return e.uri!==t.initiator});if(r.length>0){var c=[];for(i=0;i<r.length;i++)Array.prototype.push.apply(c,r[i].asJSONArray(e.getType()));a.debug("Adding participants to conversation: "+JSON.stringify(c,null,2)),s.push({instruction_name:n.CONVERSATION.ADD_STREAM,participants:c})}}a.debug("Checking recording rules for automatic recording");var l=t.recordingRules;if(l&&t.alwaysRecordOnCreation&&!t.neverRecordOnCreation){a.info("Conversation will be recorded (with rules) "+JSON.stringify(l,null,2));var d={instruction_name:n.CONVERSATION.BEGIN_RECORD,recording_style:t.recordingStyle};if(l.participants){d.participants=[];for(var u=0;u<l.participants.length;u++)d.participants.push({uri:l.participants[u]})}l.include_associations&&(a.info("Adding associations "+l.include_associations),d.include_associations=l.include_associations),l.exclude_associations&&(a.info("Adding exclude associations "+l.exclude_associations),d.exclude_associations=l.exclude_associations),s.push(d)}else t.alwaysRecordOnCreation&&!t.neverRecordOnCreation&&(a.debug("Conversation will be recorded (without rules)"),s.push({instruction_name:n.CONVERSATION.BEGIN_RECORD,recording_style:t.recordingStyle}));if(o.instructions=s,t.conversationTopic&&(o.conversation_topic=t.conversationTopic),t.shortCircuitMode&&(o.allow_direct_calls=t.shortCircuitMode),t.conversationChannel&&(o.conversation_channel=t.conversationChannel),t.conversationKey&&(o.conversation_key=t.conversationKey),t.webContext?o.web_context=t.webContext:o.web_context={},t.clientId&&(o.web_context.clientId=t.clientId),t.clientId&&(o.web_context.clientVersion=t.clientVersion),t.sidebarId&&(o.sidebar=t.sidebarId),o.stream_id&&o.stream_type){var h=e.streamId;e.streamId=o.stream_id,e.call.streamId=o.stream_id,e.call.callState.streamId=o.stream_id,e.call.streamType=o.stream_type,h!==e.streamId&&t.updateStreamId(e,h)}else o.stream_id=e.getId(),o.stream_type=e.getType();o.stream_profile=t.getLocalParticipant().getStreamInfo(o.stream_id).getStreamProfile(),a.debug("start with extHeaders: "+JSON.stringify(o,null,2)),e.call.shortCircuitMode=t.shortCircuitMode,e.call.start(e.localMediaStreams,o)},r.sendUpdateRequest=function(e,t,i,n){a.info("Begin to update stream with streamOptions: "+JSON.stringify(t),e);var o=e.conversation.getLocalParticipant().getStreamInfo(e.getId()),s=o.getStreamOptions();o.localSetStreamOptions(t),a.debug("Updating participant stream options from: "+JSON.stringify(s,null,2)+" to: "+JSON.stringify(t,null,2));var r=JSON.parse("{}");n&&(r=n),r.stream_id=e.getId(),r.stream_type=e.getType(),r.stream_options=t.asJSON(),e.conversation.conversationKey&&(r.conversation_key=e.conversation.conversationKey),e.conversation.webContext&&(r.web_context=e.conversation.webContext),e.conversation.sidebarId&&(r.sidebar=e.conversation.sidebarId),a.debug("update with extHeaders: "+JSON.stringify(r,null,2)),e.call.shortCircuitMode=e.conversation.shortCircuitMode,e.call.update(t,i,r)},r.sendAcceptResponse=function(e,t,i,n){a.info("Begin to accept request for stream with streamOptions: "+JSON.stringify(t,null,2),e);var o=e.conversation.getLocalParticipant().getStreamInfo(e.getId());o.localSetStreamOptions(t);var s=JSON.parse("{}");n&&(s=n),s.stream_id=e.getId(),s.stream_type=e.getType(),s.stream_options=t.asJSON(),s.stream_profile=o.getStreamProfile().toJSON(),a.debug("accept with extHeaders: "+JSON.stringify(s,null,2)),e.call.shortCircuitMode=e.conversation.shortCircuitMode,e.call.accept(t,i,s)},r.sendDeclineResponse=function(t,i,n){var o=t.getStreamState().state;a.info("Begin to decline request for stream in state: "+o,t);var s=JSON.parse("{}");if(n&&(s=n),s.stream_id=t.getId(),s.stream_type=t.getType(),o===e.CALLSTATE.UPDATING){var r=t.call.lastCallConfig;a.debug("accept with incoming streamOptions and extHeaders: "+JSON.stringify(s,null,2)),t.call.accept(null,null,s),setTimeout(function(){a.debug("accept with original streamOptions: "+JSON.stringify(r,null,2)+" and extHeaders: "+JSON.stringify(s,null,2)),t.update(r,null,s)},1e3)}else a.debug("decline with code: "+i+" and extHeaders: "+JSON.stringify(s,null,2)),t.call.decline(i,s),t.conversation.remove()},r.sendEndRequest=function(e,t){if(a.info("Begin to end stream",e),e.call){var i=JSON.parse("{}");t&&(i=t),e.conversation.webContext&&(i.web_context=e.conversation.webContext),e.conversation.sidebarId&&(i.sidebar=e.conversation.sidebarId),i.stream_id=e.getId(),i.stream_type=e.getType(),a.debug("end with extHeaders: "+JSON.stringify(i,null,2));var n=e.conversation.getLocalParticipant();n&&(a.debug("Remove stream from local participants: "+e.getId()),n.localRemoveStreamInfo(e.getId())),e.call.end(i),e.conversation.streams.remove(e.getId()),0===e.conversation.streams.size()&&e.conversation.remove()}},r.sendBeginRecording=function(e,t){var i=r.conversationRequest(e),o=[{instruction_name:n.CONVERSATION.BEGIN_RECORD,recording_style:e.recordingStyle}];t?(o[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType()):(t=e.getAudioVideoStream())&&(i.header.stream_id=t.getId(),i.header.stream_type=t.getType()),i.header.instructions=o,a.debug("Sending conversation modify request to begin recording"),e.session.sendMessage(i)},r.sendEndRecording=function(e,t){var i=r.conversationRequest(e),o=[{instruction_name:n.CONVERSATION.END_RECORD}];t?(o[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType()):(t=e.getAudioVideoStream())&&(i.header.stream_id=t.getId(),i.header.stream_type=t.getType()),i.header.instructions=o,a.debug("Sending conversation modify request to end recording"),e.session.sendMessage(i)},r.sendAddParticipant=function(e,t){var i=r.conversationRequest(e),o=[{instruction_name:n.CONVERSATION.ADD_STREAM,participants:t.asJSONArray()}];t.isRecording()&&o.push({instruction_name:n.CONVERSATION.BEGIN_RECORD,recording_style:e.recordingStyle,participants:[{uri:t.getUri()}]}),i.header.instructions=o;var s=e.getAudioVideoStream();s&&(i.header.stream_id=s.getId(),i.header.stream_type=s.getType()),a.debug("Sending conversation modify request to add participant"),e.session.sendMessage(i),e.onParticipantChange&&(a.debug("Invoking onParticipantChange callback for change: "+n.CONVERSATIONSTATE.STREAM_ADDED),e.onParticipantChange(e,n.CONVERSATIONSTATE.STREAM_ADDED,t))},r.sendRemoveParticipant=function(e,t,i){var o=r.conversationRequest(e),s=[{instruction_name:n.CONVERSATION.REMOVE_STREAM}];i?(s[0].participants=[].concat({uri:i.getParticipant().getUri(),stream_id:i.getId(),stream_type:i.getType()}),o.header.stream_id=i.getId(),o.header.stream_type=i.getType()):(s[0].participants=t.asJSONArray(),(i=e.getAudioVideoStream())&&(o.header.stream_id=i.getId(),o.header.stream_type=i.getType())),o.header.instructions=s,a.debug("Sending conversation modify request to remove participant"),e.session.sendMessage(o)},r.sendRemoveAllParticipants=function(e){for(var t=r.conversationRequest(e),i=e.getParticipants(),o=[],s=0;s<i.length;s++)e.getLocalParticipantUri()!==i[s].getUri()&&Array.prototype.push.apply(o,i[s].asJSONArray());t.header.instructions=[{instruction_name:n.CONVERSATION.REMOVE_STREAM,participants:o},{instruction_name:n.CONVERSATION.END_RECORD}];var c=e.getAudioVideoStream();c&&(t.header.stream_id=c.getId(),t.header.stream_type=c.getType()),a.debug("Sending conversation modify request to remove all participants"),e.session.sendMessage(t)},r.sendProfileUpdate=function(e,t){var i=r.conversationRequest(e),o=[{instruction_name:n.CONVERSATION.UPDATE_PROFILE}];o[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType(),stream_profile:t.getStreamProfile()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType(),i.header.stream_profile=t.getStreamProfile(),i.header.instructions=o,a.debug("Sending conversation modify request to update profile"),e.session.sendMessage(i)},r.sendConversationEnquiry=function(e){var t=r.conversationRequest(e);t.header.action=n.ACTION.ENQUIRY,t.header.enquiry_data={},e.pendingTargetURI&&(t.header.enquiry_data.target=e.pendingTargetURI),e.conversationChannel&&(t.header.enquiry_data.channel=e.conversationChannel),e.webContext?t.header.enquiry_data.web_context=e.webContext:t.header.enquiry_data.web_context={},e.clientId&&(t.header.enquiry_data.web_context.clientId=e.clientId),e.clientVersion&&(t.header.enquiry_data.web_context.clientVersion=e.clientVersion),t.header.web_context=t.header.enquiry_data.web_context;var i=e.getAudioVideoStream();i&&(t.header.stream_id=i.getId(),t.header.stream_type=i.getType()),a.debug("Sending conversation enquiry request"),e.session.sendMessage(t)},r.buildRelayMsg=function(e,t,i,o){a.debug("Building relay message for: "+JSON.stringify(t,null,2));var s,c=r.conversationRequest(e);if(c.control.type=n.TYPE.MESSAGE,c.header.action=n.ACTION.RELAY,"string"==typeof t)s="*"===t?"*":[{uri:t}];else{s=[];for(var l,d=[].concat(t),u=null,h=0;h<d.length;h++)d[h]&&(l=d[h].getParticipant(),o&&(u=l.getStreamInfos().find(o)),u||(u=l.getStreamInfos()[0]),s.push({uri:l.getUri(),stream_id:u.getId(),stream_type:u.getType()}))}var g=e.getLocalParticipant(),v=null;return i&&(v=g.getStreamInfos().find(i)),v||(v=g.getStreamInfos()[0]),a.debug("Building relay message with fromStream id : "+v.getId()),c.header.relay={from:g.getUri(),messages:[{participants:s}]},c.header.stream_id=v.getId(),c.header.stream_type=v.getType(),c},r.determineRelayDestinations=function(e,t,i){var n,o=[];if(i&&a.debug("Excluding relay destination: "+i),"string"==typeof t)if("*"===t){var s=e.getParticipants();for(n=0;n<s.length;n++){var r=s[n].getUri();e.getLocalParticipantUri()===r||i&&i===r||(a.debug("- relay destination: "+r),o.push({uri:r}))}}else o=[{uri:t}];else{o=[];var c=[].concat(t);for(n=0;n<c.length;n++)c[n]&&o.push({uri:c[n].participant.uri,stream_id:c[n].id,stream_type:c[n].type})}return o},r.buildReliableRelayMsg=function(e,t){var i=e.getMessageType(),o=e.getRelay(),s=e.getId(),c=e.isFinalMessage(),l=o.getDestination();a.debug("Building reliable relay "+i+" with: msgId="+s+" and relayId="+o.getId());var d=r.buildRelayMsg(o.getConversation(),l,e.getOrigStreamOptionsCallback(),e.getDestStreamOptionsCallback());return d.control.type=i,d.header.action=n.ACTION.RELIABLE_RELAY,i===n.TYPE.MESSAGE&&(d.header.action=n.ACTION.RELAY),d.header.relay.msgId=s,d.header.relay.relayId=o.getId(),t&&e.message&&(a.debug("Resending original message with correlation_id: "+e.message.control.correlation_id),d.control.sequence=e.message.control.sequence,d.control.correlation_id=e.message.control.correlation_id),i===n.TYPE.RESPONSE&&(a.debug("  as "+(c?"final":"subsequent")+" response"),d.control.message_state=c?n.MESSAGESTATE.FINAL:n.MESSAGESTATE.SUBSEQUENT),i===n.TYPE.ERROR&&(d.header.error_code=406),e.text&&(d.header.relay.messages[0].text=e.text),e.data&&(d.header.relay.messages[0].data=e.data),e.commands&&(d.header.relay.messages[0].commands=e.commands,i===n.TYPE.ERROR&&(d.header.reason=e.commands[0].arguments[0].reason)),d},r.sendStreamOptions=function(e,t,i,o,s){var r=e.getRelayForStream(t);null===r?r=e.createRelay(t.getId(),t):a.debug("Found relay with id: "+r.getId()),r.createCommand(n.CONVERSATION.STREAM_OPTIONS,[i.asJSON()]).withCallbacks(o,s).send()},r.sendPauseResume=function(e,t,i,o,s){var r=e.getSpecificRelayForStream(t);null===r?r=e.createRelay(t.getId(),t):a.debug("Found relay with id: "+r.getId()),r.createCommand(n.CONVERSATION.PAUSE_RESUME_STREAM,[i]).withCallbacks(o,s).send()},r.sendCancelRequest=function(e,t,i,o,s){var r=e.getRelayForStream(t);null===r?console.warn("No previous command for stream",t):(a.debug("Found relay with id: "+r.getId()),r.createCommand(n.CONVERSATION.CANCEL,[{original_directive:i}]).withCallbacks(o,s).send())},r.sendAddStream=function(e,t,i,o,s,c){var l=t.getStreamInfos()[0],d=t.getUri();a.debug("sendAddStream to participant: "+d+" with type: "+i);var u=e.getRelayForStream(l);null===u?u=e.createRelay(l.getId(),l):a.debug("Found relay with id: "+u.getId());var h={stream_type:i,stream_options:o.asJSON()},g=u.createCommand(n.CONVERSATION.ADD_STREAM,[h]).withCallbacks(s,c);e.isShortCircuit()?(a.debug("Short-circuit conversation - creating sidebar before adding stream"),r.sendCreateSidebar(e),e.pendingAddStreamRelay=g):(a.debug("Sending relay to add stream"),g.send())},r.sendDelayedAddStreamRequest=function(e){a.debug("sendDelayedAddStreamRequest",e.pendingAddStreamRelay),e.pendingAddStreamRelay&&(a.debug("Sending delayed relay to add stream"),e.pendingAddStreamRelay.send(),e.pendingAddStreamRelay=null)},r.sendStreamLayout=function(e,t,i,o){if(o||(o=e.getAudioVideoStream())){var s=r.conversationRequest(e);s.header.instructions=[{instruction_name:n.CONVERSATION.STREAM_LAYOUT,participants:[{uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType(),size:i}]}],o&&(s.header.stream_id=o.getId(),s.header.stream_type=o.getType()),a.debug("Sending conversation modify request to set stream size for "+t.participant.uri),e.session.sendMessage(s)}else a.debug("Failed to set stream size for stream - invalid local AV stream",t)},r.sendCreateSidebar=function(e){var t=e.getAudioVideoStream(),i=r.conversationRequest(e);i.header.instructions=[{instruction_name:n.CONVERSATION.CREATE_SIDEBAR}],i.header.stream_id=t.getId(),i.header.stream_type=t.getType(),a.debug("Sending conversation modify request to create sidebar"),e.session.sendMessage(i)},r.conversationRequest=function(e){var t=new o.Message;return t.control.type=n.TYPE.REQUEST,t.control.subsession_id=e.subSessionId,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=e.session.lastInboundSeq,t.header.initiator=e.session.userName,t.header.action=n.ACTION.MODIFY,e.conversationKey&&(t.header.conversation_key=e.conversationKey),e.conversationTopic&&(t.header.conversation_topic=e.conversationTopic),e.sidebarId&&(t.header.sidebar=e.sidebarId),t},r.getPauseResumeTargets=function(t){var i=t.audioConfig===n.MEDIADIRECTION.NONE,o=t.videoConfig===n.MEDIADIRECTION.NONE;return new e.PauseResume(i?n.PAUSERESUME.PAUSE:n.PAUSERESUME.RESUME,o?n.PAUSERESUME.PAUSE:n.PAUSERESUME.RESUME,n.PAUSERESUMEREASON.PAUSE_RESUME)},r.logEventTimestamp=function(e,t){e.logEventTimestamp(t)},t.ConversationStateMachine=r,e.StreamInfo=g,e.AudioVideoStream=p,e.ScreenShareStream=m,e.Participant=v,e.Conversation=d,e.ConversationPackage=l,e.Connection=c,e.Relay=S,e.RelayMessage=f,e.QualityMonitor=C,e.PauseResume=u,e.StreamRequest=_,e.StreamProfile=h,console.log("conversation initialized."),e}(live||{});define("oracle.live.sdk",function(){}),define("LiveSessionStore",[],function(){"use strict";const e="OracleLive_SessionState_";return new class{constructor(){this.stateMap=new Map,window.addEventListener("beforeunload",()=>{this.saveState()})}initState(e,t){this.stateMap.set(e,t),console.log("LiveSessionStore.initState: "+e)}loadState(t,i,n){console.log("LiveSessionStore.loadState: "+t);const o=sessionStorage.getItem(e+t);o?(console.log("LiveSessionStore.loadState: found key: "+t,o),i(JSON.parse(o))):n&&n()}saveState(){console.log("LiveSessionStore.saveState"),this.stateMap.forEach((t,i)=>{console.log("LiveSessionStore.saveState: "+i),t.toJSON()?sessionStorage.setItem(e+i,t.toJSON()):sessionStorage.removeItem(e+i),"function"==typeof t.beforeUnload&&(console.log("LiveSessionStore.beforeUnload: "+i),t.beforeUnload())})}loadStateCompleted(){console.log("LiveSessionStore.loadStateCompleted"),this.stateMap.forEach((e,t)=>{"function"==typeof e.loadComplete&&(console.log("LiveSessionStore.loadStateCompleted: "+t),e.loadComplete())})}clearState(){console.log("LiveSessionStore.clearState"),this.stateMap.forEach((t,i)=>{console.log("LiveSessionStore.clearState: "+i),sessionStorage.removeItem(e+i)}),this.stateMap.clear()}}}),define("LiveService",["LiveSessionStore"],function(e){"use strict";const t=1200;return class{constructor(t){this._impl=t,this._address="https://live.oraclecloud.com",this._userID="",this._tenantID="",this._authToken=null,this._tokenRefreshInterval=null,this._language=null,this._startCallDirectly=!1,e.initState("LiveService",this),$(()=>{console.log("LiveService: Loading"),e.loadState("LiveService",e=>{this._address=e.address,this._userID=e.userID,this._tenantID=e.tenantID,this._language=e.language?e.language:null,this.__startCallDirectly=e.startCallDirectly,console.log("LiveService: Loaded")})})}toJSON(){return JSON.stringify({address:this._address,userID:this._userID,tenantID:this._tenantID,language:this._language,startCallDirectly:this._startCallDirectly})}set language(e){this._language=e}get language(){return this._language}set address(e){this._address=e}get address(){return this._address}set userID(e){this._userID=e}get userID(){return this._userID}set tenantID(e){this._tenantID=e}get tenantID(){return this._tenantID}set startCallDirectly(e){this._startCallDirectly=e}get startCallDirectly(){return this._startCallDirectly}set authToken(e){console.log("LiveService::set authToken: ",e),this._authToken=e,this._impl.updateAuthToken(this._authToken)}get authToken(){return this._authToken}authRefresh(e,i){if("function"==typeof i){e<60&&(e=t);const n=e>200?e-120:e;console.log("Will refresh token every "+n+" seconds"),this._tokenRefreshInterval&&(clearInterval(this._tokenRefreshInterval),this._tokenRefreshInterval=null),this._tokenRefreshInterval=setInterval(()=>{console.log("Refreshing auth token..."),i()},1e3*n)}else console.error("Invalid token refresh function")}isValid(){let e=!0;return null!==this._authToken&&""!==this._authToken||(console.error("Live Experience - controller.service invalid: authToken not set"),e=!1),null!==this._userID&&""!==this._userID||(console.error("Live Experience - controller.service invalid: userID not set"),e=!1),null!==this._tenantID&&""!==this._tenantID||(console.error("Live Experience - controller.service invalid: tenantID not set"),e=!1),null!==this._address&&""!==this._address||(console.error("Live Experience - controller.service invalid: address not set"),e=!1),void 0!==this._language&&""!==this._language||(console.error("Live Experience - controller.service invalid: language must be null or set",this._language),e=!1),e}}}),define("LiveContextAttributes",[],function(){"use strict";return class{constructor(e){this._impl=e,this._entries=new Map}set(e,t){this._entries.set(e,t),this._impl.sendUpdatedContextAttribute(e,t)}get(e){return this._entries.get(e)}removeAll(){this._entries.clear()}remove(e){this._entries.delete(e)}isValid(){return 0===this._entries.size&&console.error("Live Experience - controller.contextAttributes invalid: No context attributes defined"),this._entries.size>0}toJSON(){let e=Object.create(null);for(let[t,i]of this._entries)e[t]=i;return JSON.stringify(e)}toWebContext(){let e=Object.create(null);for(let[t,i]of this._entries)console.log("Create web context with",t,i),i&&"behaviours"!==t&&"messages"!==t&&(e[t]=i,console.log("Adding key"));return e}populateContext(e,t,i){this.set("browser",t),this.set("browserVersion",""+i),this.set("clientVersion",e);const n=document.URL;console.log("current URL: "+n),this.set("url",n),console.log("populateContext:",this)}}}),define("LiveSettings",["LiveSessionStore"],function(e){"use strict";return class{constructor(){this._startVideoWithFrontCamera=!1,this._startVideoInFullScreen=!1,this._hideEndCallButton=!1,this._hidePauseButton=!1,this._hideQueueLengthIndicator=!1,e.initState("LiveSettings",this),$(()=>{console.log("LiveSettings: Loading"),e.loadState("LiveSettings",e=>{this._startVideoWithFrontCamera=e.startVideoWithFrontCamera,this._startVideoInFullScreen=e.startVideoInFullScreen,this._hideEndCallButton=e.hideEndCallButton,this._hidePauseButton=e.hidePauseButton,this._hideQueueLengthIndicator=e.hideQueueLengthIndicator})})}toJSON(){return JSON.stringify({startVideoWithFrontCamera:this._startVideoWithFrontCamera,startVideoInFullScreen:this._startVideoInFullScreen,hideEndCallButton:this._hideEndCallButton,hidePauseButton:this._hidePauseButton,hideQueueLengthIndicator:this._hideQueueLengthIndicator})}reset(){this._startVideoWithFrontCamera=!1,this._startVideoInFullScreen=!1,this._hideEndCallButton=!1,this._hidePauseButton=!1,this._hideQueueLengthIndicator=!1}get startVideoWithFrontCamera(){return this._startVideoWithFrontCamera}set startVideoWithFrontCamera(e){this._startVideoWithFrontCamera=e}get startVideoInFullScreen(){return this._startVideoInFullScreen}set startVideoInFullScreen(e){this._startVideoInFullScreen=e}get hideEndCallButton(){return this._hideEndCallButton}set hideEndCallButton(e){this._hideEndCallButton=e}get hidePauseButton(){return this._hidePauseButton}set hidePauseButton(e){this._hidePauseButton=e}get hideQueueLengthIndicator(){return this._hideQueueLengthIndicator}set hideQueueLengthIndicator(e){this._hideQueueLengthIndicator=e}}}),define("LiveApiVersion",[],function(){"use strict";return class{constructor(){this.TEST_VERSION="99.12",this.LATEST_KNOWN_RELEASE="19.11",this.COMMIT_BRANCH="support/19.11.2",this.COMMIT_HASH="66603d972d1f37e61f88c512e6016248cc7cd18a",this.BUILD_TAG="heads/support/19.11.2",this.appVersion=null}get version(){if(!this.appVersion){console.log("build info: "+this.buildInfo);const e=this.buildTag,t=e.lastIndexOf("/");this.appVersion=t>-1?e.substring(t+1):e,console.log("appVersion="+this.appVersion)}return this.appVersion&&"UNKNOWN_BRANCH"!==this.appVersion||(this.appVersion=this.LATEST_KNOWN_RELEASE),this.appVersion}get commitBranch(){return this.COMMIT_BRANCH}get commitHash(){return this.COMMIT_HASH}get buildTag(){let e=this.BUILD_TAG;return"unknown"!==e&&-1===e.indexOf("BUILD_TAG")||"unknown"!==(e=this.COMMIT_BRANCH)&&-1===e.indexOf("COMMIT_BRANCH")||(e=this.TEST_VERSION),e}get buildInfo(){const e=this.buildTag,t=""!==e?" @ "+e:"";return this.commitHash+" : "+this.commitBranch+t}}}),define("LiveEvents",[],function(){"use strict";const e={LiveConnecting:"LiveConnecting",LiveCanceled:"LiveCanceled",LiveConnected:"LiveConnected",LiveStreamError:"LiveStreamError",LiveEnded:"LiveEnded",LiveLoginSuccess:"LiveLoginSuccess",LiveLoginError:"LiveLoginError",LiveStartCall:"LiveStartCall",LiveStateReloaded:"LiveStateReloaded",LiveWaiting:"LiveWaiting",LiveConnectingNoAnswer:"LiveConnectingNoAnswer",LivePausedLocally:"LivePausedLocally",LiveResumedLocally:"LiveResumedLocally",LiveRatingRequired:"LiveRatingRequired",LiveRatingCompleted:"LiveRatingCompleted",LiveParticipantLeft:"LiveParticipantLeft",LiveStreamActive:"LiveStreamActive",LiveReconnectingRemote:"LiveReconnectingRemote",LiveReconnectedRemote:"LiveReconnectedRemote",LiveRecordingStarted:"LiveRecordingStarted",LiveRecordingStopped:"LiveRecordingStopped",LivePausedRemotely:"LivePausedRemotely",LiveResumedRemotely:"LiveResumedRemotely",LiveReconnectingLocal:"LiveReconnectingLocal",LiveReconnectedLocal:"LiveReconnectedLocal",LiveStartVideoRequested:"LiveStartVideoRequested",LiveStartVideoRequestCancelled:"LiveStartVideoRequestCancelled",LiveStartScreenShareRequested:"LiveStartScreenShareRequested",LiveStartScreenShareRequestCancelled:"LiveStartScreenShareRequestCancelled",LiveScreenSharePluginRequired:"LiveScreenSharePluginRequired",LiveScreenSharePluginInstalling:"LiveScreenSharePluginInstalling",LiveScreenSharePluginInstalled:"LiveScreenSharePluginInstalled",LiveSystemScreenShareDialogShowing:"LiveSystemScreenShareDialogShowing",LiveSystemScreenShareDialogRemoved:"LiveSystemScreenShareDialogRemoved",LiveRemoteVideoStarted:"LiveRemoteVideoStarted",LiveRemoteVideoStopped:"LiveRemoteVideoStopped",LiveRemoteVideoLoading:"LiveRemoteVideoLoading",LiveRemoteVideoLoaded:"LiveRemoteVideoLoaded",LiveLocalVideoStarted:"LiveLocalVideoStarted",LiveLocalVideoStopped:"LiveLocalVideoStopped",LiveNetworkPoor:"LiveNetworkPoor",LiveNetworkNormal:"LiveNetworkNormal",LiveRemoteScreenShareRequested:"LiveRemoteScreenShareRequested",LiveRemoteScreenShareCancelled:"LiveRemoteScreenShareCancelled",LiveLocalScreenStarted:"LiveLocalScreenStarted",LiveLocalScreenStopped:"LiveLocalScreenStopped",LiveRemoteScreenStarted:"LiveRemoteScreenStarted",LiveRemoteScreenStopped:"LiveRemoteScreenStopped",LiveRemoteScreenActive:"LiveRemoteScreenActive",LiveDiagnosticsAudioVideoStarted:"LiveDiagnosticsAudioVideoStarted",LiveDiagnosticsAudioStarted:"LiveDiagnosticsAudioStarted",LiveDiagnosticsComplete:"LiveDiagnosticsComplete",LiveDiagnosticsFailed:"LiveDiagnosticsFailed",LiveScreenShareAnnotationStarted:"LiveScreenShareAnnotationStarted",LiveScreenShareAnnotationStopped:"LiveScreenShareAnnotationStopped",LiveAssociateAnnotationStarted:"LiveAssociateAnnotationStarted",LiveAssociateAnnotationStopped:"LiveAssociateAnnotationStopped",LiveAssociateAnnotationReceived:"LiveAssociateAnnotationReceived",LiveAssociateVideoAnnotationStarted:"LiveAssociateVideoAnnotationStarted",LiveAssociateVideoAnnotationStopped:"LiveAssociateVideoAnnotationStopped",LiveAssociateFreezeCustomerStream:"LiveAssociateFreezeCustomerStream",LiveAssociateUnfreezeCustomerStream:"LiveAssociateUnfreezeCustomerStream",LiveAssociateVideoAnnotationReceived:"LiveAssociateVideoAnnotationReceived",LiveMessageEmitted:"LiveMessageEmitted",LivePreCallIDCheckStarted:"LivePreCallIDCheckStarted",LivePreCallIDCheckComplete:"LivePreCallIDCheckComplete",LivePreCallIDCheckError:"LivePreCallIDCheckError",LiveStartVerificationCall:"LiveStartVerificationCall",LiveCallQueuePositionUpdate:"LiveCallQueuePositionUpdate",LiveAssociateTransferStarted:"LiveAssociateTransferStarted",LiveAssociateTransferStartStream:"LiveAssociateTransferStartStream",LiveAssociateTransferCompleted:"LiveAssociateTransferCompleted",LiveAssociateTransferFailed:"LiveAssociateTransferFailed",LiveAssociateTransferStopped:"LiveAssociateTransferStopped"};return Object.freeze(e),e}),define("LiveExposedEvents",["LiveEvents"],function(e){"use strict";return[e.LiveConnecting,e.LiveConnected,e.LiveCanceled,e.LiveEnded,e.LiveStreamError]}),define("text",["module"],function(e){"use strict";var t,i,n,o,s,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],r=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,c=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,l="undefined"!=typeof location&&location.href,d=l&&location.protocol&&location.protocol.replace(/\:/,""),u=l&&location.hostname,h=l&&(location.port||void 0),g={},v=e.config&&e.config()||{};function p(e,t){return void 0===e||""===e?t:e}return t={version:"2.0.15",strip:function(e){if(e){var t=(e=e.replace(r,"")).match(c);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:v.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;t<3;t+=1){i=a[t];try{e=new ActiveXObject(i)}catch(e){}if(e){a=[i];break}}return e},parseName:function(e){var t,i,n,o=!1,s=e.lastIndexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==s&&(!a||s>1)?(t=e.substring(0,s),i=e.substring(s+1)):t=e,-1!==(s=(n=i||t).indexOf("!"))&&(o="strip"===n.substring(s+1),n=n.substring(0,s),i?i=n:t=n),{moduleName:t,ext:i,strip:o}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,n,o){var s,a,r,c=t.xdRegExp.exec(e);return!c||(s=c[2],r=(a=(a=c[3]).split(":"))[1],a=a[0],(!s||s===i)&&(!a||a.toLowerCase()===n.toLowerCase())&&(!r&&!a||function(e,t,i,n){if(t===n)return!0;if(e===i){if("http"===e)return p(t,"80")===p(n,"80");if("https"===e)return p(t,"443")===p(n,"443")}return!1}(s,r,i,o)))},finishLoad:function(e,i,n,o){n=i?t.strip(n):n,v.isBuild&&(g[e]=n),o(n)},load:function(e,i,n,o){if(o&&o.isBuild&&!o.inlineText)n();else{v.isBuild=o&&o.isBuild;var s=t.parseName(e),a=s.moduleName+(s.ext?"."+s.ext:""),r=i.toUrl(a),c=v.useXhr||t.useXhr;0!==r.indexOf("empty:")?!l||c(r,d,u,h)?t.get(r,function(i){t.finishLoad(e,s.strip,i,n)},function(e){n.error&&n.error(e)}):i([a],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,n)}):n()}},write:function(e,i,n,o){if(g.hasOwnProperty(i)){var s=t.jsEscape(g[i]);n.asModule(e+"!"+i,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,i,n,o,s){var a=t.parseName(i),r=a.ext?"."+a.ext:"",c=a.moduleName+r,l=n.toUrl(a.moduleName+r)+".js";t.load(c,n,function(i){var n=function(e){return o(l,e)};n.asModule=function(e,t){return o.asModule(e,l,t)},t.write(e,c,n,s)},s)}},"node"===v.env||!v.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(i=require.nodeRequire("fs"),t.get=function(e,t,n){try{var o=i.readFileSync(e,"utf8");"\ufeff"===o[0]&&(o=o.substring(1)),t(o)}catch(e){n&&n(e)}}):"xhr"===v.env||!v.env&&t.createXhr()?t.get=function(e,i,n,o){var s,a=t.createXhr();if(a.open("GET",e,!0),o)for(s in o)o.hasOwnProperty(s)&&a.setRequestHeader(s.toLowerCase(),o[s]);v.onXhr&&v.onXhr(a,e),a.onreadystatechange=function(t){var o,s;4===a.readyState&&((o=a.status||0)>399&&o<600?((s=new Error(e+" HTTP status: "+o)).xhr=a,n&&n(s)):i(a.responseText),v.onXhrComplete&&v.onXhrComplete(a,e))},a.send(null)}:"rhino"===v.env||!v.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,n,o=new java.io.File(e),s=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(o),"utf-8")),r="";try{for(i=new java.lang.StringBuffer,(n=a.readLine())&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),null!==n&&i.append(n);null!==(n=a.readLine());)i.append(s),i.append(n);r=String(i.toString())}finally{a.close()}t(r)}:("xpconnect"===v.env||!v.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(n=Components.classes,o=Components.interfaces,Components.utils.import("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in n,t.get=function(e,t){var i,a,r,c={};s&&(e=e.replace(/\//g,"\\")),r=new FileUtils.File(e);try{(i=n["@mozilla.org/network/file-input-stream;1"].createInstance(o.nsIFileInputStream)).init(r,1,0,!1),(a=n["@mozilla.org/intl/converter-input-stream;1"].createInstance(o.nsIConverterInputStream)).init(i,"utf-8",i.available(),o.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),a.readString(i.available(),c),a.close(),i.close(),t(c.value)}catch(e){throw new Error((r&&r.path||"")+": "+e)}}),t}),define("text!oracle.live.button.html",[],function(){return'\x3c!--\n  ~ Copyright (c) 2018 Oracle. All rights reserved.\n  ~\n  ~ This material is the confidential property of Oracle Corporation or its\n  ~ licensors and may be used, reproduced, stored or transmitted only in\n  ~ accordance with a valid Oracle license or sublicense agreement.\n--\x3e\n\n<div class="oracle-live">\n  <div class="oracle-live-menu">\n    <div class="oracle-live-menu-leftspacer" role="presentation"></div>\n    <div class="oracle-live-pause-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"/>\n    </div>\n    <div class="oracle-live-video-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"/>\n    </div>\n    <div class="oracle-live-screenshare-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"/>\n    </div>\n    <div class="oracle-live-annotate-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"/>\n    </div>\n    <div class="oracle-live-exit-button" role="button" tabindex=0>\n      <div class="oracle-live-exitbutton-icon" role="presentation"/>\n    </div>\n    <div class="oracle-live-menu-rightspacer" role="presentation"></div>\n  </div>\n  <div role="application" class="oracle-live-cancel-rejoin-buttons">\n    <div class="oracle-live-cancel-button" role="button" tabindex=0></div>\n    <div class="oracle-live-rejoin-button" role="button" tabindex=0></div>\n  </div>\n  <div class="oracle-live-main-button" role="button" tabindex=0>\n    <div class="oracle-live-mainbutton-spinner"></div>\n    <div class="oracle-live-mainbutton-icon" role="presentation"></div>\n    <span class="oracle-live-initials"></span>\n    <img class="oracle-live-agent-image" src=""/>\n    <div class="oracle-live-mainbutton-badge"></div>\n  </div>\n  <div class="oracle-live-callinfo">\n    <div class="oracle-live-callinfo-icon">\n      <span class="oracle-live-associate oracle-live-callinfo-associate"></span>\n    </div>\n    <div role="recindicator" class="oracle-live-recording oracle-live-callinfo-recording">Rec</div>\n    <label class="oracle-live-duration-label"></label>\n    <span role="timer" class="oracle-live-callinfo-timer">00:00</span>\n  </div>\n  <div class="oracle-live-call-queue-info">\n    <label class="oracle-live-position-in-queue-label"></label>\n    <span class="oracle-live-position-in-queue"></span>\n  </div>\n  <div class="oracle-live-popmessage" role="status">\n    <div role="alert" class="oracle-live-popmessage-text"></div>\n    <div class="oracle-live-popmessage-shortcode">ABCDEF</div>\n  </div>\n  <div role="alert" class="oracle-live-notificationmessage">\n    <span role="presentation"></span>\n    <div class="oracle-live-notification"></div>\n    <div role="button" tabindex=0></div>\n  </div>\n  <div role="alert" class="oracle-live-dialog">\n    <div class="oracle-live-dialog-title" role="heading"></div>\n    <div class="oracle-live-dialog-message" role="note"></div>\n    <div class="oracle-live-dialog-feedback">\n      <div id="oracle-live-dialog-question" class="oracle-live-dialog-question"></div>\n      <div class="oracle-live-dialog-options" role="radiogroup" aria-labelledby="oracle-live-dialog-question">\n        <div class="oracle-live-dialog-option-poor oracle-live-label-ellipsis" \n             role="radio" \n             aria-checked="false"\n             tabindex=0>\n          <div role="presentation"/>\n          <label/>\n        </div>\n        <div class="oracle-live-dialog-option-good oracle-live-label-ellipsis" \n             role="radio" \n             aria-checked="false"\n             tabindex=-1>\n          <div role="presentation"/>\n          <label/>\n        </div>\n        <div class="oracle-live-dialog-option-excellent oracle-live-label-ellipsis"\n             role="radio" \n             aria-checked="false"\n             tabindex=-1>\n          <div role="presentation"/>\n          <label/>\n        </div>\n      </div>\n    </div>\n    <div role="application" class="oracle-live-dialog-buttons">\n      <div role="button" tabindex=0 class="oracle-live-dialog-cancel oracle-live-label-ellipsis"></div>\n      <div role="button" tabindex=0 class="oracle-live-dialog-ok oracle-live-label-ellipsis"></div>\n    </div>\n  </div>\n\n  \x3c!-- audio and video tags --\x3e\n  <div id="oracle-live-audio" class="oracle-live-audio">\n    <audio id="oracle-live-local-audio" class="oracle-live-local-audio" autoplay muted preload="metadata"></audio>\n    <audio id="oracle-live-remote-audio" class="oracle-live-remote-audio" autoplay preload="metadata"></audio>\n    <audio id="connectingAudio" preload="auto">\n      <source src="" type="audio/wav" loop="true">\n    </audio>\n  </div>\n\n  <div class="oracle-live-audio-panel">\n    <div>\n      <div role="heading"></div>\n      <div role="timer">00:00</div>\n      <div role="recindicator" class="oracle-live-recording">Rec</div>\n    </div>\n    <div class="oracle-live-video-pause-graphic">\n    </div>\n    <span class="oracle-live-audio-panel-message"></span>\n    <hr/>\n  </div>\n\n   <div class="oracle-live-video-panel oracle-live-screenshare-panel-enduser">\n      <div class="oracle-live-video-pause-graphic">\n      </div>\n      <video id="oracle-live-local-screenshare" class="oracle-live-local-screenshare"\n             autoplay muted playsinline preload="metadata"></video>\n  </div>\n\n  \x3c!-- This is where you connect the local video (customer camera) --\x3e\n  \x3c!-- TODO: I just want one of these which we clone twice --\x3e\n  <div class="oracle-live-video-panel oracle-live-video-panel-enduser">\n   <div class="oracle-live-video-pause-graphic">\n   </div>\n    <div class="oracle-live-call-queue-info">\n      <label class="oracle-live-position-in-queue-label"></label>\n      <span class="oracle-live-position-in-queue"></span>\n    </div>\n    <div class="oracle-live-video-no-connection-graphic">\n   </div>\n    <video id="oracle-live-local-video" class="oracle-live-local-video"\n           autoplay muted playsinline preload="metadata"></video>\n    <div role="presentation"></div>\n    <div role="presentation"></div>\n    <div role="application" class="oracle-live-video-buttons-preview">\n      <div role="button" tabindex=0 class="oracle-live-preview-start-button"></div>\n      <div role="button" tabindex=0 class="oracle-live-preview-cancel-button"></div>\n    </div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-enduser">\n      <div name="endUserVideo" class="oracle-live-video-maximize oracle-live-video-toolbar-enduser" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-associate-maximized-title"></div>\n      <div role="recindicator" class="oracle-live-recording oracle-live-video-toolbar-recording">Rec</div>\n      <div role="timer" class="oracle-live-video-toolbar-timer">00:00</div>\n      <div name="swapCamera" class="oracle-live-swap-camera oracle-live-hide-camera-swap-button" role="button" tabindex="0"></div>\n    </div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-enduser-unfreeze" style="top: 44px; background-color: transparent;">\n      <div tabindex="0" role="main" class="oracle-live-unfreeze-annotation-camera">\n        <div name="unfreezeAnnotationCamera" class="oracle-live-unfreeze-annotation-camera" role="button"></div>\n      </div>\n      <div name="unfreezeAnnotationCross" class="oracle-live-unfreeze-annotation-cross" role="button" tabindex=0></div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div role="heading"></div>\n    <div class="oracle-live-video-panel-message"></div>\n    <canvas class="oracle-live-annotation-video-canvas"></canvas>\n  </div>\n\n  \x3c!-- This is where you connect the remote video (associate camera) --\x3e\n  <div class="oracle-live-video-panel oracle-live-video-panel-associate">\n    <div class="oracle-live-video-pause-graphic">\n    </div>\n    <div class="oracle-live-video-no-connection-graphic">\n    </div>\n    <video id="oracle-live-remote-video" class="oracle-live-remote-video"\n           autoplay playsinline preload="metadata"></video>\n    <div role="presentation"></div>\n    <div role="presentation"></div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-associate">\n      <div name="associateVideo" class="oracle-live-video-maximize oracle-live-video-toolbar-associate" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-associate-maximized-title oracle-live-video-toolbar-associate"></div>\n      <div role="recindicator" class="oracle-live-recording oracle-live-video-toolbar-recording oracle-live-video-toolbar-associate">Rec</div>\n      <div role="timer" class="oracle-live-video-toolbar-timer oracle-live-video-toolbar-associate">00:00</div>\n      <div name="swapCamera" class="oracle-live-swap-camera" role="button" tabindex="0"></div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div class="oracle-live-video-panel-message"></div>\n    <div role="progressbar" class="oracle-live-video-loading-spinner"></div>\n  </div>\n\n  \x3c!-- This is where you connect the remote screenshare video (associate screenshare) --\x3e\n  <div class="oracle-live-video-panel oracle-live-screenshare-panel-associate">\n    <div class="oracle-live-video-pause-graphic">\n    </div>\n    <div class="oracle-live-video-no-connection-graphic">\n    </div>\n    <div class="oracle-live-video-scroller">\n      <video id="oracle-live-remote-screenshare" class="oracle-live-remote-screenshare"\n             autoplay muted playsinline preload="metadata"></video>\n    </div>\n    <div role="presentation"></div>\n    <div role="presentation"></div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-screenshare">\n      <div name="associateScreenShare" class="oracle-live-video-maximize oracle-live-video-toolbar-screenshare" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-associate-maximized-title oracle-live-video-toolbar-screenshare"></div>\n      <div role="recindicator" class="oracle-live-recording oracle-live-video-toolbar-recording oracle-live-video-toolbar-screenshare">Rec</div>\n      <div role="timer" class="oracle-live-video-toolbar-timer oracle-live-video-toolbar-screenshare">00:00</div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div class="oracle-live-video-panel-message"></div>\n  </div>\n\n  <div class="oracle-live-video-buttons-zoom">\n    <div role="button" tabindex=0 class="oracle-live-video-zoomin-button"></div>\n    <div role="button" tabindex=0 class="oracle-live-video-default-button" aria-disabled=true></div>\n    <div role="button" tabindex=0 class="oracle-live-video-zoomout-button" aria-disabled=true></div>\n  </div>\n  <canvas class="oracle-live-annotation-canvas"></canvas>\n  <canvas id="screen-share-arriving" class="oracle-live-screen-share-canvas"></canvas>\n\n  \x3c!-- This is where we show the Jumio ID Verification screens in an iframe. --\x3e\n  <div class="oracle-live-know-your-customer">\n    <iframe id="kyc-iframe" class="kyc-jumio-iframe"\n      src=""\n      allow="camera">\n    </iframe>\n  </div>\n\n  \x3c!-- This is where we display the preCallIDCheck verifying screens. --\x3e\n  <div class="oracle-live-verification-panel oracle-live-verification-identity">\n    <div role="toolbar">\n      <div name="kyc-verifying" class="oracle-live-verification-close" role="button" tabindex="0"></div>\n    </div>\n    <div class="oracle-live-verification-container">\n      <div class="oracle-live-verification-image oracle-live-verification-verifying-image"></div>\n      <div class="oracle-live-verification-heading" role="heading">Verifying Identity</div>\n      <div class="oracle-live-verification-message" role="message">This process can take up to 4 minutes.</div>\n      <div role="progressbar" class="oracle-live-verification-spinner"></div>\n    </div>\n  </div>\n\n  <div class="oracle-live-verification-panel oracle-live-verification-success">\n    <div class="oracle-live-verification-container">\n      <div class="oracle-live-verification-image oracle-live-verification-success-image"></div>\n      <div class="oracle-live-verification-heading" role="heading">Verification Complete</div>\n      <div class="oracle-live-verification-message" role="message">\n        Congratulations! You have completed the process of verifying your ID.\n      </div>\n      <div class="oracle-live-verification-success-button" role="button"\n           title="Continue" aria-disabled="false">Continue</div>\n    </div>\n  </div>\n\n  <div class="oracle-live-verification-panel oracle-live-verification-failed">\n    <div class="oracle-live-verification-container">\n      <div class="oracle-live-verification-image oracle-live-verification-failed-image"></div>\n      <div class="oracle-live-verification-heading" role="heading">Verification Failed</div>\n      <div class="oracle-live-verification-message" role="message">\n        We were unable to verify your ID. You can try again using a different form of identification.\n      </div>\n      <div class="oracle-live-verification-try-again-button" role="button"\n           title="Continue" aria-disabled="false">Try Again</div>\n    </div>\n  </div>\n\n  <div class="oracle-live-verification-panel oracle-live-verification-verified">\n    <div role="toolbar">\n      <div name="kyc-verifying" class="oracle-live-verification-close" role="button" tabindex="0"></div>\n    </div>\n    <div class="oracle-live-verification-container">\n      <div class="oracle-live-verification-image oracle-live-verification-almost-done-image"></div>\n      <div class="oracle-live-verification-heading" role="heading">Almost Done</div>\n      <div class="oracle-live-verification-message" role="message">\n        We just need to have a quick video call with you to complete the verification process.\n      </div>\n      <div class="oracle-live-verification-continue-button" role="button"\n           title="Continue" aria-disabled="false">Continue</div>\n    </div>\n  </div>\n\n\n</div>\n'}),define("LiveCallTimer",["LiveSessionStore"],function(e){"use strict";class t{constructor(){this._timer=null,this._restartTimer=!1,this._now=0,this._startTime=0,e.initState("LiveCallTimer",this),$(()=>{console.log("LiveCallTimer: Loading"),e.loadState("LiveCallTimer",e=>{if(this._startTime=e.startTime,e.timer){this._restartTimer=!0,this._now=this.getTimeNow();const e=t.formatDuration(this._startTime,this._now);$(".oracle-live [role='timer']").each(function(){$(this).text(e)})}console.log("LiveCallTimer: Loaded, startTime="+this._startTime)})})}toJSON(){return JSON.stringify({startTime:this._startTime,timer:this._timer})}loadComplete(){console.log("LiveCallTimer: Load complete, restartTimer="+this._restartTimer),this._restartTimer&&this.resumeTimer()}static formatDuration(e,t){let i=Math.floor(t-e);const n=Math.floor(i/3600);i=Math.floor(i-3600*n);const o=Math.floor(i/60),s=Math.floor(i-60*o),a=(e,t,i)=>(new Array(i+1).join(t)+e).slice(-i);return(n>0?a(n,"",2)+":":"")+(o>0?a(o,"0",2):"00")+":"+a(s,"0",2)}startTimer(){this._timer&&this.stopTimer(),this._startTime=this.getTimeNow(),this.resumeTimer()}resumeTimer(){this._timer=setInterval(()=>{this._now=this.getTimeNow();const e=t.formatDuration(this._startTime,this._now);$(".oracle-live [role='timer']").each(function(){$(this).text(e)})},1e3),console.log("Started timer... startTime="+this._startTime,this._timer)}stopTimer(){console.log("Stopping timer...",this._timer),this._timer&&(clearInterval(this._timer),this._timer=null)}resetTimer(){console.log("Resetting timer"),$(".oracle-live [role='timer']").each(function(){$(this).text("00:00")}),this._startTime=0,this.stopTimer()}getTimeNow(){return Math.floor(Date.now()/1e3)}}return t}),define("LiveIconColours",[],function(){"use strict";return class{_hex2dec(e){let t=parseInt(e,16);return isNaN(t)&&(t=-2),t}_hex2rgba(e){console.log("_hex2rgba: incoming",e);let t=[-1,-1,-1,-1],i=!0;if(e)switch(e.length){case 4:case 5:t[0]=this._hex2dec("0x"+e[1]+e[1]),t[1]=this._hex2dec("0x"+e[2]+e[2]),t[2]=this._hex2dec("0x"+e[3]+e[3]),5===e.length&&(t[3]=this._hex2dec("0x"+e[4]+e[4]));break;case 7:case 9:t[0]=this._hex2dec("0x"+e[1]+e[2]),t[1]=this._hex2dec("0x"+e[3]+e[4]),t[2]=this._hex2dec("0x"+e[5]+e[6]),9===e.length&&(t[3]=this._hex2dec("0x"+e[7]+e[8]));break;default:i=!1}return!i||-2!==t[0]&&-2!==t[1]&&-2!==t[2]&&-2!==t[3]||(i=!1),i||(console.log("_hex2rgba: returning null"),t=null),console.log("_hex2rgba: returning",t),t}constructor(){this._mainButtonInitial=null,this._mainButtonInitial_rgba=[-1,-1,-1,-1],this._mainButtonInitialInverse=null,this._mainButtonInitialInverse_rgba=[-1,-1,-1,-1],this._mainButtonInline=null,this._mainButtonInline_rgba=[-1,-1,-1,-1],this._menuButtonDefault=null,this._menuButtonDefault_rgba=[-1,-1,-1,-1],this._menuButtonInverse=null,this._menuButtonInverse_rgba=[-1,-1,-1,-1],this._menuButtonDisabled=null,this._menuButtonDisabled_rgba=[-1,-1,-1,-1],this._menuEndButtonDefault=null,this._menuEndButtonDefault_rgba=[-1,-1,-1,-1],this._menuEndButtonInverse=null,this._menuEndButtonInverse_rgba=[-1,-1,-1,-1],this._maximizedTopBar=null,this._maximizedTopBar_rgba=[-1,-1,-1,-1],this._callInfoIcon=null,this._callInfoIcon_rgba=[-1,-1,-1,-1]}restoreAll(e){this.mainButtonInitial=e._mainButtonInitial,this.mainButtonInitialInverse=e._mainButtonInitialInverse,this.mainButtonInline=e._mainButtonInline,this.menuButtonDefault=e._menuButtonDefault,this.menuButtonInverse=e._menuButtonInverse,this.menuButtonDisabled=e._menuButtonDisabled,this.menuEndButtonDefault=e._menuEndButtonDefault,this.menuEndButtonInverse=e._menuEndButtonInverse,this.maximizedTopBar=e._maximizedTopBar,this.callInfoIcon=e._callInfoIcon}get mainButtonInitial(){return this._mainButtonInitial}set mainButtonInitial(e){this._mainButtonInitial=e,this._mainButtonInitial_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInitial_rgba",{value:this._mainButtonInitial_rgba})}get mainButtonInitialInverse(){return this._mainButtonInitialInverse}set mainButtonInitialInverse(e){this._mainButtonInitialInverse=e,this._mainButtonInitialInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInitialInverse_rgba",{value:this._mainButtonInitialInverse_rgba})}get mainButtonInline(){return this._mainButtonInline}set mainButtonInline(e){this._mainButtonInline=e,this._mainButtonInline_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInline_rgba",{value:this._mainButtonInline_rgba})}get menuButtonDefault(){return this._menuButtonDefault}set menuButtonDefault(e){this._menuButtonDefault=e,this._menuButtonDefault_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonDefault_rgba",{value:this._menuButtonDefault_rgba})}get menuButtonInverse(){return this._menuButtonInverse}set menuButtonInverse(e){this._menuButtonInverse=e,this._menuButtonInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonInverse_rgba",{value:this._menuButtonInverse_rgba})}get menuButtonDisabled(){return this._menuButtonDisabled}set menuButtonDisabled(e){this._menuButtonDisabled=e,this._menuButtonDisabled_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonDisabled_rgba",{value:this._menuButtonDisabled_rgba})}get menuEndButtonDefault(){return this._menuEndButtonDefault}set menuEndButtonDefault(e){this._menuEndButtonDefault=e,this._menuEndButtonDefault_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuEndButtonDefault_rgba",{value:this._menuEndButtonDefault_rgba})}get menuEndButtonInverse(){return this._menuEndButtonInverse}set menuEndButtonInverse(e){this._menuEndButtonInverse=e,this._menuEndButtonInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuEndButtonInverse_rgba",{value:this._menuEndButtonInverse_rgba})}get maximizedTopBar(){return this._maximizedTopBar}set maximizedTopBar(e){this._maximizedTopBar=e,this._maximizedTopBar_rgba=this._hex2rgba(e),Object.defineProperty(this,"maximizedTopBar_rgba",{value:this._maximizedTopBar_rgba})}get callInfoIcon(){return this._callInfoIcon}set callInfoIcon(e){this._callInfoIcon=e,this._callInfoIcon_rgba=this._hex2rgba(e),Object.defineProperty(this,"callInfoIcon_rgba",{value:this._callInfoIcon_rgba})}}}),define("LiveScenarioCustomization",["LiveIconColours"],function(e){"use strict";return class{constructor(t){if(this.pinnedTo=null,this.verticalMargin=null,this.horizontalMargin=null,this.iconColours=new e,this.mainButtonInitialBackgroundColour=null,this.mainButtonInitialInverseBackgroundColour=null,this.mainButtonInlineBackgroundColour=null,this.mainButtonInlineFontColour=null,this.initialMessageBackgroundColour=null,this.initialMessageFontColour=null,this.infoPanelBackgroundColour=null,this.infoPanelFontColour=null,this.maximizedTopBarBackgroundColour=null,this.maximizedTopBarFontColour=null,this.buttonBarBackgroundColour=null,this.menuButtonDefaultBackgroundColour=null,this.menuButtonActiveBackgroundColour=null,this.menuButtonDisabledBackgroundColour=null,this.menuEndButtonDefaultBackgroundColour=null,this.menuEndButtonActiveBackgroundColour=null,this.dialogPrimaryButtonBackgroundColour=null,this.dialogPrimaryButtonBorderColour=null,this.dialogPrimaryButtonFontColour=null,this.dialogPrimaryButtonInverseBackgroundColour=null,this.dialogPrimaryButtonInverseBorderColour=null,this.dialogPrimaryButtonInverseFontColour=null,this.dialogSecondaryButtonBackgroundColour=null,this.dialogSecondaryButtonBorderColour=null,this.dialogSecondaryButtonFontColour=null,this.dialogSecondaryButtonInverseBackgroundColour=null,this.dialogSecondaryButtonInverseBorderColour=null,this.dialogSecondaryButtonInverseFontColour=null,t){if(console.log("Incoming customization:",t),t.iconColours&&this.iconColours.restoreAll(t.iconColours),t.position){const e=t.position;e.pinnedTo&&(this.pinnedTo=e.pinnedTo),e.verticalMargin&&(this.verticalMargin=e.verticalMargin),e.horizontalMargin&&(this.horizontalMargin=e.horizontalMargin)}else this.pinnedTo=t.pinnedTo?t.pinnedTo:null,this.verticalMargin=t.verticalMargin>=0?t.verticalMargin:null,this.horizontalMargin=t.horizontalMargin>=0?t.horizontalMargin:null;if(t.mainButton){const e=t.mainButton;if(e.initial&&e.initial.colors){const t=e.initial.colors;t.background&&(this.mainButtonInitialBackgroundColour=t.background),t.icon&&(this.iconColours.mainButtonInitial=t.icon)}if(e.initial&&e.initial.inverse){const t=e.initial.inverse;t.background&&(this.mainButtonInitialInverseBackgroundColour=t.background),t.icon&&(this.iconColours.mainButtonInitialInverse=t.icon)}if(e.inline&&e.inline.colors){const t=e.inline.colors;t.background&&(this.mainButtonInlineBackgroundColour=t.background),t.font&&(this.mainButtonInlineFontColour=t.font),t.icon&&(this.iconColours.mainButtonInline=t.icon)}}else this.mainButtonInitialBackgroundColour=t.mainButtonInitialBackgroundColour?t.mainButtonInitialBackgroundColour:null,this.mainButtonInitialInverseBackgroundColour=t.mainButtonInitialInverseBackgroundColour?t.mainButtonInitialInverseBackgroundColour:null,this.mainButtonInlineBackgroundColour=t.mainButtonInlineBackgroundColour?t.mainButtonInlineBackgroundColour:null,this.mainButtonInlineFontColour=t.mainButtonInlineFontColour?t.mainButtonInlineFontColour:null;if(t.initialMessage&&t.initialMessage.colors){const e=t.initialMessage.colors;e.background&&(this.initialMessageBackgroundColour=e.background),e.font&&(this.initialMessageFontColour=e.font)}else this.initialMessageBackgroundColour=t.initialMessageBackgroundColour?t.initialMessageBackgroundColour:null,this.initialMessageFontColour=t.initialMessageFontColour?t.initialMessageFontColour:null;if(t.infoPanel&&t.infoPanel.colors){const e=t.infoPanel.colors;e.background&&(this.infoPanelBackgroundColour=e.background),e.font&&(this.infoPanelFontColour=e.font,this.iconColours.callInfoIcon=e.font)}else this.infoPanelBackgroundColour=t.infoPanelBackgroundColour?t.infoPanelBackgroundColour:null,this.infoPanelFontColour=t.infoPanelFontColour?t.infoPanelFontColour:null;if(t.maximisedComponent&&t.maximisedComponent.colors){const e=t.maximisedComponent.colors;e.background&&(this.maximizedTopBarBackgroundColour=e.background),e.font&&(this.maximizedTopBarFontColour=e.font),e.icon&&(this.iconColours.maximizedTopBar=e.icon)}else this.maximizedTopBarBackgroundColour=t.maximizedTopBarBackgroundColour?t.maximizedTopBarBackgroundColour:null,this.maximizedTopBarFontColour=t.maximizedTopBarFontColour?t.maximizedTopBarFontColour:null;if(t.buttonBar){const e=t.buttonBar;if(e.bar&&e.bar.colors&&e.bar.colors.background&&(this.buttonBarBackgroundColour=e.bar.colors.background),e.buttons){const t=e.buttons;t.default&&t.default.colors&&(t.default.colors.background&&(this.menuButtonDefaultBackgroundColour=t.default.colors.background),t.default.colors.icon&&(this.iconColours.menuButtonDefault=t.default.colors.icon)),t.inverse&&t.inverse.colors&&(t.inverse.colors.background&&(this.menuButtonInverseBackgroundColour=t.inverse.colors.background),t.inverse.colors.icon&&(this.iconColours.menuButtonInverse=t.inverse.colors.icon)),t.disabled&&t.disabled.colors&&(t.disabled.colors.background&&(this.menuButtonDisabledBackgroundColour=t.disabled.colors.background),t.disabled.colors.icon&&(this.iconColours.menuButtonDisabled=t.disabled.colors.icon)),t.end&&(t.end.colors&&(t.end.colors.background&&(this.menuEndButtonDefaultBackgroundColour=t.end.colors.background),t.end.colors.icon&&(this.iconColours.menuEndButtonDefault=t.end.colors.icon)),t.end.inverse&&(t.end.inverse.background&&(this.menuEndButtonInverseBackgroundColour=t.end.inverse.background),t.end.inverse.icon&&(this.iconColours.menuEndButtonInverse=t.end.inverse.icon)))}}else this.buttonBarBackgroundColour=t.buttonBarBackgroundColour?t.buttonBarBackgroundColour:null,this.menuButtonDefaultBackgroundColour=t.menuButtonDefaultBackgroundColour?t.menuButtonDefaultBackgroundColour:null,this.menuButtonInverseBackgroundColour=t.menuButtonInverseBackgroundColour?t.menuButtonInverseBackgroundColour:null,this.menuButtonDisabledBackgroundColour=t.menuButtonDisabledBackgroundColour?t.menuButtonDisabledBackgroundColour:null,this.menuEndButtonDefaultBackgroundColour=t.menuEndButtonDefaultBackgroundColour?t.menuEndButtonDefaultBackgroundColour:null,this.menuEndButtonInverseBackgroundColour=t.menuEndButtonInverseBackgroundColour?t.menuEndButtonInverseBackgroundColour:null;if(t.dialogs){if(t.dialogs.primaryButton){if(t.dialogs.primaryButton.colors){const e=t.dialogs.primaryButton.colors;e.background&&(this.dialogPrimaryButtonBackgroundColour=e.background),e.border&&(this.dialogPrimaryButtonBorderColour=e.border),e.font&&(this.dialogPrimaryButtonFontColour=e.font)}if(t.dialogs.primaryButton.inverse){const e=t.dialogs.primaryButton.inverse;e.background&&(this.dialogPrimaryButtonInverseBackgroundColour=e.background),e.border&&(this.dialogPrimaryButtonInverseBorderColour=e.border),e.font&&(this.dialogPrimaryButtonInverseFontColour=e.font)}}if(t.dialogs.secondaryButton){if(t.dialogs.secondaryButton.colors){const e=t.dialogs.secondaryButton.colors;e.background&&(this.dialogSecondaryButtonBackgroundColour=e.background),e.border&&(this.dialogSecondaryButtonBorderColour=e.border),e.font&&(this.dialogSecondaryButtonFontColour=e.font)}if(t.dialogs.secondaryButton.inverse){const e=t.dialogs.secondaryButton.inverse;e.background&&(this.dialogSecondaryButtonInverseBackgroundColour=e.background),e.border&&(this.dialogSecondaryButtonInverseBorderColour=e.border),e.font&&(this.dialogSecondaryButtonInverseFontColour=e.font)}}}else this.dialogPrimaryButtonBackgroundColour=t.dialogPrimaryButtonBackgroundColour?t.dialogPrimaryButtonBackgroundColour:null,this.dialogPrimaryButtonBorderColour=t.dialogPrimaryButtonBorderColour?t.dialogPrimaryButtonBorderColour:null,this.dialogPrimaryButtonFontColour=t.dialogPrimaryButtonFontColour?t.dialogPrimaryButtonFontColour:null,this.dialogPrimaryButtonInverseBackgroundColour=t.dialogPrimaryButtonInverseBackgroundColour?t.dialogPrimaryButtonInverseBackgroundColour:null,this.dialogPrimaryButtonInverseBorderColour=t.dialogPrimaryButtonInverseBorderColour?t.dialogPrimaryButtonInverseBorderColour:null,this.dialogPrimaryButtonInverseFontColour=t.dialogPrimaryButtonInverseFontColour?t.dialogPrimaryButtonInverseFontColour:null,this.dialogSecondaryButtonBackgroundColour=t.dialogSecondaryButtonBackgroundColour?t.dialogSecondaryButtonBackgroundColour:null,this.dialogSecondaryButtonBorderColour=t.dialogSecondaryButtonBorderColour?t.dialogSecondaryButtonBorderColour:null,this.dialogSecondaryButtonFontColour=t.dialogSecondaryButtonFontColour?t.dialogSecondaryButtonFontColour:null,this.dialogSecondaryButtonInverseBackgroundColour=t.dialogSecondaryButtonInverseBackgroundColour?t.dialogSecondaryButtonInverseBackgroundColour:null,this.dialogSecondaryButtonInverseBorderColour=t.dialogSecondaryButtonInverseBorderColour?t.dialogSecondaryButtonInverseBorderColour:null,this.dialogSecondaryButtonInverseFontColour=t.dialogSecondaryButtonInverseFontColour?t.dialogSecondaryButtonInverseFontColour:null}console.log("mainButtonInitialBackgroundColour",this.mainButtonInitialBackgroundColour),console.log("iconColours.mainButtonInitial",this.iconColours.mainButtonInitial),console.log("mainButtonInitialInverseBackgroundColour",this.mainButtonInitialInverseBackgroundColour),console.log("iconColours.mainButtonInitialInverse",this.iconColours.mainButtonInitialInverse),console.log("mainButtonInlineBackgroundColour",this.mainButtonInlineBackgroundColour),console.log("mainButtonInlineFontColour",this.mainButtonInlineFontColour),console.log("iconColours.mainButtonInline",this.iconColours.mainButtonInline),console.log("initialMessageBackgroundColour",this.initialMessageBackgroundColour),console.log("initialMessageFontColour",this.initialMessageFontColour),console.log("infoPanelBackgroundColour",this.infoPanelBackgroundColour),console.log("infoPanelFontColour",this.infoPanelFontColour),console.log("iconColours.callInfoIcon",this.iconColours.callInfoIcon),console.log("maximizedTopBarBackgroundColour",this.maximizedTopBarBackgroundColour),console.log("maximizedTopBarFontColour",this.maximizedTopBarFontColour),console.log("iconColours.maximizedTopBar",this.iconColours.maximizedTopBar),console.log("buttonBarBackgroundColour",this.buttonBarBackgroundColour),console.log("menuButtonDefaultBackgroundColour",this.menuButtonDefaultBackgroundColour),console.log("iconColours.menuButtonDefault",this.iconColours.menuButtonDefault),console.log("menuButtonActiveBackgroundColour",this.menuButtonActiveBackgroundColour),console.log("iconColours.menuButtonActive",this.iconColours.menuButtonActive),console.log("menuButtonDisabledBackgroundColour",this.menuButtonDisabledBackgroundColour),console.log("iconColours.menuButtonDisabled",this.iconColours.menuButtonDisabled),console.log("menuEndButtonDefaultBackgroundColour",this.menuEndButtonDefaultBackgroundColour),console.log("iconColours.menuEndButtonDefault",this.iconColours.menuEndButtonDefault),console.log("menuEndButtonActiveBackgroundColour",this.menuEndButtonActiveBackgroundColour),console.log("iconColours.menuEndButtonActive",this.iconColours.menuEndButtonActive),console.log("dialogPrimaryButtonBackgroundColour",this.dialogPrimaryButtonBackgroundColour),console.log("dialogPrimaryButtonBorderColour",this.dialogPrimaryButtonBorderColour),console.log("dialogPrimaryButtonFontColour",this.dialogPrimaryButtonFontColour),console.log("dialogPrimaryButtonInverseBackgroundColour",this.dialogPrimaryButtonInverseBackgroundColour),console.log("dialogPrimaryButtonInverseBorderColour",this.dialogPrimaryButtonInverseBorderColour),console.log("dialogPrimaryButtonInverseFontColour",this.dialogPrimaryButtonInverseFontColour),console.log("dialogSecondaryButtonBackgroundColour",this.dialogSecondaryButtonBackgroundColour),console.log("dialogSecondaryButtonBorderColour",this.dialogSecondaryButtonBorderColour),console.log("dialogSecondaryButtonFontColour",this.dialogSecondaryButtonFontColour),console.log("dialogSecondaryButtonInverseBackgroundColour",this.dialogSecondaryButtonInverseBackgroundColour),console.log("dialogSecondaryButtonInverseBorderColour",this.dialogSecondaryButtonInverseBorderColour),console.log("dialogSecondaryButtonInverseFontColour",this.dialogSecondaryButtonInverseFontColour)}}}),define("LiveZoom",["LiveScenarioCustomization"],function(e){"use strict";return class{constructor(e){console.log("LiveZoom: constructing.."),this._customization=e,this._customization&&$(".oracle-live-video-buttons-zoom").css("background-color",this._customization.buttonBarBackgroundColour).css("border-color",this._customization.buttonBarBackgroundColour),this.ZOOM_FACTOR=1.25,this.CONTENT_SHRINK_FACTOR=1-1/this.ZOOM_FACTOR,this.reset()}disable(e){!0===e?(this.reset(),$(".oracle-live-screenshare-panel-associate video").off("click"),$(".oracle-live-video-zoomin-button").off("click"),$(".oracle-live-video-zoomout-button").off("click"),$(".oracle-live-video-default-button").off("click")):($(".oracle-live-screenshare-panel-associate video").off("click").click(e=>{this.centreOnClickedPoint(e.offsetX,e.offsetY)}),$(".oracle-live-video-zoomin-button").off("click").click(this.zoomIn.bind(this)),$(".oracle-live-video-zoomout-button").off("click").click(this.zoomOut.bind(this)),$(".oracle-live-video-default-button").off("click").click(this.reset.bind(this)))}reset(){console.log("LiveZoom: ---- Reset ----"),this.zoomPercent=100,this.scrolledLeft=0,this.scrolledTop=0,this.targetTag?this.assertCameraPanAndZoom():this.sensitizeButtons()}centreOnClickedPoint(e,t,i){this.captureCurrentScrolledValues();let n=this.parentTag.width(),o=this.parentTag.height(),s=i;if(!s){let i=e>this.innerWidth/2?this.innerWidth-e:e,a=t>this.innerHeight/2?this.innerHeight-t:t,r=i<n?n/i:1,c=a<o?o/a:1;(s=r>c?r/2:c/2)<this.ZOOM_FACTOR&&(s=this.ZOOM_FACTOR)}this.zoomPercent*=s,console.log("Zoom percent is ",this.zoomPercent),this.scrolledLeft=e*s-n/2,this.scrolledTop=t*s-o/2,this.assertCameraPanAndZoom()}zoomIn(){console.log("LiveZoom: ---- Zoom In ----"),this.captureCurrentScrolledValues();let e=this.parentTag.width(),t=this.parentTag.height();console.log("viewerWidthScaled="+e+", viewerHeightScaled="+t);let i=this.scrolledLeft+e/2,n=this.scrolledTop+t/2;this.centreOnClickedPoint(i,n,this.ZOOM_FACTOR)}zoomOut(){if(this.zoomPercent>100){console.log("LiveZoom: ---- Zoom Out ----"),this.captureCurrentScrolledValues(),this.zoomPercent/=this.ZOOM_FACTOR,this.zoomPercent<100&&(this.zoomPercent=100);let e=this.innerWidth*this.CONTENT_SHRINK_FACTOR,t=this.innerHeight*this.CONTENT_SHRINK_FACTOR;console.log("Our content will shrink via this zoom by width="+e+", height="+t),this.scrolledLeft=this.scrolledLeft-e/2,this.scrolledTop=this.scrolledTop-t/2,this.assertCameraPanAndZoom()}else console.log("LiveZoom: Zoom out request ignored - already fully 'out'")}assertCameraPanAndZoom(){console.log("LiveZoom: ===> Asserting: zoom="+this.zoomPercent+"%, scrollLeft="+this.scrolledLeft+", scrollTop="+this.scrolledTop);let e={width:this.zoomPercent+"%",height:this.zoomPercent+"%"};console.log("LiveZoom: Setting pan/zoom related styles to..",e),this.targetTag.css(e),console.log("LiveZoom: (re-styled) targetTag:",this.targetTag),this.sensitizeButtons(),this.parentTag.scrollLeft(this.scrolledLeft),this.parentTag.scrollTop(this.scrolledTop)}ensureTagsAreValid(){this.targetTag||(console.log("LiveZoom: no targetTag yet, resolving.."),this.targetTag=$(".oracle-live-remote-screenshare"),console.log("LiveZoom: targetTag:",this.targetTag)),this.parentTag||(console.log("LiveZoom: no parentTag yet, resolving.."),this.parentTag=$(".oracle-live-video-scroller"),console.log("LiveZoom: parentTag:",this.parentTag)),this.zoomInButton||(console.log("LiveZoom: no zoomInButton yet, resolving.."),this.zoomInButton=$(".oracle-live-video-zoomin-button"),console.log("LiveZoom: zoomInButton:",this.zoomInButton)),this.zoomOutButton||(console.log("LiveZoom: no zoomOutButton yet, resolving.."),this.zoomOutButton=$(".oracle-live-video-zoomout-button"),console.log("LiveZoom: zoomOutButton:",this.zoomOutButton)),this.resetButton||(console.log("LiveZoom: no resetButton yet, resolving.."),this.resetButton=$(".oracle-live-video-default-button"),console.log("LiveZoom: resetButton:",this.resetButton))}captureCurrentScrolledValues(){console.log("LiveZoom: captureCurrentScrolledValues"),this.ensureTagsAreValid(),this.scrolledLeft=this.parentTag.scrollLeft()||0,this.scrolledTop=this.parentTag.scrollTop()||0,console.log("scrolledLeft="+this.scrolledLeft+", scrolledTop="+this.scrolledTop),this.innerWidth=this.targetTag.width(),this.innerHeight=this.targetTag.height(),console.log("innerWidth="+this.innerWidth+", innerHeight="+this.innerHeight)}sensitizeButtons(){this.ensureTagsAreValid();const e=this.zoomPercent>100,t=100!==this.zoomPercent;if(console.log("LiveZoom: sensitizeButtons: canZoomIn=true, canZoomOut="+e+", canReset="+t),this.zoomInButton.attr("aria-disabled",!1),this.zoomOutButton.attr("aria-disabled",!e),this.resetButton.attr("aria-disabled",!t),this._customization){const i=this._customization.menuButtonDefaultBackgroundColour,n=this._customization.iconColours.menuButtonDefault,o=e?this._customization.menuButtonDefaultBackgroundColour:this._customization.menuButtonDisabledBackgroundColour,s=e?this._customization.iconColours.menuButtonDefault:this._customization.iconColours.menuButtonDisabled,a=t?this._customization.menuButtonDefaultBackgroundColour:this._customization.menuButtonDisabledBackgroundColour,r=t?this._customization.iconColours.menuButtonDefault:this._customization.iconColours.menuButtonDisabled;this.zoomInButton.css("background-color",i).css("border-color",i).css("color",n),this.zoomOutButton.css("background-color",o).css("border-color",o).css("color",s),this.resetButton.css("background-color",a).css("border-color",a).css("color",r)}}}}),define("LiveIconColourChange",["LiveIconColours"],function(e){"use strict";return class{constructor(e,t,i,n){if(console.log("LiveIconColourChange",e,t),console.log("rgbas.menuButtonDefault_rgba1",t.menuButtonDefault_rgba),this._updatedImg=null,!e)return void(n?n("Missing icon file url"):console.error("Missing icon file url"));let o=e.startsWith("url")?e.replace(/^url\(['"](.+)['"]\)/,"$1"):e,s=new Image;s.setAttribute("crossOrigin",""),s.onload=(()=>{console.log("LiveIconColourChange: url:",o);let e=document.createElement("canvas"),n=e.getContext("2d"),a=s.width,r=s.height;e.width=a,e.height=r,n.drawImage(s,0,0,a,r);let c=(e,t,i,o,s)=>{console.log("LiveIconColourChange: onload.replaceImage: x, y, w, h, rgba",e,t,i,o,s);let a=n.getImageData(e,t,i,o);for(let e=0;e<a.data.length;e+=4)if(0!==a.data[e+3]&&(a.data[e]=s[0],a.data[e+1]=s[1],a.data[e+2]=s[2],s[3]>=0)){const t=100-s[3]/255*100;a.data[e+3]-=a.data[e+3]/100*t}n.putImageData(a,e,t)};t.mainButtonInitial&&t.mainButtonInitial_rgba&&c(8,8,a-8,41,t.mainButtonInitial_rgba),t.mainButtonInitialInverse&&t.mainButtonInitialInverse_rgba&&c(8,50,a-8,41,t.mainButtonInitialInverse_rgba),t.mainButtonInline&&t.mainButtonInline_rgba&&c(8,746,a-8,20,t.mainButtonInline_rgba),t.menuButtonDefault&&t.menuButtonDefault_rgba&&c(30,686,a-30,20,t.menuButtonDefault_rgba),t.menuButtonInverse&&t.menuButtonInverse_rgba&&c(30,706,a-30,20,t.menuButtonInverse_rgba),t.menuButtonDisabled&&t.menuButtonDisabled_rgba&&(c(7,666,a-7,20,t.menuButtonDisabled_rgba),c(7,726,a-7,20,t.menuButtonDisabled_rgba)),t.menuEndButtonDefault&&t.menuEndButtonDefault_rgba&&c(7,686,20,20,t.menuEndButtonDefault_rgba),t.menuEndButtonInverse&&t.menuEndButtonInverse_rgba&&c(7,706,20,20,t.menuEndButtonInverse_rgba),t.maximizedTopBar&&t.maximizedTopBar_rgba&&c(8,970,50,16,t.maximizedTopBar_rgba),t.callInfoIcon&&t.callInfoIcon_rgba&&c(54,771,10,15,t.callInfoIcon_rgba),this._updatedImg="url("+e.toDataURL("image/png")+")",Object.defineProperty(this,"icons",{value:this._updatedImg}),i&&i(this._updatedImg)}),s.src=o,console.log("LiveIconColourChange: image:",s)}}}),function(){"use strict";var e=/(^.*(^|\/)nls(\/|$))([^\/]*)\/?([^\/]*)/;function t(e,t,i,n,o,s){t[e]&&(i.push(e),!0!==t[e]&&1!==t[e]||n.push(o+e+"/"+s))}function i(e,t,i,n,o){var s=n+t+"/"+o;require._fileExists(e.toUrl(s+".js"))&&i.push(s)}function n(e,t,i){var o;for(o in t)!t.hasOwnProperty(o)||e.hasOwnProperty(o)&&!i?"object"==typeof t[o]&&n(e[o],t[o],i):e[o]=t[o]}define("i18n",["module"],function(o){var s=o.config?o.config():{};return{version:"2.0.2",load:function(o,a,r,c){(c=c||{}).locale&&(s.locale=c.locale);var l,d,u,h=e.exec(o),g=h[1],v=h[4],p=h[5],m=v.split("-"),S=[],f={},_="";if(h[5]?l=(g=h[1])+p:(l=o,p=h[4],(v=s.locale)||(v=s.locale="undefined"==typeof navigator?"root":(navigator.language||navigator.userLanguage||"root").toLowerCase()),m=v.split("-")),c.isBuild){for(S.push(l),i(a,"root",S,g,p),d=0;d<m.length;d++)u=m[d],i(a,_+=(_?"-":"")+u,S,g,p);a(S,function(){r()})}else a([l],function(e){var i,o=[];for(t("root",e,o,S,g,p),d=0;d<m.length;d++)i=m[d],t(_+=(_?"-":"")+i,e,o,S,g,p);a(S,function(){var t,i,s;for(t=o.length-1;t>-1&&o[t];t--)!0!==(i=e[s=o[t]])&&1!==i||(i=a(g+s+"/"+p)),n(f,i);r(f)})})}}})}(),define("css",[],function(){if("undefined"==typeof window)return{load:function(e,t,i){i()}};var e=document.getElementsByTagName("head")[0],t=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)|AndroidWebKit\/([^ ;]*)/)||0,i=!1,n=!0;t[1]||t[7]?i=parseInt(t[1])<6||parseInt(t[7])<=9:t[2]||t[8]?n=!1:t[4]&&(i=parseInt(t[4])<18);var o,s,a,r={pluginBuilder:"./css-builder"},c=function(){o=document.createElement("style"),e.appendChild(o),s=o.styleSheet||o.sheet},l=0,d=[],u=function(e){32==++l&&(c(),l=0),s.addImport(e),o.onload=function(){h()}},h=function(){a();var e=d.shift();return e?(a=e[1],void u(e[0])):void(a=null)},g=function(t,i){var o=document.createElement("link");if(o.type="text/css",o.rel="stylesheet",n)o.onload=function(){o.onload=function(){},setTimeout(i,7)};else var s=setInterval(function(){for(var e=0;e<document.styleSheets.length;e++){if(document.styleSheets[e].href==o.href)return clearInterval(s),i()}},10);o.href=t,e.appendChild(o)};return r.normalize=function(e,t){return".css"==e.substr(e.length-4,4)&&(e=e.substr(0,e.length-4)),t(e)},r.load=function(e,t,n){(i?function(e,t){if(s&&s.addImport||c(),s&&s.addImport)a?d.push([e,t]):(u(e),a=t);else{o.textContent='@import "'+e+'";';var i=setInterval(function(){try{o.sheet.cssRules,clearInterval(i),t()}catch(e){}},10)}}:g)(t.toUrl(e+".css"),n)},r}),define("LiveButtonMenu",["jquery","text!oracle.live.button.html","LiveCallTimer","LiveEvents","LiveZoom","LiveIconColourChange","LiveIconColours","i18n!nls/oracle.live.messages","css!oracle.live.style.css"],function($,e,t,i,n,o,s,a){"use strict";return class{constructor(e){this._impl=e,this._messages=a,console.log("Language is: "+navigator.language),this._callTimer=new t,this._agentName="",this._avatarImageUrl=null,this._connectingAudioSrc=null,this._isMeeting=!1,this._meetingTitle=null,this._greetingMessage=null,this._connectingMessage=null,this._transferringMessage=null,this._notificationUptime=8e3,this._shortCode=null,this._shortCodeMode=!1,this._preCallIDCheck=!1,this._connectingAudioTimer=null,this._startInVideo=!1,this._startVideoInFullScreen=!1,this._startVideoWithFrontCamera=!1,this._startInScreenShare=!1,this._endUserControlsCamera=!1,this._endUserControlsScreenShare=!1,this._previousMaximizedFeed=null,this._havePausedResumed=!1,this._canRejoinMeeting=!0,this._annotationList=[],this._videoAnnotationList=[],this._maximizedFeedWhenScreenShareAdded=null,this._liveUpdatedIcons=null,this._iconColours=null,this._positionsDefined=!1,this._vertpx=null,this._horzpx=null,this._vertpn=null,this._horzpn=null,this._hideEndCallButton=!1,this._hidePauseButton=!1,this._cameraDefaultOn=null,this._addedOracleLiveVideoControlEnduser=!1,this._hideQueueLengthIndicator=!1,this._diagnosticsRunning=!1,this._resumeConnectedStatus=!1,this._originMaximizedVideo="NONE"}addComponent(e,t,i){this._addComponent(),this.updateMessages(e,i),this._browser=t}setMessages(e){console.log("Installing messages downloaded from REST service",e),this._messages=e,this._populateMessages()}setPopMessageText(e,t){e&&t?($(".oracle-live-popmessage").attr("tabindex",0),$(".oracle-live-popmessage").attr("aria-label",e+" "+t),$(".oracle-live-popmessage-text").attr("tabindex",null),$(".oracle-live-popmessage-text").text(e),$(".oracle-live-popmessage-text").attr("aria-label",null),$(".oracle-live-popmessage-shortcode").attr("tabindex",null),$(".oracle-live-popmessage-shortcode").text(t),$(".oracle-live-popmessage-shortcode").attr("aria-label",null)):($(".oracle-live-popmessage").attr("tabindex",null),$(".oracle-live-popmessage").attr("aria-label",null),e?($(".oracle-live-popmessage-text").attr("tabindex",0),$(".oracle-live-popmessage-text").text(e),$(".oracle-live-popmessage-text").attr("aria-label",e)):($(".oracle-live-popmessage-text").attr("tabindex",null),$(".oracle-live-popmessage-text").text(""),$(".oracle-live-popmessage-text").attr("aria-label",null)),t?($(".oracle-live-popmessage-shortcode").attr("tabindex",0),$(".oracle-live-popmessage-shortcode").text(t),$(".oracle-live-popmessage-shortcode").attr("aria-label",t)):($(".oracle-live-popmessage-shortcode").attr("tabindex",null),$(".oracle-live-popmessage-shortcode").text(""),$(".oracle-live-popmessage-shortcode").attr("aria-label",null)))}setPopMessageAriaDisabled(e){let t="false";!0===e&&(t="true",this.setPopMessageText(null,null)),$(".oracle-live-popmessage").attr("aria-disabled",t),$(".oracle-live-popmessage-text").attr("aria-disabled",t),$(".oracle-live-popmessage-shortcode").attr("aria-disabled",t)}updateMessages(e,t){console.log("updateMessages: "+JSON.stringify(e,null,2)+", meetingTitle: "+t),e&&(this._greetingMessage=this._messages.hasOwnProperty(e.greetingMessage)?this._messages[e.greetingMessage]:e.greetingMessage,e.connectingMessage&&(this._connectingMessage=this._messages.hasOwnProperty(e.connectingMessage)?this._messages[e.connectingMessage]:e.connectingMessage),this.setPopMessageText(this._greetingMessage,null)),t&&(this._meetingTitle=t)}setCustomization(e){console.log("Installing customization downloaded from REST service",e),this._customization=e,this._customize()}resetClass(e){const t=$(".oracle-live"),i=t.hasClass("oracle-live-hidden");t.removeClass().addClass(e),this._isMeeting&&t.addClass("oracle-live-meeting"),i&&t.addClass("oracle-live-hidden"),console.log("resetClass to: "+t.attr("class"))}_addComponent(){console.log("Menu::addComponent, meeting=",this._isMeeting);let t=$("body");t.length?(t.prepend(e),this.resetClass("oracle-live"),this._populateMessages(),this._customize(),console.log("Attaching mouse listeners to ",$(".oracle-live-video-panel")),$(".oracle-live-video-panel").off("click").on("click",e=>{console.log("Clicked the video panel");const t=$(".oracle-live"),i=t.hasClass("oracle-live-paused-associate");return!(!t.hasClass("oracle-live-video-preview")&&!this.getMaximizedFeed()&&!i&&(t.hasClass("oracle-live-videopanel-toolbars-hidden")?t.removeClass("oracle-live-videopanel-toolbars-hidden"):t.addClass("oracle-live-videopanel-toolbars-hidden"),0))}),$(".oracle-live-video-panel .oracle-live-local-video").off("click").on("click",e=>{console.log("Clicked the video panel when in maximized status of end user");const t=$(".oracle-live");if(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))return this._toggleTopbarAndToolbar(),!0})):console.warn("No body element on this page - there's nowhere to attach LX component")}_toggleTopbarAndToolbar(){$(".oracle-live").hasClass("oracle-live-videopanel-topbar-toolbar-hidden")?this._unHideTopbarAndToolbar():this._hideTopbarAndToolbar()}_hideTopbarAndToolbar(){const e=$(".oracle-live");e.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")||e.addClass("oracle-live-videopanel-topbar-toolbar-hidden"),$(".oracle-live-menu").css("display","none"),$(".oracle-live-video-toolbar-enduser").css("display","none")}_unHideTopbarAndToolbar(){this._topBarShowTimer&&clearTimeout(this._topBarShowTimer);const e=$(".oracle-live");e.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")&&e.removeClass("oracle-live-videopanel-topbar-toolbar-hidden"),$(".oracle-live-menu").css("display","block"),$(".oracle-live-video-toolbar-enduser").css("display","block"),this._topBarShowTimer=setTimeout(()=>{this._hideTopbarAndToolbar()},5e3)}_clearCustomPositionCss(e){e.css("left","").css("right","").css("top","").css("bottom","").css("width","").css("height","")}_clearCustomColourCss(e){e.css("background-color","").css("border-color","").css("color","")}_setIconColourCss(){this._liveUpdatedIcons&&($(".oracle-live-mainbutton-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-mainbutton-badge").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-buttonbar-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-exitbutton-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-video-maximize").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-unfreeze-annotation-camera").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-unfreeze-annotation-cross").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-callinfo-icon").css("background-image",this._liveUpdatedIcons.icons))}_setCustomColourCssMinMax(e){this._customization&&(this._clearCustomColourCss($(".oracle-live-video-toolbar-minimized")),this._clearCustomColourCss($(".oracle-live-video-toolbar-maximized")),$(".oracle-live-video-toolbar-enduser").removeClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-associate").removeClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-screenshare").removeClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-enduser").removeClass("oracle-live-video-toolbar-maximized"),$(".oracle-live-video-toolbar-associate").removeClass("oracle-live-video-toolbar-maximized"),$(".oracle-live-video-toolbar-screenshare").removeClass("oracle-live-video-toolbar-maximized"),e?$(".oracle-live").hasClass("oracle-live-video-enduser-maximized")?($(".oracle-live-video-toolbar-enduser").addClass("oracle-live-video-toolbar-maximized"),$(".oracle-live-video-toolbar-associate").addClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-screenshare").addClass("oracle-live-video-toolbar-minimized")):$(".oracle-live").hasClass("oracle-live-video-associate-maximized")?($(".oracle-live-video-toolbar-associate").addClass("oracle-live-video-toolbar-maximized"),$(".oracle-live-video-toolbar-enduser").addClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-screenshare").addClass("oracle-live-video-toolbar-minimized")):$(".oracle-live").hasClass("oracle-live-screenshare-associate-maximized")&&($(".oracle-live-video-toolbar-screenshare").addClass("oracle-live-video-toolbar-maximized"),$(".oracle-live-video-toolbar-enduser").addClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-associate").addClass("oracle-live-video-toolbar-minimized")):($(".oracle-live-video-toolbar-enduser").addClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-associate").addClass("oracle-live-video-toolbar-minimized"),$(".oracle-live-video-toolbar-screenshare").addClass("oracle-live-video-toolbar-minimized")),this._customization.maximizedTopBarBackgroundColour&&$(".oracle-live-video-toolbar-maximized:not(.oracle-live-unfreeze-annotation-camera):not(.oracle-live-unfreeze-annotation-cross)").css("background-color",this._customization.maximizedTopBarBackgroundColour).css("border-color",this._customization.maximizedTopBarBackgroundColour),this._customization.maximizedTopBarFontColour&&$(".oracle-live-video-toolbar-maximized").css("color",this._customization.maximizedTopBarFontColour),$(".oracle-live-video-toolbar-minimized").css("color","white"),$(".oracle-live-video-maximize").css("background-color","transparent"),$(".oracle-live-video-maximize").css("border-color","transparent"),$(".oracle-live-video-associate-maximized-title").css("background-color","transparent"),$(".oracle-live-video-associate-maximized-title").css("border-color","transparent"),$(".oracle-live-video-toolbar-recording").css("background-color","transparent"),$(".oracle-live-video-toolbar-recording").css("border-color","transparent"),$(".oracle-live-video-toolbar-timer").css("background-color","transparent"),$(".oracle-live-video-toolbar-timer").css("border-color","transparent"))}_setButtonBarButtonColourCss(e,t,i){this._customization&&(t||i?t&&!i?e.css("background-color",this._customization.menuButtonInverseBackgroundColour).css("border-color",this._customization.menuButtonInverseBackgroundColour):i&&e.css("background-color",this._customization.menuButtonDisabledBackgroundColour).css("border-color",this._customization.menuButtonDisabledBackgroundColour):e.css("background-color",this._customization.menuButtonDefaultBackgroundColour).css("border-color",this._customization.menuButtonDefaultBackgroundColour))}_defineCustomPosition(){if(!this._positionsDefined&&this._customization){if(this._vertpx=12,this._horzpx=12,this._vertpn="bottom",this._horzpn="right",this._customization.pinnedTo&&this._customization.pinnedTo.indexOf("-")>-1){let e=this._customization.pinnedTo.split("-");this._vertpn=e[0],this._horzpn=e[1]}this._customization.verticalMargin&&(this._vertpx=parseInt(this._customization.verticalMargin),isNaN(this._vertpx)&&(this._vertpx=12)),this._customization.horizontalMargin&&(this._horzpx=parseInt(this._customization.horizontalMargin),isNaN(this._horzpx)&&(this._horzpx=12)),console.log("Custom _vertpx",this._vertpx),console.log("Custom _horzpx",this._horzpx),console.log("Custom _vertpn",this._vertpn),console.log("Custom _horzpn",this._horzpn),this._positionsDefined=!0}}_setDialogButtonColourCss(e,t,i){this._customization&&(t?i?e.css("background-color",this._customization.dialogPrimaryButtonInverseBackgroundColour).css("border-color",this._customization.dialogPrimaryButtonInverseBorderColour).css("color",this._customization.dialogPrimaryButtonInverseFontColour):e.css("background-color",this._customization.dialogPrimaryButtonBackgroundColour).css("border-color",this._customization.dialogPrimaryButtonBorderColour).css("color",this._customization.dialogPrimaryButtonFontColour):i?e.css("background-color",this._customization.dialogSecondaryButtonInverseBackgroundColour).css("border-color",this._customization.dialogSecondaryButtonInverseBorderColour).css("color",this._customization.dialogSecondaryButtonInverseFontColour):e.css("background-color",this._customization.dialogSecondaryButtonBackgroundColour).css("border-color",this._customization.dialogSecondaryButtonBorderColour).css("color",this._customization.dialogSecondaryButtonFontColour))}_setButtonBarEndButtonColourCss(e,t){this._customization&&(e||t?e&&!t?$(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonInverseBackgroundColour).css("border-color",this._customization.menuEndButtonInverseBackgroundColour):t&&$(".oracle-live-exit-button").css("background-color",this._customization.menuButtonDisabledBackgroundColour).css("border-color",this._customization.menuButtonDisabledBackgroundColour):$(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonDefaultBackgroundColour).css("border-color",this._customization.menuEndButtonDefaultBackgroundColour))}_setButtonBarEndButtonIconCss(e){this._customization&&(e?$(".oracle-live-exitbutton-icon").css("background-position-x","-7px").css("background-position-y","-728px").css("width","20px").css("height","16px"):$(".oracle-live-exitbutton-icon").css("background-position-x","-7px").css("background-position-y","-688px").css("width","20px").css("height","16px"))}_isMaximized(){return $(".oracle-live").hasClass("oracle-live-video-enduser-maximized")||$(".oracle-live").hasClass("oracle-live-video-associate-maximized")||$(".oracle-live").hasClass("oracle-live-screenshare-associate-maximized")}_setCustomPositionCssMinMax(e){if(void 0!==e&&null!==e||(e=this._isMaximized()),this._customization)if(console.log("_setCustomPositionCssMinMax",e),this._defineCustomPosition(),e)$(".oracle-live-video-panel").removeClass("oracle-live-video-panel-minimized"),this._clearCustomPositionCss($(".oracle-live-video-panel")),$(".oracle-live-video-panel").addClass("oracle-live-video-panel-maximized"),this._clearCustomPositionCss($(".oracle-live-menu")),$(".oracle-live-menu-rightspacer").hide(),$(".oracle-live-menu-leftspacer").hide(),this._clearCustomPositionCss($(".oracle-live-dialog"));else{$(".oracle-live-video-panel").removeClass("oracle-live-video-panel-maximized"),this._clearCustomPositionCss($(".oracle-live-video-panel")),$(".oracle-live-video-panel").addClass("oracle-live-video-panel-minimized"),this._clearCustomPositionCss($(".oracle-live-menu"));let e="",t="",i="",n="",o="",s="",a="",r="",c="",l="",d="",u="",h="",g="",v="",p="",m="",S="";"left"===this._horzpn?($(".oracle-live-menu-rightspacer").hide(),$(".oracle-live-menu-leftspacer").show(),$(".oracle-live-menu-leftspacer").css("display","inline-block"),e=this._horzpx+38+"px",t="unset",o=this._horzpx+10+"px",s=e,a=this._horzpx+"px",r="unset",d=this._horzpx+10+"px",u="unset",v=this._horzpx+"px",p="unset"):($(".oracle-live-menu-rightspacer").show(),$(".oracle-live-menu-rightspacer").css("display","inline-block"),$(".oracle-live-menu-leftspacer").hide(),e="unset",t=this._horzpx+38+"px",o=this._horzpx+10+"px",s=t,a="unset",r=this._horzpx+"px",d="unset",u=this._horzpx+242+"px",v="unset",p=this._horzpx+"px"),"top"===this._vertpn?(i=this._vertpx+18+"px",n="unset",c=this._vertpx+100+"px",l="unset",h=this._vertpx+278+"px",g="unset",m=this._vertpx+95+"px",S="unset"):(i="unset",n=this._vertpx+18+"px",c="unset",l=this._vertpx+100+"px",h="unset",g=this._vertpx+110+"px",m="unset",S=this._vertpx+95+"px");let f=document.querySelector(".oracle-live-menu");if(f){let e=document.getElementById("oracle-live-menu-animation"),t=document.createElement("style");t.id="oracle-live-menu-animation",t.textContent="@keyframes oracle-live-buttonmenu-show-keyframes {0% { opacity: 0; "+this._horzpn+": "+o+"; width: 0px } 100% { opacity: 1; "+this._horzpn+" : "+s+"; width: fit-content } }\n@keyframes oracle-live-buttonmenu-hide-keyframes {0% { opacity: 1; "+this._horzpn+": "+s+"; width: fit-content } 100% { opacity: 0; "+this._horzpn+": "+o+"; width: 0px } }",e&&e.parentNode.removeChild(e),f.appendChild(t)}$(".oracle-live-menu").css("left",e).css("right",t).css("top",i).css("bottom",n).css("width","fit-content").css("overflow","hidden"),$(".oracle-live").hasClass("oracle-live-video-associate-on")&&$(".oracle-live").hasClass("oracle-live-video-enduser-on")||$(".oracle-live").hasClass("oracle-live-screenshare-associate-on")&&$(".oracle-live").hasClass("oracle-live-video-enduser-on")?$(".oracle-live-video-panel-enduser").css("left",d).css("right",u).css("top",h).css("bottom",g):$(".oracle-live-video-panel-enduser").css("left",a).css("right",r).css("top",c).css("bottom",l),$(".oracle-live-video-panel-associate").css("left",a).css("right",r).css("top",c).css("bottom",l),$(".oracle-live-screenshare-panel-associate").css("left",a).css("right",r).css("top",c).css("bottom",l),$(".oracle-live-dialog").css("left",v).css("right",p).css("top",m).css("bottom",S)}else{let e=document.querySelector(".oracle-live-menu");if(e){let t=document.getElementById("oracle-live-menu-animation"),i=document.createElement("style");i.id="oracle-live-menu-animation",i.textContent="@keyframes oracle-live-buttonmenu-show-keyframes {0% { opacity: 0; right: 0px; width: 0px } 100% { opacity: 1; right: 58px; width: fit-content } }\n@keyframes oracle-live-buttonmenu-hide-keyframes {0% { opacity: 1; right: 58px; width: fit-content } 100% { opacity: 0; right: 0px; width: 0px } }",t&&t.parentNode.removeChild(t),e.appendChild(i)}}}_setCustomCssMinMax(e){void 0!==e&&null!==e||(e=this._isMaximized()),this._setCustomPositionCssMinMax(e),this._setCustomColourCssMinMax(e)}_setHover(e,t,i,n,o,s,a,r,c,l,d,u){e.mouseenter(()=>{"true"!==e.attr("aria-disabled")&&(i&&e.css("background-color",i).css("border-color",i),n&&(c>=0&&n.css("background-position-x",-1*c+"px"),l>=0&&n.css("background-position-y",-1*l+"px"),d>=0&&n.css("width",d+"px"),u>=0&&n.css("height",u+"px")))}),e.mouseleave(()=>{"true"!==e.attr("aria-disabled")&&(t&&e.css("background-color",t).css("border-color",t),n&&(o>=0&&n.css("background-position-x",-1*o+"px"),s>=0&&n.css("background-position-y",-1*s+"px"),a>=0&&n.css("width",a+"px"),r>=0&&n.css("height",r+"px")))}),e.keypress(()=>{e.mouseenter()})}_setCustomPositionCss(){if(this._customization){this._defineCustomPosition();let e="",t="",i="",n="",o="",s="",a="",r="",c="",l="",d="",u="",h="",g="",v="",p="",m="";"left"===this._horzpn?(e=this._horzpx+"px",t="unset",o=this._horzpx+92+"px",s="unset",l=this._horzpx+"px",d="unset",g=this._horzpx+"px",v="unset"):(e="unset",t=this._horzpx+"px",o="unset",s=this._horzpx+92+"px",l="unset",d=this._horzpx+"px",g="unset",v=this._horzpx+"px"),"top"===this._vertpn?(i=this._vertpx+"px",n="unset",a=this._vertpx+40+"px",r="unset",c="translate(0, -50%)",u=this._vertpx+100+"px",h="unset",p=this._vertpx+100+"px",m="unset"):(i="unset",n=this._vertpx+"px",a="unset",r=this._vertpx+40+"px",c="translate(0, 50%)",u="unset",h=this._vertpx+100+"px",p="unset",m=this._vertpx+100+"px"),$(".oracle-live-main-button").css("left",e).css("right",t).css("top",i).css("bottom",n),$(".oracle-live-popmessage").css("left",o).css("right",s).css("top",a).css("bottom",r).css("transform",c).css("-ms-transform",c),$(".oracle-live-callinfo").css("left",l).css("right",d).css("top",u).css("bottom",h),$(".oracle-live-call-queue-info").css("left",g).css("right",v).css("top",p).css("bottom",m),this._setCustomPositionCssMinMax(!1)}}_setMainButtonColourCss(e){if(this._customization){let t=!1,i=!1;$(".oracle-live").hasClass("oracle-live-precall-dialog")||$(".oracle-live").hasClass("oracle-live-video-preview")||$(".oracle-live").hasClass("oracle-live-shortcode")||$(".oracle-live").hasClass("oracle-live-connecting")||$(".oracle-live").hasClass("oracle-live-transferring")||$(".oracle-live").hasClass("oracle-live-waiting")||$(".oracle-live").hasClass("oracle-live-disconnected")?(t=!0,i=!0):$(".oracle-live").hasClass("oracle-live-connected")||(t=!0,e&&(i=!0)),t?i?($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInitialInverseBackgroundColour).css("border-color",this._customization.mainButtonInitialInverseBackgroundColour),$(".oracle-live-mainbutton-icon").css("background-position-y","-50px")):($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInitialBackgroundColour).css("border-color",this._customization.mainButtonInitialBackgroundColour),$(".oracle-live-mainbutton-icon").css("background-position-y","-8px")):($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInlineBackgroundColour).css("border-color",this._customization.mainButtonInlineBackgroundColour).css("color",this._customization.mainButtonInlineFontColour),$(".oracle-live-initials").css("color",this._customization.mainButtonInlineFontColour))}}_setCustomColourCss(){if(this._customization){this._customization.initialMessageBackgroundColour&&$(".oracle-live-popmessage").css("background-color",this._customization.initialMessageBackgroundColour).css("border-color",this._customization.initialMessageBackgroundColour),this._customization.initialMessageFontColour&&($(".oracle-live-popmessage").css("color",this._customization.initialMessageFontColour),$(".oracle-live-popmessage-text").css("color",this._customization.initialMessageFontColour),$(".oracle-live-popmessage-shortcode").css("color",this._customization.initialMessageFontColour)),this._customization.infoPanelBackgroundColour&&$(".oracle-live-callinfo").css("background-color",this._customization.infoPanelBackgroundColour).css("border-color",this._customization.infoPanelBackgroundColour),this._customization.infoPanelFontColour&&($(".oracle-live-callinfo").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-associate").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-recording").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-icon").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-timer").css("color",this._customization.infoPanelFontColour),$(".oracle-live-call-queue-info").css("color",this._customization.infoPanelFontColour),$(".oracle-live-position-in-queue").css("color",this._customization.infoPanelFontColour)),this._customization.buttonBarBackgroundColour&&$(".oracle-live-menu").css("background-color",this._customization.buttonBarBackgroundColour).css("border-color",this._customization.buttonBarBackgroundColour),this._customization.menuButtonDefaultBackgroundColour&&$(".oracle-live-buttonbar-button").css("background-color",this._customization.menuButtonDefaultBackgroundColour).css("border-color",this._customization.menuButtonDefaultBackgroundColour),this._customization.menuEndButtonDefaultBackgroundColour&&($(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonDefaultBackgroundColour).css("border-color",this._customization.menuEndButtonDefaultBackgroundColour),this._customization.menuEndButtonInverseBackgroundColour&&(this._setHover($(".oracle-live-exit-button"),this._customization.menuEndButtonDefaultBackgroundColour,this._customization.menuEndButtonInverseBackgroundColour,$(".oracle-live-exitbutton-icon"),7,688,20,16,7,708,20,16),$(".oracle-live-exit-button").click(()=>{this._setButtonBarEndButtonIconCss(!0)}),$(".oracle-live-dialog-cancel").click(()=>{this._setButtonBarEndButtonIconCss(!1)}),$(".oracle-live-dialog-ok").click(()=>{$(".oracle-live").hasClass("oracle-live-disconnected")||$(".oracle-live").hasClass("oracle-live-disconnecting")||this._setButtonBarEndButtonIconCss(!1)}))),this._customization.dialogPrimaryButtonBackgroundColour&&$(".oracle-live-dialog-ok").css("background-color",this._customization.dialogPrimaryButtonBackgroundColour),this._customization.dialogPrimaryButtonBorderColour&&$(".oracle-live-dialog-ok").css("border-color",this._customization.dialogPrimaryButtonBorderColour),this._customization.dialogPrimaryButtonFontColour&&$(".oracle-live-dialog-ok").css("color",this._customization.dialogPrimaryButtonFontColour),this._customization.dialogSecondaryButtonBackgroundColour&&$(".oracle-live-dialog-cancel").css("background-color",this._customization.dialogSecondaryButtonBackgroundColour),this._customization.dialogSecondaryButtonBorderColour&&$(".oracle-live-dialog-cancel").css("border-color",this._customization.dialogSecondaryButtonBorderColour),this._customization.dialogSecondaryButtonFontColour&&$(".oracle-live-dialog-cancel").css("color",this._customization.dialogSecondaryButtonFontColour);let e=(e,t,i)=>{this._setDialogButtonColourCss(e,t,i)};$(".oracle-live-dialog-ok").mousedown(t=>{1===t.which&&e($(".oracle-live-dialog-ok"),!0,!0)}),$(".oracle-live-dialog-ok").mouseleave(()=>{e($(".oracle-live-dialog-ok"),!0,!1)}),$(".oracle-live-dialog-cancel").mousedown(t=>{1===t.which&&e($(".oracle-live-dialog-cancel"),!1,!0)}),$(".oracle-live-dialog-cancel").mouseleave(()=>{e($(".oracle-live-dialog-cancel"),!1,!1)})}this._setButtonBarEndButtonIconCss(!1),this._setCustomColourCssMinMax(!1)}_setIconColour(){this._customization&&(this._liveUpdatedIcons?this._setIconColourCss():new Promise((e,t)=>{let i=$(".oracle-live-mainbutton-icon").css("background-image");i&&(this._liveUpdatedIcons=new o(i,this._iconColours,e,t))}).then(e=>{this._setIconColourCss()}).catch(e=>{console.error("Error updating icons:",e),this._liveUpdatedIcons=null}))}_customize(){if(console.log("_customize",this._customization),this._customization){this._iconColours=this._customization.iconColours,this._setIconColour(),this._setMainButtonColourCss(!1),this._setCustomColourCss(),this._setCustomPositionCss();let e=e=>{this._setMainButtonColourCss(e)};$(".oracle-live-main-button").mouseenter(()=>{e(!0)}),$(".oracle-live-main-button").mouseleave(()=>{e(!1)})}else $(".oracle-live-menu-leftspacer").hide()}_populateMessages(){this._greetingMessage=this._messages.application_universal_message_welcome,this._connectingMessage=this._messages.application_universal_message_connecting_next_associate,this._messages.application_universal_message_transferring_to_another_associate="We are transferring you to another associate...",this._transferringMessage=this._messages.application_universal_message_transferring_to_another_associate,this._meetingTitle=this._messages.application_meeting_label_title,$(".oracle-live-dialog-cancel").text(this._messages.application_universal_button_cancel),$(".oracle-live-dialog-cancel").prop("title",this._messages.application_universal_button_cancel),$(".oracle-live-dialog-ok").text(this._messages.application_universal_button_ok),$(".oracle-live-dialog-ok").prop("title",this._messages.application_universal_button_ok),$(".oracle-live-dialog-question").text(this._messages.application_universal_message_service_quality_rating),$(".oracle-live-dialog-option-poor label").text(this._messages.application_universal_label_service_quality_bad),$(".oracle-live-dialog-option-poor").prop("title",this._messages.application_universal_label_service_quality_bad),$(".oracle-live-dialog-option-good label").text(this._messages.application_universal_label_service_quality_good),$(".oracle-live-dialog-option-good").prop("title",this._messages.application_universal_label_service_quality_good),$(".oracle-live-dialog-option-excellent label").text(this._messages.application_universal_label_service_quality_excellent),$(".oracle-live-dialog-option-excellent").prop("title",this._messages.application_universal_label_service_quality_excellent),$(".oracle-live-cancel-button").text(this._messages.application_universal_button_cancel),$(".oracle-live-rejoin-button").text(this._messages.application_universal_button_rejoin),$(".oracle-live-exit-button").prop("title",this._messages.application_universal_tooltip_end_call),$(".oracle-live-video-zoomin-button").text("+"),$(".oracle-live-video-zoomout-button").text("-"),$(".oracle-live-video-default-button").text(this._messages.application_universal_message_zoom_default_text),$(".oracle-live-video-closeall").prop("title",this._messages.application_video_call_tooltip_hide),$(".oracle-live-video-closelocal").prop("title",this._messages.application_video_call_tooltip_hide_local_video),$(".oracle-live-poor-video-connection-text").text(this._messages.application_universal_title_poor_connection),$(".oracle-live-recording").text(this._messages.application_universal_label_record),$(".oracle-live-duration-label").text(this._messages.application_universal_label_duration),$(".oracle-live-position-in-queue-label").text(this._messages.application_universal_label_position_in_queue),$(".oracle-live-main-button").attr("aria-label",this._messages.application_universal_label_main_button)}showComponent(){$(".oracle-live").removeClass("oracle-live-hidden")}hideEndCallButton(){$(".oracle-live-exit-button").hide()}hidePauseResumeButton(){$(".oracle-live-pause-button").hide()}hideQueueLengthIndicator(e){const t=$(".oracle-live-call-queue-info");e?t.addClass("oracle-live-hide-queue-info"):t.removeClass("oracle-live-hide-queue-info")}hideComponent(){$(".oracle-live").addClass("oracle-live-hidden")}setIdle(){console.log("LiveButtonMenu::setIdle"),this._idle=!0,this.setAssociateName(""),this._avatarImageUrl=null,this._callTimer.resetTimer(),this._enableZoom(!1),this._liveZoom=null,this._shortCode=null,this.setPopMessageText(this._greetingMessage,null),this.setPopMessageAriaDisabled(!1);const e=$(".oracle-live"),t=e.hasClass("oracle-live-cancelled");this.resetClass("oracle-live"),t&&e.addClass("oracle-live-cancelled"),!0===this._startInVideo?e.addClass("oracle-live-start-in-video"):e.removeClass("oracle-live-start-in-video"),!0===this._startInScreenShare?e.addClass("oracle-live-start-in-screenshare"):e.removeClass("oracle-live-start-in-screenshare"),$(".oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),this._isMeeting&&e.addClass("oracle-live-cancelled"),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}showStartCallDialog(e){e?($(".oracle-live").addClass("oracle-live-precall-dialog"),$(".oracle-live-dialog-title").text(this._messages.application_universal_title_start_call),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_continue),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),$(".oracle-live-main-button").attr("aria-disabled","true"),this._showDialog(!0,!0)):($(".oracle-live").removeClass("oracle-live-precall-dialog"),$(".oracle-live").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").attr("aria-disabled","false")),this._setMainButtonColourCss(!1)}setDiagnostics(e,t){this._diagnosticsRunning=e,e?(console.log("LiveButtonMenu::setDiagnostics, type="+t),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_diagnostic_label_checking),"video"===t?this.setPopMessageText(this._messages.application_diagnostics_message_mic_camera_check,null):this.setPopMessageText(this._messages.application_diagnostics_message_mic_check,null)):(!0===this._shortCodeMode?($(".oracle-live").addClass("oracle-live-shortcode"),console.log("Set the text to ",this._messages.application_short_code_message_provide_code),this.setPopMessageText(this._messages.application_short_code_message_provide_code,this._shortCode)):this.setPopMessageText(this._connectingMessage,null),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_universal_label_waiting_for_associate)),this._setMainButtonColourCss(!1)}setConnecting(e){console.log("setConnecting"),this._idle=!1,this._shortCode=e||null;const t=$(".oracle-live"),i=t.hasClass("oracle-live-video-preview"),n=t.hasClass("oracle-live-video-enduser-maximized");this.resetClass("oracle-live oracle-live-connecting"),this.setPopMessageAriaDisabled(!1),this._preCallIDCheck&&(console.log("Adding class oracle-live-preCallIDCheck-call-associate back in "),t.addClass("oracle-live-preCallIDCheck-call-associate"),t.addClass("oracle-live-video-enduser-maximized")),!0===i&&(t.addClass("oracle-live-video-enduser-on"),!0===n&&(t.addClass("oracle-live-video-enduser-maximized"),$(".oracle-live-exit-button").attr("aria-disabled",!1))),null!==this._shortCode?!0===this._startInScreenShare?this.setPopMessageText(this._messages.application_short_code_message_provide_code,this._shortCode):this.setPopMessageText(this._messages.application_short_code_message_provide_code_audio,this._shortCode):this.setPopMessageText(this._connectingMessage,null),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_universal_label_waiting_for_associate),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_waiting_for_associate),this._setMeetingTitle(),this._setMainButtonColourCss(!1)}setConnectingAudio(e){console.log("Setting connecting audio to "+e),e||null===this._connectingAudioTimer||(clearInterval(this._connectingAudioTimer),this._connectingAudioTimer=null);const t=document.getElementById("connectingAudio");if(t){if(console.log("Obtained a connecting audio, display="+t.style.display,t),!e)return console.log("Pausing connecting audio"),void t.pause();t.src!==this._connectingAudioSrc&&(t.src=this._connectingAudioSrc);let i=function(e){e._diagnosticsRunning?console.log("Still running diagnostics, not playing connecting audio yet"):(console.log("Playing connecting audio"),t.play())};i(this),this._connectingAudioTimer=setInterval(()=>{i(this)},4e3)}else console.log("Unable to control connectingAudio file")}_setMeetingTitle(){let e="";this._isMeeting&&(e=this._meetingTitle,this._agentName&&""!==this._agentName&&(e=e+" ("+this._messages.application_meeting_label_with+" "+this._agentName+")"),console.log('setMeetingTitle: "'+e+'"'),$(".oracle-live-video-panel-enduser [role='heading']").text(e),$(".oracle-live-video-panel [role='heading']").text(e),$(".oracle-live-audio-panel [role='heading']").text(e),$(".oracle-live-video-associate-maximized-title").text(e))}_setAssociateTitle(){let e="";this._agentName&&""!==this._agentName&&(e+=this._agentName),console.log('setAssociateTitle: "'+e+'"'),$(".oracle-live-video-associate-maximized-title").text(e)}setWaiting(e){this._setMeetingTitle(),e?($(".oracle-live").addClass("oracle-live-waiting"),$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_wait)):($(".oracle-live").removeClass("oracle-live-waiting"),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_connecting),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_universal_label_connecting)),this._setMainButtonColourCss(!1)}setCancelled(e){e?($(".oracle-live").addClass("oracle-live-cancelled"),$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_left)):($(".oracle-live").removeClass("oracle-live-cancelled"),$(".oracle-live-audio-panel-message").text("")),this._setMainButtonColourCss(!1)}setConnected(e){console.log("LiveButtonMenu::setConnected"),this._idle=!1;const t=$(".oracle-live"),i=t.hasClass("oracle-live-video-enduser-on"),n=t.hasClass("oracle-live-video-enduser-maximized")||!0===this._shortCodeMode&&!0===this._startVideoInFullScreen;this.resetClass("oracle-live oracle-live-connected"),this.setPopMessageAriaDisabled(!0),!0===i&&(t.addClass("oracle-live-video-enduser-on"),n&&this._maximizeEndUserVideo(!0)),this._preCallIDCheck&&(console.log("Adding class oracle-live-preCallIDCheck-call-associate back in "),t.addClass("oracle-live-preCallIDCheck-call-associate")),this._endUserControlsCamera&&t.addClass("oracle-live-video-control-enduser"),this._endUserControlsScreenShare&&t.addClass("oracle-live-screenshare-control-enduser"),e||this._callTimer.startTimer(),this._avatarImageUrl&&t.addClass("oracle-live-agent-image-loaded"),this._isMeeting?this._setMeetingTitle():this._setAssociateTitle(),e&&(this._resumeConnectedStatus=!0),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}setDisconnecting(e){e?($(".oracle-live").addClass("oracle-live-disconnecting"),$(".oracle-live-dialog-title").text(this._messages.application_universal_title_exit_session),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_exit_session),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._showDialog(!0,!0)):($(".oracle-live").removeClass("oracle-live-disconnecting"),this._showDialog(!1)),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}setDisconnected(e,t){console.log("LiveButtonMenu::setDisconnected, feedback=",e,", error=",t),this._callTimer.stopTimer(),this._agentName="",this._setMeetingTitle(),this._isMeeting&&$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_left),this.setEndUserAnnotationOn(!1),this._removeActiveClasses();const n=$(".oracle-live");n.removeClass("oracle-live-connected"),n.addClass("oracle-live-disconnected"),n.hasClass("oracle-live-video-enduser-maximized")||n.hasClass("oracle-live-video-associate-maximized")||n.hasClass("oracle-live-screenshare-associate-maximized")||this._setCustomCssMinMax(!1);const o=$(".oracle-live-cancel-rejoin-buttons");this._canRejoinMeeting?(console.log("showing rejoin button"),o.hasClass("oracle-live-no-rejoin")&&o.removeClass("oracle-live-no-rejoin")):(console.log("hiding rejoin button"),o.hasClass("oracle-live-no-rejoin")||o.addClass("oracle-live-no-rejoin"));const s=$(".oracle-live-dialog-cancel"),a=$(".oracle-live-dialog-ok");t?(n.addClass("oracle-live-error"),t===i.LiveConnectingNoAnswer?($(".oracle-live-dialog-title").text(this._messages.application_universal_message_no_answer),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_no_agent_available)):t===i.LiveDiagnosticsFailed?($(".oracle-live-dialog-title").text(this._messages.application_universal_title_service_failed),$(".oracle-live-dialog-message").text(this._messages.application_diagnostics_message_failed)):($(".oracle-live-dialog-title").text(this._messages.application_universal_title_service_ended),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_service_ended)),a.attr("aria-disabled","false"),this._showDialog(!0,!1)):($(".oracle-live-dialog-title").text(this._messages.application_universal_title_service_ended),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_service_ended),!0===e?(n.addClass("oracle-live-feedback"),a.attr("aria-disabled","true"),s.attr("aria-disabled","false"),this._showDialog(!0,!0)):(a.attr("aria-disabled","false"),this._showDialog(!0,!1))),!0===this._startInVideo?n.addClass("oracle-live-start-in-video"):n.removeClass("oracle-live-start-in-video"),!0===this._startInScreenShare?n.addClass("oracle-live-start-in-screenshare"):n.removeClass("oracle-live-start-in-screenshare"),this._havePausedResumed=!1,this._updateMenuButtons(),this._setMainButtonColourCss(!1)}sessionEnded(){$(".oracle-live-main-button").focus()}setReconnectingEndUser(e){console.log("LiveButtonMenu::setReconnectingEndUser",e),!0===e?($(".oracle-live-notification").text(this._messages.application_universal_message_local_attempting_to_reconnect),$(".oracle-live").addClass("oracle-live-reconnecting-enduser")):($(".oracle-live-notification").text(this._messages.application_universal_message_local_reconnected),$(".oracle-live").removeClass("oracle-live-reconnecting-enduser")),this._showNotification(),this._updateMenuButtons()}setReconnectingAssociate(e){console.log("LiveButtonMenu::setReconnectingAssociate",e),!0===e?($(".oracle-live-notification").text(this._messages.application_universal_message_associate_disconnected),$(".oracle-live").addClass("oracle-live-reconnecting-associate"),this.restoreFromAnnotation()):($(".oracle-live-notification").text(this._messages.application_universal_message_associate_reconnected),$(".oracle-live").removeClass("oracle-live-reconnecting-associate")),this._showNotification(),this._updateMenuButtons()}showVideoPreview(e){console.log("LiveButtonMenu::showVideoPreview",e),this.setEndUserControlsCamera(e);const t=$(".oracle-live");if(e){this.setCancelled(!1),t.addClass("oracle-live-video-preview"),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_diagnostic_label_video_preview),$(".oracle-live-preview-cancel-button").text(this._messages.application_universal_button_cancel).attr("aria-disabled","false");const e=t.hasClass("oracle-live-connected");e?$(".oracle-live-preview-start-button").text(this._messages.application_universal_button_share).attr("aria-disabled","false"):$(".oracle-live-preview-start-button").text(this._messages.application_universal_button_start).attr("aria-disabled","false"),e&&!1===this.isRemoteVideoOn()&&!0===this._startVideoInFullScreen?this._maximizeEndUserVideo(!0):e||!0!==this._startVideoInFullScreen||!0===this._shortCodeMode?this._setCustomCssMinMax(!1):this._maximizeEndUserVideo(!0)}else t.removeClass("oracle-live-video-preview"),this._maximizeEndUserVideo(!1),this.setEndUserVideoOn(!1);this._updateMenuButtons(),this._setMainButtonColourCss(!1)}setEndUserVideoOn(e){console.log("setEndUserVideoOn=",e);const t=$(".oracle-live");t.removeClass("oracle-live-video-preview"),!0===e?(t.addClass("oracle-live-video-enduser-on"),this._setMeetingTitle()):(this.setAssociateVideoAnnotationOn(!1),this._clearVideoAnnotations(),t.removeClass("oracle-live-video-enduser-on"),t.removeClass("oracle-live-video-enduser-maximized"),t.removeClass("oracle-live-annotation-associate-video-on")),this._updateMenuButtons(),this._setCustomCssMinMax()}setAssociateVideoOn(e){console.log("LiveButtonMenu::setAssociateVideoOn=",e);const t=$(".oracle-live");if(!0===e)t.hasClass("oracle-live-video-enduser-on")&&t.hasClass("oracle-live-video-enduser-maximized")&&!this._havePausedResumed?t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on")||this._maximizeAssociateVideo(!0):!1===this.isVideoOn()&&!0===this._startVideoInFullScreen?this._maximizeAssociateVideo(!0):this._impl._isRehydratingMeetingCall()?this._maximizeAssociateVideo(!0):!this._isMeeting||t.hasClass("oracle-live-video-enduser-maximized")||t.hasClass("oracle-live-screenshare-associate-maximized")||this._maximizeAssociateVideo(!0),t.addClass("oracle-live-video-associate-on"),this._setMeetingTitle();else{const e=t.hasClass("oracle-live-video-enduser-on")&&t.hasClass("oracle-live-video-associate-maximized");t.removeClass("oracle-live-video-associate-on"),this._maximizeAssociateVideo(!1),e&&this._maximizeEndUserVideo(!0)}this._setCustomCssMinMax()}setVideoLoading(e){console.log("LiveButtonMenu::setVideoLoading=",e);const t=$(".oracle-live");e?t.addClass("oracle-live-video-loading"):(t.removeClass("oracle-live-video-loading"),this._resumeConnectedStatus&&(this._resumeConnectedStatus=!1,this.restoreFromAnnotation()))}setAssociateScreenShareOn(e){console.log("LiveButtonMenu::setAssociateScreenShareOn=",e);const t=$(".oracle-live");!0===e?(this._maximizedFeedWhenScreenShareAdded=this.getMaximizedFeed(),t.hasClass("oracle-live-video-enduser-on")&&t.hasClass("oracle-live-video-enduser-maximized")?this._maximizeAssociateScreenShare(!0):!1===this.isVideoOn()&&!0===this._startVideoInFullScreen&&this._maximizeAssociateScreenShare(!0),t.addClass("oracle-live-screenshare-associate-on"),this._setMeetingTitle()):(t.removeClass("oracle-live-screenshare-associate-on"),this._maximizeAssociateScreenShare(!1),"associateVideo"===this._maximizedFeedWhenScreenShareAdded&&this._maximizeAssociateVideo(!0)),this._updateMenuButtons(),this._setCustomCssMinMax()}setEndUserScreenShareOn(e){console.log("LiveButtonMenu::setEndUserScreenShareOn",e),!0===e?$(".oracle-live").addClass("oracle-live-screenshare-enduser-on"):(this.setEndUserAnnotationOn(!1),this.setAssociateAnnotationOn(!1),$(".oracle-live").removeClass("oracle-live-screenshare-enduser-on")),this._updateMenuButtons()}isEndUserAnnotationOn(){return $(".oracle-live").hasClass("oracle-live-annotation-enduser-on")}setEndUserAnnotationOn(e){console.log("setEndUserAnnotationOn:"+e);const t=$(".oracle-live");t.hasClass("oracle-live-annotation-associate-on")||(!0===e?(t.addClass("oracle-live-annotation-enduser-on"),this._addEndUserAnnotationSupport()):(t.removeClass("oracle-live-annotation-enduser-on"),this._removeAnnotationSupport()),this._updateMenuButtons())}setAssociateAnnotationOn(e){console.log("setAssociateAnnotationOn:"+e);const t=$(".oracle-live");if(!t.hasClass("oracle-live-annotation-enduser-on"))if(!0===e&&!0!==t.hasClass("oracle-live-annotation-associate-on")){let e=this._messages.application_video_call_message_remote_annotation_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),t.addClass("oracle-live-annotation-associate-on"),this._addAssociateAnnotationSupport(),this._updateMenuButtons()}else if(!0!==e&&t.hasClass("oracle-live-annotation-associate-on")){let e=this._messages.application_video_call_message_remote_annotation_stopped;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),t.removeClass("oracle-live-annotation-associate-on"),this._removeAnnotationSupport(),this._updateMenuButtons()}}setAssociateVideoAnnotationOn(e,t){console.log("setAssociateVideoAnnotationOn:"+e);const i=$(".oracle-live");if(e&&!i.hasClass("oracle-live-annotation-associate-video-on")){let e=this._messages.application_video_call_message_remote_annotation_video_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),i.addClass("oracle-live-annotation-associate-video-on"),i.hasClass("oracle-live-frozen-annotation")||($(".oracle-live-unfreeze-annotation-cross").prop("title",this._messages.application_video_call_tooltip_unannotate_video),this.setOriginMaximizedVideo(),this._maximizeEndUserVideo(!0),i.hasClass("oracle-live-collapsed")&&(this.setCollapsed(!1),i.addClass("oracle-live-collapsed-restore"))),this._addAssociateVideoAnnotationSupport()}else if(!0!==e&&i.hasClass("oracle-live-annotation-associate-video-on")){let e=this._messages.application_video_call_message_remote_annotation_video_stopped;e&&e.length>0&&!t&&($(".oracle-live-notification").text(e),this._showNotification()),i.removeClass("oracle-live-annotation-associate-video-on"),i.hasClass("oracle-live-frozen-annotation")||this.restoreOriginMaximizedVideo(),this._removeVideoAnnotationSupport(),t&&this._impl._conversation.relayCommandTo(null,"*","video_annotate_stop",[{}])}this._updateMenuButtons()}setFrozenAnnotationOn(e,t){const i=$(".oracle-live");if(e){let e=this._messages.application_video_call_message_remote_frozen_annotation_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),i.addClass("oracle-live-frozen-annotation"),$(".oracle-live-unfreeze-annotation-cross").prop("title",this._messages.application_video_call_tooltip_unfreeze_video),$(".oracle-live-unfreeze-annotation-camera").prop("title",this._messages.application_video_call_tooltip_frozen_video),i.hasClass("oracle-live-annotation-associate-video-on")||this.setOriginMaximizedVideo(),this._impl._av.freezeEndUserVideo(!0)}else{if(t){let e=this._messages.application_video_call_message_remote_frozen_annotation_stopped;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification())}i.removeClass("oracle-live-frozen-annotation"),i.hasClass("oracle-live-annotation-associate-video-on")||this.restoreOriginMaximizedVideo(),this._impl._av.freezeEndUserVideo(!1),this._frozenUrl=null,t||this._impl._conversation.relayCommandTo(null,"*","unfreeze_customer_stream",[{}]),this._clearVideoAnnotations()}this._updateMenuButtons()}restoreFromAnnotation(){this.setAssociateVideoAnnotationOn(!1,!0),this.setFrozenAnnotationOn(!1,!1),this._previousMaximizedFeed=this.getMaximizedFeed()}setOriginMaximizedVideo(){const e=$(".oracle-live");e.hasClass("oracle-live-video-associate-maximized")?this._originMaximizedVideo="ASSOCIATE":e.hasClass("oracle-live-video-enduser-maximized")?this._originMaximizedVideo="ENDUSER":this._originMaximizedVideo="NONE",e.hasClass("oracle-live-collapsed")&&(this.setCollapsed(!1),e.addClass("oracle-live-collapsed-restore")),this._maximizeEndUserVideo(!0),this._hideTopbarAndToolbar()}restoreOriginMaximizedVideo(){const e=$(".oracle-live");"NONE"===this._originMaximizedVideo?this._maximizeEndUserVideo(!1):"ASSOCIATE"===this._originMaximizedVideo&&this._maximizeAssociateVideo(!0),e.hasClass("oracle-live-collapsed-restore")&&(this.setCollapsed(!0),e.removeClass("oracle-live-collapsed-restore")),this._unHideTopbarAndToolbar(),this._topBarShowTimer&&clearTimeout(this._topBarShowTimer)}showUnfreezeAnnotationDialog(e){e?($(".oracle-live").addClass("oracle-live-unfreeze-annotation"),$(".oracle-live-dialog-title").text(this._messages.application_video_call_title_discard_frozen),0===this._videoAnnotationList.length?$(".oracle-live-dialog-message").text(this._messages.application_video_call_message_discard_frozen):$(".oracle-live-dialog-message").text(this._messages.application_video_call_message_discard_frozen_annotation),$(".oracle-live-dialog-ok").text(this._messages.application_universal_button_discard),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._showDialog(!0,!0)):($(".oracle-live").removeClass("oracle-live-unfreeze-annotation"),$(".oracle-live").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").attr("aria-disabled","false"),$(".oracle-live-dialog-ok").text(this._messages.application_universal_button_ok)),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}distance(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}lineIntersects(e,t,i,n,o,s,a,r){const c=1e-5;function l(e,t,i){return e-c<=t&&t<=i+c}let d=((e*n-t*i)*(o-a)-(e-i)*(o*r-s*a))/((e-i)*(s-r)-(t-n)*(o-a)),u=((e*n-t*i)*(s-r)-(t-n)*(o*r-s*a))/((e-i)*(s-r)-(t-n)*(o-a));if(isNaN(d)||isNaN(u))return!1;if(e>=i){if(!l(i,d,e))return!1}else if(!l(e,d,i))return!1;if(t>=n){if(!l(n,u,t))return!1}else if(!l(t,u,n))return!1;if(o>=a){if(!l(a,d,o))return!1}else if(!l(o,d,a))return!1;if(s>=r){if(!l(r,u,s))return!1}else if(!l(s,u,r))return!1;return console.log("lineIntersects returning true"),!0}checkLineIntersectsWithAnnotations(e,t,i,n,o,s,a){s.forEach((s,r)=>{console.log("checkLineIntersectsWithAnnotations: processing annotation index (looking for intersection): ",r);for(let c=0;c<s.length-1;c++){let l=this.lineIntersects(e[0].x,e[0].y,e[1].x,e[1].y,s[c].x*t+n,s[c].y*i+o,s[c+1].x*t+n,s[c+1].y*i+o);console.log("checkLineIntersectsWithAnnotations: eraseAnnotation: intersects: ",l),l&&(console.log("checkLineIntersectsWithAnnotations: eraseAnnotation: found an intersection at index "+r),a.push(r))}})}_drawCursorPoint(e,t,i,n,o){let s;(s=e||(this._canvasCtx?this._canvasCtx:this._videoCanvasCtx)).beginPath(),s.moveTo(i,n),"circle"===t?s.arc(i,n,10,0,2*Math.PI):s.rect(i-10,n-10,20,20),s.strokeStyle=o,s.stroke()}eraseAnnotation(e){console.log("LiveButtonMenu::eraseAnnotation: ",e);let t=[];if(e.length>=1){let i=e[0].annotationIds;i&&this._annotationList.forEach((e,n)=>{e[0].objectId&&i.includes(e[0].objectId)&&(console.log("Marking screenshare '"+e[0].objectId+"' annotation["+n+"] for deletion"),t.push(n))})}if(0===t.length)console.log("LiveButtonMenu::eraseAnnotation: failed to find anything to delete");else{let e=[];console.log("LiveButtonMenu::eraseAnnotation: removing all intersecting annotations"),this._annotationList.forEach((i,n)=>{console.log("processing annotation index: ",n),t.includes(n)||e.push(i)}),console.log("LiveButtonMenu::eraseAnnotation: clearing annotations"),this._clearAnnotations(),console.log("LiveButtonMenu::eraseAnnotation: Redrawing annotations with just the survivors"),e.forEach((e,t)=>{this.displayAssociateAnnotation(e)})}}displayAssociateAnnotation(e){if(console.log("LiveButtonMenu::displayAssociateAnnotation",e),!this._canvasCtx)return;if(e&&"erase"===e[0].mode)return void this.eraseAnnotation(e);e&&e[0].color&&(this._canvasCtx.strokeStyle=e[0].color),this._annotationList.push(e);let t=0,i=0,n=0;"Chrome"===this._browser&&"browser"===this._impl._screen.getDisplaySurface()?(i=window.innerWidth,t=window.innerHeight):(i=window.outerWidth,t=window.outerHeight,n=t-window.innerHeight);const o=(e,o)=>{if(0===o)this._oldPosition={x:e.x*i,y:e.y*t-n};else{const o={x:e.x*i,y:e.y*t-n};this._drawGraph(this._oldPosition,o),this._oldPosition=o}};let s=window.screen.width,a=window.screen.height;const r=(e,t)=>{let i=s*e.x,o=a*e.y,r=i-(window.screenLeft-s),c=o-window.screenTop-n;if(0===t)this._oldPosition={x:r,y:c};else{const e={x:r,y:c};this._drawGraph(this._oldPosition,e),this._oldPosition=e}};"Chrome"===this._browser&&"monitor"===this._impl._screen.getDisplaySurface()?e.forEach((e,t)=>{r(e,t)}):e.forEach((e,t)=>{o(e,t)})}getXOffset(e){console.log("LiveButtonMenu::getXOffset");let t=0;if(!e)return t;const i=e.clientWidth,n=e.clientHeight,o=e.videoWidth,s=e.videoHeight,a=i/n,r=o/s;return console.log("LiveButtonMenu::cw: "+i+"  ch: "+n+"  vw: "+o+"  vh: "+s),console.log("LiveButtonMenu::car: "+a+"    ar: "+r),a>r&&(t=(i-n*o/s)/2),console.log("LiveButtonMenu::xOffset: "+t),t}getYOffset(e){console.log("LiveButtonMenu::getYOffset");let t=0;if(!e)return t;const i=e.clientWidth,n=e.clientHeight,o=e.videoWidth,s=e.videoHeight,a=i/n,r=o/s;return console.log("LiveButtonMenu::cw: "+i+"  ch: "+n+"  vw: "+o+"  vh: "+s),console.log("LiveButtonMenu::car: "+a+"    ar: "+r),a<r&&(t=(n-i*s/o)/2),console.log("LiveButtonMenu::yOffset: "+t),t}eraseVideoAnnotation(e){console.log("LiveButtonMenu::eraseVideoAnnotation: ",e);let t=[];if(e.length>=1){let i=e[0].annotationIds;i&&this._videoAnnotationList.forEach((e,n)=>{e[0].objectId&&i.includes(e[0].objectId)&&(console.log("Marking video '"+e[0].objectId+"' annotation["+n+"] for deletion"),t.push(n))})}if(0===t.length)console.log("LiveButtonMenu::eraseVideoAnnotation: failed to find anything to delete");else{let e=[];console.log("LiveButtonMenu::eraseVideoAnnotation: removing all intersecting annotations"),this._videoAnnotationList.forEach((i,n)=>{console.log("processing annotation index: ",n),t.includes(n)||e.push(i)}),console.log("LiveButtonMenu::eraseAnnotation: clearing annotations"),this._clearVideoAnnotations(),console.log("LiveButtonMenu::eraseAnnotation: Redrawing annotations with just the survivors"),e.forEach((e,t)=>{this.displayAssociateVideoAnnotation(e)})}}redrawVideoAnnotations(){console.log("LiveButtonMenu::redrawVideoAnnotation");let e=this._videoAnnotationList;this._clearVideoAnnotations(),console.log("LiveButtonMenu::redrawVideoAnnotation Redrawing the video annotations"),e.forEach((e,t)=>{this.displayAssociateVideoAnnotation(e)})}displayAssociateVideoAnnotation(e){if(console.log("LiveButtonMenu::displayAssociateVideoAnnotation",e),!this._videoCanvasCtx)return;if(e&&"erase"===e[0].mode)return void this.eraseVideoAnnotation(e);e&&e[0].color&&(this._videoCanvasCtx.strokeStyle=e[0].color),this._videoAnnotationList.push(e);const t=$(".oracle-live-local-video")[0],i=this.getXOffset(t),n=this.getYOffset(t);let o=0,s=0;s=t.clientWidth-2*i,o=t.clientHeight-2*n,"Chrome"===this._browser&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.toLowerCase().indexOf("mobi")>0&&t.clientHeight>this._videoCanvasCtx.canvas.height&&this._videoCanvasCtx.canvas.height-2*n>=50&&(o=this._videoCanvasCtx.canvas.height-2*n);const a=(e,t,i,n)=>{if(0===t)this._oldPosition={x:e.x*s+i,y:e.y*o+n};else{const t={x:e.x*s+i,y:e.y*o+n};this._drawVideoGraph(this._oldPosition,t),this._oldPosition=t}};e.forEach((e,t)=>{a(e,t,i,n)})}setPausedByUser(e){const t=$(".oracle-live");!0===e?(t.addClass("oracle-live-paused-enduser"),this._endUserAnnotationOnPriorToPause=this.isEndUserAnnotationOn(),this._previousMaximizedFeed=this.getMaximizedFeed(),this._havePausedResumed=!0,this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!1),$(".oracle-live-notification").text(this._messages.application_universal_message_local_hold),this._showNotification()):(t.removeClass("oracle-live-notification-show oracle-live-paused-enduser"),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!0),this.maximize(this._previousMaximizedFeed,!0)),this._updateMenuButtons()}setPausedByAssociate(e){const t=$(".oracle-live");!0===e?(this._toolbarsHidden=!1,t.hasClass("oracle-live-videopanel-toolbars-hidden")&&(t.removeClass("oracle-live-videopanel-toolbars-hidden"),this._toolbarsHidden=!0),$(".oracle-live-notification").text(this._messages.application_universal_message_remote_hold),t.addClass("oracle-live-paused-associate"),this._endUserAnnotationOnPriorToPause=this.isEndUserAnnotationOn(),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!1),this._previousMaximizedFeed=this.getMaximizedFeed(),this._havePausedResumed=!0,this._showNotification(),(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))&&this._unHideTopbarAndToolbar()):(t.removeClass("oracle-live-notification-show oracle-live-paused-associate"),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!0),this.maximize(this._previousMaximizedFeed,!0),this._toolbarsHidden&&t.addClass("oracle-live-videopanel-toolbars-hidden")),this._updateMenuButtons()}setTransferringToAnotherAssociate(e){console.log("setTransferringToAnotherAssociate"),this._idle=!1,this.resetClass("oracle-live oracle-live-transferring"),this.setPopMessageAriaDisabled(!1),this.setPopMessageText(this._transferringMessage,null),this._updateMenuButtons(),$(".oracle-live-video-panel-enduser [role='heading']").text(this._messages.application_universal_label_transferring),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_transferring),this._setMeetingTitle(),this._setMainButtonColourCss(!1),this._impl.holdCallWithAssociate()}setTransferredToAnotherAssociate(e){console.log("TRANSFER: setTransferredToAnotherAssociate",e),this.setConnected(!0),this._impl.resumeCallWithAssociate()}cancelCallTransfer(){console.log("cancelCallTransfer"),this.setConnected(!0),this._impl.resumeCallWithAssociate()}setAssociateName(e){this._agentName=e,$(".oracle-live-associate").text(e).prop("title",e);const t=(e=>{let t="";if(null===e)return t;const i=(e=e.trim()).indexOf(" ");return(t=-1===i?e.substring(0,1):e.substring(0,1)+e.substring(i).trim().substring(0,1)).toUpperCase()})(this._agentName);console.log("Agent initials="+t),$(".oracle-live-initials").text(t),$(".oracle-live-video-enduser-name").text(e).prop("title",e),$(".oracle-live-video-associate-name").text(e).prop("title",e),$(".oracle-live-screenshare-associate-name").text(e).prop("title",e),this._setMeetingTitle()}setAssociatePhoto(e){const t=this._messages.application_universal_message_picture_description.replace(/\{0\}/,this._agentName);this._avatarImageUrl=e,e&&$(".oracle-live").addClass("oracle-live-agent-image-loaded"),$(".oracle-live-agent-image").attr("src",e).prop("title",t)}setConnectingAudioSource(e){this._connectingAudioSrc=e}setPoorNetwork(e){console.log("LiveButtonMenu::setPoorNetwork",e);const t=$(".oracle-live");!0===e?($(".oracle-live-video-panel-message").text(this._messages.application_universal_title_poor_connection),t.hasClass("oracle-live-connecting")?$(".oracle-live-notification").text(this._messages.application_universal_message_poor_network_connection):(t.hasClass("oracle-live-connected")||t.hasClass("oracle-live-transferring"))&&$(".oracle-live-notification").text(this._messages.application_universal_message_check_network_connection),t.addClass("oracle-live-poor-connection")):(t.removeClass("oracle-live-poor-connection"),this._setMeetingTitle()),this._updateMenuButtons(),this._showNotification()}setCollapsed(e){console.log("LiveButtonMenu::setCollapsed ",e);const t=$(".oracle-live");!0===e?(console.log("LiveButtonMenu::setCollapsed Removing maximized styles and adding collapsed style"),t.removeClass("oracle-live-video-enduser-maximized").removeClass("oracle-live-video-associate-maximized").removeClass("oracle-live-screenshare-associate-maximized"),t.addClass("oracle-live-collapsed")):(console.log("LiveButtonMenu::setCollapsed Removing collapsed styles"),t.removeClass("oracle-live-collapsed oracle-live-video-hide").removeClass("oracle-live-video-local-hide"),(t.hasClass("oracle-live-annotation-associate-video-on")||t.hasClass("oracle-live-frozen-annotation"))&&t.addClass("oracle-live-video-enduser-maximized"),t.hasClass("oracle-live-annotation-associate-video-on")&&this._resizeVideoAnnotationCanvas())}setScreenShareDialogShowing(e){e?$(".oracle-live").addClass("oracle-live-screenshare-system-dialog"):$(".oracle-live").removeClass("oracle-live-screenshare-system-dialog"),this._updateMenuButtons()}setRecording(e){!0===e?$(".oracle-live").addClass("oracle-live-recording-on"):$(".oracle-live").removeClass("oracle-live-recording-on")}setRating(e){const t=$(".oracle-live");switch(e){case"poor":t.removeClass("oracle-live-quality-good").removeClass("oracle-live-quality-excellent").addClass("oracle-live-quality-poor");break;case"good":t.removeClass(" oracle-live-quality-excellent").removeClass("oracle-live-quality-poor").addClass("oracle-live-quality-good");break;case"excellent":t.removeClass("oracle-live-quality-poor").removeClass("oracle-live-quality-good").addClass("oracle-live-quality-excellent")}$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-option-poor").prop("tabindex","poor"===e?0:-1).attr("aria-checked","poor"===e),$(".oracle-live-dialog-option-good").prop("tabindex","good"===e?0:-1).attr("aria-checked","good"===e),$(".oracle-live-dialog-option-excellent").prop("tabindex","excellent"===e?0:-1).attr("aria-checked","excellent"===e)}getMaximizedFeed(){const e=$(".oracle-live");return e.hasClass("oracle-live-collapsed")?null:e.hasClass("oracle-live-video-enduser-maximized")?"endUserVideo":e.hasClass("oracle-live-video-associate-maximized")?"associateVideo":e.hasClass("oracle-live-screenshare-associate-maximized")?"associateScreenShare":null}isVideoOn(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-enduser-on")||e.hasClass("oracle-live-video-associate-on")||e.hasClass("oracle-live-screenshare-associate-on")}isRemoteVideoOn(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-associate-on")||e.hasClass("oracle-live-screenshare-associate-on")}isFullScreen(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-enduser-maximized")||e.hasClass("oracle-live-video-associate-maximized")||e.hasClass("oracle-live-screenshare-associate-maximized")}maximize(e,t){console.log("LiveButtonMenu::maximize ",e,t),$(".oracle-live").hasClass("oracle-live-collapsed")?console.log("is collapsed - returning"):"endUserVideo"===e?this._maximizeEndUserVideo(t):"associateVideo"===e?this._maximizeAssociateVideo(t):"associateScreenShare"===e&&this._maximizeAssociateScreenShare(t)}_showDialog(e,t){this._setDialogButtonColourCss($(".oracle-live-dialog-ok"),!0,!1),this._setDialogButtonColourCss($(".oracle-live-dialog-cancel"),!1,!1),e?(this._oldFocus=document.activeElement,$(".oracle-live").addClass("oracle-live-show-dialog"),!0===t?$(".oracle-live-dialog-cancel").focus():$(".oracle-live-dialog-ok").focus()):($(".oracle-live").removeClass("oracle-live-show-dialog"),this._oldFocus&&this._oldFocus.focus(),this._updateMenuButtons()),this._setButtonBarEndButtonIconCss(e)}_maximizeEndUserVideo(e){console.log("LiveButtonMenu::_maximizeEndUserVideo ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeEndUserVideo (max and not olc)"),t.removeClass("oracle-live-video-associate-maximized"),t.removeClass("oracle-live-screenshare-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-video-enduser-maximized"),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video),this._resizeVideoAnnotationCanvas()):(console.log("LiveButtonMenu::_maximizeEndUserVideo (not max) or (max and olc)"),t.removeClass("oracle-live-video-enduser-maximized"),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",e?this._messages.application_video_call_tooltip_minimize_video:this._messages.application_video_call_tooltip_maximize),this._resizeVideoAnnotationCanvas()),e&&($(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),$(".oracle-live-screenshare-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize)),this._setCustomCssMinMax(e)}_maximizeAssociateVideo(e){console.log("LiveButtonMenu::_maximizeAssociateVideo ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeAssociateVideo (max and not olc)"),t.removeClass("oracle-live-video-enduser-maximized"),t.removeClass("oracle-live-screenshare-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-video-associate-maximized"),$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video)):(console.log("LiveButtonMenu::_maximizeAssociateVideo (not max) or (max and olc)"),t.removeClass("oracle-live-video-associate-maximized"),$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",e?this._messages.application_video_call_tooltip_minimize_video:this._messages.application_video_call_tooltip_maximize)),e&&($(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),$(".oracle-live-screenshare-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize)),this._setCustomCssMinMax(e)}_maximizeAssociateScreenShare(e){console.log("LiveButtonMenu::_maximizeAssociateScreenShare ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeAssociateScreenShare (max and not olc)"),t.removeClass("oracle-live-video-enduser-maximized"),t.removeClass("oracle-live-video-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-screenshare-associate-maximized"),$(".oracle-live-screenshare-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video),this._enableZoom(!0)):(console.log("LiveButtonMenu::_maximizeAssociateScreenShare (not max) or (max and olc)"),t.removeClass("oracle-live-screenshare-associate-maximized"),$(".oracle-live-screenshare-panel-associate .oracle-live-video-maximize").prop("title",e?this._messages.application_video_call_tooltip_minimize_video:this._messages.application_video_call_tooltip_maximize),this._enableZoom(!1)),e&&($(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize)),this._setCustomCssMinMax(e)}_updateMenuButtons(){const e=$(".oracle-live"),t=$(".oracle-live-menu"),i=$(".oracle-live-pause-button"),n=$(".oracle-live-video-button"),o=$(".oracle-live-screenshare-button"),s=$(".oracle-live-annotate-button"),a=$(".oracle-live-exit-button");!0===this._hideEndCallButton&&this.hideEndCallButton(),!0===this._hidePauseButton&&this.hidePauseResumeButton();const r=e.hasClass("oracle-live-show-dialog"),c=e.hasClass("oracle-live-video-preview"),l=e.hasClass("oracle-live-screenshare-system-dialog"),d=e.hasClass("oracle-live-connected"),u=e.hasClass("oracle-live-disconnecting"),h=e.hasClass("oracle-live-disconnected"),g=e.hasClass("oracle-live-reconnecting-enduser"),v=e.hasClass("oracle-live-paused-associate"),p=e.hasClass("oracle-live-paused-enduser"),m=e.hasClass("oracle-live-video-enduser-on"),S=e.hasClass("oracle-live-video-control-enduser"),f=e.hasClass("oracle-live-screenshare-enduser-on"),_=e.hasClass("oracle-live-screenshare-control-enduser"),C=e.hasClass("oracle-live-screenshare-associate-on"),E=e.hasClass("oracle-live-annotation-enduser-on"),R=e.hasClass("oracle-live-annotation-associate-on");if(this._isMeeting||((!0!==this._hidePauseButton||m||S||f||_||E||!0!==this._hideEndCallButton)&&(d||u||h)&&!e.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")?t.css("display","block"):t.css("display","none")),!0===this._idle)return!0!==this._hidePauseButton?i.prop("title",this._messages.application_universal_tooltip_pause_call).attr("aria-pressed",!1).attr("aria-disabled",!1):i.prop("title",this._messages.application_universal_tooltip_pause_call_disabled).attr("aria-pressed",!1).attr("aria-disabled",!0),n.prop("title",this._messages.application_video_call_tooltip_share_camera).attr("aria-pressed",!1).attr("aria-disabled",!1),o.prop("title",this._messages.application_video_call_tooltip_share_screen).attr("aria-pressed",!1).attr("aria-disabled",!1),!0!==this._hideEndCallButton?a.prop("title",this._messages.application_universal_tooltip_end_call).attr("aria-pressed",!1).attr("aria-disabled",!1):a.prop("title",this._messages.application_universal_tooltip_end_call_disabled).attr("aria-pressed",!1).attr("aria-disabled",!0),this._addedOracleLiveVideoControlEnduser=!1,void(this._cameraDefaultOn=null);const b=g||v||u||h||r||c||l;i.attr("aria-disabled",b||this._hidePauseButton),i.attr("aria-pressed",p),b||this._hidePauseButton?(i.prop("title",this._messages.application_universal_tooltip_pause_call_disabled),this._setButtonBarButtonColourCss(i,!1,!0)):p?(i.prop("title",this._messages.application_universal_tooltip_resume_call),this._setButtonBarButtonColourCss(i,!0,!1)):(i.prop("title",this._messages.application_universal_tooltip_pause_call),this._setButtonBarButtonColourCss(i,!1,!1));const T=b||p||v;n.attr("aria-disabled",T),n.attr("aria-pressed",m),e.hasClass("oracle-live-frozen-annotation")||e.hasClass("oracle-live-annotation-associate-video-on")?$(".oracle-live-video-maximize.oracle-live-video-toolbar-enduser").attr("aria-disabled",!0):$(".oracle-live-video-maximize.oracle-live-video-toolbar-enduser").attr("aria-disabled",!1),T?(n.prop("title",this._messages.application_video_call_tooltip_share_camera_disabled),this._setButtonBarButtonColourCss(n,!1,!0)):m?(null===this._cameraDefaultOn&&(this._cameraDefaultOn=!0),n.prop("title",this._messages.application_video_call_tooltip_stop_camera_share),this._setButtonBarButtonColourCss(n,!0,!1),e.hasClass("oracle-live-video-control-enduser")||(this._addedOracleLiveVideoControlEnduser=!0,e.addClass("oracle-live-video-control-enduser"))):(null===this._cameraDefaultOn&&(this._cameraDefaultOn=!1),n.prop("title",this._messages.application_video_call_tooltip_share_camera),this._setButtonBarButtonColourCss(n,!1,!1),this._addedOracleLiveVideoControlEnduser&&!1===this._cameraDefaultOn&&(this._addedOracleLiveVideoControlEnduser=!1,e.removeClass("oracle-live-video-control-enduser")));const A=T||C;o.attr("aria-disabled",A),o.attr("aria-pressed",f),A?(o.prop("title",this._messages.application_video_call_tooltip_screen_share_disabled),this._setButtonBarButtonColourCss(o,!1,!0)):f?(o.prop("title",this._messages.application_video_call_tooltip_stop_screen_share),this._setButtonBarButtonColourCss(o,!0,!1)):(o.prop("title",this._messages.application_video_call_tooltip_share_screen),this._setButtonBarButtonColourCss(o,!1,!1)),s.attr("aria-disabled",T||R),s.attr("aria-pressed",E),T?(s.prop("title",this._messages.application_video_call_tooltip_annotation_disabled),this._setButtonBarButtonColourCss(s,!1,!0)):E?(s.prop("title",this._messages.application_video_call_tooltip_stop_annotation),this._setButtonBarButtonColourCss(s,!0,!1)):(s.prop("title",this._messages.application_video_call_tooltip_annotate),this._setButtonBarButtonColourCss(s,!1,!1));const I=u||h||r||c||this._hideEndCallButton;a.attr("aria-disabled",I),I?a.prop("title",this._messages.application_universal_tooltip_end_call_disabled):a.prop("title",this._messages.application_universal_tooltip_end_call),this._setButtonBarEndButtonColourCss(!1,I)}_enableZoom(e){e?(this._liveZoom||(this._liveZoom=new n(this._customization)),this._liveZoom.disable(!1)):this._liveZoom&&this._liveZoom.disable(!0)}hideVideo(){$(".oracle-live").addClass("oracle-live-video-hide")}hideLocalVideo(){$(".oracle-live").addClass("oracle-live-video-local-hide")}swapCamera(){console.log("Swap the local camera"),this._impl._av.swapCamera()}displayMessageDialog(e){$(".oracle-live-dialog-title").text(this._messages[e+"Title"]),$(".oracle-live-dialog-message").text(this._messages[e+"Message"]),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-ok").text(this._messages.application_universal_button_close),this._showDialog(!0,!1)}closeMessageDialog(){return $(".oracle-live-dialog-ok").text()===this._messages.application_universal_button_close&&($(".oracle-live-dialog-ok").text(this._messages.application_universal_button_ok),this._showDialog(!1),!0)}showShareRequest(e,t){this._resetChromeScreenSharePluginClasses(),e?("associate-screenshare"===t?($(".oracle-live-dialog-title").text(this._messages.application_universal_title_remote_add_screen_share),$(".oracle-live-dialog-message").text(this._messages.application_universal_message_remote_add_screen_share)):"user-screenshare"===t?($(".oracle-live-dialog-title").text(this._messages.application_video_call_title_share_screen_request),$(".oracle-live-dialog-message").text(this._messages.application_video_call_message_you_can_stop_screen_share)):"user-video"===t?($(".oracle-live-dialog-title").text(this._messages.application_video_call_message_see_surroundings),this._hidePauseButton?$(".oracle-live-dialog-message").text(this._messages.application_video_call_message_no_pause):$(".oracle-live-dialog-message").text(this._messages.application_video_call_message_pause)):console.log("showShareRequest: Unknown share type: '"+t+"'"),$(".oracle-live").addClass("oracle-live-share-media-request"),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._showDialog(!0,!0)):($(".oracle-live").removeClass("oracle-live-share-media-request"),this._showDialog(!1)),this._updateMenuButtons()}_resetChromeScreenSharePluginClasses(){$(".oracle-live").removeClass("oracle-live-install-plugin-request"),$(".oracle-live").removeClass("oracle-live-installing-plugin"),$(".oracle-live").removeClass("oracle-live-installed-plugin"),$(".oracle-live-dialog-ok").text(this._messages.application_universal_button_ok)}showInstallChromeScreenSharePluginRequest(e){console.log("showInstallChromeScreenSharePluginRequest: show="+e),this._resetChromeScreenSharePluginClasses(),e?($(".oracle-live-dialog-title").text(this._messages.application_screen_share_plugin_install_chrome),$(".oracle-live-dialog-message").text(this._messages.application_screen_share_plugin_install_permission_chrome),$(".oracle-live").addClass("oracle-live-install-plugin-request"),$(".oracle-live-dialog-ok").text(this._messages.application_screen_share_plugin_install_extension),$(".oracle-live-dialog-ok").attr("aria-disabled","false"),this._showDialog(!0,!1)):this._showDialog(!1),this._updateMenuButtons()}showInstallingChromeScreenSharePlugin(e){console.log("showInstallingChromeScreenSharePlugin: show="+e),this._resetChromeScreenSharePluginClasses(),e?($(".oracle-live-dialog-title").text(""),$(".oracle-live-dialog-message").text(this._messages.application_screen_share_plugin_installing_message_chrome),$(".oracle-live").addClass("oracle-live-installing-plugin"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._showDialog(!0,!0)):this._showDialog(!1),this._updateMenuButtons()}showInstalledChromeScreenSharePlugin(e){console.log("showInstalledChromeScreenSharePlugin: show="+e),this._resetChromeScreenSharePluginClasses(),e?($(".oracle-live-dialog-title").text(this._messages.application_screen_share_plugin_installed_title_chrome),$(".oracle-live-dialog-message").text(this._messages.application_screen_share_plugin_installed_message_chrome),$(".oracle-live").addClass("oracle-live-installed-plugin"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),$(".oracle-live-dialog-ok").text(this._messages.application_screen_share_plugin_installed_share_screen),this._showDialog(!0,!0)):this._showDialog(!1),this._updateMenuButtons()}setStartInVideo(e){e!==this._startInVideo&&(this._startInVideo=e,!0===this._idle&&(!0===this._startInVideo?$(".oracle-live").addClass("oracle-live-start-in-video"):$(".oracle-live").removeClass("oracle-live-start-in-video")))}setStartInScreenShare(e){console.log("LiveButtonMenu::setStartInScreenShare",e),e!==this._startInScreenShare&&(this._startInScreenShare=e,!0===this._idle&&(!0===this._startInScreenShare?$(".oracle-live").addClass("oracle-live-start-in-screenshare"):$(".oracle-live").removeClass("oracle-live-start-in-screenshare")))}setStartVideoInFullScreen(e){console.log("setStartVideoInFullScreen: "+e),this._startVideoInFullScreen=e}setStartVideoWithFrontCamera(e){console.log("setStartVideoWithFrontCamera: "+e),this._startVideoWithFrontCamera=e}setHideEndCallButton(e){console.log("setHideEndCallButton: "+e),this._hideEndCallButton=e}setHidePauseButton(e){console.log("setHidePauseButton: "+e),this._hidePauseButton=e}setHideQueueLengthIndicator(e){console.log("setQueueLengthIndicator: "+e),this._hideQueueLengthIndicator=e}setEndUserControlsCamera(e){console.log("setEndUserControlsCamera: "+e),this._endUserControlsCamera=e}setEndUserControlsScreenShare(e){console.log("setEndUserControlsScreenShare: "+e),this._endUserControlsScreenShare=e}setShortCodeMode(e){e!==this._shortCodeMode&&(this._shortCodeMode=e)}setPreCallIDCheck(e){console.log("LiveButtonMenu::setPreCallIDCheck setting _preCallIDCheck: ",e),e!==this._preCallIDCheck&&(this._preCallIDCheck=e)}getPreCallIDCheck(){return this._preCallIDCheck}updatePositionInQueue(e){e&&(console.log(`Setting positionInQueue: ${e}`),$(".oracle-live-position-in-queue").attr("tabindex",null),$(".oracle-live-position-in-queue").text(e),$(".oracle-live-position-in-queue").attr("aria-label",null))}_showNotification(){console.log("LiveButtonMenu::_showNotification"),this._notificationTimer&&clearTimeout(this._notificationTimer);const e=$(".oracle-live");e.removeClass("oracle-live-notification-show  oracle-live-notification-close"),setTimeout(()=>{e.addClass("oracle-live-notification-show")},10),this._notificationTimer=setTimeout(()=>{e.removeClass("oracle-live-notification-show  oracle-live-notification-close")},this._notificationUptime)}closeNotificationMessage(){console.log("LiveButtonMenu::closeNotificationMessage()"),$(".oracle-live").addClass("oracle-live-notification-close")}_removeActiveClasses(){console.log("LiveButtonMenu::_removeActiveClasses");const e=$(".oracle-live-pause-button");!0===this._hidePauseButton?this.hidePauseResumeButton():e.css("display","inline-block"),!0===this._hideEndCallButton&&this.hideEndCallButton(),$(".oracle-live").removeClass("oracle-live-disconnecting oracle-live-feedback").removeClass("oracle-live-paused-enduser oracle-live-paused-associate").removeClass("oracle-live-reconnecting-enduser oracle-live-reconnecting-associate").removeClass("oracle-live-show-dialog").removeClass("oracle-live-recording-on oracle-live-collapsed").removeClass("oracle-live-video-enduser oracle-live-video-enduser-on").removeClass("oracle-live-video-associate oracle-live-video-associate-on").removeClass("oracle-live-screenshare-enduser oracle-live-screenshare-enduser-on").removeClass("oracle-live-screenshare-associate oracle-live-screenshare-associate-on").removeClass("oracle-live-screenshare-associate-maximized").removeClass("oracle-live-screenshare-system-dialog").removeClass("oracle-live-video-associate-maximized").removeClass("oracle-live-video-enduser-maximized").removeClass("oracle-live-enduser-screenshare-annotation-on").removeClass("oracle-live-videopanel-toolbars-hidden")}_addEndUserAnnotationSupport(){console.log("LiveButtonMenu::_addEndUserAnnotationSupport"),this._canvas=$(".oracle-live-annotation-canvas"),this._canvasCtx=this._canvas[0].getContext("2d"),this._oldPosition={x:0,y:0};const e=e=>(this._oldPosition={x:e.clientX,y:e.clientY},!0);this._resizeAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeAnnotationCanvas(),!0)),this._canvas.off("mousemove").on("mousemove",e=>{if(console.log("LiveButtonMenu::_addEndUserAnnotationSupport::draw"),1!==e.buttons)return!0;const t={x:e.clientX,y:e.clientY};return this._drawGraph(this._oldPosition,t),this._oldPosition=t,!0}).off("mousedown").on("mousedown",t=>{console.log("LiveButtonMenu::_addEndUserAnnotationSupport::startGraph"),this._clearAnnotations();const i=$(".oracle-live");i.addClass("oracle-live-enduser-annotation-hide");const n=document.elementFromPoint(t.clientX,t.clientY);return $(n).click(),i.removeClass("oracle-live-enduser-annotation-hide"),e(t)}).off("mouseenter").on("mouseenter",e)}_addAssociateAnnotationSupport(){console.log("LiveButtonMenu::_addAssociateAnnotationSupport()"),this._canvas=$(".oracle-live-annotation-canvas"),this._canvasCtx=this._canvas[0].getContext("2d"),this._oldPosition={x:0,y:0},this._resizeAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeAnnotationCanvas(),!0)),this._canvas.off("mousedown").on("mousedown",e=>{const t=$(".oracle-live");t.addClass("oracle-live-enduser-annotation-hide");const i=document.elementFromPoint(e.clientX,e.clientY);$(i).click(),t.removeClass("oracle-live-enduser-annotation-hide")})}_addAssociateVideoAnnotationSupport(){console.log("LiveButtonMenu::_addAssociateVideoAnnotationSupport"),this._videoCanvas=$(".oracle-live-annotation-video-canvas"),this._videoCanvasCtx=this._videoCanvas[0].getContext("2d"),this._oldPosition={x:0,y:0},this._resizeVideoAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeVideoAnnotationCanvas(),!0)),this._videoCanvas.off("mousedown").on("mousedown",e=>{const t=$(".oracle-live");if(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))return this._toggleTopbarAndToolbar(),!0;t.addClass("oracle-live-associate-annotation-video-hide");const i=document.elementFromPoint(e.clientX,e.clientY);$(i).click(),t.removeClass("oracle-live-associate-annotation-video-hide")})}_drawGraph(e,t){this._canvasCtx?(this._canvasCtx.beginPath(),this._canvasCtx.lineWidth=3,this._canvasCtx.lineCap="round",this._canvasCtx.strokeStyle||(this._canvasCtx.strokeStyle="#FF0000"),this._canvasCtx.moveTo(e.x,e.y),this._canvasCtx.lineTo(t.x,t.y),this._canvasCtx.stroke()):console.log("LiveButtonMenu::_drawGraph has no canvas context")}_drawVideoGraph(e,t){this._videoCanvasCtx?(this._videoCanvasCtx.beginPath(),this._videoCanvasCtx.lineWidth=3,this._videoCanvasCtx.lineCap="round",this._videoCanvasCtx.strokeStyle||(this._videoCanvasCtx.strokeStyle="#FF0000"),this._videoCanvasCtx.moveTo(e.x,e.y),this._videoCanvasCtx.lineTo(t.x,t.y),this._videoCanvasCtx.stroke()):console.log("LiveButtonMenu::_drawVideoGraph has no canvas context")}_removeAnnotationSupport(){this._clearAnnotations(),$(window).off("resize.oraclelive"),$(".oracle-live-annotation-canvas").off("mousemove").off("mousedown").off("mouseenter"),this._canvas=null,this._canvasCtx=null,this._annotationList=[]}_removeVideoAnnotationSupport(){console.log("_removeVideoAnnotationSupport:"),this._clearVideoAnnotations(),$(window).off("resize.oraclelive"),$(".oracle-live-annotation-video-canvas").off("mousemove").off("mousedown").off("mouseenter"),this._videoCanvas=null,this._videoCanvasCtx=null,this._videoAnnotationList=[]}_resizeAnnotationCanvas(){if(!this._canvasCtx)return;const e=window.innerWidth,t=window.innerHeight;this._canvasCtx&&this._canvasCtx.canvas?(this._canvasCtx.canvas.width=e,this._canvasCtx.canvas.height=t,console.log("LiveButtonMenu::_resizeAnnotationCanvas, success this time")):console.error("LiveButtonMenu::_resizeAnnotationCanvas, no canvas found!")}_resizeVideoAnnotationCanvas(){const e=$(".oracle-live");if(this._videoCanvasCtx)if(e.hasClass("oracle-live-video-enduser-maximized")){const e=window.innerWidth,t=window.innerHeight;this._videoCanvasCtx&&this._videoCanvasCtx.canvas?(this._videoCanvasCtx.canvas.width=e,this._videoCanvasCtx.canvas.height=t-44,this.redrawVideoAnnotations(),console.log("LiveButtonMenu::_resizeVideoAnnotationCanvas, success this time")):console.error("LiveButtonMenu::_resizeVideoAnnotationCanvas, no canvas found!")}else{const e=350,t=262;this._videoCanvasCtx.canvas.width=e,this._videoCanvasCtx.canvas.height=t,this.redrawVideoAnnotations()}}_clearAnnotations(){this._canvasCtx&&(this._canvasCtx.clearRect(0,0,this._canvasCtx.canvas.width,this._canvasCtx.canvas.height),this._annotationList=[])}_clearVideoAnnotations(){console.log("_clearVideoAnnotations"),this._videoCanvasCtx&&(this._videoCanvasCtx.clearRect(0,0,this._videoCanvasCtx.canvas.width,this._videoCanvasCtx.canvas.height),this._videoAnnotationList=[])}}}),define("LiveState",["LiveEvents","LiveButtonMenu","LiveSessionStore"],function(LiveEvents,LiveButtonMenu,LiveSessionStore){"use strict";const Paused={None:"None",Local:"Local",Remote:"Remote"},Name={Idle:"Idle",Connecting:"Connecting",Connected:"Connected",Transferring:"Transferring",ReconnectingLocal:"ReconnectingLocal",ReconnectingRemote:"ReconnectingRemote",Disconnecting:"Disconnecting",Disconnected:"Disconnected",PreCallIDCheck:"PreCallIDCheck"},TransferState={None:"None",Started:"Started",AssociateObtained:"AssociateObtained",RemoveOriginalAssociate:"RemoveOriginalAssociate"},Rating={Poor:1,Good:50,Excellent:100};class AbstractState{constructor(e){if(new.target===AbstractState)throw"Cannot instantiate abstract State";this._context=e}get context(){return this._context}get name(){return"Invalid"}enter(){}leave(){}start(){}pause(){}toggleVideo(){}toggleScreenShare(){}toggleScreenShareAnnotate(){}end(){}notification_close(){console.log("Close notification")}dialog_ok(){return this.context.menu.closeMessageDialog()}dialog_cancel(){console.log("Dialog Cancel ignored")}video_preview_start(){console.log("Start in video preview ignored")}video_preview_cancel(){console.log("Cancel in video preview ignored")}poor(){}good(){}excellent(){}changeSize(e){}hideVideo(){}hideLocalVideo(){}swapCamera(){}event(e,t){switch(e){case LiveEvents.LiveMessageEmitted:this.context.menu.displayMessageDialog(t);break;default:console.log("Ignore event: "+e,t||"")}}remoteResume(){this.context.paused===Paused.Remote&&(this.context.paused=Paused.None,this.context.menu.setPausedByAssociate(!1))}remotePause(){this.context.paused===Paused.None&&(this.context.paused=Paused.Remote,this.context.menu.setPausedByAssociate(!0))}localPauseResume(){if(console.log("LiveState::localPauseResume, previewActive="+this.context.previewActive+", oldPausedState="+this.context.paused),!0!==this.context.previewActive)switch(this.context.paused){case Paused.None:this.context.paused=Paused.Local,this.context.menu.setPausedByUser(!0),this.context.controller.holdCallWithAssociate();break;case Paused.Local:this.context.paused=Paused.None,this.context.menu.setPausedByUser(!1),this.context.controller.resumeCallWithAssociate()}else console.log("Ignore pause/resume when preview is active")}remoteUpgrade(){console.log("remoteUpgrade"),this.context.associateVideoOn=!0,this.context.maximizedFeed=null,this.context.menu.setAssociateVideoOn(!0)}reset(){this.context.state=Idle}collapseExpand(){this.context.collapsed=!this.context.collapsed,this.context.menu.setCollapsed(this.context.collapsed),this.context.collapsed?this._maximizedFeed=null:this.context.hiddenVideo&&(this.context.hiddenVideo=!1)}startCall(){this.context.menu.showStartCallDialog(!1),console.log("Idle::start requirePreview="+this.context.isStartWithEndUserVideo()),console.log("Idle::start isPreCallIDCheck="+this.context.isPreCallIDCheck()),this.context.isPreCallIDCheck()?(console.log("LiveState: about to initiate a preCallIDCheck"),this.context.state=PreCallIDCheck):this.context.isStartWithEndUserVideo()?(this.context.previewActive=!0,this.context.controller.startVideoPreview(),this.context.menu.showVideoPreview(!0)):this.context.state=Connecting}endCall(){this.context.controller.endCallWithAssociate(),this.context.menu.showVideoPreview(!1),this.context.controller.stopVideoPreview(!0),this.context.state=Idle}maximizeAssociateScreenShare(){this.context.controller._permanentTwoWayScreenShare||"associateVideo"===this.context.menu.getMaximizedFeed()&&this.context.menu.maximize("associateScreenShare",!0)}}class Idle extends AbstractState{constructor(e,t){console.log("Constructor for Idle State",e,t),super(e),super.context.menu.setIdle(),super.context.configureComponent(),super.context.controller.service.startCallDirectly&&super.context.menu.hideComponent()}get name(){return Name.Idle}start(){super.context.isMeeting||super.context.isPreCallIDCheck()||super.context.controller.service.startCallDirectly?super.startCall():super.context.previewActive||super.context.menu.showStartCallDialog(!0)}dialog_ok(){super.dialog_ok()||super.startCall()}dialog_cancel(){super.context.menu.showStartCallDialog(!1)}video_preview_start(){super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0)}video_preview_cancel(){super.context.previewActive=!1,super.context.menu.showVideoPreview(!1),super.context.controller.stopVideoPreview(!0),super.context.controller.service.startCallDirectly&&super.context.menu.hideComponent()}changeSize(e){const t=e!==super.context.menu.getMaximizedFeed();super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}swapCamera(){super.context.menu.swapCamera()}verificationTryAgain(){console.log("LiveState::idle::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState()}event(e,t){switch(e){case LiveEvents.LiveStartCall:this.start();break;case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;case LiveEvents.LiveLocalVideoStopped:super.context.previewActive&&(console.log("Cannot show video preview - continue as audio"),this.video_preview_cancel(),super.context.state=Connecting);break;default:super.event(e,t)}}}class Connecting extends AbstractState{constructor(e,t){super(e);const i=super.context.isShortCodeEnabled(),n=super.context.isMeeting;console.log("LiveState::shortCodeEnabled =",i),n&&console.log("LiveState::isMeeting, ignoring shortCodeEnabled");let o=null;!n&&i&&(o=super.context.controller.generateShortCode(),console.log("Short code is ",o)),super.context.menu.setConnecting(o),super.context.controller.startCallWithAssociate(null,o)}get name(){return Name.Connecting}enter(){super.enter(),super.context.menu.setConnectingAudio(!0)}leave(){super.leave(),super.context.menu.setConnectingAudio(!1)}start(){super.endCall()}startLocalVideo(){super.context.controller.startVideoPreview()}end(){super.endCall()}changeSize(e){const t=e!==super.context.menu.getMaximizedFeed();super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}swapCamera(){super.context.menu.swapCamera()}event(e,t){switch(e){case LiveEvents.LiveWaiting:super.context.menu.setWaiting(!0);break;case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveConnecting:super.context.menu.setWaiting(!1);break;case LiveEvents.LiveConnected:super.context.state=Connected;break;case LiveEvents.LiveConnectingNoAnswer:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveParticipantLeft:case LiveEvents.LiveEnded:super.endCall();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveRemoteVideoStarted:console.log("LiveState::Got LiveRemoteVideoStarted"),super.remoteUpgrade();break;case LiveEvents.LiveRemoteVideoStopped:super.context.associateVideoOn=!1,super.context.menu.setAssociateVideoOn(!1);break;case LiveEvents.LiveLocalVideoStarted:console.log("LiveState::Got LiveLocalVideoStarted"),super.context.userVideoOn=!0,super.context.menu.setEndUserVideoOn(!0);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;case LiveEvents.LiveDiagnosticsFailed:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveCallQueuePositionUpdate:super.context.menu.updatePositionInQueue(super.context.controller.getPositionInQueue());break;default:super.event(e,t)}}}class Connected extends AbstractState{constructor(e,t){super(e),t===Name.Connecting&&super.context.menu.setConnected()}get name(){return Name.Connected}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}pause(){super.localPauseResume()}toggleVideo(){super.context.paused===Paused.None?super.context.userVideoOn?(super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1),super.context.controller.downgradeLocalVideo()):super.context.isEndUserVideoPossible()&&(super.context.previewActive=!0,super.context.controller.startVideoPreview(),super.context.menu.showVideoPreview(!0)):console.log("Ignore video button in paused state",super.context.paused)}toggleScreenShare(){super.context.paused===Paused.None?super.context.userScreenShareOn?super.context.controller.sendScreenShare(!1):super.context.isEndUserScreenSharePossible()&&super.context.controller.sendScreenShare(!0):console.log("Ignore video button in paused state",super.context.paused)}toggleScreenShareAnnotate(){super.context.userScreenShareOn&&(super.context.menu.isEndUserAnnotationOn()?super.context.menu.setEndUserAnnotationOn(!1):super.context.menu.setEndUserAnnotationOn(!0),super.context.userScreenShareAnnotationOn=super.context.menu.isEndUserAnnotationOn())}video_preview_start(){super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0),console.log("Connected::preview-start: associateVideoOn=",super.context.associateVideoOn),super.context.controller.upgradeLocalVideo()}video_preview_cancel(){super.context.previewActive=!1,super.context.controller.stopVideoPreview(!1),super.context.menu.showVideoPreview(!1)}end(){super.context.state=Disconnecting}changeSize(e){console.log("LiveState::changeSize: feed ="+e+", max feed=",super.context.menu.getMaximizedFeed()),console.log("LiveState::changeSize: maximizedFeed = "+super.context.menu.getMaximizedFeed());const t=e!==super.context.menu.getMaximizedFeed();console.log("LiveState::changeSize: maximize = "+t),super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}hideVideo(){super.context.hiddenVideo=!0,super.context.menu.hideVideo()}hideLocalVideo(){super.context.hiddenLocalVideo=!0,super.context.menu.hideLocalVideo()}swapCamera(){super.context.menu.swapCamera()}dialog_ok(){if(!super.dialog_ok()){if($(".oracle-live").hasClass("oracle-live-install-plugin-request"))return console.log("The user is permitting the chrome plugin install!"),super.context.menu.showInstallChromeScreenSharePluginRequest(!1),void super.context.controller.installChromeScreenSharePlugin();if($(".oracle-live").hasClass("oracle-live-installed-plugin"))return console.log("The user is confirming the offer to share screen after the plugin install"),super.context.menu.showInstalledChromeScreenSharePlugin(!1),void super.context.controller.sendScreenShare(!0);if($(".oracle-live").hasClass("oracle-live-unfreeze-annotation"))return console.log("The user is confirming unfreezing annotation"),super.context.menu.showUnfreezeAnnotationDialog(!1),super.context.menu.setFrozenAnnotationOn(!1),void super.context.menu.setAssociateVideoAnnotationOn(!1,!0);super.context.menu.showShareRequest(!1),super.context.controller.upgradeRequestIsAssociateScreenShare()?super.context.controller.acceptUpgradeRequest():super.context.controller.upgradeRequestIsUserScreenShare()?this.toggleScreenShare():(super.context.previewActive=!0,super.context.controller.startVideoPreview(),super.context.menu.showVideoPreview(!0))}}dialog_cancel(){return $(".oracle-live").hasClass("oracle-live-install-plugin-request")?(console.log("The user is declining the offer to install the chrome plugin"),super.context.menu.showInstallChromeScreenSharePluginRequest(!1),void super.context.controller.declineUpgradeRequest()):$(".oracle-live").hasClass("oracle-live-installing-plugin")?(console.log("The user is canceling the wait for the chrome plugin install"),super.context.menu.showInstallingChromeScreenSharePlugin(!1),void super.context.controller.cancelChromeScreenSharePluginInstall()):$(".oracle-live").hasClass("oracle-live-installed-plugin")?(console.log("The user is canceling the offer to share screen after the plugin install"),super.context.menu.showInstalledChromeScreenSharePlugin(!1),void super.context.controller.declineUpgradeRequest()):$(".oracle-live").hasClass("oracle-live-unfreeze-annotation")?($("body").css("visibility","hidden"),$(".oracle-live").css("visibility","visible"),console.log("The user is canceling the unfreeze annotation"),void super.context.menu.showUnfreezeAnnotationDialog(!1)):(super.context.menu.showShareRequest(!1),void super.context.controller.declineUpgradeRequest())}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveParticipantLeft:console.log("Connected:LiveParticipantLeft: -> ParticipantLeft"),console.log("TRANSFER: TransferState = "+super.context.transferState),super.context.transferState===TransferState.RemoveOriginalAssociate?(console.log("TRANSFER: TransferingCall: Participant has left. Checking to switchover streams..."),super.context._controller._av.switchOverTransferStream(t)):(console.log("Not a transfer call, so disconnecting call."),super.context.state=Disconnected);break;case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectingLocal:super.context.state=ReconnectingLocal;break;case LiveEvents.LiveReconnectingRemote:super.context.state=ReconnectingRemote;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveScreenSharePluginRequired:console.log("Trying to show the Chrome plugin install permission dialog"),super.context.menu.showInstallChromeScreenSharePluginRequest(!0);break;case LiveEvents.LiveScreenSharePluginInstalling:console.log("Showing a dialog that the Chrome plugin install is in progress"),super.context.menu.showInstallingChromeScreenSharePlugin(!0);break;case LiveEvents.LiveScreenSharePluginInstalled:console.log("Closing the dialog that the Chrome plugin install is in progress"),super.context.menu.showInstallingChromeScreenSharePlugin(!1),super.context.menu.showInstalledChromeScreenSharePlugin(!0);break;case LiveEvents.LiveStartVideoRequested:super.context.menu.showShareRequest(!0,"user-video");break;case LiveEvents.LiveRemoteScreenShareRequested:super.context.menu.showShareRequest(!0,"associate-screenshare");break;case LiveEvents.LiveStartScreenShareRequested:super.context.menu.showShareRequest(!0,"user-screenshare");break;case LiveEvents.LiveStartVideoRequestCancelled:case LiveEvents.LiveRemoteScreenShareCancelled:case LiveEvents.LiveStartScreenShareRequestCancelled:super.context.menu.showShareRequest(!1);break;case LiveEvents.LiveRemoteVideoStarted:super.remoteUpgrade();break;case LiveEvents.LiveRemoteVideoStopped:super.context.associateVideoOn=!1,super.context.menu.setAssociateVideoOn(!1);break;case LiveEvents.LiveRemoteVideoLoading:super.context.menu.setVideoLoading(!0);break;case LiveEvents.LiveRemoteVideoLoaded:super.context.menu.setVideoLoading(!1);break;case LiveEvents.LiveLocalVideoStarted:super.context.userVideoOn=!0,super.context.menu.setEndUserVideoOn(!0);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveRemoteScreenStarted:super.context.associateScreenOn=!0,super.context.menu.setAssociateScreenShareOn(!0),this.context.controller._permanentTwoWayScreenShare&&this.context.menu.maximize("associateScreenShare",!0);break;case LiveEvents.LiveRemoteScreenStopped:super.context.associateScreenOn=!1,super.context.menu.setAssociateScreenShareOn(!1);break;case LiveEvents.LiveRemoteScreenActive:super.maximizeAssociateScreenShare();break;case LiveEvents.LiveLocalScreenStarted:super.context.userScreenShareOn=!0,super.context.menu.setEndUserScreenShareOn(!0);break;case LiveEvents.LiveLocalScreenStopped:super.context.userScreenShareOn=!1,super.context.menu.setEndUserScreenShareOn(!1);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveSystemScreenShareDialogShowing:super.context.menu.setScreenShareDialogShowing(!0);break;case LiveEvents.LiveSystemScreenShareDialogRemoved:super.context.menu.setScreenShareDialogShowing(!1);break;case LiveEvents.LiveAssociateAnnotationStarted:super.context.menu.setAssociateAnnotationOn(!0);break;case LiveEvents.LiveAssociateAnnotationStopped:super.context.menu.setAssociateAnnotationOn(!1);break;case LiveEvents.LiveAssociateAnnotationReceived:super.context.menu.displayAssociateAnnotation(t);break;case LiveEvents.LiveAssociateVideoAnnotationStarted:super.context.menu.setAssociateVideoAnnotationOn(!0);break;case LiveEvents.LiveAssociateVideoAnnotationStopped:super.context.menu.setAssociateVideoAnnotationOn(!1);break;case LiveEvents.LiveAssociateVideoAnnotationReceived:super.context.menu.displayAssociateVideoAnnotation(t);break;case LiveEvents.LiveAssociateFreezeCustomerStream:super.context.menu.setFrozenAnnotationOn(!0);break;case LiveEvents.LiveAssociateUnfreezeCustomerStream:super.context.menu.setFrozenAnnotationOn(!1,!0);break;case LiveEvents.LiveAssociateTransferStarted:console.log("TRANSFER: Connected: TransferStarted"),super.context.userScreenShareOn&&(console.log("TRANSFER: Turning screenshare off when transfer starts"),this.toggleScreenShare()),super.context.state=Transferring;break;default:super.event(e,t)}}unfreezeAnnotation(){const e=$(".oracle-live");e.hasClass("oracle-live-paused-associate")||(e.hasClass("oracle-live-frozen-annotation")?super.context.menu.showUnfreezeAnnotationDialog(!0):super.context.menu.setAssociateVideoAnnotationOn(!1,!0))}}class Transferring extends AbstractState{constructor(e,t){super(e),super.context.menu.setTransferringToAnotherAssociate(!0)}get name(){return Name.Transferring}enter(){super.enter()}leave(){super.leave()}start(){}end(){}event(e,t){switch(e){case LiveEvents.LiveAssociateTransferStartStream:console.log("Transferring: TransferStartStream");break;case LiveEvents.LiveAssociateTransferCompleted:console.log("Transferring: TransferComplete"),super.context.state=Connected,super.context.menu.setTransferredToAnotherAssociate(t),super.context.userScreenShareOn=!1;break;case LiveEvents.LiveAssociateTransferFailed:console.log("Transferring: TransferFailed"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;case LiveEvents.LiveAssociateTransferStopped:console.log("Transferring: TransferStopped"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;default:super.event(e,t)}}}class ReconnectingLocal extends AbstractState{constructor(e,t){super(e),super.context.menu.setReconnectingEndUser(!0)}get name(){return Name.ReconnectingLocal}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}pause(){super.localPauseResume()}end(){super.context.state=Disconnecting}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveStreamActive:case LiveEvents.LiveReconnectedLocal:super.context.menu.setPoorNetwork(!1),super.context.menu.setReconnectingEndUser(!1),super.context.controller.sendNetworkStatus("network_recover"),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveParticipantLeft:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;default:super.event(e,t)}}}class ReconnectingRemote extends AbstractState{constructor(e,t){super(e),super.context.menu.setReconnectingAssociate(!0)}get name(){return Name.ReconnectingRemote}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}pause(){super.localPauseResume()}end(){super.context.state=Disconnecting}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectedRemote:super.context.menu.setReconnectingAssociate(!1),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveParticipantLeft:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;default:super.event(e,t)}}}class Disconnecting extends AbstractState{constructor(e,t){super(e),super.context.menu.setDisconnecting(!0)}get name(){return Name.Disconnecting}dialog_ok(){super.dialog_ok()||(super.context.state=Disconnected)}dialog_cancel(){super.context.menu.setDisconnecting(!1),super.context.state=Connected}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectedRemote:super.context.menu.setReconnectingAssociate(!1),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;default:super.event(e,t)}}}class Disconnected extends AbstractState{constructor(e,t){super(e);try{super.context.controller.endCallWithAssociate()}catch(e){console.error("LiveState::DISCONNECTED::could not end the call because of ",e)}super.context.menu.setDisconnected(super.context.ratingRequired)}get name(){return Name.Disconnected}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}dialog_ok(){if(!super.dialog_ok()){const e=super.context.rating;super.context.reset(),super.context.state=Idle,super.context.menu.sessionEnded(),e>0&&(super.context.controller._rest.sendPostCallRating(e,()=>{console.log("Submitted rating: "+e)}),super.context.controller.dispatchEvent(LiveEvents.LiveRatingCompleted))}super.context.menu.setAssociateName("")}enter(){super.enter(),super.context.controller._av.cancelTransferSwitchoverStream()}leave(){super.leave()}start(){super.context.isMeeting&&(console.log("Rejoin a meeting"),super.startCall())}dialog_cancel(){super.context.state=Idle}video_preview_start(){super.context.isMeeting&&(console.log("Rejoin a meeting"),super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0))}video_preview_cancel(){super.context.state=Idle,super.context.isMeeting&&super.context.menu.setCancelled(!0)}poor(){super.context.rating=Rating.Poor,super.context.menu.setRating("poor")}good(){super.context.rating=Rating.Good,super.context.menu.setRating("good")}excellent(){super.context.rating=Rating.Excellent,super.context.menu.setRating("excellent")}verificationSuccessContinue(){console.log("LiveState::disconnected::verificationSuccessContinue"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationTryAgain(){console.log("LiveState::disconnected::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationEnd(){console.log("LiveState::disconnected::verificationEnd"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.context.controller.addClass(".oracle-live","oracle-live-preCallIDCheck-error")}}class PreCallIDCheck extends AbstractState{constructor(e,t){console.log("Constructor for PreCallIDCheck state",e,t),super(e),this.context.menu.setPreCallIDCheck(!0),this.context.controller.startPreCallIDCheck(window)}get name(){return Name.PreCallIDCheck}startPreCallIDCheck(){console.log("LiveState::PreCallIDCheck::starting")}continueVerification(){console.log("LiveState::PreCallIDCheck::continueVerification"),this.context.controller.continueVerification()}verificationSuccessContinue(){console.log("LiveState::PreCallIDCheck::verificationSuccessContinue"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationTryAgain(){console.log("LiveState::PreCallIDCheck::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationEnd(){console.log("LiveState::PreCallIDCheck::verificationEnd"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.context.controller.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.context.controller.netVerificationCancelled()}video_preview_start(){console.log("LiveState::PreCallIDCheck::video_preview_start"),super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0)}video_preview_cancel(){console.log("LiveState::PreCallIDCheck::video_preview_cancel"),super.context.previewActive=!1,super.context.menu.showVideoPreview(!1),super.context.controller.stopVideoPreview(!0)}startAssociateVerificationCall(){console.log("LiveState::PreCallIDCheck::startAssociateVerificationCall"),this.context.isStartWithEndUserVideo()?(console.log("startAssociateVerificationCall: starting video preview"),this.context.previewActive=!0,this.context.controller.startVideoPreview(),this.context.menu.showVideoPreview(!0)):(console.log("startAssociateVerificationCall: moving to connecting state"),this.context.state=Connecting)}showRecordingDialog(){super.context.previewActive||super.context.menu.showStartCallDialog(!0)}dialog_ok(){super.dialog_ok()||(super.context.menu.showStartCallDialog(!1),this.startAssociateVerificationCall())}dialog_cancel(){super.context.menu.showStartCallDialog(!1)}event(e,t){switch(console.log("LiveState::PreCallIDCheck:event ",e,t),e){case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveStartVerificationCall:this.showRecordingDialog();break;case LiveEvents.LivePreCallIDCheckComplete:super.context.state=Idle;break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;default:super.event(e,t)}}}class LiveState{constructor(e){this._controller=e,this._buttonMenu=new LiveButtonMenu(e),this._state=new Idle(this,null),this._stateName=this._state.name,this._isMeeting=!1,this._associateName=null,this._associatePhotoURL=null,this._connectingAudioURL=null,this._positionInQueue=0,this._paused=Paused.None,this._collapsed=!1,this._rating=0,console.log("LiveState::constructor Setting rating required to false"),this._ratingRequired=!1,this._transferState=TransferState.None,this._userVideo=!1,this._userScreen=!1,this._userScreenAnnotate=!1,this._associateVideo=!1,this._associateScreen=!1,this._previewActive=!1,this._hiddenVideo=!1,this._hiddenLocalVideo=!1,this._maximizedFeed=null,this._hideWhenIdle=!1,this._hidden=!1,this._available=!0,this._canRejoinMeeting=!0,this._messages=null,LiveSessionStore.initState("LiveState",this),$(()=>{LiveSessionStore.loadState("LiveState",e=>{const t=e.stateName;this._stateSupportsRehydration(t)&&(this._stateName=e.stateName,this._positionInQueue=e.positionInQueue,this._associateName=e.associateName,this._associatePhotoURL=e.associatePhotoURL,this._connectingAudioURL=e.connectingAudioURL,this._paused=e.paused,this._collapsed=!1,this._maximizedFeed=e.maximizedFeed,this._associateVideo=e.associateVideo,this._userVideo=e.userVideo,this._isMeeting=e.isMeeting,this._canRejoinMeeting=e.canRejoinMeeting,this._userScreenAnnotate=e.userScreenAnnotate,this._associateScreen=e.associateScreen,this._previewActive=e.previewActive,this._hiddenVideo=e.hiddenVideo,this._hiddenLocalVideo=e.hiddenLocalVideo,this._rating=e.rating,this._transferState=e.transferState,this._ratingRequired=e.ratingRequired,this._hideWhenIdle=e.hideWhenIdle,this._hidden=e.hidden,this._available=e.available,this._messages=e.messages,console.log("LiveState: Loaded"))})})}toJSON(){return this._stateSupportsRehydration(this._stateName)?JSON.stringify({stateName:this._stateName,positionInQueue:this._positionInQueue,associateName:this._associateName,associatePhotoURL:this._associatePhotoURL,connectingAudioURL:this._connectingAudioURL,isMeeting:this._isMeeting,canRejoinMeeting:this._canRejoinMeeting,paused:this._paused,userVideo:this._userVideo,userScreenAnnotate:this._userScreenAnnotate,associateVideo:this._associateVideo,associateScreen:this._associateScreen,previewActive:this._previewActive,hiddenVideo:this._hiddenVideo,hiddenLocalVideo:this._hiddenLocalVideo,rating:this._rating,transferState:this._transferState,ratingRequired:this._ratingRequired,hideWhenIdle:this._hideWhenIdle,hidden:this._hidden,available:this._available,messages:this._messages,maximizedFeed:this._maximizedFeed}):null}loadComplete(){if(console.log("LiveState::loadComplete"),!this._stateSupportsRehydration(this._stateName))return void console.log("We will not have restored our state, stay in Idle");const stateClass=eval(this._stateName);this._state=new stateClass(this,null),console.log("LiveState::loadComplete restored state: ",this.stateName,this._buttonMenu);let recoverLocalVideoView=!1;"Connected"===this._stateName?(this._buttonMenu.setConnected(!0),this._hidden?this.hideMenu():this.showMenu()):"Disconnecting"===this._stateName?(this._buttonMenu.setConnected(!0),this._buttonMenu.setDisconnecting(!0),this._hidden?this.hideMenu():this.showMenu()):this.isEndUserVideo()&&(recoverLocalVideoView=!0),this._buttonMenu.updatePositionInQueue(this._positionInQueue),this._buttonMenu.setAssociateName(this._associateName),this._buttonMenu.setAssociatePhoto(this._associatePhotoURL),this._buttonMenu.setConnectingAudioSource(this._connectingAudioURL),console.log("About to restore the paused state: "+this._paused),this._paused===Paused.Local?this._buttonMenu.setPausedByUser(!0):this._paused===Paused.Remote&&this._buttonMenu.setPausedByAssociate(!0),this._associateVideo&&(console.log("About to turn associate video back on"),this._buttonMenu.setAssociateVideoOn(!0)),this._associateScreen&&(console.log("About to turn associate screen back on"),this._buttonMenu.setAssociateScreenShareOn(!0)),this._previewActive&&this._buttonMenu.showVideoPreview(!0),(this._userVideo||recoverLocalVideoView)&&(console.log("About to turn end user video back on"),this._buttonMenu.setEndUserVideoOn(!0),this._controller.startVideoPreview()),this._userScreen&&this._buttonMenu.setEndUserScreenShareOn(!0),this._userScreenAnnotate&&this._buttonMenu.setEndUserAnnotationOn(!0),this._hiddenVideo&&this._buttonMenu.hideVideo(),this._hiddenLocalVideo&&this._buttonMenu.hideLocalVideo(),this._maximizedFeed&&this._buttonMenu.maximize(this._maximizedFeed,!0),this._buttonMenu.setStartVideoWithFrontCamera(this.isStartVideoWithFrontCamera()),this._buttonMenu.setStartVideoInFullScreen(this.isStartVideoInFullScreen()),this._buttonMenu.setHideEndCallButton(this.isHideEndCallButton()),this._buttonMenu.setHidePauseButton(this.isHidePauseButton()),this._buttonMenu.setHideQueueLengthIndicator(this.isHideQueueLengthIndicator())}reset(){console.log("LiveState::reset"),this._positionInQueue=0,this._associateName=null,this._associatePhotoURL=null,this._paused=Paused.None,this._collapsed=!1,this._maximizedFeed=null,this._associateVideo=!1,this._userVideo=!1,this._userScreen=!1,this._userScreenAnnotate=!1,this._associateScreen=!1,this._previewActive=!1,this._hiddenVideo=!1,this._hiddenLocalVideo=!1,this._canRejoinMeeting=!0,this._rating=0,this._transferState=TransferState.None,console.log("LiveState::reset Setting rating required to false"),this._ratingRequired=!1}set state(e){const t=this._state;this._state.leave(e),this._state=new e(this,t.name),this._state.enter(t),this._stateName=this.stateName,console.log("state transition: "+t.name+" -> "+this.stateName)}get state(){return this._state}get stateName(){return this.state.name}get menu(){return this._buttonMenu}get controller(){return this._controller}get associateName(){return this._associateName}set associateName(e){this._associateName=e,this._buttonMenu.setAssociateName(e)}get associatePhotoURL(){return this._associatePhotoURL}set associatePhotoURL(e){this._associatePhotoURL=e,this._buttonMenu.setAssociatePhoto(e)}set connectingAudioURL(e){this._connectingAudioURL=e,this._buttonMenu.setConnectingAudioSource(e)}get connectingAudioURL(){return this._connectingAudioURL}get paused(){return this._paused}set paused(e){this._paused=e}get collapsed(){return this._collapsed}set collapsed(e){this._collapsed=e}get associateVideoOn(){return this._associateVideo}set associateVideoOn(e){this._associateVideo=e}get userVideoOn(){return this._userVideo}set userVideoOn(e){this._userVideo=e}get userScreenShareOn(){return this._userScreen}set userScreenShareOn(e){this._userScreen=e}get userScreenShareAnnotationOn(){return this._userScreenAnnotate}set userScreenShareAnnotationOn(e){this._userScreenAnnotate=e,e?this._controller.sendAnnotationStart():this._controller.sendAnnotationStop()}get associateScreenOn(){return this._associateScreen}set associateScreenOn(e){this._associateScreen=e}get previewActive(){return this._previewActive}set previewActive(e){this._previewActive=e}get hiddenVideo(){return this._hiddenVideo}set hiddenVideo(e){this._hiddenVideo=e}get hiddenLocalVideo(){return this._hiddenLocalVideo}set hiddenLocalVideo(e){this._hiddenLocalVideo=e}get rating(){return this._rating}set rating(e){this._rating=e}get transferState(){return this._transferState}set transferState(e){this._transferState=e}get isMeeting(){return this._isMeeting}set isMeeting(e){this._isMeeting=e,this.menu._isMeeting=e}get canRejoinMeeting(){return this._canRejoinMeeting}set canRejoinMeeting(e){this._canRejoinMeeting=e,this.menu._canRejoinMeeting=e}get ratingRequired(){return console.log("Get ratingRequired",this._ratingRequired),this._ratingRequired}set ratingRequired(e){console.log("Setting ratingRequired to ",e),this._ratingRequired=e}set messages(e){this._messages=e}get messages(){return this._messages}isTransferring(){const e=this._transferState===TransferState.Started||this._transferState===TransferState.AssociateObtained;return console.log("Transfer: isTransferring: "+e+"("+this._transferState+")"),e}isEndUserVideo(){return this.controller._behaviours&&this.controller._behaviours.isEndUserVideo()}isEndUserVideoPossible(){return this.controller._behaviours&&this.controller._behaviours.isEndUserVideoPossible()}isEndUserControlsCamera(){const e=this.controller._behaviours&&this.controller._behaviours.isEndUserVideoPossible()&&!0===this.controller._behaviours.endUserCanAddVideo;return console.log("isEndUserControlsCamera: "+!!e),!!e}isEndUserScreenSharePossible(){return this.controller._behaviours&&this.controller._behaviours.isEndUserScreenSharePossible()}isEndUserControlsScreenShare(){const e=this.controller._behaviours&&this.controller._behaviours.isEndUserScreenSharePossible()&&!0===this.controller._behaviours.endUserCanAddScreenShare;return console.log("isEndUserControlsScreenShare: "+!!e),!!e}isAssociateAudioPossible(){return this.controller._behaviours&&this.controller._behaviours.isAssociateAudioPossible()}isAssociateVideoPossible(){return this.controller._behaviours&&this.controller._behaviours.isAssociateVideoPossible()}isStartWithEndUserVideo(){return this.controller._behaviours&&this.controller._behaviours.isStartWithEndUserVideo()}isStartWithAssociateVideo(){return this.controller._behaviours&&this.controller._behaviours.isStartWithAssociateVideo()}isStartWithEndUserScreenShare(){return this.controller._behaviours&&this.controller._behaviours.isStartWithEndUserScreenShare()}isShortCodeEnabled(){const e=!this.isMeeting&&this.controller._behaviours&&this.controller._behaviours.shortCodeEnabled;return console.log("LiveState::isShortCodeEnabled=",e),!0===e}isPreCallIDCheck(){return console.log("LiveState::isPreCallIDCheck=",this.controller._behaviours&&this.controller._behaviours.preCallIDCheck),!0===(this.controller._behaviours&&this.controller._behaviours.preCallIDCheck)}isStartVideoWithFrontCamera(){const e=(this.isMeeting||this._controller.settings.startVideoWithFrontCamera)&&this.isEndUserVideoPossible();return console.log("LiveState::isStartVideoWithFrontCamera=",e),!0===e}isStartVideoInFullScreen(){const e=(this.isMeeting||this._controller.settings.startVideoInFullScreen)&&(this.isAssociateVideoPossible()||this.isEndUserVideoPossible());return console.log("LiveState::isStartVideoInFullScreen=",e),!0===e}isHideEndCallButton(){return console.log("LiveState: isHideEndCallButton=",this._controller.settings.hideEndCallButton),!0===this._controller.settings.hideEndCallButton}isHidePauseButton(){return console.log("LiveState: isHidePauseButton=",this._controller.settings.hidePauseButton),!0===this._controller.settings.hidePauseButton}isHideQueueLengthIndicator(){return console.log("LiveState: isHideQueueLengthIndicator=",this._controller.settings.hideQueueLengthIndicator),!0===this._controller.settings.hideQueueLengthIndicator}addMenu(e){const t=this.controller.contextAttributes.get("meetingTitle");this._messages&&this.menu.setMessages(this._messages),this.controller._customization&&this.menu.setCustomization(this.controller._customization),this.menu.addComponent(this.controller._messages,this.controller._browserName,t),e?console.log("addMenu: refreshing - not returning to Idle state"):this.menu.setIdle(),this.configureComponent(),this._setClickHandlers(),this._hidden?this.hideMenu():this.showMenu(),this.controller.service.startCallDirectly&&(live.resumeAudioContext(),this.start())}updateMenu(){const e=this.stateName;console.log("updateMenu in state: "+e),e===Name.Idle&&this.configureComponent()}configureComponent(){const e=this.controller.contextAttributes.get("meetingTitle");this.menu.updateMessages(this.controller._messages,e),this.menu.setCustomization(this.controller._customization);const t=this.isStartWithEndUserVideo()||this.isStartWithAssociateVideo();this.menu.setStartInVideo(t),this.menu.setStartVideoWithFrontCamera(this.isStartVideoWithFrontCamera()),this.menu.setStartVideoInFullScreen(this.isStartVideoInFullScreen()),this.menu.setStartInScreenShare(this.isStartWithEndUserScreenShare()),this.menu.setShortCodeMode(this.isShortCodeEnabled()),this.menu.setPreCallIDCheck(this.isPreCallIDCheck()),this.menu.setHideEndCallButton(this.isHideEndCallButton()),this.menu.setHidePauseButton(this.isHidePauseButton()),this.menu.setHideQueueLengthIndicator(this.isHideQueueLengthIndicator()),this.configureBehaviours()}hidePauseResumeButton(){this.menu.hidePauseResumeButton()}hideQueueLengthIndicator(){console.log("hideQueueLengthIndicator"),this.menu.hideQueueLengthIndicator(this.isHideQueueLengthIndicator())}configureBehaviours(){this.menu.setEndUserControlsCamera(this.isEndUserControlsCamera()),this.menu.setEndUserControlsScreenShare(this.isEndUserControlsScreenShare())}_stateSupportsRehydration(e){let t="Connecting"===e||"Connected"===e||"Disconnecting"===e;return console.log("supportsRehydration("+e+") returning "+t),t}_setClickHandlers(){this._connectHandlers($(".oracle-live-main-button"),()=>{live.resumeAudioContext(),this.start()}),this._connectHandlers($(".oracle-live-exit-button"),()=>{this.end()}),this._connectHandlers($(".oracle-live-cancel-button"),()=>{this.end()}),this._connectHandlers($(".oracle-live-rejoin-button"),()=>{this.start()}),this._connectHandlers($(".oracle-live-pause-button"),()=>{this.pause()}),this._connectHandlers($(".oracle-live-video-button"),()=>{this.toggleVideo()}),this._connectHandlers($(".oracle-live-screenshare-button"),()=>{this.toggleScreenShare()}),this._connectHandlers($(".oracle-live-annotate-button"),()=>{this.toggleScreenShareAnnotate()}),this._connectHandlers($(".oracle-live-notificationmessage"),()=>{this.notification_close()}),this._connectHandlers($(".oracle-live-dialog-ok"),()=>{this.dialog_ok()}),this._connectHandlers($(".oracle-live-dialog-cancel"),()=>{this.dialog_cancel()}),this._connectHandlers($(".oracle-live-dialog-option-poor"),()=>{this.poor()}),this._connectHandlers($(".oracle-live-dialog-option-good"),()=>{this.good()}),this._connectHandlers($(".oracle-live-dialog-option-excellent"),()=>{this.excellent()}),this._connectHandlers($(".oracle-live-preview-start-button"),()=>{this.video_preview_start()}),this._connectHandlers($(".oracle-live-preview-cancel-button"),()=>{this.video_preview_cancel()}),this._connectHandlers($(".oracle-live-video-maximize"),e=>{if(e&&e.target){const t=e.target.getAttribute("name");this.changeSize(t)}}),this._connectHandlers($(".oracle-live-video-closeall"),()=>{this.hideVideo()}),this._connectHandlers($(".oracle-live-swap-camera"),()=>{this.swapCamera()}),this._connectHandlers($(".oracle-live-video-closelocal"),()=>{this.hideLocalVideo()}),this._connectHandlers($(".oracle-live-verification-continue-button"),()=>{this.continueVerification()}),this._connectHandlers($(".oracle-live-verification-success-button"),()=>{this.verificationSuccessContinue()}),this._connectHandlers($(".oracle-live-verification-try-again-button"),()=>{this.verificationTryAgain()}),this._connectHandlers($(".oracle-live-verification-close"),()=>{this.verificationEnd()}),this._connectHandlers($(".oracle-live-unfreeze-annotation-cross"),()=>{this.unfreezeAnnotation()})}_connectHandlers(e,t){e&&t||console.log("Missing component",e," or handler ",t),e.off("click").click(i=>{if(!0!==e.attr("aria-disabled")&&"true"!==e.attr("aria-disabled"))return t(i),!1;console.log("Clicked on component is disabled",e)}),e.off("keypress").keypress(i=>{if(!0===e.attr("aria-disabled")||"true"===e.attr("aria-disabled"))return;const n=i.keyCode||i.which;return 13===n||32===n?(t(i),!1):void 0})}showMenu(){this._available&&(this._hidden=!1,this._hideWhenIdle=!1,this.controller.service.startCallDirectly?console.log("Not showing menu, startCallDirectly flag is set"):(console.log("showMenu in state: "+this.stateName),this.menu.showComponent()))}hideMenu(){this._hidden=!0,console.log("hideMenu in state: "+this.stateName),this.stateName===Name.Idle?(this.menu.hideComponent(),this._hideWhenIdle=!1):(console.log("Cannot hide component in state: "+this.stateName+", will hide when Idle"),this._hideWhenIdle=!0)}setAvailable(e){this._available=e,console.log("LiveState::setAvailable: ",this._available)}isAvailable(){return this._available}hideWhenIdle(){this._hideWhenIdle&&this._hidden&&(this.menu.hideComponent(),this._hideWhenIdle=!1)}start(){console.log("click: start in state: "+this.stateName),this._state.start()}pause(){console.log("click: pause in state: "+this.stateName),this._state.pause()}toggleVideo(){console.log("click: video in state: "+this.stateName),this._state.toggleVideo()}toggleScreenShare(){console.log("click: toggle screen share in state: "+this.stateName),this._state.toggleScreenShare()}toggleScreenShareAnnotate(){console.log("click: toggle screen share annotate in state: "+this.stateName),this._state.toggleScreenShareAnnotate()}end(){console.log("click: end in state: "+this.stateName),this._state.end()}notification_close(){console.log("click: X in state: "+this.stateName),this._state.notification_close()}dialog_ok(){console.log("click: ok in state: "+this.stateName),this._state.dialog_ok()}dialog_cancel(){console.log("click: cancel in state: "+this.stateName),this._state.dialog_cancel()}video_preview_start(){console.log("click: start video preview in state: "+this.stateName),this._state.video_preview_start()}video_preview_cancel(){console.log("click: cancel video preview in state: "+this.stateName),this._state.video_preview_cancel()}poor(){console.log("click: poor in state: "+this.stateName),this._state.poor()}good(){console.log("click: good in state: "+this.stateName),this._state.good()}excellent(){console.log("click: excellent in state: "+this.stateName),this._state.excellent()}changeSize(e){this._state.changeSize(e)}hideVideo(){console.log("click: hideVideo in state: "+this.stateName),this._state.hideVideo()}hideLocalVideo(){console.log("click: hideVideo in state: "+this.stateName),this._state.hideLocalVideo()}swapCamera(){console.log("click: swapCamera in state: "+this.stateName),this._state.swapCamera()}continueVerification(){console.log("click: continueVerification in state: "+this.stateName),this._state.continueVerification()}verificationSuccessContinue(){console.log("click: verificationSuccessContinue in state: "+this.stateName),this._state.verificationSuccessContinue()}verificationTryAgain(){console.log("click: verificationTryAgain in state: "+this.stateName),this._state.verificationTryAgain()}verificationEnd(){console.log("click: verificationEnd in state: "+this.stateName),this._state.verificationEnd()}unfreezeAnnotation(){$("body").css("visibility","visible"),console.log("click: veriunfreezeAnnotation in state: "+this.stateName),this._state.unfreezeAnnotation()}event(e,t){console.log("event: "+e+" in state: "+this.stateName),this._state.event(e,t)}}return LiveState}),function(e){"use strict";function t(){this.bitsNeeded=0,this.codePoint=0}function i(e){this.withCredentials=!1,this.responseType="",this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=I,this.onreadystatechange=I,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=I}function n(e){return e.replace(/[A-Z]/g,function(e){return String.fromCharCode(e.charCodeAt(0)+32)})}function o(e){for(var t=Object.create(null),i=e.split("\r\n"),o=0;o<i.length;o+=1){var s=i[o].split(": "),a=s.shift(),r=s.join(": ");t[n(a)]=r}this._map=t}function s(){}function a(e){this._headers=e}function r(){}function c(){this._listeners=Object.create(null)}function l(e){p(function(){throw e},0)}function d(e){this.type=e,this.target=void 0}function u(e,t){d.call(this,e),this.data=t.data,this.lastEventId=t.lastEventId}function h(e,t){d.call(this,e),this.status=t.status,this.statusText=t.statusText,this.headers=t.headers}function g(e,t){c.call(this),this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this._close=void 0,function(e,t,n){t=String(t);var o=void 0!=n&&Boolean(n.withCredentials),a=U(1e3),c=void 0!=n&&void 0!=n.heartbeatTimeout?V(n.heartbeatTimeout,45e3):U(45e3),g="",S=a,f=!1,_=void 0!=n&&void 0!=n.headers?JSON.parse(JSON.stringify(n.headers)):void 0,C=void 0!=n&&void 0!=n.Transport?n.Transport:v(),E=F?void 0:new i(new C),R=F?new r:new s,b=void 0,T=0,A=y,I="",q="",z="",H="",W=N,G=0,j=0,J=function(t,i,n,o,s){if(A===O)if(b=s,200===t&&void 0!=n&&x.test(n)){A=k,f=!0,S=a,e.readyState=k;var r=new h("open",{status:t,statusText:i,headers:o});e.dispatchEvent(r),B(e,e.onopen,r)}else{var c="";200!==t?(i&&(i=i.replace(/\s+/g," ")),c="EventSource's response has a status "+t+" "+i+" that is not 200. Aborting the connection."):c="EventSource's response has a Content-Type specifying an unsupported type: "+(void 0==n?"-":n.replace(/\s+/g," "))+". Aborting the connection.",l(new Error(c)),K();var r=new h("error",{status:t,statusText:i,headers:o});e.dispatchEvent(r),B(e,e.onerror,r)}},Y=function(t){if(A===k){for(var i=-1,n=0;n<t.length;n+=1){var o=t.charCodeAt(n);(o==="\n".charCodeAt(0)||o==="\r".charCodeAt(0))&&(i=n)}var s=(-1!==i?H:"")+t.slice(0,i+1);H=(-1===i?H:"")+t.slice(i+1),""!==s&&(f=!0);for(var r=0;r<s.length;r+=1){var o=s.charCodeAt(r);if(W===w&&o==="\n".charCodeAt(0))W=N;else if(W===w&&(W=N),o==="\r".charCodeAt(0)||o==="\n".charCodeAt(0)){if(W!==N){W===P&&(j=r+1);var l=s.slice(G,j-1),d=s.slice(j+(r>j&&s.charCodeAt(j)===" ".charCodeAt(0)?1:0),r);"data"===l?(I+="\n",I+=d):"id"===l?q=d:"event"===l?z=d:"retry"===l?(a=V(d,a),S=a):"heartbeatTimeout"===l&&(c=V(d,c),0!==T&&(m(T),T=p(function(){Z()},c)))}if(W===N){if(""!==I){g=q,""===z&&(z="message");var h=new u(z,{data:I.slice(1),lastEventId:q});if(e.dispatchEvent(h),"message"===z&&B(e,e.onmessage,h),A===L)return}I="",z=""}W=o==="\r".charCodeAt(0)?w:N}else W===N&&(G=r,W=P),W===P?o===":".charCodeAt(0)&&(j=r+1,W=D):W===D&&(W=M)}}},Q=function(){if(A===k||A===O){A=y,0!==T&&(m(T),T=0),T=p(function(){Z()},S),S=U(Math.min(16*a,2*S)),e.readyState=O;var t=new d("error");e.dispatchEvent(t),B(e,e.onerror,t)}},K=function(){A=L,void 0!=b&&(b(),b=void 0),0!==T&&(m(T),T=0),e.readyState=L},Z=function(){if(T=0,A===y){f=!1,T=p(function(){Z()},c),A=O,I="",z="",q=g,H="",G=0,j=0,W=N;var e=t;"data:"!==t.slice(0,5)&&"blob:"!==t.slice(0,5)&&""!==g&&(e+=(-1===t.indexOf("?")?"?":"&")+"lastEventId="+encodeURIComponent(g));var i={Accept:"text/event-stream"};if(void 0!=_)for(var n in _)Object.prototype.hasOwnProperty.call(_,n)&&(i[n]=_[n]);try{R.open(E,J,Y,Q,e,o,i)}catch(e){throw K(),e}}else f||void 0==b?(f=!1,T=p(function(){Z()},c)):(l(new Error("No activity within "+c+" milliseconds. Reconnecting.")),b(),b=void 0)};e.url=t,e.readyState=O,e.withCredentials=o,e._close=K,Z()}(this,e,t)}function v(){return S&&"withCredentials"in S.prototype?S:f}var p=e.setTimeout,m=e.clearTimeout,S=e.XMLHttpRequest,f=e.XDomainRequest,_=e.EventSource,C=e.document,E=e.Promise,R=e.fetch,b=e.Response,T=e.TextDecoder,A=e.TextEncoder;null==Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t}),void 0!=E&&void 0==E.prototype.finally&&(E.prototype.finally=function(e){return this.then(function(t){return E.resolve(e()).then(function(){return t})},function(t){return E.resolve(e()).then(function(){throw t})})}),t.prototype.decode=function(e){function t(e,t,i){if(1===i)return e>=128>>t&&2047>=e<<t;if(2===i)return e>=2048>>t&&55295>=e<<t||e>=57344>>t&&65535>=e<<t;if(3===i)return e>=65536>>t&&1114111>=e<<t;throw new Error}function i(e,t){if(6===e)return t>>6>15?3:t>31?2:1;if(12===e)return t>15?3:2;if(18===e)return 3;throw new Error}for(var n=65533,o="",s=this.bitsNeeded,a=this.codePoint,r=0;r<e.length;r+=1){var c=e[r];0!==s&&(128>c||c>191||!t(a<<6|63&c,s-6,i(s,a)))&&(s=0,a=n,o+=String.fromCharCode(a)),0===s?(c>=0&&127>=c?(s=0,a=c):c>=192&&223>=c?(s=6,a=31&c):c>=224&&239>=c?(s=12,a=15&c):c>=240&&247>=c?(s=18,a=7&c):(s=0,a=n),0===s||t(a,s,i(s,a))||(s=0,a=n)):(s-=6,a=a<<6|63&c),0===s&&(65535>=a?o+=String.fromCharCode(a):(o+=String.fromCharCode(55296+(a-65535-1>>10)),o+=String.fromCharCode(56320+(a-65535-1&1023))))}return this.bitsNeeded=s,this.codePoint=a,o};void 0!=T&&void 0!=A&&function(){try{return"test"===(new T).decode((new A).encode("test"),{stream:!0})}catch(e){}return!1}()||(T=t);var I=function(){};i.prototype.open=function(e,t){this._abort(!0);var i=this,n=this._xhr,o=1,s=0;this._abort=function(e){0!==i._sendTimeout&&(m(i._sendTimeout),i._sendTimeout=0),(1===o||2===o||3===o)&&(o=4,n.onload=I,n.onerror=I,n.onabort=I,n.onprogress=I,n.onreadystatechange=I,n.abort(),0!==s&&(m(s),s=0),e||(i.readyState=4,i.onreadystatechange())),o=0};var a=function(){if(1===o){var e=0,t="",s=void 0;if("contentType"in n)e=200,t="OK",s=n.contentType;else try{e=n.status,t=n.statusText,s=n.getResponseHeader("Content-Type")}catch(i){e=0,t="",s=void 0}0!==e&&(o=2,i.readyState=2,i.status=e,i.statusText=t,i._contentType=s,i.onreadystatechange())}},r=function(){if(a(),2===o||3===o){o=3;var e="";try{e=n.responseText}catch(e){}i.readyState=3,i.responseText=e,i.onprogress()}},c=function(){r(),(1===o||2===o||3===o)&&(o=4,0!==s&&(m(s),s=0),i.readyState=4,i.onreadystatechange())},l=function(){s=p(function(){l()},500),3===n.readyState&&r()};n.onload=c,n.onerror=c,n.onabort=c,"sendAsBinary"in S.prototype||"mozAnon"in S.prototype||(n.onprogress=r),n.onreadystatechange=function(){void 0!=n&&(4===n.readyState?c():3===n.readyState?r():2===n.readyState&&a())},"contentType"in n&&(t+=(-1===t.indexOf("?")?"?":"&")+"padding=true"),n.open(e,t,!0),"readyState"in n&&(s=p(function(){l()},0))},i.prototype.abort=function(){this._abort(!1)},i.prototype.getResponseHeader=function(e){return this._contentType},i.prototype.setRequestHeader=function(e,t){var i=this._xhr;"setRequestHeader"in i&&i.setRequestHeader(e,t)},i.prototype.getAllResponseHeaders=function(){return void 0!=this._xhr.getAllResponseHeaders?this._xhr.getAllResponseHeaders():""},i.prototype.send=function(){if("ontimeout"in S.prototype||void 0==C||void 0==C.readyState||"complete"===C.readyState){var e=this._xhr;e.withCredentials=this.withCredentials,e.responseType=this.responseType;try{e.send(void 0)}catch(e){throw e}}else{var t=this;t._sendTimeout=p(function(){t._sendTimeout=0,t.send()},4)}},o.prototype.get=function(e){return this._map[n(e)]},s.prototype.open=function(e,t,i,n,s,a,r){e.open("GET",s);var c=0;for(var l in e.onprogress=function(){var t=e.responseText.slice(c);c+=t.length,i(t)},e.onreadystatechange=function(){if(2===e.readyState){var i=e.status,s=e.statusText,a=e.getResponseHeader("Content-Type"),r=e.getAllResponseHeaders();t(i,s,a,new o(r),function(){e.abort()})}else 4===e.readyState&&n()},e.withCredentials=a,e.responseType="text",r)Object.prototype.hasOwnProperty.call(r,l)&&e.setRequestHeader(l,r[l]);e.send()},a.prototype.get=function(e){return this._headers.get(e)},r.prototype.open=function(e,t,i,n,o,s,r){var c=new T;R(o,{headers:r,credentials:s?"include":"same-origin"}).then(function(e){var n=e.body.getReader();return t(e.status,e.statusText,e.headers.get("Content-Type"),new a(e.headers),function(){n.cancel()}),new E(function(e,t){var o=function(){n.read().then(function(t){if(t.done)e(void 0);else{var n=c.decode(t.value,{stream:!0});i(n),o()}}).catch(function(e){t(e)})};o()})}).finally(function(){n()})},c.prototype.dispatchEvent=function(e){e.target=this;var t=this._listeners[e.type];if(void 0!=t)for(var i=t.length,n=0;i>n;n+=1){var o=t[n];try{"function"==typeof o.handleEvent?o.handleEvent(e):o.call(this,e)}catch(e){l(e)}}},c.prototype.addEventListener=function(e,t){e=String(e);var i=this._listeners,n=i[e];void 0==n&&(n=[],i[e]=n);for(var o=!1,s=0;s<n.length;s+=1)n[s]===t&&(o=!0);o||n.push(t)},c.prototype.removeEventListener=function(e,t){e=String(e);var i=this._listeners,n=i[e];if(void 0!=n){for(var o=[],s=0;s<n.length;s+=1)n[s]!==t&&o.push(n[s]);0===o.length?delete i[e]:i[e]=o}},u.prototype=Object.create(d.prototype),h.prototype=Object.create(d.prototype);var y=-1,O=0,k=1,L=2,w=-1,N=0,P=1,D=2,M=3,x=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,V=function(e,t){var i=parseInt(e,10);return i!=i&&(i=t),U(i)},U=function(e){return Math.min(Math.max(e,1e3),18e6)},B=function(e,t,i){try{"function"==typeof t&&t.call(e,i)}catch(e){l(e)}},F=void 0!=R&&void 0!=b&&"body"in b.prototype;g.prototype=Object.create(c.prototype),g.prototype.CONNECTING=O,g.prototype.OPEN=k,g.prototype.CLOSED=L,g.prototype.close=function(){this._close()},g.CONNECTING=O,g.OPEN=k,g.CLOSED=L,g.prototype.withCredentials=void 0,e.EventSourcePolyfill=g,e.NativeEventSource=_,void 0==S||void 0!=_&&"withCredentials"in _.prototype||(e.EventSource=g)}("undefined"!=typeof window?window:this),define("eventsource.min",function(){}),define("LiveRestHelper",["LiveEvents","LiveSessionStore","eventsource.min"],function(e,t){"use strict";const i=1e4;return class{constructor(e){this._impl=e,this._callQueue=null,this._clientId=null,this._clientKey=null,this._appName=null,this._noProxyForKyc=!1,this._kycAttemptNumber=0,this._runningForChromeExtension=!1,this._promisesInFlight={},t.initState("LiveRestHelper",this),$(()=>{console.log("LiveRestHelper: Loading"),t.loadState("LiveRestHelper",e=>{this._clientId=e.clientId,this._clientKey=e.clientKey,this._appName=e.appName,this._noProxyForKyc=e.noProxyForKyc,this._kycAttemptNumber=e.kycAttemptNumber,this._impl.contextAttributes.set("appName",this._appName),this._impl.contextAttributes.set("clientId",this._clientId),console.log("Loaded appName = "+this._impl.contextAttributes.get("appName")),console.log("LiveRestHelper: Loaded")})});let i=this._promisesInFlight;this.messageHandler=function(e){if(e.data&&e.data.lxRequest&&"LiveRestHelper.js"===e.data.lxRequest.sender){console.log("We have a response to a background XHR request..",e.data);let t=i[e.data.lxRequest.promiseId];t&&(console.log("Resolving - and deleting - promise...",t),e.data.lxError?t.reject(e.data.lxError):t.resolve(JSON.parse(e.data.lxResponse)),delete i[e.data.lxRequest.promiseId],console.log("Note: promisesInFlight cache now=",i))}},window.addEventListener("message",this.messageHandler,!1)}toJSON(){return JSON.stringify({clientId:this._clientId,clientKey:this._clientKey,appName:this._appName,noProxyForKyc:this._noProxyForKyc,kycAttemptNumber:this._kycAttemptNumber})}beforeUnload(){console.log("LiveRestHelper: Attempting to close the call queue"),this.closeCallQueue()}loadComplete(){console.log("LiveRestHelper: Load complete")}generateId(e){let t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=i.length;for(let o=0;o<e;o++)t+=i.charAt(Math.floor(Math.random()*n));return t}defer(){let e,t,i=new Promise((i,n)=>{e=i,t=n});return i.resolve=e,i.reject=t,i}_fetchInBackground(e,t,i,n,o){console.log("LiveRestHelper.fetchInBackground - handing off to the background doXHR mechanism.."),console.log("LiveRestHelper.fetchInBackground: method=",e),console.log("LiveRestHelper.fetchInBackground: url=",t),console.log("LiveRestHelper.fetchInBackground: data=",i),console.log("LiveRestHelper.fetchInBackground: auth=",n),console.log("LiveRestHelper.fetchInBackground: contentType=",o);let s=this.defer(),a=this.generateId(8);return this._promisesInFlight[a]=s,window.postMessage({sender:"LiveRestHelper.js",msg:"doXHR",method:e,accept:o,contentType:o,auth:n||"Bearer "+this._impl.service.authToken,url:t,body:i,promiseId:a},"*"),s}_fetch(e,t,i,n,o){const s=n||this._impl.service.authToken,a=o||"application/json";return this._runningForChromeExtension?this._fetchInBackground(e,t,i,n,a):fetch(t,{method:e,body:i,mode:"cors",credentials:"include",headers:{"Content-Type":a,Accept:a,Authorization:"Bearer "+s,"X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(e.ok)return 200===e.status?e.text():Promise.resolve(e.statusText);{const t=new Error(e.statusText);throw t.response=e,t}}).then(e=>{try{return e?Promise.resolve(JSON.parse(e)):Promise.resolve(e)}catch(t){return console.log("LiveRestHelper::fetch could not process : '"+e+"'"),console.warn("response : '"+t+"''"),Promise.resolve(e)}})}_get(e,t){return this._fetch("GET",e,null,null,t)}_post(e,t){return this._fetch("POST",e,t)}_put(e,t){return this._fetch("PUT",e,t)}_delete(e,t){return this._fetch("DELETE",e,null,t)}closeCallQueue(){this._callQueue&&this._callQueue.close(),this._callQueue=null,this.stopKeepAliveTimer()}addToCallQueue(e,t,i){console.log("LiveRestHelper::addToCallQueue: mediaType="+e);let n=this._impl.service.authToken,o=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/pending?mediaType="+e+"&version="+this._impl.version+"&jwt="+n+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("LiveRestHelper::addToCallQueue: pendingURI="+o),this.closeCallQueue(),this._callQueue=new EventSource(o),this._callQueue.addEventListener("Success",e=>{const i=e.data;console.log("LiveRestHelper::addToCallQueue: success: address="+i,e),this.closeCallQueue(),t(i)},!1),this._callQueue.addEventListener("Upgrade",e=>{const i=e.data;console.log("LiveRestHelper::addToCallQueue: upgrade: eventData="+i,e),this.closeCallQueue(),t(i)},!1),this._callQueue.addEventListener("None",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: none: message="+t,e),this.closeCallQueue(),i(t)}),this._callQueue.addEventListener("KeepAlive",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: keep-alive: message="+t,e);try{const e=JSON.parse(t);console.log("LiveRestHelper::addToCallQueue: keep-alive: waitTime="+e.waitTime+", queuePosition="+e.queuePosition),this._impl.setPositionInQueue(e.queuePosition)}catch(e){console.log("LiveRestHelper::addToCallQueue: keep-alive: failed to parse keep-alive response",e)}}),this.startKeepAliveTimer(e)}closeCallQueueAndRemove(t,i){if(console.log("closeCallQueueAndRemove",this._callQueue),!this._callQueue)return;this.closeCallQueue(),this._impl.dispatchEvent(e.LiveCanceled);let n=this._impl.service.authToken;this.removeFromQueue(t,n,i)}removeFromQueue(e,t,i){let n=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/pending?mediaType="+e+"&jwt="+t+"&version="+this._impl.version+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("removeFromQueue: pendingURI: "+n),this._delete(n,t).then(()=>{console.log("Got success for delete pending"),i()}).catch(e=>{404!==e.response.status?console.log("Failed to delete pending call, Error: "+e.message,e.response):(console.log("Pending call already removed"),i())})}startKeepAliveTimer(e){this.stopKeepAliveTimer(),console.log("startKeepAliveTimer"),this._keepAliveTimer=setInterval(()=>{this.sendQueueKeepAlive(e)},i)}stopKeepAliveTimer(){this._keepAliveTimer&&(console.log("stopKeepAliveTimer"),clearInterval(this._keepAliveTimer),this._keepAliveTimer=null)}sendQueueKeepAlive(t){let i=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/keepAlive?version="+this._impl.version+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("sendQueueKeepAlive: keepaliveURI: "+i),this._post(i,null).then(()=>{console.log("Got success to queue keep-alive")}).catch(i=>{console.log("Failed to send queue keep-alive, Error: "+i.message,i.response),i.response&&404===i.response.status&&(console.log("Got queue keep-alive 'Not Found' error response - pending call has been cancelled"),this.closeCallQueueAndRemove(t,()=>{console.log("Removed pending call"),this._impl.dispatchEvent(e.LiveEnded)}))})}getAppAvailability(e){console.log("LiveRestHelper::getAppAvailability: for tenantID=",this._impl.service.tenantID);let t=this._impl.service.address+"/tenant/api/tenants/"+this._impl.service.tenantID+"/application?version="+this._impl.version;this._get(t).then(t=>{console.log("Got availability response: ",t),e(t)}).catch(e=>{console.log("Failed to get availability, Error: "+e.message,e.response)})}getMetaScenario(e){if(console.log("LiveRestHelper::getMetaScenario: for tenantID=",this._impl.service.tenantID),!this._impl.service.tenantID)return;navigator.userAgent.includes("iPad")||navigator.userAgent.includes("iPhone")?this._impl.contextAttributes.set("devType","Mobile (iOS)"):navigator.userAgent.includes("Android")?this._impl.contextAttributes.set("devType","Mobile (Android)"):this._impl.contextAttributes.set("devType","web");let t=this._impl.service.address+"/tenant/api/tenants/"+this._impl.service.tenantID+"/match-meta-scenario?version="+this._impl.version,i=JSON.stringify(this._impl.contextAttributes.toWebContext());this._post(t,i).then(t=>{console.log("LiveRestHelper::getMetaScenario: Got success for post/match-meta-scenario: ",t);const i=t.Application;this._clientId=i.clientId,console.log("application.name received in matched metaScenario = "+i.name),this._appName=i.name,this._impl.contextAttributes.set("appName",i.name),this._impl.contextAttributes.set("clientId",i.clientId);const n=t.Configuration,o=t.Components;e(n,o)}).catch(e=>{console.error("Failed to match meta scenario (no response text), Error: "+e.message,e.response)})}getMessages(e,t){this._impl.service.tenantID&&this._clientId||(console.warn("LiveRestHelper::getMessages Cannot retrieve messages for invalid tenant"),t());let i=this._impl.service.address+"/tenant/api/tenant/"+this._impl.service.tenantID+"/localisation/application/"+this._clientId+"/messages/locale/"+e+"/?usageType=mce";this._get(i,"application/octet-stream").then(e=>{e?e.application_layer?t(e.application_layer):t(e):t()}).catch(e=>{console.warn("LiveRestHelper::getMessages Cannot retrieve messages, Error: "+e.message,e.response),t()})}sendContext(e){console.log("Inside sendContext");let t=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/context?version="+this._impl.version+(this._clientKey?"&clientKey="+this._clientKey:""),i=this._impl.contextAttributes.toJSON();console.log("LiveRestHelper::sendContext: ",this._impl.contextAttributes),sessionStorage.setItem("previousJWT",this._impl.service.authToken),this._post(t,i).then(t=>{console.log("LiveRestHelper::sendContext: responseData: ",JSON.stringify(t)),t&&(t.clientKey?this._clientKey=t.clientKey:t.key&&(this._clientKey=t.key)),console.log("LiveRestHelper::sendContext: clientKey: "+this._clientKey),e()}).catch(e=>{console.error("LiveRestHelper::sendContext: Failed to send context info, Error: "+e.message,e.response)})}sendPostCallRating(e,t){console.log("sendPostCallRating: rating="+e),this._impl._conversationId||console.warn("Cannot submit post-call rating - invalid conversation ID");let i=JSON.stringify({uri:this._impl.service.userID,qualityRating:e}),n=this._impl.service.address+"/sr/api/tenant/"+this._impl.service.tenantID+"/application/"+this._clientId+"/session/"+this._impl._conversationId+"/participantcallrating/?version="+this._impl.version;console.log("sendRating: "+i+" to: "+n),this._post(n,i).then(()=>{console.log("Successfully sent call rating"),this._impl._conversationId=null,t()}).catch(e=>{console.error("Failed to send call rating, Error: "+e.message,e.response)})}getAssociateInfo(){console.log("Entered getAssociateInfo..");let e=this._impl.service.tenantID,t=this._impl._associateUri;if(!t)return void console.log("No associateURI field available so skipping retrieval");let i=encodeURI(this._impl.service.address+"/assoc/api/tenant/"+e+"/assoc/"+t+"?version="+this._impl.version);console.log("Fetch associate info from URL: "+i);const n=this._get(i);return n.then(e=>{console.log("Got response from associate info request..",e),e.name&&this._impl.setAssociateName(e.name)}).catch(e=>{console.log("Failed to retrieve associate info, Error: "+e.message,e.response)}),n}getAssociateAvatar(){console.log("Entered getAssociateAvatar..");let e=this._impl.service.authToken,t=this._impl.service.tenantID,i=this._impl._associateUri;if(!i)return void console.log("No associateURI field available so skipping retrieval");let n=encodeURI(this._impl.service.address+"/auth/user/api/users/avatar/"+t+"/"+i+"?version="+this._impl.version);console.log("Fetch associate avatar from URL: "+n),fetch(n,{credentials:"include",mode:"cors",headers:{Accept:"application/octet-stream","X-Requested-With":"XMLHttpRequest",Authorization:"Bearer "+e}}).then(e=>{if(e.ok)return e.blob();console.log("Failed to find avatar: "+e.status,e.statusText)}).then(e=>{let t=URL.createObjectURL(e);console.log("Successfully downloaded avatar",t),this._impl.setAssociatePhoto(t)}).catch(e=>{console.log("Failed to download associate avatar: ",e.message)})}updatePreCallIdCheck(e,t,i,n){if(console.log("LiveRestHelper::updatePreCallIdCheck:  for tenantID=",e.tenantID),console.log("clientKey: ",i),i||(i=this._clientKey),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::updatePreCallIdCheck:Cannot update PreCallIDCheck for invalid tenant"),void n(void 0);let o=e.address+"/sl/api/kyc/tenant/"+e.tenantID+"/client/"+i+"/attempt/"+this.getLastUsedKycAttemptNumber()+"/update/"+t;this._post(o).then(e=>{console.log("LiveRestHelper::updatePreCallIdCheck: got response: "+e),e&&n(e)}).catch(e=>{console.log("LiveRestHelper::updatePreCallIdCheck: failed to updatePreCallIdCheck, Error: "+e.message,e.response)})}getLocale(){let e="en";return navigator.languages&&navigator.languages.length?e=navigator.languages[0]:navigator.language&&(e=navigator.language),console.log("LiveRestHelper::getLocale: language: ",e),e}setClientId(e){this._clientId=e}getClientKey(){return this._clientKey}createInitiatePreCallCheckPayload(){return{deviceType:"web",attemptNumber:this.getIncrementedKycAttemptNumber(),clientId:this._clientId,clientKey:this._clientKey,userId:this._impl.service.userID,locale:this.getLocale(),noProxy:this._noProxyForKyc}}initiatePreCallIDCheck(e,t,i){if(console.log("LiveRestHelper::initiatePreCallIDCheck: for tenantID=",e.tenantID),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::initiatePreCallIDCheck:Cannot initiate PreCallIDCheck for invalid tenant"),void i(void 0);let n=e.address+"/kyc/api/tenant/"+e.tenantID+"/application/"+this._clientId+"/initiate";console.log("LiveRestHelper::initiatePreCallIDCheck: uri: ",n),console.log("LiveRestHelper::initiatePreCallIDCheck: data: ",t),this._post(n,JSON.stringify(t)).then(e=>{console.log("LiveRestHelper::initiatePreCallIDCheck: got response: ",e),e&&i(e)}).catch(e=>{console.log("LiveRestHelper::initiatePreCallIDCheck: failed to initiatePreCallIDCheck, Error: "+e.message,e.response)})}getPreCallIDCheckStatus(e,t,i,n){if(console.log("LiveRestHelper::getPreCallIDCheckStatus:  for tenantID=",e.tenantID),console.log("transactionReference: ",t),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::getPreCallIDCheckStatus:Cannot get PreCallIDCheck for invalid tenant"),void n(void 0);let o=e.address+"/kyc/api/tenant/"+e.tenantID+"/application/"+this._clientId+"/transaction/"+t+"/status";this._get(o).then(e=>{console.log("LiveRestHelper::getPreCallIDCheckStatus: got response: "+e),e&&i(e)}).catch(e=>{console.log("LiveRestHelper::getPreCallIDCheckStatus: failed to getPreCallIDCheckStatus, Error: "+e.message,e.response),n(e.response)})}getPreCallIDCheckResult(e,t){if(console.log("LiveRestHelper::getPreCallIDCheckResult:  for tenantID=",e.tenantID),console.log("clientKey: ",t),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::getPreCallIDCheckStatus:Cannot get PreCallIDCheck for invalid tenant"),Promise.reject(void 0);let i=e.address+"/sr/api/kyc/tenant/"+e.tenantID+"/session/"+t+"/id-verification/result";return this._get(i)}getLastUsedKycAttemptNumber(){return this._kycAttemptNumber}getIncrementedKycAttemptNumber(){return this._kycAttemptNumber+=1,this.getLastUsedKycAttemptNumber()}setNoProxyForKyc(e){console.log("LiveRestHelper::setNoProxyForKyc noProxy: ",e),this._noProxyForKyc=e}deleteIdentityVerificationTransaction(e,t){if(console.log("LiveRestHelper::deleteIdentityVerificationTransaction:  for tenantID=",e.tenantID),console.log("transactionReference: ",t),console.log("attempt: ",this._kycAttemptNumber),!e.tenantID||!this._clientKey)return console.log("LiveRestHelper::deleteIdentityVerificationTransaction: Cannot delete transaction for invalid tenant/app"),Promise.reject(new Error("Invalid tenant or application"));const i=e.address+"/sl/api/kyc/tenant/"+e.tenantID+"/client/"+this._clientKey+"/attempt/"+this._kycAttemptNumber+"/result",n={transactionReference:t,result:"Failed"};return this._post(i,JSON.stringify(n))}setRunningForChromeExtension(e){console.log("liveAPI REST helper: setRunningForChromeExtension="+e),this._runningForChromeExtension=e}}}),define("LiveDiagnostics",["LiveSessionStore","LiveEvents"],function(e,t){"use strict";const i=51,n=50,o=11,s=16,a="LXDiagnosticsResults";return class{constructor(t){this._impl=t,this._browserName=null,this._browserVersion=null,this._haveAudioIn=!1,this._haveAudioOut=!1,this._haveVideo=!1,this._haveTwoCameras=!1,this._cancelled=!1,this._videoStream=null,this._networkTestRunning=!1,this._networkResult=0,this._networkPromise=null,this._diagnosticsTimer={},this._diagnosticsTimeout=2e4,this._audioOutDiagnosticsTimeout=6e4,this._reloadedForDiagnosticsRun=!1,e.initState("LiveDiagnostics",this),$(()=>{console.log("LiveDiagnostics: Loading"),e.loadState("LiveDiagnostics",e=>{this._browserName=e.browserName,this._browserVersion=e.browserVersion,this._haveAudioIn=e.haveAudioIn,this._haveAudioOut=e.haveAudioOut,this._haveVideo=e.haveVideo,this._haveTwoCameras=e._haveTwoCameras,this._networkResult=e.networkResult,console.log("LiveDiagnostics: Loaded")})})}toJSON(){return JSON.stringify({browserName:this._browserName,browserVersion:this._browserVersion,haveAudioIn:this._haveAudioIn,haveAudioOut:this._haveAudioOut,haveVideo:this._haveVideo,haveTwoCameras:this._haveTwoCameras,networkResult:this._networkResult})}setAutoTest(e){console.log("LiveDiagnostics::setAutoTest setting to: ",e),!0===e&&(this._haveAudioIn=!0,this._haveAudioOut=!0,this._haveVideo=!0,this._haveTwoCameras=!1)}checkBrowser(){return new Promise((e,t)=>{if(!this._browserName||!this._browserVersion){const e=live.testBrowser().details;this._browserName=e.browserName,this._browserVersion=e.browserVersion}if("Chrome"===this._browserName&&this._browserVersion>i||"Firefox"===this._browserName&&this._browserVersion>n||"Safari"===this._browserName&&this._browserVersion>=o||"Edge"===this._browserName&&this._browserVersion>=s)console.log("Supported browser: "+this._browserName+", version: "+this._browserVersion),e({browserName:this._browserName,browserVersion:this._browserVersion});else{const e="Live Experience - Unsupported browser: "+this._browserName+", version: "+this._browserVersion;console.error(e),t(new Error(e))}})}cancelChecks(){console.log("cancelChecks: Diagnostics cancelled"),this._cancelled=!0}checkMedia(e){if(console.log("LiveDiagnostics::checkMedia includeCamera=",e),this._haveAudioIn&&this._haveAudioOut&&(!e||this._haveVideo))return console.log("LiveDiagnostics::checkMedia success from restored values"),Promise.resolve("Diagnostics completed already");e?this._impl.dispatchEvent(t.LiveDiagnosticsAudioVideoStarted):this._impl.dispatchEvent(t.LiveDiagnosticsAudioStarted),this._cancelled=!1;const i=()=>e?Promise.all([this._checkAudioOutput(),this._checkAudioInput(),this._checkCamera(),this._checkNetwork(!1)]):Promise.all([this._checkAudioOutput(),this._checkAudioInput(),this._checkNetwork(!1)]);return new Promise((e,t)=>{i().then(t=>{console.log("LiveDiagnostics::checkMedia: Diagnostics completed: ",t),this._cancelled?(console.log("LiveDiagnostics::checkMedia: Diagnostics cancelled"),e("CANCELLED")):e("Diagnostics complete")}).catch(e=>{console.warn("LiveDiagnostics::checkMedia: Diagnostics ended with error ",e),this._cancelled?(console.log("LiveDiagnostics::checkMedia: ignoring diagnostics were cancelled"),t("CANCELLED")):t("Diagnostics failed:"+e)})})}checkMeetingDiagnostics(e){console.log("checkMeetingDiagnostics: videoRequired="+e);const t=sessionStorage.getItem(a);return t?(this._meetingDiagnostics=JSON.parse(t),console.log("Have meeting diagnostics results: "+JSON.stringify(this._meetingDiagnostics,null,2)),this._haveAudioIn=this._meetingDiagnostics.audioIn,this._haveAudioOut=this._meetingDiagnostics.audioOut,this._haveVideo=this._meetingDiagnostics.video,this._networkResult=this._meetingDiagnostics.network,this._reloadedForDiagnosticsRun||this._haveAudioIn&&this._haveAudioOut||(console.log("We're headed for a diagnostics failure on meeting Rejoin, so reloading page instead"),this._reloadedForDiagnosticsRun=!0,location.reload()),this._checkNetworkResult(!e,this._networkResult)):(console.log("Warning: no meeting diagnostics results found"),Promise.resolve("No results"))}testCombinedDevices(e){if(console.log("LiveDiagnostics::testCombinedDevices includeCamera="+e),this._haveAudioIn&&this._haveAudioOut&&(!e||this._haveVideo))return console.log("LiveDiagnostics::testCombinedDevices success from restored values"),Promise.resolve("Diagnostics completed already");e?this._impl.dispatchEvent(t.LiveDiagnosticsAudioVideoStarted):this._impl.dispatchEvent(t.LiveDiagnosticsAudioStarted);let i={audio:!0};e&&(console.log("Including camera (video) as mandatory device.."),i.video={width:{min:640,ideal:1280,max:1920},height:{min:360,ideal:720,max:1080}});let n=this,o=t=>{let i=!1,o=!1,s=!1,a=[],r=!1,c=!1;(e=>{let t=navigator.mediaDevices.enumerateDevices();t&&t.then?navigator.mediaDevices.enumerateDevices().then(e).catch(()=>{e([])}):e([])})(l=>{l.forEach(e=>{let t={};for(let i in e)if("function"!=typeof e[i])try{t[i]=e[i]}catch(e){console.log("Error occurred checking for _device function",e)}if(console.log("Enumerated media device....",t),"audio"===t.kind&&(t.kind="audioinput"),"video"===t.kind&&(t.kind="videoinput"),"audioinput"===t.kind&&(r=!0,i=!0),"audiooutput"===t.kind&&(o=!0),"videoinput"===t.kind&&(s=!0,c=null!==n._videoStream)){const e={id:t.deviceId,label:t.label};a.push(e),console.log("cameraInfo: id: "+e.id+"  label: "+e.label)}}),console.log("mic="+i+", speakers="+o+", camera="+s+", micPermissions="+r+", camPermissions="+c),n._haveAudioIn=i&&r,n._haveAudioOut=n._haveAudioIn||o,n._haveVideo=!e||s&&c,n._haveTwoCameras=a.length>1,console.log("haveTwoCameras: "+(a.length>1)),console.log(`enumeratesFunction: cameras: ${JSON.stringify(a)}`),t("Camera, mic and speaker tests have been performed")})};return new Promise(t=>{console.log("Requesting user media with constraints:",i),navigator.mediaDevices.getUserMedia(i).then(i=>{e&&(n._videoStream=i),this._videoStream.getTracks().forEach(e=>{e.stop()}),o(t)}).catch(e=>{console.log("Error occurred getting user media",e),o(t)})})}hasAudio(){return console.log("LiveDiagnostics: hasAudio - haveAudioIn="+this._haveAudioIn+", haveAudioOut="+this._haveAudioOut),this._haveAudioIn&&this._haveAudioOut}hasVideo(){return console.log("LiveDiagnostics: hasVideo - haveVideo="+this._haveVideo),this._haveVideo}hasTwoCameras(){return console.log("LiveDiagnostics: hasTwoCameras - haveTwoCameras="+this._haveTwoCameras),this._haveTwoCameras}startNetworkCheck(e){return this._checkNetwork(e)}_clearDiagnosticsTimer(e){const t=this._diagnosticsTimer[e];t&&(clearTimeout(t),delete this._diagnosticsTimer[e])}_checkAudioOutput(){return this._haveAudioOut?Promise.resolve("Audio out already verified"):(this._haveAudioOut=!1,new Promise((e,t)=>{this._diagnosticsTimer.audio_out=setTimeout(()=>{console.warn("LiveDiagnostics::_checkAudioOutput timed out at ",(new Date).toString()),t("Audio output diagnosis timed out")},this._audioOutDiagnosticsTimeout),live.testAudio().then(i=>{this._clearDiagnosticsTimer("audio_out");let n=null,o=!1;i.available?(console.log("LiveDiagnostics::_checkAudioOutput Audio output works",i),this._haveAudioOut=!0,n="Audio output success",o=!0):"Firefox"===this._browserName||"Safari"===this._browserName?(console.log("LiveDiagnostics::_checkAudioOutput failure ignored in browser "+this._browserName),this._haveAudioOut=!0,n="Audio output failure ignored",o=!0):(console.warn("LiveDiagnostics::_checkAudioOutput failed",i),n="Audio output diagnosis failed"),this._cancelled?t("CANCELLED"):o?e(n):t(n)}).catch(e=>{console.warn("LiveDiagnostics::_checkAudioOutput check failed",e),this._clearDiagnosticsTimer("audio_out"),t("Audio output does not work")})}))}_checkAudioInput(){return this._haveAudioIn?Promise.resolve("Audio in already verified"):(this._haveAudioIn=!1,new Promise((e,t)=>{this._diagnosticsTimer.audio_in=setTimeout(()=>{this._clearDiagnosticsTimer("audio_in"),console.log("LiveDiagnostics::_checkAudioInput timed out at ",(new Date).toString()),t("Audio input diagnosis timed out")},6e4),live.testMicrophone().then(i=>{this._clearDiagnosticsTimer("audio_in"),i.available?(console.log("LiveDiagnostics::_checkAudioInput: Microphone works"),this._haveAudioIn=!0,this._cancelled?t("CANCELLED"):e("Audio input works"),console.log("Audio input works"),this._haveAudioIn=!0,e("Audio input works")):"Safari"===this._browserName?(console.log("Audio input test failure result ignored in browser "+this._browserName),this._haveAudioIn=!0,e("Audio input failure ignored")):(console.warn("LiveDiagnostics::_checkAudioInput Audio input does not work",i),t("Audio input does not work"))}).catch(e=>{this._clearDiagnosticsTimer("audio_in"),console.warn("LiveDiagnostics::_checkAudioInput Audio input does not work",e),t("Audio input does not work")})}))}_checkCamera(){return console.log("LiveDiagnostics::_checkCamera"),this._haveVideo?Promise.resolve("Camera already verified"):(this._haveVideo=!1,new Promise((e,t)=>{const i=e=>{console.warn("LiveDiagnostics::_checkCamera failed",e),this._clearDiagnosticsTimer("camera"),t("No camera detected")};this._diagnosticsTimer.camera=setTimeout(()=>{this._clearDiagnosticsTimer("camera"),console.log("LiveDiagnostics::_checkCamera timed out"),t("Camera diagnosis timed out")},this._diagnosticsTimeout),this._haveVideo=!1,this._videoStream=null,live.testCamera().then(n=>{if(console.log("LiveDiagnostics::_checkCamera succeeded with ",n),this._clearDiagnosticsTimer("camera"),this._cancelled&&t("CANCELLED"),!n.available)return console.warn("LiveDiagnostics::_checkCamera no camera found"),void t("Camera does not work");if(this._videoStream)return this._videoStream.getVideoTracks().forEach(e=>{e.stop()}),this._haveVideo=!0,void e("Camera is ready");const o={audio:!1,video:{width:{min:640,ideal:1280,max:1920},height:{min:360,ideal:720,max:1080}}};navigator.mediaDevices.getUserMedia(o).then(i=>{const n=i.getVideoTracks();n.forEach(e=>{e.stop()}),console.log("Got stream with constraints:",o),console.log("Using video device: "+n[0].label),this._videoStream=i,this._haveVideo=!0,this._cancelled?t("CANCELLED"):e("Camera is ready after checking user media")}).catch(i)}).catch(i)}))}_checkNetwork(e){return console.log("LiveDiagnostics::_checkNetwork: result="+this._networkResult),this._networkResult?this._checkNetworkResult(e,this._networkResult):this._checkNetworkInternal(e)}_checkNetworkInternal(e){return console.log("LiveDiagnostics::_checkNetworkInternal: audio=",e),this._networkTestRunning&&this._networkPromise?this._networkPromise:(this._networkPromise=new Promise(t=>{const i=e=>{this._networkResult=0,this._clearDiagnosticsTimer("network"),this._networkTestRunning=!1,console.log("Network check failed",e),t("Network check failure")},n=(t,i)=>(this._clearDiagnosticsTimer("network"),console.log("Network Quality: status:"+t+", hints:",i),this._networkTestRunning=!1,this._networkResult=t,this._checkNetworkResult(e,this._networkResult));this._diagnosticsTimer.network=setTimeout(()=>{this._clearDiagnosticsTimer("network"),this._networkTestRunning=!1,console.log("Network diagnosis timed out"),t("Network diagnosis timed out")},this._diagnosticsTimeout),this._networkTestRunning?console.log("Network status check already running"):(console.log("Checking network status"),this._networkResult=0,this._impl.getNetworkStatus(n,i),this._networkTestRunning=!0)}),this._networkPromise)}_checkNetworkResult(e,t){return new Promise(i=>{switch(t){case 1:this._haveAudioOut=!1,i("Audio quality too low: "+t);break;case 2:e?i("Audio quality maybe low: "+t):(this._haveVideo=!1,i("Video quality too low: "+t));break;case 3:i("Video quality maybe low: "+t);break;case 4:case 5:i("Acceptable for audio and video: "+t);break;default:i("Unknown result: "+t)}})}}}),define("LiveScreenSharing",["LiveEvents","LiveSessionStore"],function(e,t){"use strict";return class{constructor(e){this._impl=e,this._remoteOutgoingSS=null,this._remoteIncomingSS=null,this._remoteOutgoingStreamId=null,this._remoteIncomingStreamId=null,this._localOutgoingSS=null,this._localIncomingSS=null,this._localOutgoingStreamId=null,this._localIncomingStreamId=null,this._canvas=null,this._showScreenShareLoadingHint=!1,this._showSelectedScreenShareStream=!0,this._screenShareArrivingCanvasReady=!1,this._sharedTrack=null,this._showScreenSharePending=!1,this._haveDisplayedIncomingScreenShareInThisCallAlready=!1,this._screenSharePendingTimeout=null,this._screenShareStreamSettings={},this._localStreamOptions=null,this._localMedia=null,this._localScreenShareActive=!1,this._remoteScreenShareActive=!1,this._restartSendingScreenShare=!1,this._minChromeVersionForScreenShare=72,this._minSafariVersionForScreenShare=13,this._minFirefoxVersionForGetDisplayMedia=68,this._connectionRestored=!1,this._restoredStreams=[],this._qualityMetricsCallback=null,t.initState("LiveScreenSharing",this),$(()=>{console.log("LiveScreenSharing: Loading"),t.loadState("LiveScreenSharing",e=>{this._remoteScreenShareActive=e.remoteScreenShareActive,this._localScreenShareActive=e.localScreenShareActive,this._restartSendingScreenShare=e.restartSendingScreenShare,this._remoteOutgoingStreamId=e.remoteOutgoingStreamId,this._remoteIncomingStreamId=e.remoteIncomingStreamId,this._localOutgoingStreamId=e.localOutgoingStreamId,this._localIncomingStreamId=e.localIncomingStreamId,this._localStreamOptions=e.localStreamOptions,console.log("LiveScreenSharing: Loaded: localOutgoingStreamId="+this._localOutgoingStreamId)})})}toJSON(){return JSON.stringify({remoteScreenShareActive:this._remoteScreenShareActive,localScreenShareActive:this._localScreenShareActive,restartSendingScreenShare:this._localScreenShareActive||this._restartSendingScreenShare,localStreamOptions:this._localStreamOptions,localOutgoingStreamId:this._localOutgoingSS?this._localOutgoingSS.getId():null,localIncomingStreamId:this._localIncomingSS?this._localIncomingSS.getId():null,remoteOutgoingStreamId:this._remoteOutgoingSS?this._remoteOutgoingSS.getId():null,remoteIncomingStreamId:this._remoteIncomingSS?this._remoteIncomingSS.getId():null})}loadComplete(){console.log("LiveScreenSharing:loadComplete()"),this._connectionRestored&&(console.log("LiveScreenSharing:loadComplete() resumes screen share"),console.log("LiveScreenSharing:loadComplete() State is:","\n_remoteScreenShareActive:\t\t",this._remoteScreenShareActive,"\n_localScreenShareActive:\t\t",this._localScreenShareActive,"\n_restartSendingScreenShare:\t\t",this._restartSendingScreenShare,"\n_localStreamOptions:\t\t",this._localStreamOptions,"\n_localOutgoingStreamId:\t\t",this._localOutgoingStreamId,"\n_localIncomingStreamId:\t\t",this._localIncomingStreamId),this._resumeScreenShare())}setConnectionRestored(){this._connectionRestored=!0}checkStreamPeerConnection(e,t){t&&(t.call?t.call.peerConnection||alert("Something is wrong: "+e+" has no call.peerConnection reference"):alert("Something is wrong: "+e+" has no call reference"))}debugStreams(){console.log("======= WEB API STREAMS ======="),console.log("=== _localOutgoingSS",this._localOutgoingSS),console.log("=== _localIncomingSS",this._localIncomingSS),console.log("=== _localOutgoingStreamId",this._localOutgoingStreamId),console.log("=== _localIncomingStreamId",this._localIncomingStreamId),console.log("=== _remoteOutgoingSS",this._remoteOutgoingSS),console.log("=== _remoteIncomingSS",this._remoteIncomingSS),console.log("=== _remoteOutgoingStreamId",this._remoteOutgoingStreamId),console.log("=== _remoteIncomingStreamId",this._remoteIncomingStreamId),console.log("=== _remoteScreenShareActive",this._remoteScreenShareActive),this.isPermanentTwoWayScreenShare()&&(this.checkStreamPeerConnection("hidden outgoing",this._localOutgoingSS),this.checkStreamPeerConnection("hidden incoming",this._localIncomingSS)),console.log("================================"),setTimeout(()=>{this.debugStreams()},3e4)}createScreenShareStream(e,t){if(!this._impl._conversation)return Promise.reject(new Error("No ongoing conversation"));try{return t||(t=e?live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.SENDONLY):live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.RECVONLY)),this._impl._conversation.addScreenShareStream(null,t)}catch(e){return Promise.reject(e)}}startReceivingScreenShare(e){console.log("LiveScreenSharing::startReceivingScreenShare",e,this._localIncomingSS,this._remoteIncomingSS),this._remoteIncomingSS=e,this._localIncomingSS?console.log("LiveScreenSharing::startReceivingScreenShare Local SS incoming stream already active"):(console.log("Creating screen share stream to receive remote SS"),this.createScreenShareStream(!1).then(e=>{this._localIncomingSS=e.stream,this._qualityMetricsCallback&&(this._localIncomingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=e.options,this._initCallbacks(this._localIncomingSS),this._localIncomingSS.start([])}).catch(e=>{console.warn("LiveScreenSharing::startReceivingScreenShare Could not start local stream",e)}))}stopReceivingScreenShare(){console.log("LiveScreenSharing: stopReceivingScreenShare"),this._impl.stopStream(this._localMedia),this._localMedia=null,$(".oracle-live-remote-screenshare").hide(),this._remoteIncomingSS=null,this._localIncomingSS&&(this._localIncomingSS.end(),this._localIncomingSS=null),this._remoteScreenShareActive&&this._impl.dispatchEvent(e.LiveRemoteScreenStopped),this._remoteScreenShareActive=!1}populateScreenShareStream(e,t){if(console.log("populateScreenShareStream entered:",e,t),!this._localOutgoingSS)return console.log("no outgoing SS - where did it go???"),void alert("Can no longer share screen in this call as reference to outgoing screen share stream has been lost");if(!e)return void console.log("populateScreenShareStream given no content stream - ignoring");let i=null;console.log("have initialized promise to:",i);let n=this;const o=function(){console.log("Caught stream ended on screen share track"),n.stopSendingScreenShare()};let s=this._localOutgoingSS.call.peerConnection,a=!1;return s?e.getTracks().forEach(e=>{console.log("real (new) SS track..",e.id,e.label);let n=s.getSenders().find(t=>t.track.kind===e.kind);console.log("we have found remote sender and have new track",n,e),i=n.replaceTrack(e),console.log("we have requested the track replacement and have new promise",i),this._isChrome()?e.enabled=!0:(e.enabled=!1,console.log("Delaying track enable; required by FF"),i.then(()=>{setTimeout(()=>{console.log("Enabling track (after short delay; required by FF)"),e.enabled=!0},750)})),a=!0,this._sharedTrack=e,t&&(e.onended=o)}):console.warn("No peer connection available - cannot substitute screen share stream tracks as desired"),a?i:Promise.reject("Failed to replace any screen share tracks in LX populateScreenShareStream")}populateEmptyScreenShareStream(){this.populateScreenShareStream(this.getEmptyMediaStream(),!1)}populateStreamWithScreenShareComingHint(){this._showScreenShareLoadingHint&&(console.log("populateStreamWithScreenShareComingHint entered"),this._addCanvasBackground().then(()=>{console.log("have canvas background ready.. using it to capture a stream"),this._hintStream=this._canvas.captureStream(1),console.log("have stream..",this._hintStream),this.populateScreenShareStream(this._hintStream,!0)}).catch(e=>{console.warn("LiveScreenSharing::populateStreamWithScreenShareComingHint failed:",e)}))}getEmptyMediaStream(){try{let e=document.querySelector("#screen-share-arriving");console.log("Starting hidden screen share stream using empty media, canvas=",e);let t=e.captureStream(1);return console.log("getEmptyMediaStream returning:",t),t}catch(e){return null}}startDummyScreenShare(){console.log("LiveScreenSharing::startDummyScreenShare");const t=live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.SENDONLY);this.createScreenShareStream(!0,t).then(t=>{console.log("we have dummy SS with stream/options",t),this._localOutgoingSS=t.stream,this._qualityMetricsCallback&&(this._localOutgoingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=t.options,this._initCallbacks(this._localOutgoingSS);let i=this.getEmptyMediaStream();i?this._localOutgoingSS.start([i]):this._localOutgoingSS.start([]),this._impl.dispatchEvent(e.LiveLocalScreenStopped)}).catch(e=>{console.warn("LiveScreenSharing::startDummyScreenShare could not start local outgoing stream",e)}),$("#oracle-live-remote-screenshare").off("resize").on("resize",()=>{this._showScreenSharePending&&(console.log("Have been waiting for this resize - showing incoming screen share now.."),this.showIncomingScreenShareNow())})}cleanSharedTrack(){this._sharedTrack&&(this._sharedTrack.stop(),this._sharedTrack=null)}startSendingScreenShareStream(e){console.log("LiveScreenSharing::startSendingScreenShareStream got permission to start"),this._impl.acceptUpgradeRequest(),this.populateScreenShareStream(e,!0).then(()=>{console.log("Track is replaced - other party can show the screen share again"),this.showHideScreenShare(!0)}).catch(e=>{console.warn("LiveScreenSharing::startSendingScreenShareStream: populate call failed:",e)})}getDisplaySurface(){return this._screenShareStreamSettings.displaySurface}startSendingScreenShare(){if(!this.isPermanentTwoWayScreenShare())return void this.startSendingScreenShareOriginal();if(console.log("LiveScreenSharing::startSendingScreenShare: remoteSS=",this._remoteOutgoingSS),this._remoteOutgoingSS)return console.log("LiveScreenSharing::startSendingScreenShare Remote SS stream already active"),this._impl.dispatchEvent(e.LiveLocalScreenStopped),void this._impl.declineUpgradeRequest();const t=(t,i)=>{console.warn(t,i),this._impl.declineUpgradeRequest(),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.stopSendingScreenShare(),this._isFirefox()&&this._impl.dispatchEvent(e.LiveMessageEmitted,"shareScreenDeclined")};if(this._isChrome()&&(console.log("Checking Chrome version >= ",this._minChromeVersionForScreenShare),parseInt(this._impl._browserVersion)<this._minChromeVersionForScreenShare))return this._impl.dispatchEvent(e.LiveMessageEmitted,"application_get_latest_browser_version"),console.log("In order to share your screen from Chrome you need version "+this._minChromeVersionForScreenShare+" or later"),void t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:","Your Chrome version ("+this._impl._browserVersion+") is inadequate - must be "+this._minChromeVersionForScreenShare+" or later");if(this._isSafari()&&(console.log("Checking Safari version >= ",this._minSafariVersionForScreenShare),parseInt(this._impl._browserVersion)<this._minSafariVersionForScreenShare))return this._impl.dispatchEvent(e.LiveMessageEmitted,"application_get_latest_browser_version"),console.log("In order to share your screen from Safari you need version "+this._minSafariVersionForScreenShare+" or later"),void t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:","Your Safari version ("+this._impl._browserVersion+") is inadequate - must be "+this._minSafariVersionForScreenShare+" or later");let i=!1;if(this._isFirefox()&&(console.log("Checking Firefox version >= ",this._minFirefoxVersionForGetDisplayMedia),parseInt(this._impl._browserVersion)<this._minFirefoxVersionForGetDisplayMedia&&(i=!0)),this._screenShareStreamSettings={},i)console.log("Using getUserMedia"),this._getMediaConstraints().then(e=>(console.log("LiveScreenSharing::startSendingScreenShare got constraints",e),navigator.mediaDevices.getUserMedia(e))).then(e=>{this.startSendingScreenShareStream(e)}).catch(e=>{t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:",e)});else{console.log("Using getDisplayMedia");let e={video:!0};navigator.mediaDevices.getDisplayMedia(e).then(e=>{this._screenShareStreamSettings=e.getTracks()[0].getSettings(),console.log("Stream settings are: ",this._screenShareStreamSettings),this.startSendingScreenShareStream(e)},e=>{console.log("Unable to acquire screen capture",e),t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:",e)})}}startSendingScreenShareOriginal(){if(console.log("LiveScreenSharing::startSendingScreenShareOriginal"),this._remoteOutgoingSS)return console.log("LiveScreenSharing::startSendingScreenShareOriginal Remote SS stream already active"),this._impl.dispatchEvent(e.LiveLocalScreenStopped),void this._impl.declineUpgradeRequest();const t=(t,i)=>{console.warn(t,i),this._impl.declineUpgradeRequest(),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.stopSendingScreenShare(),this._isFirefox()&&this._impl.dispatchEvent(e.LiveMessageEmitted,"shareScreenDeclined")};this.createScreenShareStream(!0).then(e=>{this._localOutgoingSS=e.stream,this._qualityMetricsCallback&&(this._localOutgoingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=e.options,this._initCallbacks(this._localOutgoingSS),this._isChrome()||this._isSafari()?(console.log("We're in Chrome or Safari so we'll use getDisplayMedia.."),navigator.mediaDevices.getDisplayMedia({video:!0}).then(e=>{console.log("We have a media stream from getDisplayMedia"),this._impl.acceptUpgradeRequest(),this._localOutgoingSS.start([e])},e=>{console.log("Unable to acquire screen capture",e)})):this._getMediaConstraints().then(e=>(console.log("LiveScreenSharing::startSendingScreenShareOriginal got constraints ",e),navigator.mediaDevices.getUserMedia(e))).then(e=>{console.log("LiveScreenSharing::startSendingScreenShareOriginal got permission to start"),this._impl.acceptUpgradeRequest(),this._localOutgoingSS.start([e])}).catch(e=>{t("LiveScreenSharing::startSendingScreenShareOriginal error when starting screenshare:",e)})}).catch(e=>{t("LiveScreenSharing::startSendingScreenShareOriginal error when creating screenshare stream:",e),console.warn("LiveScreenSharing::startSendingScreenShareOriginal Could not start local stream",e)})}isPermanentTwoWayScreenShare(){return this._impl._permanentTwoWayScreenShare}clearPendingScreenShare(){this._showScreenSharePending=!1,this._screenSharePendingTimeout&&(clearTimeout(this._screenSharePendingTimeout),this._screenSharePendingTimeout=null)}showIncomingScreenShareNow(){console.log("Showing incoming screen share right now",this._localIncomingSS,this._remoteIncomingSS),this.clearPendingScreenShare(),this._remoteScreenShareActive=!0,$(".oracle-live-remote-screenshare").show(),this._impl.dispatchEvent(e.LiveRemoteScreenStarted)}showIncomingScreenShare(){console.log("We've been told to show incoming screen share"),this._isFirefox()||this._haveDisplayedIncomingScreenShareInThisCallAlready?this.showIncomingScreenShareNow():(console.log("First time, non-FF: we'll rely on screen resize to inform us of remote screen share arrival"),this._showScreenSharePending=!0,this._screenSharePendingTimeout=setTimeout(()=>{console.log("We're giving up waiting for resize event to trigger showing of screen share"),this.showIncomingScreenShareNow()},1500)),this._haveDisplayedIncomingScreenShareInThisCallAlready=!0}hideIncomingScreenShare(){console.log("We've been told to hide incoming screen share"),this._remoteScreenShareActive=!1,$(".oracle-live-remote-screenshare").hide(),this._impl.dispatchEvent(e.LiveRemoteScreenStopped)}showHideScreenShare(t){console.log("showHideScreenShare("+t+")"),this._impl._conversation?t?(console.log("Web API sending relay message to show screen share"),this._impl._conversation.relayCommandTo(null,"*","show_screen_share",[{}]),this._impl.dispatchEvent(e.LiveLocalScreenStarted)):(console.log("Web API sending relay message to hide screen share"),this._impl._conversation.relayCommandTo(null,"*","hide_screen_share",[{}]),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.cleanSharedTrack(),this.stopOutgoingSSVideo()):console.log("No conversation, so showHideScreenShare("+t+") call having no effect"),this._localScreenShareActive=t}stopSendingScreenShare(){this.isPermanentTwoWayScreenShare()?(console.log("LiveScreenSharing: stopSendingScreenShare"),this.showHideScreenShare(!1)):this.stopSendingScreenShareOriginal()}stopSendingScreenShareOriginal(){console.log("LiveScreenSharing: stopSendingScreenShareOriginal"),this._impl.stopStream(this._localMedia),this._localMedia=null,this._localScreenShareActive=!1,this._localOutgoingSS&&(this._localOutgoingSS.end(),this._localOutgoingSS=null),this._impl.dispatchEvent(e.LiveLocalScreenStopped)}pauseResumeStream(e){console.log("LiveScreenSharing: pauseResumeStream",e),this._localOutgoingSS&&(console.log("LiveScreenSharing: pauseResumeStream - local outgoing:",this._localOutgoingSS),this._localOutgoingSS.pauseResumeStream(e)),this._localIncomingSS&&(console.log("LiveScreenSharing: pauseResumeStream - local incoming:",this._localIncomingSS),this._localIncomingSS.pauseResumeStream(e))}streamJoined(e){console.log("=== LiveScreenSharing: streamJoined",e),"recvonly"===e.streamOptions.videoConfig&&(console.log("=== streamJoined: Our dummy screen share has started - make sure we've got it paused"),this._localScreenShareActive?console.log("Looks like an associate reconnect.. leaving the (currently shared) stream alone"):this.isPermanentTwoWayScreenShare()&&this.stopOutgoingSSVideo())}pauseResumeOutgoing(e){if(console.log("LiveScreenSharing: pauseResumeOutgoing: paused=",e),this._localOutgoingSS&&this._localOutgoingSS.call){let t=this._localOutgoingSS.call.peerConnection;if(t){let i=t.getSenders().find(e=>"video"===e.track.kind),n=e?"pausing":"resuming";console.log("LiveScreenSharing: "+n+" video track:",i.track),i.track.enabled=!e}}}stopOutgoingSSVideo(){if(console.log("LiveScreenSharing: stopOutgoingSSVideo"),this._localOutgoingSS){this.populateEmptyScreenShareStream(),console.log("Attempting to disable video tracks of hidden outgoing screen share stream (to save RTP)");let e=this._localOutgoingSS.call.peerConnection;if(e){let t=e.getSenders().find(e=>"video"===e.track.kind);console.log("Disabling video track of sender",t.track,t),t.track.enabled=!1}}}beforeUnload(){!0===this._localScreenShareActive?(console.log("LiveScreenSharing::beforeUnload - attempt to stop local screenshare"),this._restartSendingScreenShare=!0,this.stopSendingScreenShare()):console.log("LiveScreenSharing::beforeUnload - do nothing")}resume(e){console.log("======= LiveScreenSharing::resume",e),this._restoredStreams.push(e)}maybeSelectRemoteSS(){console.log("LiveScreenSharing::maybeSelectRemoteSS: remoteScreenShareActive=",this._remoteScreenShareActive,this._localIncomingSS,this._remoteIncomingSS),this._localIncomingSS&&this._remoteIncomingSS&&(console.log("Setting layout on incoming screen share"),this._remoteIncomingSS.setLayout(live.STREAMSIZE.PRIMARY,this._localIncomingSS))}isActive(){return!!this._localOutgoingSS||!!this._localIncomingSS}_resumeScreenShare(){if(console.log("=== LiveScreenSharing::_resumeScreenShare",this._restoredStreams),this._restoredStreams.forEach(e=>{console.log("resuming stream",e);const t=e.getId();t===this._localOutgoingStreamId?(console.log("=== (this is _localOutgoingSS)"),this._localOutgoingSS=e):t===this._localIncomingStreamId?(console.log("=== (this is _localIncomingSS)"),this._localIncomingSS=e):t===this._remoteOutgoingStreamId?(console.log("=== (this is _remoteOutgoingSS)"),this._remoteOutgoingSS=e):t===this._remoteIncomingStreamId&&(console.log("=== (this is _remoteIncomingSS)"),this._remoteIncomingSS=e)}),console.log("=== Assigned local and remote streams: ","_localOutgoingSS:",this._localOutgoingSS,"_remoteOutgoingSS:",this._remoteOutgoingSS,"_localIncomingSS:",this._localIncomingSS,"_remoteIncomingSS:",this._remoteIncomingSS),this._localOutgoingSS){console.log("LiveScreenSharing::resume: resuming hidden outgoing stream");try{this._initCallbacks(this._localOutgoingSS),this._localOutgoingSS.resume(()=>{console.log("LiveScreenSharing::resume: local outgoing stream resumed"),this.stopOutgoingSSVideo()},e=>{console.log("LiveScreenSharing::resume: FAILED to resume local outgoing SS stream:",e)})}catch(e){console.warn("LiveScreenSharing::resume could not restart outgoing screen share stream",e)}}if(this._localIncomingSS){console.log("LiveScreenSharing::resume: resuming hidden incoming stream");try{this._initCallbacks(this._localIncomingSS),this._localIncomingSS.resume(()=>{console.log("LiveScreenSharing::resume: local incoming stream resumed")},e=>{console.log("LiveScreenSharing::resume: FAILED to resume local incoming SS stream:",e)})}catch(e){console.warn("LiveScreenSharing::resume could not restart incoming screen share stream",e)}}!0===this._restartSendingScreenShare&&(console.log("LiveScreenSharing::resume ask user if they want to start the screenshare again"),this.startSendingScreenShare(),this._restartSendingScreenShare=!1)}_isChrome(){return"Chrome"===this._impl._browserName}_isFirefox(){return"Firefox"===this._impl._browserName}_isSafari(){return"Safari"===this._impl._browserName}reset(){this._remoteScreenShareActive=!1,this._localScreenShareActive=!1,this._restartSendingScreenShare=!1,this._localStreamOptions=null,this._remoteStreamId=null,this._remoteOutgoingSS=null,this._remoteIncomingSS=null,this._remoteOutgoingStreamId=null,this._remoteIncomingStreamId=null,this._localOutgoingSS=null,this._localIncomingSS=null,this._localOutgoingStreamId=null,this._localIncomingStreamId=null,this._sharedTrack=null,this._screenShareArrivingCanvasReady=!1,this._showScreenSharePending=!1,this._haveSharedScreenInThisCallAlready=!1,this._screenSharePendingTimeout=null,this._haveDisplayedIncomingScreenShareInThisCallAlready=!1,this._screenShareStreamSettings={}}_getMediaConstraints(){if(this._isFirefox()){const e={video:{mediaSource:"window"}};return Promise.resolve(e)}if(this._isSafari()){const e={video:{mediaSource:"window"}};return Promise.resolve(e)}console.warn("_getMediaConstraints() called, but doing nothing, for browser: "+this._impl._browserName)}_initCallbacks(e){console.log("Adding callbacks to stream:",e),e.withCallbacks(this.detectWhenScreenSharingHasChangedState.bind(this,e),this._makeScreenSharingStreamsLive.bind(this),this.detectWhenScreenSharingIsUpdated.bind(this,e),this.detectWhenStreamHasFailed.bind(this),this.detectStreamPauseResumeRequest.bind(this),this.detectWhenStreamOptionsAreUpdated.bind(this))}detectWhenScreenSharingHasChangedState(e,t){console.log("LiveScreenSharing: detectWhenScreenSharingHasChangedState: streamState=",JSON.stringify(t,null,2),e);const i=t.state,n=t.status,o=0+n.code,s=n.reason;switch(this._impl._connection.logEventTimestamp("ssStreamStateTo"+i),i){case live.STREAMSTATE.FAILED:case live.STREAMSTATE.ENDED:this._impl.onScreenShareEnded();break;case live.STREAMSTATE.ESTABLISHED:this._impl.onCallEstablished(!0),this._localStreamOptions.videoConfig===live.MEDIADIRECTION.SENDRECV&&(console.log("LiveScreenSharing: Downgrade local SS to sendonly"),this._localStreamOptions=live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.SENDONLY),e.update(this._localStreamOptions));break;case live.STREAMSTATE.ERROR:console.log("LiveAudioVideo: detectWhenStreamHasChangedState - ERROR: code="+o+", reason="+s),o===live.ERRORCODE.ICE_CONNECTION_ERROR&&(console.log("LiveScreenSharing: ICE connection error"),this._impl.onCallStreamStateError())}}detectStreamPauseResumeRequest(t,i,n,o){const s=o.reason,a=s===live.PAUSERESUMEREASON.PAUSE_RESUME,r=o.audio===live.PAUSERESUME.PAUSE&&o.video===live.PAUSERESUME.PAUSE;console.log("LiveScreenSharing::detectStreamPauseResumeRequest() reason=",s,", isPause=",r),a&&(n.accept(),this.pauseResumeStream(o),r?this._impl.dispatchEvent(e.LivePausedRemotely):this._impl.dispatchEvent(e.LiveResumedRemotely))}_makeScreenSharingStreamsLive(t,i){if(console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: event=",t,i),i instanceof RTCRtpReceiver||i instanceof RTCRtpSender){if(null===i.track)return void console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: ignore screen-sharing event without video")}else if(0===i.getVideoTracks().length)return void console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: ignore screen-sharing event without video");const n=$(".oracle-live-local-screenshare"),o=$(".oracle-live-remote-screenshare");switch(t){case live.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED:this._localMedia=i,n.length?(this._impl._av.attachToMedia(i,n[0],!1,this.detectWhenScreenSharingEnds.bind(this)),this.isPermanentTwoWayScreenShare()||this._impl.dispatchEvent(e.LiveLocalScreenStarted)):console.error("LiveScreenSharing: _makeScreenSharingStreamsLive no element");break;case live.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED:this._impl.stopStream(this._localMedia),this._localMedia=null,n.length?n[0].srcObject=null:console.error("LiveScreenSharing: _makeScreenSharingStreamsLive No screen share element"),this.isPermanentTwoWayScreenShare()||this._impl.dispatchEvent(e.LiveLocalScreenStopped);break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED:o.length?(this._impl._av.attachToMedia(i,o[0],!1),this.isPermanentTwoWayScreenShare()||(this._remoteScreenShareActive=!0,o.show(),this._impl.dispatchEvent(e.LiveRemoteScreenStarted))):console.error("LiveScreenSharing: _makeScreenSharingStreamsLive no element");break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED:this._remoteScreenShareActive=!1,o.length?(o[0].srcObject=null,o.hide()):console.error("LiveScreenSharing: _makeScreenSharingStreamsLive no element"),this._impl.dispatchEvent(e.LiveRemoteScreenStopped)}}detectWhenScreenSharingEnds(){console.log("LiveScreenSharing: detectWhenScreenSharingEnds"),this.stopSendingScreenShare()}detectWhenScreenSharingIsUpdated(e,t){console.log("LiveScreenSharing: detectWhenScreenSharingIsUpdated",t),e&&(this._localStreamOptions=t,e.accept(t))}detectWhenStreamHasFailed(t){console.log("LiveScreenSharing: detectWhenStreamHasFailed, error="+JSON.stringify(t,null,2)),this._impl.dispatchEvent(e.LiveStreamError)}detectWhenStreamOptionsAreUpdated(e,t,i,n){console.log("LiveScreenSharing: detectWhenStreamOptionsAreUpdated: streamRequest="+JSON.stringify(i,null,2)+", streamOptions="+JSON.stringify(n,null,2),t),i.accept(),t&&(this._localStreamOptions=n,t.accept(n))}isScreenScreenSharePossible(){return this._isFirefox()||this._isChrome()}_addCanvasBackground(){return this._screenShareArrivingCanvasReady?Promise.resolve():new Promise((e,t)=>{console.log("adding screenshare-arriving canvas background image"),this._canvas=document.querySelector("#screen-share-arriving"),console.log("have found screen share canvas:",this._canvas);let i=this._canvas.getContext("2d");i.font="14px Arial",i.fillStyle="white",i.textAlign="center",i.fillText("Screen Share Frames Arriving...",this._canvas.width/2,this._canvas.height/2),this._screenShareArrivingCanvasReady=!0,e()})}}}),define("LiveAudioVideo",["jquery","LiveEvents","LiveSessionStore"],function($,e,t){"use strict";return class{constructor(e){this._impl=e,this._avStream1=null,this._avStream2=null,this._newAssociateAvStream=null,this._av1StreamId=null,this._av2StreamId=null,this._newAssociateAvStreamId=null,this._localAudioStream=null,this._localVideoStream=null,this._previewStream=null,this._localStreamOptions=null,this._originalStreamOptions=null,this._userVideoInitiallyPaused=!1,this._associateVideoInitiallyPaused=!1,this._userIsCurrentlyPaused=!1,this._upgradePauseResume=null,this._sidebar=!1,this._qualityMetricsCallback=null,this._currentCameraId=null,this._cameras=[],this._hasTwoCameras=!1,t.initState("LiveAudioVideo",this),$(()=>{console.log("LiveAudioVideo: Loading"),t.loadState("LiveAudioVideo",e=>{this._localStreamOptions=e.localStreamOptions,this._originalStreamOptions=e.originalStreamOptions,this._av1StreamId=e.av1StreamId,this._av2StreamId=e.av2StreamId,this._userVideoInitiallyPaused=e.userVideoInitiallyPaused,this._associateVideoInitiallyPaused=e.associateVideoInitiallyPaused,this._userIsCurrentlyPaused=e.userIsCurrentlyPaused,this._hasTwoCameras=e.hasTwoCameras,this._currentCameraId=e.currentCameraId,this._cameras=e.cameras,console.log("LiveAudioVideo: Loaded, AV1="+this._av1StreamId+", AV2="+this._av2StreamId),console.log("LiveAudioVideo: Loaded, currentCameraId=",this._currentCameraId)})})}toJSON(){return JSON.stringify({localStreamOptions:this._localStreamOptions,originalStreamOptions:this._originalStreamOptions,av1StreamId:this._avStream1?this._avStream1.getId():null,av2StreamId:this._avStream2?this._avStream2.getId():null,userVideoInitiallyPaused:this._userVideoInitiallyPaused,associateVideoInitiallyPaused:this._associateVideoInitiallyPaused,userIsCurrentlyPaused:this._userIsCurrentlyPaused,hasTwoCameras:this._hasTwoCameras,currentCameraId:this._currentCameraId,cameras:this._cameras})}loadComplete(){console.log("LiveAudioVideo: Load complete"),this._av1StreamId&&this._impl._conversation&&(console.log("LiveAudioVideo: Attempting to resolve AV1: "+this._av1StreamId),this._avStream1=this._impl._conversation.getAudioVideoStream(this._av1StreamId),this._avStream1&&this._avStream1.getId()===this._av1StreamId||(this._avStream1=null,this._av1StreamId=null)),this._av2StreamId&&this._impl._conversation&&(console.log("LiveAudioVideo: Attempting to resolve AV2: "+this._av2StreamId),this._avStream2=this._impl._conversation.getAudioVideoStream(this._av2StreamId),this._avStream2&&this._avStream2.getId()===this._av2StreamId&&this._avStream2.getId()!==this._av1StreamId||(this._avStream2=null,this._av2StreamId=null)),this._showSwapCameraButton()}_isEdge(){return"Edge"===this._impl._browserName}isActive(){return!!this._avStream1||!!this._avStream2}_showSwapCameraButton(){const e=$(".oracle-live-swap-camera");e&&(this._hasTwoCameras?(console.log("LiveAudioVideo:_showSwapCameraButton removing oracle-live-hide-camera-swap-button class"),e.removeClass("oracle-live-hide-camera-swap-button")):(console.log("LiveAudioVideo:_showSwapCameraButton adding oracle-live-hide-camera-swap-button class"),e.addClass("oracle-live-hide-camera-swap-button")))}_getCameraDeviceIds(e){console.log("LiveAudioVideo::_getCameraDeviceIds"),e.forEach(e=>{if("videoinput"===e.kind){console.log("LiveAudioVideo::_getCameraDeviceIds found a camera: ",e);const t={deviceId:e.deviceId,label:e.label,isFront:e.label.toLowerCase().includes("front")};this._cameras.push(t)}}),console.log("LiveAudioVideo::_getCameraDeviceIds cameras: ",this._cameras),this._hasTwoCameras=this._cameras.length>1,this._showSwapCameraButton()}_getDifferentCameraId(e){let t;return console.log("LiveAudioVideo::_getDifferentCameraId"),this._cameras&&(t=this._cameras.find(t=>(console.log("LiveAudioVideo::_getDifferentCameraId  camera: ",t),t.deviceId&&t.deviceId!==e))),t?t.deviceId:e}_getCameraStreamWithDeviceId(e,t,i){console.log(`getCameraStream for camera with deviceId: ${e}`);let n=null;const o={audio:"Idle"===this._impl._buttonState.stateName,video:{width:{min:640,ideal:1024,max:1920},height:{min:360,ideal:768,max:1080},deviceId:{exact:e}}};navigator.mediaDevices.getUserMedia(o).then(e=>{console.log("_getCamera: we got a stream"),t(n=e)}).catch(t=>{console.log(`getCameraStream failed to obtain stream for camera with deviceID: ${e}`),console.error("getCameraStream error:  ",t),console.error(`getCameraStream error:  name: ${t.name}   message: ${t.message}`),i(t)})}reset(){this._impl.stopStream(this._localAudioStream),this._impl.stopStream(this._localVideoStream),this._impl.stopStream(this._previewStream),this._avStream1=null,this._avStream2=null,this._activeLocalVideoTrack=null,this._av1StreamId=null,this._av2StreamId=null,this._localAudioStream=null,this._localVideoStream=null,this._previewStream=null,this._localStreamOptions=null,this._originalStreamOptions=null,this._userVideoInitiallyPaused=!1,this._associateVideoInitiallyPaused=!1,this._userIsCurrentlyPaused=!1,this._upgradePauseResume=null,this._sidebar=!1,this._currentCameraId=null}start(e,t,i){console.log("LiveAudioVideo: start");let n=!1;this._previewStream&&this._previewStream.getVideoTracks()&&this._previewStream.getVideoTracks()[0]&&(n=!0),console.log("LiveAudioVideo: start -  usePreviewStream: ",n),this._avStream1=this._impl._conversation.createAudioVideoStream(e,null,t),this._av1StreamId=this._avStream1.getId(),this._localStreamOptions=e;const o=e=>{this._initCallbacks(this._avStream1),this._avStream1.start(e)};if(this._qualityMetricsCallback&&(this._avStream1.onQualityMetrics=this._qualityMetricsCallback),i)console.log("LiveAudioVideo: start - Attempting to use custom constraints: "+JSON.stringify(i,null,2)),navigator.mediaDevices.getUserMedia(i).then(e=>{console.log("LiveAudioVideo: start - Got media for custom constraints",e),this._localVideoStream=e,o(e)}).catch(e=>{console.log("LiveAudioVideo: start - Failed to getUserMedia with custom constraints",e),o(null)});else if(n){console.log("LiveAudioVideo: start - starting local av stream with clone of the previewStream");const e=this._previewStream.clone();o(e)}else o(null)}resume(e){const t=e.getId();if(console.log("LiveAudioVideo: resume, stream id=",t),t===this._av1StreamId)this._avStream1=e,this._initCallbacks(this._avStream1),console.log("LiveAudioVideo: resume - AV1");else{if(t!==this._av2StreamId)return void console.warn("LiveAudioVideo: resume - Invalid stream ID: "+t,e);this._avStream2=e,this._initCallbacks(this._avStream2),console.log("LiveAudioVideo: resume - AV2")}new Promise((t,i)=>{e.resume(t,i)}).then(()=>{console.log("LiveAudioVideo: resume - AV stream resumed",e),this._impl.addQualityMonitor(),this._impl.reconnectedLocal()}).catch(e=>{console.log("LiveAudioVideo: resume - FAILED to resume AV stream:",e),t===this._av1StreamId&&this._impl.reset()})}_initCallbacks(e){e.withCallbacks(this.detectWhenStreamHasChangedState.bind(this,e),this.makeAudioVideoStreamsLive.bind(this),this.detectWhenAudioVideoIsUpdated.bind(this,e),this.detectWhenStreamHasFailed.bind(this,e),this.detectStreamPauseResumeRequest.bind(this))}stop(){console.log("LiveAudioVideo: stop"),this._avStream1&&(console.log("LiveAudioVideo: stop - AV1"),this._avStream1.end(),this._avStream1=null,this._av1StreamId=null),this._avStream2&&(console.log("LiveAudioVideo: stop - AV2"),this._avStream2.end(),this._avStream2=null,this._av2StreamId=null)}streamJoined(e){if(console.log("LiveAudioVideo: streamJoined, userPaused="+this._userVideoInitiallyPaused+", assocPaused="+this._associateVideoInitiallyPaused,e),this.isActive()&&(this._userVideoInitiallyPaused&&this.stopVideo(),this._associateVideoInitiallyPaused)){const t=e.getStreamProfile();t.upgraded=!1,t.paused_by=this._impl.service.userID,t.pauseResume.pausedBy=this._impl.service.userID,t.pauseResume.video=live.PAUSERESUME.PAUSE,t.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,console.log("LiveAudioVideo: Associate is initially paused - updating stream profile",t),e.pauseResumeStream(t.pauseResume)}}stopRemote(e){console.log("LiveAudioVideo: Stop the remote stream",e);const t=e.getId();this._avStream1&&this._avStream2&&this._av1StreamId===t&&(console.log("LiveAudioVideo: Switch to sidebar: AV2 -> AV1"),this._sidebar=!0,this._avStream1=this._avStream2,this._av1StreamId=this._av2StreamId,this._avStream2=null,this._av2StreamId=null)}pauseResumeStream(e){this._avStream1&&this._avStream1.pauseResumeStream(e,()=>{console.log("LiveAudioVideo: pauseResumeStream - AV1 successful"),this._userIsCurrentlyPaused=this._avStream1.isVideoPaused()},e=>{console.log("LiveAudioVideo: pauseResumeStream - AV1 failed",e)}),this._avStream2&&this._avStream2.pauseResumeStream(e,()=>{console.log("LiveAudioVideo: pauseResumeStream - AV2 successful"),this._userIsCurrentlyPaused=this._avStream1.isVideoPaused()},e=>{console.log("LiveAudioVideo: pauseResumeStream - AV2 failed",e)})}makeAudioVideoStreamsLive(t,i){console.log("LiveAudioVideo: makeAudioVideoStreamsLive - event="+t,i);let n,o,s,a,r=!1,c=null;i instanceof RTCRtpReceiver||i instanceof RTCRtpSender?i.track&&"video"===i.track.kind&&(r=!0,c=i.track.getSettings().deviceId):(r=i.getVideoTracks().length>0,i.getVideoTracks()&&i.getVideoTracks()[0]&&(c=i.getVideoTracks()[0].getSettings().deviceId)),console.log("LiveAudioVideo: makeAudioVideoStreamsLive - deviceId: ",c),console.log("LiveAudioVideo: makeAudioVideoStreamsLive - stream has video="+r);let l=$(".oracle-live-local-video"),d=$(".oracle-live-remote-video");switch(t){case live.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED:if(r){a=document.querySelector(".oracle-live-local-video"),console.log("LiveAudioVideo: Have local video: ",a);const t=this._userVideoInitiallyPaused||this._userIsCurrentlyPaused;console.log("LiveAudioVideo: User video is paused="+t),a&&(console.log("LiveAudioVideo: Setting local video stream",i),this._localVideoStream=i,this.attachToMedia(i,a,t)),t||(l.show(),this._impl.dispatchEvent(e.LiveLocalVideoStarted)),console.log("LiveAudioVideo: currentCameraId: ",this._currentCameraId),console.log("LiveAudioVideo: deviceId: ",c),this._currentCameraId&&c?c!==this._currentCameraId&&(this._currentCameraId=c,this.swapCamera()):this._currentCameraId=c}else s=document.querySelector(".oracle-live-local-audio"),console.log("LiveAudioVideo: Have local audio: ",s),s&&(console.log("LiveAudioVideo: Setting local audio stream",i),this._localAudioStream=i,s.srcObject=i,this.playMedia(s));break;case live.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED:console.log("LiveAudioVideo: Processing LOCAL_STREAM_REMOVED event"),(s=document.querySelector(".oracle-live-local-audio"))&&(s.srcObject=null),this._impl.stopStream(this._localAudioStream),this._localAudioStream=null,(a=document.querySelector(".oracle-live-local-video"))&&(a.srcObject=null),this._impl.stopStream(this._localVideoStream),this._localVideoStream=null,l.hide(),this._impl.dispatchEvent(e.LiveLocalVideoStopped);break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED:if(r){if(o=document.querySelector(".oracle-live-remote-video")){let t=this._associateVideoInitiallyPaused;const n=this._impl._conversation.getRemoteParticipant();if(n){const e=n.getStreamInfos()[0].getStreamOptions(),i=n.getStreamInfos()[0].getStreamProfile();e&&(console.log("LiveAudioVideo: Remote stream options: video="+e.videoConfig),t=t||e.videoConfig===live.MEDIADIRECTION.RECVONLY||e.videoConfig===live.MEDIADIRECTION.INACTIVE),i&&(console.log("LiveAudioVideo: Remote stream profile: "+JSON.stringify(i,null,2)),t=t||!i.upgraded||i.pauseResume.video===live.PAUSERESUME.PAUSE&&i.pauseResume.reason===live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE)}console.log("LiveAudioVideo: Remote video is paused="+t),this.attachToMedia(i,o,t),d.show(),t||this._impl.dispatchEvent(e.LiveRemoteVideoStarted)}}else(n=document.querySelector(".oracle-live-remote-audio"))&&(n.srcObject=i,this.playMedia(n));break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED:r?((o=document.querySelector(".oracle-live-remote-video"))&&(o.srcObject=null),d.hide(),this._impl.dispatchEvent(e.LiveRemoteVideoStopped)):(n=document.querySelector(".oracle-live-remote-audio"))&&(n.srcObject=null)}}attachToMedia(e,t,i,n){if(e&&t){console.log("LiveAudioVideo: attachToMedia: stream=",e,", media=",t),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(e.track.enabled=!1),e.track&&"audio"===e.track.kind&&(e.track.enabled=!1)):(e.getVideoTracks().forEach(e=>{e.enabled=!1}),e.getAudioTracks().forEach(e=>{e.enabled=!1}));const o=()=>{console.log("LiveAudioVideo: Loaded metadata",e),t.removeEventListener("loadedmetadata",o);let s=!i||"Safari"===this._impl._browserName;e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(console.log("LiveAudioVideo: Loaded metadata: downgradedVideo="+i),e.track.enabled=s,console.log("LiveAudioVideo: video track enabled = "+e.track.enabled),n&&(e.track.onended=n)),e.track&&"audio"===e.track.kind&&(e.track.enabled=!0)):(e.getVideoTracks().forEach(e=>{console.log("LiveAudioVideo: Loaded metadata: downgradedVideo="+i),e.enabled=s,console.log("LiveAudioVideo: video track enabled = "+e.enabled),n&&(e.onended=n)}),e.getAudioTracks().forEach(e=>{e.enabled=!0}))};"Safari"===this._impl._browserName?o():t.addEventListener("loadedmetadata",o,{once:!0}),t.srcObject=e,this.playMedia(t)}}playMedia(e){e&&"function"==typeof e.play&&(console.log("Start playing media"),this._isEdge()?e.play():e.play().then(()=>{console.log("Started playing media")}).catch(e=>{console.log("Failed to start playing media",e)}))}detectWhenStreamHasChangedState(e,t){console.log("LiveAudioVideo: detectWhenStreamHasChangedState - streamState=",JSON.stringify(t,null,2),e,this._avStream1,this._avStream2);const i=t.state,n=t.status,o=n.code+0,s=n.reason;switch(this._impl._connection.logEventTimestamp("avStreamStateTo"+i),i){case live.STREAMSTATE.ESTABLISHED:e&&e.streamId&&this._impl._rememberMyStreams(e.streamId),this._impl.onCallEstablished();break;case live.STREAMSTATE.ERROR:console.log("LiveAudioVideo: detectWhenStreamHasChangedState - ERROR: code="+o+", reason="+s),o!==live.ERRORCODE.ICE_CONNECTION_ERROR||this._sidebar||(console.log("LiveAudioVideo: ICE connection error"),this._impl.onCallStreamStateError()),this._sidebar&&(this._sidebar=!1);break;case live.STREAMSTATE.FAILED:case live.STREAMSTATE.ENDED:console.log("live.STREAMSTATE.ENDED: Stream Ended"),console.dir(e),console.log("     Call State = "+this._impl._buttonState.stateName),console.log("  transferState = "+this._impl._buttonState.transferState),"None"!==this._impl._buttonState.transferState?(this._impl._buttonState.transferState="None",console.log("TRANSFER: Ignoring live.STREAMSTATE.ENDED because this is a participant leaving")):this._avStream2?(console.log("LiveAudioVideo: Switching to sidebar: AV2 -> AV1"),this._avStream1=this._avStream2,this._av1StreamId=this._av2StreamId,this._avStream2=null,this._av2StreamId=null):(console.log("LiveAudioVideo: Ending AV1 stream"),this._impl.onCallEnded(),this._avStream1=null,this._av1StreamId=null,this.reset())}}detectWhenAudioVideoIsUpdated(e,t){console.log("LiveAudioVideo: detectWhenAudioVideoIsUpdated",t,e);const i=e.getId();this._avStream1&&i===this._av1StreamId?(this._localStreamOptions=t,this._avStream1.accept(t)):this._avStream2&&i===this._av2StreamId&&(this._localStreamOptions=t,this._avStream2.accept(t))}detectWhenStreamHasFailed(t,i){console.log("LiveAudioVideo: detectWhenStreamHasFailed, error: ",JSON.stringify(i,null,2),t);const n=t.getId();this._avStream1&&this._avStream2?this._av2StreamId===n?console.log("LiveAudioVideo: Ignore error for AV1 stream - it will end soon"):this._av2StreamId===n&&this._impl.dispatchEvent(e.LiveStreamError):this._av1StreamId===n&&this._impl.dispatchEvent(e.LiveStreamError)}detectStreamPauseResumeRequest(t,i,n,o){let s=o.reason,a=s===live.PAUSERESUMEREASON.PAUSE_RESUME,r=o.audio===live.PAUSERESUME.PAUSE&&o.video===live.PAUSERESUME.PAUSE,c=o.audio===live.PAUSERESUME.RESUME&&o.video===live.PAUSERESUME.RESUME,l=o.audio===live.PAUSERESUME.RESUME&&o.video===live.PAUSERESUME.PAUSE,d=i.getType();console.log("LiveAudioVideo: detectStreamPauseResumeRequest - reason="+s+", isPause="+r+", isUpgrade="+c+", isDowngrade="+l,o),a?(n.accept(),$(".oracle-live").hasClass("oracle-live-frozen-annotation")&&(o.video=live.PAUSERESUME.RESUME),this.pauseResumeStream(o),this._impl._screen.pauseResumeOutgoing(r),r?this._impl.dispatchEvent(e.LivePausedRemotely):this._impl.dispatchEvent(e.LiveResumedRemotely)):l?(n.accept(),d===live.STREAMTYPE.AUDIOVIDEO&&(this._impl.dispatchEvent(e.LiveLocalVideoStopped),this.pauseResumeStream(o))):c&&(this._upgradePauseResume=o,this._impl._upgradeRequest=n,this._impl._upgradeRequestStreamType=d,this._impl._upgradeRequestForUser="user",d===live.STREAMTYPE.AUDIOVIDEO&&this._impl.dispatchEvent(e.LiveStartVideoRequested))}startVideo(){console.log("LiveAudioVideo: startVideo",this._upgradePauseResume);let t=this._upgradePauseResume;if(!t){const e=live.StreamProfile.create(this._avStream1.getStreamInfo().getStreamProfile());e.upgraded=!0,e.paused_by=this._impl.service.userID,e.pauseResume.pausedBy=this._impl.service.userID,e.pauseResume.video=live.PAUSERESUME.RESUME,e.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,t=e.pauseResume}console.log("LiveAudioVideo: startVideo: pauseResume="+JSON.stringify(t,null,2)),this._avStream1&&this._avStream1.pauseResumeStream(t,()=>{console.log("LiveAudioVideo: Started local video avStream1"),this._impl.dispatchEvent(e.LiveLocalVideoStarted),this._userVideoInitiallyPaused=!1}),this._avStream2&&this._avStream2.pauseResumeStream(t,()=>{console.log("LiveAudioVideo: Started local video avStream2"),this._impl.dispatchEvent(e.LiveLocalVideoStarted),this._userVideoInitiallyPaused=!1}),this._upgradePauseResume=null}stopVideo(){console.log("LiveAudioVideo: stopVideo");const t=this._avStream1.getStreamInfo().getStreamProfile();t.upgraded=!1,t.paused_by=this._impl.service.userID,t.pauseResume.pausedBy=this._impl.service.userID,t.pauseResume.video=live.PAUSERESUME.PAUSE,t.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._avStream1&&this._avStream1.pauseResumeStream(t.pauseResume,()=>{console.log("LiveAudioVideo: Stopped local video avStream1"),this._impl.dispatchEvent(e.LiveLocalVideoStopped),this._userVideoInitiallyPaused=!0}),this._avStream2&&this._avStream2.pauseResumeStream(t.pauseResume,()=>{console.log("LiveAudioVideo: Stopped local video avStream2"),this._impl.dispatchEvent(e.LiveLocalVideoStopped),this._userVideoInitiallyPaused=!0})}startVideoPreview(){const t=this._avStream1&&this._avStream1.isVideoPaused()||this._avStream2&&this._avStream2.isVideoPaused()||this._userVideoInitiallyPaused;if(console.log("LiveAudioVideo: startVideoPreview: videoIsPaused="+t),this._impl.acceptUpgradeRequest(),$(".oracle-live-local-video").show(),t&&this._localVideoStream)if(console.log("LiveAudioVideo: startVideoPreview: preview in Connected state"),this._cameras&&0===this._cameras.length&&navigator.mediaDevices.enumerateDevices().then(this._getCameraDeviceIds.bind(this)),this._localVideoStream instanceof RTCRtpReceiver||this._localVideoStream instanceof RTCRtpSender)this._localVideoStream.track&&"video"===this._localVideoStream.track.kind&&(console.log("LiveAudioVideo: Enable video tracks: length=1",this._localVideoStream.track),this._localVideoStream.track.enabled=!0);else{const e=this._localVideoStream.getVideoTracks();console.log("LiveAudioVideo: Enable video tracks: length="+e.length,e),e.forEach(e=>{e.enabled=!0})}else{console.log("LiveAudioVideo: startVideoPreview: preview in Idle state");const t={audio:!0,video:{width:{min:640,ideal:1024,max:1920},height:{min:360,ideal:768,max:1080}}};this._currentCameraId&&(t.video.deviceId={exact:this._currentCameraId});const i=e=>{if(console.log("LiveAudioVideo: Got preview stream for constraints:",t),this._cameras&&0===this._cameras.length&&navigator.mediaDevices.enumerateDevices().then(this._getCameraDeviceIds.bind(this)),console.log("LiveAudioVideo: this._cameras: ",this._cameras),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender)e.track&&"video"===e.track.kind&&(this._currentCameraId=e.track.getSettings().deviceId,console.log("LiveAudioVideo: Using RTCRtp video device: "+e.track.label));else{const t=e.getVideoTracks();this._currentCameraId=t[0].getSettings().deviceId,console.log("LiveAudioVideo: Using video device: "+t[0].label)}e.oninactive=(()=>{console.log("LiveAudioVideo: Preview stream inactive")}),this._previewStream=e;const i=document.getElementById("oracle-live-local-video");i?(i.srcObject=e,this.playMedia(i)):(console.warn("LiveAudioVideo: Failed to attach preview stream"),this._impl.stopStream(this._previewStream))},n=t=>{console.warn("LiveAudioVideo: Failed to get preview stream",t),this._impl.dispatchEvent(e.LiveLocalVideoStopped)};navigator.mediaDevices.getUserMedia(t).then(i.bind(this)).catch(n.bind(this))}}stopVideoPreview(){this._impl.stopStream(this._previewStream),this._previewStream=null,this._avStream1&&this._avStream1.isVideoPaused()||(this._impl.stopStream(this._localVideoStream),this._localVideoStream=null)}swapCamera(){if(console.log("LiveAudioVideo::swapCamera"),!this._hasTwoCameras)return void console.log("LiveAudioVideo::swapCamera - nothing to swap so returning");if(this._activeLocalVideoTrack=null,this._avStream1){const e=this._avStream1.call;if(e){let t=e.getPeerConnection().getSenders().find(e=>e.track&&"video"===e.track.kind);t&&(console.log("LiveAudioVideo::swapCamera - stopping sender video track"),t.track.stop())}}const e=e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!1,e.track.stop()):e.getVideoTracks().forEach(e=>{e.enabled=!1,e.stop()}),e=null},t=this._getDifferentCameraId(this._currentCameraId);console.log("LiveAudioVideo::swapCamera  newDeviceId: ",t);const i=document.getElementById("oracle-live-local-video");this._localVideoStream&&(console.log("LiveAudioVideo::swapCamera  stopping _localVideoStream"),e(this._localVideoStream)),this._previewStream&&(console.log("LiveAudioVideo::swapCamera  stopping preview video tracks"),e(this._previewStream)),this._getCameraStreamWithDeviceId(t,e=>{console.log("LiveAudioVideo::swapCamera: gotStream()"),$(".oracle-live").hasClass("oracle-live-video-preview")&&(console.log("LiveAudioVideo::swapCamera:  updating video preview"),this._previewStream=e,i?this.attachToMedia(this._previewStream,i,!1):(console.warn("LiveAudioVideo::swapCamera Failed to attach preview stream"),this._impl.stopStream(this._previewStream)));const t=e.getVideoTracks();if(this._currentCameraId=t[0].getSettings().deviceId,this._avStream1){console.log("LiveAudioVideo::swapCamera: _avStream1: ",this._avStream1),console.log("LiveAudioVideo::swapCamera: cameraVideoTracks",t);const e=this._avStream1.call.getPeerConnection();e&&e.getSenders().forEach(e=>{e instanceof RTCRtpSender&&e.track&&"video"===e.track.kind&&(console.log("LiveAudioVideo::swapCamera: pcSenders replacing track with camera"),e.replaceTrack(t[0]))})}this._localVideoStream=e,$(".oracle-live").hasClass("oracle-live-video-preview")||this.attachToMedia(e,i,!1)},e=>{console.log("LiveAudioVideo::swapCamera: error trying to obtain camera stream: ",e)})}enableRemoteVideo(){this._avStream1&&this._avStream1.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!0):e.getVideoTracks().forEach(e=>{e.enabled=!0})}),this._avStream2&&this._avStream2.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!0):e.getVideoTracks().forEach(e=>{e.enabled=!0})}),console.log("LiveAudioVideo: Upgraded remote stream"),this._impl.dispatchEvent(e.LiveRemoteVideoStarted),this._associateVideoInitiallyPaused=!1}disableRemoteVideo(){let t="Safari"===this._impl._browserName;this._avStream1&&this._avStream1.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=t):e.getVideoTracks().forEach(e=>{e.enabled=t})}),this._avStream2&&this._avStream2.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=t):e.getVideoTracks().forEach(e=>{e.enabled=t})}),console.log("LiveAudioVideo: Downgraded remote stream (except for Safari)"),this._impl.dispatchEvent(e.LiveRemoteVideoStopped)}incomingAV(e,t){let i=null,n=e.getStreamOptions();this._avStream1?(console.log("LiveAudioVideo: incomingAV: Incoming AV2 stream",e),this._avStream2=e,this._av2StreamId=this._avStream2.getId(),i=this._localStreamOptions):(console.log("LiveAudioVideo: incomingAV: Incoming AV1 stream",e),this._avStream1=e,this._av1StreamId=this._avStream1.getId(),this._originalStreamOptions=live.StreamInfo.createStreamOptions(n.audioConfig,n.videoConfig),i=this._originalStreamOptions),console.log("LiveAudioVideo: incomingAV: Old streamOptions="+JSON.stringify(i,null,2)+", New local streamOptions="+JSON.stringify(n,null,2)+", New remote streamOptions="+JSON.stringify(t,null,2));const o=this._impl._conversation.getParticipants().find(e=>e.getUri()!==this._impl._conversation.getLocalParticipantUri());let s=!1;o&&(console.log("LiveAudioVideo: Checking if remote participant only has screen-share active"),s=o.getStreamInfos().every(e=>e.getType()===live.STREAMTYPE.SCREENSHARE)),console.log("LiveAudioVideo: incomingAV: remoteScreenShareOnly="+s),this._impl._screen._restartSendingScreenShare||s?(console.log("LiveAudioVideo: remoteScreenShareActive is "+this._impl._screen._remoteScreenShareActive),n=live.StreamInfo.createStreamOptions(i.audioConfig,live.MEDIADIRECTION.RECVONLY),console.log("LiveAudioVideo: incomingAV: Have active local screen share - Overriding stream options to: "+JSON.stringify(n,null,2))):console.log("LiveAudioVideo: incomingAV: New stream options are: "+JSON.stringify(n,null,2)),this._initCallbacks(e),e.accept(n),this._localStreamOptions=n;const a=this._impl._conversation.getLocalParticipant();if(a){const t=a.getStreamInfo(e.getId());if(t){console.log("LiveAudioVideo: incomingAV: Local stream options:",t.streamOptions);const e=t.getStreamProfile();console.log("LiveAudioVideo: incomingAV: Local stream profile:",e);const i=this._impl._behaviours;if(i){let t=!1;i.associateInitialMedia&&(t=i.associateInitialMedia===i.StartMediaType.AUDIO_VIDEO||i.associateInitialMedia===i.StartMediaType.VIDEO_ONLY);const n=i.associateCanAddVideo;console.log("LiveAudioVideo: incomingAV: startWithVideo:"+t+", canAdd:"+n),t||!n||this._avStream2||(e.upgraded=!1,this._userVideoInitiallyPaused=!0,console.log("LiveAudioVideo: incomingAV: Overriding local profile to have downgraded video"))}}}if(o){const t=o.getStreamInfo(e.getId());if(t){const e=t.streamOptions;console.log("LiveAudioVideo: incomingAV: Remote stream options:",e);const i=t.getStreamProfile();if(console.log("LiveAudioVideo: incomingAV: Remote stream profile:",i),e){const t=e.videoConfig===live.MEDIADIRECTION.SENDRECV||e.videoConfig===live.MEDIADIRECTION.SENDONLY;console.log("LiveAudioVideo: incomingAV: Setting Remote upgraded on incomingAV to "+t),this._associateVideoInitiallyPaused=!t}}}}createAVStreamForNewAssociate(e,t){console.log("TRANSFER: createAVStreamForNewAssociate"),console.log("createAVStreamForNewAssociate: Call in state="+this._impl._buttonState.stateName);let i=null;if(t&&t.getStreamInfos().length>0&&(i=t.getStreamInfos()[0].streamId),console.log("createAVStreamForNewAssociate:  participant streamId="+i),this._impl._buttonState&&"Transferring"!==this._impl._buttonState.stateName)return void console.log("createAVStreamForNewAssociate: Call not in connected state");let n=live.MEDIADIRECTION.SENDRECV,o=live.MEDIADIRECTION.INACTIVE;const s=this._impl._behaviours;s?s.associateCanAddVideo&&s.associateCanRequestEndUserVideo&&s.endUserCanAddVideo?o=live.MEDIADIRECTION.SENDRECV:s.endUserCanAddVideo?o=live.MEDIADIRECTION.SENDONLY:s.associateCanAddVideo&&(o=live.MEDIADIRECTION.RECVONLY):console.log("createAVStreamForNewAssociate: No behaviours found");let a=live.StreamInfo.createStreamOptions(n,o);const r=this._impl._conversation.getLocalParticipant();if(!r)return void console.log("createAVStreamForNewAssociate: No local participant found");const c=r.getUri(),l=live.StreamProfile.create();l.paused_by=c,l.pauseResume.pausedBy=c,s.endUserInitialMedia!==s.StartMediaType.AUDIO_VIDEO&&(l.pauseResume.video=live.PAUSERESUME.PAUSE),this._newAssociateAvStream&&(console.log("newAssociateAvStream should be null. Ending it first"),this._newAssociateAvStream.end()),console.log("createAVStreamForNewAssociate: creating audio/video stream"),this._newAssociateAvStream=this._impl._conversation.createAudioVideoStream(a,i,l),this._newAssociateAvStreamId=this._newAssociateAvStream.getId(),this._qualityMetricsCallback&&(this._newAssociateAvStream.onQualityMetrics=this._qualityMetricsCallback),console.log("createAVStreamForNewAssociate: Starting AV Media"),(e=>{this._initCallbacks(this._newAssociateAvStream),this._newAssociateAvStream.start(e)})(null)}switchOverTransferStream(e){if(console.log("TRANSFER: switchOverTransferStream"),console.log("transferringAssociate: "+this._impl._transferringAssociateUri),console.log("          participant: "+e.getUri()),this._impl._transferringAssociateUri===e.getUri()){let e=null;if(this._localAudioStream){const t=this._localAudioStream,i=t.getAudioTracks();console.log("Init activeLocalAudioTrack"),e=i[0],t.removeTrack(i[0])}this._avStream1&&(console.log("Ending AV1 stream for "+this._impl._transferringAssociateUri+" (associate has left)"),this._avStream1.end()),console.log("Switching over to new associate's stream"),this._avStream1=this._newAssociateAvStream,this._av1StreamId=this._newAssociateAvStreamId,this.replaceSenderAudioTrack(e),this._newAssociateAvStream=null,this._newAssociateAvStreamId=null,this._impl._transferringAssociateUri=null}}replaceSenderVideoTrack(e){if(this._avStream1){const t=this._avStream1.call.getPeerConnection();if(t){const i=t.getSenders();console.log("*** pcSenders: ",i),i.forEach(t=>{t instanceof RTCRtpSender&&t.track&&"video"===t.track.kind&&t.replaceTrack(e)})}}}replaceSenderAudioTrack(e){if(this._avStream1){const t=this._avStream1.call.getPeerConnection();if(t){const i=t.getSenders();console.log("*** pcSenders: ",i),i.forEach(t=>{t instanceof RTCRtpSender&&t.track&&"audio"===t.track.kind&&t.replaceTrack(e)})}}}replaceLocalStreamVideoTrack(e){if(console.log("replaceLocalStreamVideoTrack track: {} ",e),this._localVideoStream){const t=this._localVideoStream,i=t.getVideoTracks();this._activeLocalVideoTrack||(this._activeLocalVideoTrack=i[0]),t.removeTrack(i[0]),t.addTrack(e)}}cancelTransferSwitchoverStream(){"None"!==this._impl._buttonState.transferState&&(console.log("TRANSFER: cancelTransferSwitchoverStream"),this._newAssociateAvStream&&(console.log("newAssociateAvStream should be null. Ending it first"),this._newAssociateAvStream.end()),this._newAssociateAvStream=null,this._newAssociateAvStreamId=null,this._impl._buttonState.transferState="None")}freezeEndUserVideo(e){if(!e)return void(this._activeLocalVideoTrack&&(this.replaceSenderVideoTrack(this._activeLocalVideoTrack),this.replaceLocalStreamVideoTrack(this._activeLocalVideoTrack)));let t=$("#oracle-live-local-video")[0],i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height);let n=i.captureStream();console.log("Canvas stream ",n),this.replaceLocalStreamVideoTrack(n.getVideoTracks()[0]),this.replaceSenderVideoTrack(n.getVideoTracks()[0])}}}),define("LiveScenarioBehaviours",[],function(){"use strict";const e={NONE:"NONE",AUDIO_VIDEO:"AUDIO_VIDEO",AUDIO_ONLY:"AUDIO_ONLY",SCREEN_SHARE:"SCREEN_SHARE",VIDEO_ONLY:"VIDEO_ONLY"};return class{constructor(t){this.StartMediaType=e,t&&(this.endUserCanAddAudio=t.endUserCanAddAudio,this.endUserCanAddVideo=t.endUserCanAddVideo,this.endUserCanAddScreenShare=t.endUserCanAddScreenShare,this.associateCanAddAudio=t.associateCanAddAudio,this.associateCanAddVideo=t.associateCanAddVideo,this.associateCanAddScreenShare=t.associateCanAddScreenShare,this.associateCanRequestEndUserAudio=t.associateCanRequestEndUserAudio,this.associateCanRequestEndUserVideo=t.associateCanRequestEndUserVideo,this.associateCanRequestEndUserScreenShare=t.associateCanRequestEndUserScreenShare,this.preCallIDCheck=t.preCallIDCheck,this.endUserInitialMedia=t.endUserInitialMedia,this.associateInitialMedia=t.associateInitialMedia,this.shortCodeEnabled=t.shortCodeEnabled,this.meetingsEnabled=t.meetingsEnabled,this.transferEnabled=t.transferEnabled)}toJSON(){return{endUserCanAddAudio:this.endUserCanAddAudio,endUserCanAddVideo:this.endUserCanAddVideo,endUserCanAddScreenShare:this.endUserCanAddScreenShare,associateCanAddAudio:this.associateCanAddAudio,associateCanAddVideo:this.associateCanAddVideo,associateCanAddScreenShare:this.associateCanAddScreenShare,associateCanRequestEndUserAudio:this.associateCanRequestEndUserAudio,associateCanRequestEndUserVideo:this.associateCanRequestEndUserVideo,associateCanRequestEndUserScreenShare:this.associateCanRequestEndUserScreenShare,preCallIDCheck:this.preCallIDCheck,endUserInitialMedia:this.endUserInitialMedia,associateInitialMedia:this.associateInitialMedia,shortCodeEnabled:this.shortCodeEnabled,meetingsEnabled:this.meetingsEnabled,transferEnabled:this.transferEnabled}}allowDowngrades(t){console.log("Allowing Downgrades ("+t+")"),this.endUserInitialMedia!==e.AUDIO_ONLY&&this.endUserInitialMedia!==e.AUDIO_VIDEO||this.endUserCanAddAudio!==t&&(console.log("Altering endUserCanAddAudio to be ("+t+")"),this.endUserCanAddAudio=t),this.endUserInitialMedia===e.AUDIO_VIDEO&&this.endUserCanAddVideo!==t&&(console.log("Altering endUserCanAddVideo to be ("+t+")"),this.endUserCanAddVideo=t)}isEndUserAudioPossible(){return this.endUserCanAddAudio||this.associateCanRequestEndUserAudio||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.AUDIO_ONLY}isEndUserVideoPossible(){return this.endUserCanAddVideo||this.associateCanRequestEndUserVideo||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isStartWithEndUserVideo(){return this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isStartWithAssociateVideo(){return this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY}isStartWithEndUserScreenShare(){return console.log("liveScenarioBehaviours::isStartWithEndUserScreenShare",this.endUserInitialMedia===e.SCREEN_SHARE),this.endUserInitialMedia===e.SCREEN_SHARE}isEndUserScreenSharePossible(){return this.endUserCanAddScreenShare||this.associateCanRequestEndUserScreenShare||this.endUserInitialMedia===e.SCREEN_SHARE}isAssociateAudioPossible(){return this.associateCanAddAudio||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.AUDIO_ONLY}isAssociateVideoPossible(){return this.associateCanAddVideo||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY}isAssociateScreenSharePossible(){return this.associateCanAddScreenShare||this.associateInitialMedia===e.SCREEN_SHARE}isAudioPossible(){return this.endUserCanAddAudio||this.associateCanAddAudio||this.associateCanRequestEndUserAudio||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.AUDIO_ONLY||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.AUDIO_ONLY}isAudioOnly(){return this.associateInitialMedia===e.AUDIO_ONLY&&this.endUserInitialMedia===e.AUDIO_ONLY}isVideoPossible(){return this.endUserCanAddVideo||this.associateCanAddVideo||this.associateCanRequestEndUserVideo||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isVideoOnly(){return this.associateInitialMedia===e.AUDIO_VIDEO&&this.endUserInitialMedia===e.AUDIO_VIDEO}isEndUserVideo(){return this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isScreenSharePossible(){return this.endUserCanAddScreenShare||this.associateCanAddScreenShare||this.associateCanRequestEndUserScreenShare||this.associateInitialMedia===e.SCREEN_SHARE||this.endUserInitialMedia===e.SCREEN_SHARE}isPreCallIDCheck(){return this.preCallIDCheck}getMediaType(){let e="";return this.isAudioPossible()&&(e+="audio"),this.isVideoPossible()&&(""!==e&&(e+=","),e+="video"),this.isScreenSharePossible()&&(""!==e&&(e+=","),e+="screenshare"),e}}}),define("LiveScenarioMessages",[],function(){"use strict";return class{constructor(e){e&&(this.greetingMessage=e.greetingMessage,this.connectingMessage=e.connectingMessage)}}}),define("LiveNetworkQualityMonitor",["LiveEvents"],function(e){"use strict";const t=1e4;return class{constructor(e){this._impl=e,this._monitoredStreams=new Map,this._qualityMap={},this._isBad=!1,this._lastQualityResult=live.ExperienceStatus.GOOD,this._qualityPeriod=2e4,this._qualityTimer=null,this._videoLoadingTimer=null}_getExperienceStatus(e){switch(e){case live.ExperienceStatus.GOOD:return"GOOD";case live.ExperienceStatus.BAD:return"BAD";case live.ExperienceStatus.NOT_AVAILABLE:return"N/A";default:return"I/S"}}monitor(i,n){const o=n?"local":"remote",s=i.getId(),a=i.getType();if(this._monitoredStreams[o+a+s])return void this.optionallyLog("LiveNetworkQualityMonitor::monitor: Already monitoring "+o+" stream id: "+s+", type: "+a);this._monitoredStreams[o+a+s]=!0,this.optionallyLog("LiveNetworkQualityMonitor::monitor: Start monitoring "+o+" stream id: "+s+", type: "+a);const r=i.getQualityMonitor();if(r.onNewStatus(live.ExperienceFactor.VIDEO_INBOUND,(e,t)=>{const n=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+o+":"+a+":"+s+").InVideoStatus: "+n+" - hints: "+r+")"),i.getStreamOptions().shouldReceiveVideo()&&!i.isVideoPaused()&&this._updateMos(s,live.ExperienceFactor.VIDEO_INBOUND,e)}),r.onNewStatus(live.ExperienceFactor.VIDEO_OUTBOUND,(e,t)=>{const n=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+o+":"+a+":"+s+").OutVideoStatus: "+n+" - hints: "+r+")"),i.getStreamOptions().shouldSendVideo()&&!i.isVideoPaused()&&this._updateMos(s,live.ExperienceFactor.VIDEO_OUTBOUND,e)}),r.onNewStatus(live.ExperienceFactor.AUDIO_INBOUND,(e,t)=>{const n=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+o+":"+a+":"+s+").InAudioStatus: "+n+" - hints: "+r+")"),i.getStreamOptions().shouldReceiveAudio()&&!i.isAudioPaused()&&this._updateMos(s,live.ExperienceFactor.AUDIO_INBOUND,e)}),r.onNewStatus(live.ExperienceFactor.AUDIO_OUTBOUND,(e,t)=>{const n=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+o+":"+a+":"+s+").OutAudioStatus: "+n+" - hints: "+r+")"),i.getStreamOptions().shouldSendAudio()&&!i.isAudioPaused()&&this._updateMos(s,live.ExperienceFactor.AUDIO_OUTBOUND,e)}),n){let i=!0;a===live.STREAMTYPE.AUDIOVIDEO&&(this._impl.dispatchEvent(e.LiveRemoteVideoLoading),this._videoLoadingTimer=setTimeout(()=>{this._videoLoaded()},t)),r.withCallbacks(e=>{this.optionallyLog("QM("+o+":"+a+":"+s+").InFrRate: "+e),a===live.STREAMTYPE.AUDIOVIDEO&&e>0&&i&&(i=!1,this._videoLoaded())},e=>{this.optionallyLog("QM("+o+":"+a+":"+s+").OutFrRate: "+e)},(e,t)=>{this.optionallyLog("QM("+o+":"+a+":"+s+").InRes: "+e+"x"+t),a===live.STREAMTYPE.AUDIOVIDEO&&e>0&&t>0&&i&&(i=!1,this._videoLoaded())},(e,t)=>{this.optionallyLog("QM("+o+":"+a+":"+s+").OutRes: "+e+"x"+t)})}this._checkQualityStatus(this._qualityPeriod)}_videoLoaded(){this._impl.dispatchEvent(e.LiveRemoteVideoLoaded),this._videoLoadingTimer&&clearTimeout(this._videoLoadingTimer),this._videoLoadingTimer=null}_updateMos(e,t,i){const n="LiveNetworkQualityMonitor::_updateMos:";this.optionallyLog(`${n} streamId: ${e} factor: ${t}  status: ${i}`);const o={};o.status=i,o.timestamp=Date.now();const s=e+t;this._qualityMap[s]=this._qualityMap[s]||[],this._qualityMap[s].push(o),this.optionallyLog(`${n}key: ${s} = ${JSON.stringify(this._qualityMap[s])})`),this._isBad||i===live.ExperienceStatus.BAD&&(this._isBad=!0,this.optionallyLog("QoE value has changed to BAD. Show first BAD message now."),this._lastQualityResult=live.ExperienceStatus.BAD)}_getQualityResultOfLastPeriod(e){const t=Date.now(),i=this._impl._conversation.getLocalParticipant();if(!i)return this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning not available"),live.ExperienceStatus.NOT_AVAILABLE;const n=[],o=[];return i.getStreamInfos().forEach(i=>{const s=i.getId(),a=i.getStreamOptions(),r=this._impl.getAssociateStreamInfo(i.getType()),c=this._qualityMap[s+live.ExperienceFactor.VIDEO_INBOUND],l=this._qualityMap[s+live.ExperienceFactor.VIDEO_OUTBOUND],d=this._qualityMap[s+live.ExperienceFactor.AUDIO_INBOUND],u=this._qualityMap[s+live.ExperienceFactor.AUDIO_OUTBOUND];void 0!==c&&c.length>0&&a.shouldReceiveVideo()&&!r.isVideoPaused()&&n.push(this._getQuality(t,e,live.ExperienceFactor.VIDEO_INBOUND,s)),void 0!==l&&l.length>0&&a.shouldSendVideo()&&!i.isVideoPaused()&&n.push(this._getQuality(t,e,live.ExperienceFactor.VIDEO_OUTBOUND,s)),void 0!==d&&d.length>0&&a.shouldReceiveAudio()&&!r.isAudioPaused()&&o.push(this._getQuality(t,e,live.ExperienceFactor.AUDIO_INBOUND,s)),void 0!==u&&u.length>0&&a.shouldSendAudio()&&!i.isAudioPaused()&&o.push(this._getQuality(t,e,live.ExperienceFactor.AUDIO_OUTBOUND,s))}),n.find(e=>e===live.ExperienceStatus.BAD)||o.find(e=>e===live.ExperienceStatus.BAD)?(this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning BAD"),live.ExperienceStatus.BAD):(this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning GOOD"),live.ExperienceStatus.GOOD)}_getQuality(e,t,i,n){const o=n+i,s=this._qualityMap[o],a=e-t,r={};r.status=s[s.length-1].status,r.timestamp=e,s.push(r);let c=0,l=0,d=0;this.optionallyLog(`LiveNetworkQualityMonitor::_getQuality: qualityTagList: ${JSON.stringify(s)}`);for(let e=0;e<s.length;e++){const t=s[e];if(t.timestamp>a){if(e>0){const i=s[e-1],n=t.timestamp-i.timestamp;i.status===live.ExperienceStatus.BAD?l+=n:i.status===live.ExperienceStatus.GOOD?c+=n:d+=n}}else t.timestamp=a}const u=s[s.length-1];this._qualityMap[o]=[],this._qualityMap[o].push(u);const h=Math.round(100*l/t);return this.optionallyLog(i+" of stream "+n+": bad time is: "+l/1e3+" seconds, the percentage is: "+h),h<30?live.ExperienceStatus.GOOD:live.ExperienceStatus.BAD}_checkQualityStatus(e){this._qualityTimer?this.optionallyLog("LiveNetworkQualityMonitor::_checkQualityStatus: qualityTimer is running - returning"):this._qualityTimer=setInterval(()=>{const t=this._getQualityResultOfLastPeriod(e);this.optionallyLog(`LiveNetworkQualityMonitor::qualityTimer: result of last period: ${t} previousResult: ${this._lastQualityResult}`),t===live.ExperienceStatus.BAD?this._lastQualityResult===live.ExperienceStatus.GOOD&&this.optionallyLog("LiveNetworkQualityMonitor::qualityTimer: QoE value changed to BAD"):t===live.ExperienceStatus.GOOD?(this._lastQualityResult===live.ExperienceStatus.BAD&&this.optionallyLog("LiveNetworkQualityMonitor::qualityTimer: QoE value changed to GOOD"),this._isBad=!1):this.optionallyLog(`LiveNetworkQualityMonitor::qualityTimer: Unexpected QoE result: ${t}`),this._lastQualityResult=t},e)}reset(){this.optionallyLog("LiveNetworkQualityMonitor::reset"),this._qualityTimer&&(clearInterval(this._qualityTimer),this._qualityTimer=null),this._qualityMap={},this._isBad=!1,this._lastQualityResult=live.ExperienceStatus.GOOD,this._videoLoadingTimer&&clearTimeout(this._videoLoadingTimer),this._videoLoadingTimer=null}optionallyLog(e){}}}),define("LiveControllerImpl",["oracle.live.sdk","jquery","LiveService","LiveContextAttributes","LiveSettings","LiveApiVersion","LiveEvents","LiveExposedEvents","LiveState","LiveRestHelper","LiveCallTimer","LiveDiagnostics","LiveScreenSharing","LiveAudioVideo","LiveScenarioBehaviours","LiveScenarioMessages","LiveSessionStore","LiveNetworkQualityMonitor","LiveScenarioCustomization"],function(e,$,t,i,n,o,s,a,r,c,l,d,u,h,g,v,p,m,S){"use strict";return class{constructor(){console.log("LiveControllerImpl::constructor START"),this.service=new t(this),this.contextAttributes=new i(this),this.settings=new n,this.version=(new o).version,this._browserName=null,this._browserVersion=null,this._networkQualityMonitor=new m(this),this._isMeeting=!1,this._buttonState=new r(this),this._rest=new c(this),this._diags=new d(this),this._screen=new u(this),this._av=new h(this),this._behaviours=null,this._messages=null,this._customization=null,this._connection=null,this._retry=!1,this._callMediaType="",this._conversation=null,this._conversationId=null,this._associateUri=null,this._transferringAssociateUri=null,this._upgradeRequest=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this._rehydratingToState=null,this._connectionId=null,this._readyToStartConnection=!1,this._readyToAddComponent=!1,this._haveRequestedVideoPreview=!1,this._callEstablished=!1,this._connectionTimer=null,this._connectionTimeout=18e4,this._reconnectionTimer=null,this._reconnectionTimeout=2e4,this._reconnectingLocal=!1,this._statusCheckTimer=null,this._statusCheckTimeout=1e4,this._dynamicChromeExtensionInstall=!1,this._permanentTwoWayScreenShare=!1,this._dummyScreenShareCreated=!1,this._canRejoinMeeting=!0,this._componentAdded=!1,this._autoTest=!1,this._transactionReference=null,this._positionInQueue=0,this._myStreams=[],p.initState("LiveControllerImpl",this),$(()=>{console.log("LiveControllerImpl::constructor about to restore"),p.loadState("LiveControllerImpl",e=>{console.log("LiveControllerImpl: Loading, found ",e),this._isMeeting=e.isMeeting;const t=e.state;this._autoTest=e.autoTest,this._browserVersion=e.browserVersion,this._browserName=e.browserName,this._metaScenario=e.metaScenario,this._conversationId=e.conversationId,this.setPermanentTwoWayScreenShare(e.permanentTwoWayScreenShare),this._dummyScreenShareCreated=e.dummyScreenShareCreated,console.log("LiveControllerImpl::getMetaScenario resetting the metaScenario"),e.metaScenario&&e.metaScenario.behaviours&&e.metaScenario.messages&&(this._behaviours=new g(e.metaScenario.behaviours),console.log("Restored behaviours: ",this._behaviours),this.contextAttributes.set("behaviours",e.metaScenario.behaviours),this._messages=new v(e.metaScenario.messages),console.log("Restored messages: ",this._messages),this.contextAttributes.set("messages",e.metaScenario.messages)),e.customization&&(this._customization=new S(e.customization),console.log("Restored customization: ",this._customization)),this._browserName&&this._browserVersion&&this.contextAttributes.populateContext(this.version,this._browserName,this._browserVersion),console.log("Context attributes are: ",this.contextAttributes),console.log("Loading state: ",t),console.log("Meeting is: ",this._isMeeting);let i=window.location.toString()===e.url;console.log("Location (URL) is: ",i?"unchanged":"changed"),!0===this._isMeeting&&i||this._buttonState._stateSupportsRehydration(t)?(this._rehydratingToState=this._isMeeting?"Meeting":t,this._callMediaType=e.callMediaType,this._associateUri=e.associateUri,this._transferringAssociateUri=e._transferringAssociateUri,this._connectionId=e.connectionId,console.log("Restored connection ID: ",this._connectionId)):(this._rehydratingToState=null,console.log("LiveControllerImpl::Not rehydrating, resetting the button state"),this._buttonState.reset(),"Connecting"===t&&(this._authToken=e.authToken,this.beforeUnload(),this._authToken=null)),console.log("LiveControllerImpl::constructor Attempting to restore state: "+this._rehydratingToState),console.log("LiveControllerImpl::constructor done restoring, creating the component=",this._readyToAddComponent),this._readyToStartConnection=!0,!0===this._readyToAddComponent&&this._addComponent(),this._transactionReference=e.transactionReference,this._positionInQueue=e.positionInQueue},()=>{console.log("LiveControllerImpl::constructor no state to restore, add component"),this._readyToStartConnection=!0,!0===this._readyToAddComponent&&this._addComponent()})}),console.log("LiveControllerImpl::constructor end")}toJSON(){return!0===this._isMeeting||this._buttonState._stateSupportsRehydration(this._buttonState.stateName)?JSON.stringify({isMeeting:this._isMeeting,url:window.location.toString(),metaScenario:this._metaScenario,callMediaType:this._callMediaType,associateUri:this._associateUri,transferringAssociateUri:this._transferringAssociateUri,state:this._buttonState.stateName,authToken:this.service.authToken,connectionId:this._connection.getConnectionId(),browserName:this._browserName,browserVersion:this._browserVersion,conversationId:this._conversationId,permanentTwoWayScreenShare:this._permanentTwoWayScreenShare,dummyScreenShareCreated:this._dummyScreenShareCreated,transactionReference:this._transactionReference,positionInQueue:this._positionInQueue,autoTest:this._autoTest,customization:this._customization}):null}setAutoTest(e){console.log("LiveControllerImpl::setAutoTest setting to: ",e),this._diags.setAutoTest(e),this._autoTest=e}setQualityMetricsCallback(e){this._av._qualityMetricsCallback=e,this._screen._qualityMetricsCallback=e}setRunningForChromeExtension(e){this._rest.setRunningForChromeExtension(e)}setNoProxyForKyc(e){console.log("LiveControllerImpl::setNoProxyForKyc setting to: ",e),this._rest.setNoProxyForKyc(e)}reset(){console.log("Controller::reset"),this._networkQualityMonitor.reset();const e=e=>{e&&(console.log("reset method is clearing media..",e),e.srcObject=null)};this._screen.stopReceivingScreenShare(),this._screen.reset(),this._autoTest=!1,e(document.querySelector(".oracle-live-local-audio")),e(document.querySelector(".oracle-live-local-video")),e(document.querySelector(".oracle-live-remote-audio")),e(document.querySelector(".oracle-live-remote-video")),e(document.querySelector(".oracle-live-local-screenshare")),e(document.querySelector(".oracle-live-remote-screenshare")),clearTimeout(this._connectionTimer),clearTimeout(this._reconnectionTimer),clearTimeout(this._statusCheckTimer),this._statusCheckTimer=null,this._reconnectionTimer=null,this._connectionTimer=null,this._callEstablished=!1,this._conversation=null,this._av.reset(),this._associateUri=null,this._transferringAssociateUri=null,this._upgradeRequest=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this._rehydratingToState=null,this._transactionReference=null,this._positionInQueue=0,this.setPermanentTwoWayScreenShare(!1),this._dummyScreenShareCreated=!1,this._reconnectingLocal=!1,this._haveRequestedVideoPreview=!1,this._rest.closeCallQueue(),this._diags.cancelChecks(),this._transactionReference=null,this.contextAttributes.remove("preCallCheckId"),$(".kyc-jumio-iframe").attr("src",null),$(".oracle-live-local-video").hide(),$(".oracle-live-remote-video").hide()}beforeUnload(){let e=this._authToken?this._authToken:this.service.authToken;e&&(console.log("beforeUnload: attempting to remove from queue",e),this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("success")}),this._authToken=null)}_isRehydrating(){let e=!!this._rehydratingToState;return console.log("_isRehydrating:",e,", state: ",this._rehydratingToState),e}_isRehydratingMeetingCall(){let e=this._isRehydrating()&&"Meeting"===this._rehydratingToState;return console.log("_isRehydratingMeetingCall:",e),e}_isRehydratingNonMeetingCall(){let e=this._isRehydrating()&&"Meeting"!==this._rehydratingToState;return console.log("_isRehydratingNonMeetingCall:",e),e}addComponent(e){console.log("LiveControllerImpl::addComponent"),e&&(console.log("We have a root tag, this is a meeting"),this._eventNode=e,this._isMeeting=!0),!0===this._readyToStartConnection?(console.log("LiveControllerImpl::addComponent ready, adding now"),this._addComponent()):(console.log("LiveControllerImpl::addComponent setting add when ready"),this._readyToAddComponent=!0)}_addComponent(){console.log("LiveControllerImpl::_addComponent"),this._isRehydrating()?(console.log("LiveControllerImpl::_addComponent/rehydrating"),this.loginToLiveExperience()):(console.log("LiveControllerImpl::_addComponent/not rehydrating"),this._diags.checkBrowser().then(e=>{this._browserName=e.browserName,this._browserVersion=e.browserVersion,console.log("Set the value of the browser name: "+this._browserName+" and browser version: "+this._browserVersion),this.service.isValid()&&this.contextAttributes.isValid()&&(this.contextAttributes.populateContext(this.version,this._browserName,this._browserVersion),this.loginToLiveExperience())}).catch(e=>{console.warn("Not displaying the component",e)}))}updateComponent(){this.service.authToken?this.getMetaScenario(()=>{this._componentAdded?this._buttonState.updateMenu():this._getMessagesAndAddComponent()}):console.log("Not attempting to resolve meta scenario while unauthorised")}getNetworkStatus(e,t){console.log("LiveAPI::getNetworkStatus",this._connection),this._connection?this._connection.getNetworkStatus(e,t):t("Invalid connection")}updateAuthToken(e){this._connection&&this._connection.updateWebSocketUri(this._getWebSocketUri(e))}stopStream(e){e&&(console.log("stop stream",e),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(console.log("stop video track",e.track),e.track.stop&&e.track.stop(),e.track.enabled&&(e.track.enabled=!1),console.log("After stopping, track muted property="+e.track.muted)),e.track&&"audio"===e.track.kind&&(console.log("stop audio track",e.track),e.rack.stop&&e.track.stop(),e.track.enabled&&(e.track.enabled=!1),console.log("After stopping, track muted property="+e.track.muted))):(e.getVideoTracks().forEach(e=>{console.log("stop video track",e),e.stop&&e.stop(),e.enabled&&(e.enabled=!1),console.log("After stopping, track muted property="+e.muted)}),e.getAudioTracks().forEach(e=>{console.log("stop audio track",e),e.stop&&e.stop(),e.enabled&&(e.enabled=!1),console.log("After stopping, track muted property="+e.muted)})))}loginToLiveExperience(){console.log("loginToLiveExperience(): "+this.service.userID),this.loginAndConnect().then(()=>{console.log("Connected with username: "+this.service.userID+" and tenant: "+this.service.tenantID),this._connection.initCallbacks(this.detectIncomingStream.bind(this),this.refreshConnection.bind(this),this.detectWhenConnectionHasChanged.bind(this));const e=this._connection.isRefresh()||this._isRehydratingMeetingCall();if(console.log("Login success, refresh = "+e),e){const e=this._connection.getConversations(),t=e.length||0;console.log("Handling browser refresh",e),e&&t>0&&this.refreshConnection(e[t-1]),this._isMeeting&&(this._buttonState.isMeeting=!0),this._buttonState.addMenu(!0),p.loadStateCompleted(),this.dispatchEvent(s.LiveStateReloaded,{state:this._buttonState.stateName})}else this._isMeeting?this.getMetaScenario(()=>{this._getMessagesAndAddComponent()}):(this.getAvailability(),this.getMetaScenario(()=>{this._getMessagesAndAddComponent()}));this.dispatchEvent(s.LiveLoginSuccess)}).catch(e=>{console.error("Failed to connect",e),this.dispatchEvent(s.LiveLoginError)})}loginAndConnect(){return console.log("loginAndConnect()"),this._retry=!1,new Promise((e,t)=>{console.log("ConnectToLiveExperience Attempt 1"),this.connectToLiveExperience(e,i=>{this._retry?(console.log("Failed to connect to Live Experience (2) - already retried",i),t(i)):(console.log("Failed to connect to Live Experience (1) - retrying",i),this._retry=!0,console.log("ConnectToLiveExperience Attempt 2"),this.connectToLiveExperience(e,t))})})}_getWebSocketUri(e){let t=this.service.address.replace(/^http/,"ws")+"/ws/webrtc/cloud";return t+="?jwt="+e+"&tenant_profile_key="+this.service.tenantID,console.log("Connection has WebSocketURI: "+t),t}connectToLiveExperience(e,t){if(!(this.service.userID&&""!==this.service.userID&&this.service.userID.indexOf("@")>0))return console.log("connectToLiveExperience: Invalid username: "+this.service.userID),void this.logoutFromLiveExperience();let i=null;this._buttonState.connectingAudioURL=this.service.address+"/meeting/media/connecting.wav";let n=this.service.authToken;!0===this._isRehydrating()&&this._connectionId?(console.log("connectToLiveExperience: Rehydrating plus we have an existing session: "+this._connectionId),i=this._connectionId):(console.log("connectToLiveExperience: is rehydrating "+this._isRehydrating()),console.log("connectToLiveExperience: connectionId "+this._connectionId),console.log("connectToLiveExperience: Not rehydrating or no connection id to restart"),this._rehydratingToState=null),console.log("Logged in with username: "+this.service.userID+", tenant: "+this.service.tenantID),console.log("Local connection ID is: "+i),console.log("Creating connection with JWT: "+n);let o=this._getWebSocketUri(n);this._connection=new live.Connection(this.service.userID,o,e,t).withEarlyCallbacks(this.detectWhenConnectionHasChanged.bind(this),()=>null).withConnectionId(i).withExtPayloads({capability:{appid:"web"}}).start(),this._connection.setTrickleIceMode("full"),console.log("Starting connection: wsUri="+o,this._connection)}logoutFromLiveExperience(){console.log("LiveControllerImpl::logoutFromLiveExperience"),this._connection&&(console.log("logout: "+this.service.userID),this.beforeUnload(),this._connection.close(),this._connection=null,this._retry=!1),this.reset()}getMetaScenario(e){const t=this.contextAttributes.get("appLocation");return console.log("MetaScenario appLocation is ",this._metaScenarioAppLocation),"wce_test"===t?(console.log("LiveControllerImpl::getMetaScenario Using locally set configuration for test purposes: ",this._metaScenario),this._metaScenarioAppLocation=t,this._behaviours=new g(this._metaScenario.behaviours),this._behaviours.allowDowngrades(!1),this.contextAttributes.set("behaviours",this._metaScenario.behaviours),this._callMediaType=this._behaviours.getMediaType(),e&&e(),void this._buttonState.showMenu()):this._metaScenarioAppLocation&&this._metaScenarioAppLocation===t?(console.log("Scenario already downloaded, don't do anything"),e&&e(),void this._buttonState.showMenu()):(this._buttonState.hideMenu(),void this._rest.getMetaScenario((i,n)=>{i?(this._isMeeting&&(i=this._meet.applyPossiblePstnOverride(i)),this._metaScenario=i,this._metaScenarioAppLocation=t,this._behaviours=new g(i.behaviours),this._behaviours.allowDowngrades(!1),this._messages=new v(i.messages),this._callMediaType=this._behaviours.getMediaType(),console.log("Configuration.behaviours: ",i.behaviours),console.log("Configuration.messages: ",i.messages),this.contextAttributes.set("behaviours",i.behaviours),console.log("Stored behaviours: "+JSON.stringify(this.contextAttributes.get("behaviours"),null,2)),this.contextAttributes.set("messages",i.messages),console.log("Stored messages: "+JSON.stringify(this.contextAttributes.get("messages"),null,2))):console.log("getMetaScenario: No configuration"),n?(this._components=n,this._customization=new S(n.customization),console.log("Components.customization: ",n.customization)):console.log("getMetaScenario: No components"),this._buttonState.updateMenu(),this._isMeeting?(console.log("Hiding oracle-live-experience"),this._buttonState.isMeeting=!0,e&&e()):(e&&e(),this._buttonState.showMenu())}))}overrideBehaviours(e){console.log("Overriding behaviours to be "+JSON.stringify(e,null,2)),this._behaviours=new g(e),this._callMediaType=this._behaviours.getMediaType(),this.contextAttributes.set("behaviours",e),this._buttonState.updateMenu()}_getMessagesAndAddComponent(){const e=this.settings.locale||navigator.language;this._rest.getMessages(e,e=>{e&&(this._buttonState.messages=e),this._buttonState.addMenu(!1),this._componentAdded=!0,console.log("Component added")})}getAvailability(){this._rest.getAppAvailability(e=>{this.refreshAvailability(e.nextChange),console.log("getAvailability: available="+e.available),this._buttonState.setAvailable(!0===e.available),!0===e.available?this._buttonState.showMenu():this._buttonState.hideMenu()})}refreshAvailability(e){if(console.log("refreshAvailability: nextChange="+e),e){const t=Date.parse(e),i=Math.floor(t/1e3),n=Date.now(),o=Math.floor(n/1e3),s=t-n,a=Math.floor(s/1e3),r=l.formatDuration(o,i);console.log("Will refresh availability in: "+a+" seconds ("+r+" [hours:mins:secs])"),setTimeout(()=>{this.getAvailability()},s)}}checkPostCallRating(){this._conversation.isPostCallRatingRequired()&&(console.log("LiveAudioVideo: Post-call rating is required"),this._conversationId=this._conversation.getKey(),this.dispatchEvent(s.LiveRatingRequired))}startCallWithAssociate(e,t){if(console.log("LiveControllerImpl::startCallWithAssociate: rehydratingToState="+this._rehydratingToState),this._isMeeting||(this._connectionTimer=setTimeout(()=>{console.log("LiveControllerImpl:: associate did not respond in 3 minutes"),this.dispatchEvent(s.LiveConnectingNoAnswer)},this._connectionTimeout)),!0===this._reconnectingLocal)return void console.log("LiveControllerImpl::startCallWithAssociate: reconnectingLocal is true so returning");this.contextAttributes.set("shortCode",t||null);const i=t=>{console.log("LiveControllerImpl::startCallWithAssociate: waiting for answer.."),this._buttonState.hideQueueLengthIndicator(),this.dispatchEvent(s.LiveWaiting),this._connection.logEventTimestamp("availableAgentRequestSent"),this._rest.addToCallQueue(this._callMediaType,i=>{let n=i,o=null;if(i.startsWith("{")&&i.endsWith("}")){const e=JSON.parse(i);n=e.assignedAgent,o=e.conversationKey,console.log("LiveControllerImpl::_hidePauseResumeButton... "),this._buttonState.hidePauseResumeButton(),console.log("LiveControllerImpl::startCallWithAssociate: Have a conversationKey="+o)}console.log("LiveControllerImpl::startCallWithAssociate: Call answered, address="+n),this._connection.logEventTimestamp("availableAgentSuccessResponseGot"),this.dispatchEvent(s.LiveConnecting),this.startCall(n,e,o),t&&(console.log("Restore original behaviours for next call"),this.contextAttributes.set("behaviours",t))},e=>{console.log("LiveControllerImpl::startCallWithAssociate: No answer, reason="+e),this._connection.logEventTimestamp("availableAgentFailResponseGot"),this.dispatchEvent(s.LiveConnectingNoAnswer),t&&(console.log("Restore original behaviours for next call"),this.contextAttributes.set("behaviours",t))})},n=()=>{if(this.dispatchEvent(s.LiveDiagnosticsComplete),"Connecting"===this._rehydratingToState){let e=sessionStorage.getItem("previousJWT");e&&this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("Have removed earlier call made with JWT:"+e),console.log("LiveControllerImpl::startCallWithAssociate sending context"),this._rest.sendContext(()=>{i(this._behaviours)})})}else console.log("LiveControllerImpl::startCallWithAssociate sending context"),this._rest.sendContext(()=>{i(this._behaviours)})},o=()=>{this._diags.hasAudio()?(this._diags.hasAudio()&&!this._diags.hasVideo()&&(console.log("LiveControllerImpl::startCallWithAssociate: Cannot start video call - downgrading user behaviours"),this._behaviours.isEndUserVideo()&&(this._behaviours.endUserInitialMedia=this._behaviours.StartMediaType.AUDIO_ONLY),this._behaviours.associateCanRequestEndUserVideo&&(this._behaviours.associateCanRequestEndUserVideo=!1),this._behaviours.endUserCanAddVideo&&(this._behaviours.endUserCanAddVideo=!1),this.contextAttributes.set("behaviours",this._behaviours.toJSON()),this._buttonState.configureBehaviours()),n()):this._buttonState.event(s.LiveDiagnosticsFailed)};if(this._isMeeting)this._diags.checkMeetingDiagnostics(this._behaviours.isEndUserVideoPossible()).then(e=>{console.log("LiveControllerImpl::startCallWithAssociate: Audio & video checks completed: ",e),o()}).catch(e=>{console.log("LiveControllerImpl::startCallWithAssociate: Audio & video checks failed: ",e),o()});else if(!0===this._behaviours.isStartWithEndUserScreenShare())console.log("LiveControllerImpl::startCallWithAssociate: no diagnostics for screenshare call"),n();else{const e=this._behaviours.isEndUserVideoPossible()&&!this._haveRequestedVideoPreview;this._diags.testCombinedDevices(e).then(e=>{console.log("LiveControllerImpl::startCallWithAssociate: diagnostics completed: ",e),o()}).catch(e=>{console.warn("LiveControllerImpl::startCallWithAssociate: diagnostics failed: ",e),"CANCELLED"!==e&&this._buttonState.event(s.LiveDiagnosticsFailed)})}}endCallWithAssociate(){if($("body").css("visibility","visible"),console.log("LiveControllerImpl::endCallWithAssociate"),this._resetMyStreams(),this._av)try{this._av.stop()}catch(e){console.log("LiveControllerImpl::endCallWithAssociate Conversation already closed",e)}let e;if(this._screen.stopSendingScreenShare(),this._conversation)console.log("LiveControllerImpl::endCallWithAssociate ending conversation",this._conversation),e=this._conversation.conversationKey,this._conversation.getLocalParticipant().remove(),this._conversation=null;else{console.log("LiveControllerImpl::endCallWithAssociate no call, remove from queue");let e=this.service.authToken;this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("LiveControllerImpl::endCallWithAssociate removed from call queue")})}this._buttonState.isPreCallIDCheck()?this.getVerificationResult(e).finally(()=>this.reset()):this.reset()}holdCallWithAssociate(){if(console.log("LiveControllerImpl::holdCallWithAssociate"),this._buttonState.isTransferring())console.log("Not holding call with associate because we're transferring a call");else if(this._conversation&&(this._av.isActive()||this._screen.isActive())){console.log("LiveControllerImpl::holdCallWithAssociate found active stream");let e=new live.PauseResume(live.PAUSERESUME.PAUSE,live.PAUSERESUME.PAUSE,live.PAUSERESUMEREASON.PAUSE_RESUME);this._conversation.getParticipant(this._associateUri).getStreamInfos().forEach(t=>{t.pauseResumeStream(e,()=>{if(console.log("Paused stream"),this.dispatchEvent(s.LivePausedLocally),this._av.isActive()){const t=e;$(".oracle-live").hasClass("oracle-live-frozen-annotation")&&(t.video=live.PAUSERESUME.RESUME),this._av.pauseResumeStream(t)}this._screen.isActive()&&(this._screen.pauseResumeStream(e),this._screen.pauseResumeOutgoing(!0))})})}}resumeCallWithAssociate(){if(console.log("LiveControllerImpl::resumeCallWithAssociate"),this._buttonState.isTransferring())console.log("Not resuming call with associate because we're transferring a call");else if(this._conversation&&(this._av.isActive()||this._screen.isActive())){console.log("LiveControllerImpl::resumeCallWithAssociate found active stream");let e=new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,live.PAUSERESUMEREASON.PAUSE_RESUME);this._conversation.getParticipant(this._associateUri).getStreamInfos().forEach(t=>{t.pauseResumeStream(e,()=>{console.log("Resuming call"),this.dispatchEvent(s.LiveResumedLocally),this._av.isActive()&&this._av.pauseResumeStream(e),this._screen.isActive()&&(this._screen.pauseResumeStream(e),this._screen.pauseResumeOutgoing(!1))})})}}dispatchEvent(e,t){console.log("LiveControllerImpl::dispatchEvent: "+e,t);let i={bubbles:!0};t&&(i.detail=t);const n=new CustomEvent(e,i);if(console.log("LiveControllerImpl::dispatchEvent new event: ",n),this._eventNode)console.log("LiveControllerImpl::dispatchEvent dispatching on: ",this._eventNode),document.querySelector(this._eventNode).dispatchEvent(n);else{let t=document.querySelector("body");if(null===t)return void console.warn("No body element on this page - there's nowhere to dispatch its events to");a.find(t=>t===e)&&t.dispatchEvent(n)}this._buttonState.event(e,t)}event(e){console.log("LiveControllerImpl::receivedEvent: ",e),this._buttonState.event(e)}reloadAssociateAvatar(e){this._associateUri=e,this._isMeeting||this._rest.getAssociateAvatar()}startCall(e,t,i){console.log("startCall with: "+e+", conversationKey:"+i),this._associateUri=e,this._rest.getAssociateInfo(),this._isMeeting||this._rest.getAssociateAvatar();const n=i&&i.length>0;this._buttonState.canRejoinMeeting=!n,this._behaviours.allowDowngrades(n),this._buttonState.configureComponent(),this._resetMyStreams(),this._conversation=this._connection.makeConversation().withKey(i).withCallbacks(this.detectWhenRecordingStateChanges.bind(this),this.detectWhenParticipantsChange.bind(this),this.detectWhenCallHasFailed.bind(this),this.detectWhenRelayCommandIsReceived.bind(this)).withContext(this.contextAttributes.toWebContext()).withoutShortCircuit(),console.log("startCall: endUserInitialMedia="+this._behaviours.endUserInitialMedia+", associateInitialMedia="+this._behaviours.associateInitialMedia+", meetingsEnabled="+this._behaviours.meetingsEnabled);const o=new live.StreamProfile(!0,!1,this.service.userID,new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,null));this._behaviours.associateInitialMedia!==this._behaviours.StartMediaType.AUDIO_ONLY&&this._behaviours.associateInitialMedia!==this._behaviours.StartMediaType.NONE||(console.log("Updating associate stream profile to disable video"),o.upgraded=!1,o.pauseResume.video=live.PAUSERESUME.PAUSE,o.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._av._associateVideoInitiallyPaused=!0),console.log("startCall: assocStreamProfile="+JSON.stringify(o,null,2));const s=this._buildRemoteStreamOptions();if(this._behaviours.isStartWithEndUserScreenShare())this.startCallScreenShareStream(s,o);else{const e=new live.StreamProfile(!0,!1,this.service.userID,new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,null));this._behaviours.endUserInitialMedia!==this._behaviours.StartMediaType.AUDIO_ONLY&&this._behaviours.endUserInitialMedia!==this._behaviours.StartMediaType.NONE||(console.log("Updating user stream profile to disable video"),e.upgraded=!1,e.pauseResume.video=live.PAUSERESUME.PAUSE,e.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._av._userVideoInitiallyPaused=!0);const i=this._buildLocalStreamOptions();console.log("startCall: userStreamProfile="+JSON.stringify(e,null,2)),this.startCallAudioVideoStream(i,s,t,e,o)}}_resetMyStreams(){console.log("Resetting remembered streams"),this._myStreams=[]}_rememberMyStreams(e){console.log("Remembering streamId: "+e),this._myStreams.includes(e)||this._myStreams.push(e)}_buildLocalStreamOptions(){let e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.INACTIVE;return this._behaviours.isStartWithEndUserScreenShare()?(e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.SENDONLY):(this._behaviours.isAssociateAudioPossible()&&this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDONLY:this._behaviours.isAssociateAudioPossible()&&(e=live.MEDIADIRECTION.RECVONLY),this._behaviours.isAssociateVideoPossible()&&this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDONLY:this._behaviours.isAssociateVideoPossible()&&(t=live.MEDIADIRECTION.RECVONLY)),console.log("localStreamOptions: audio="+e+", video="+t),live.StreamInfo.createStreamOptions(e,t)}_buildRemoteStreamOptions(){let e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.INACTIVE;return this._behaviours.isStartWithEndUserScreenShare()?(e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.RECVONLY):(this._behaviours.isAssociateAudioPossible()&&this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.RECVONLY:this._behaviours.isAssociateAudioPossible()&&(e=live.MEDIADIRECTION.SENDONLY),this._behaviours.isAssociateVideoPossible()&&this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.RECVONLY:this._behaviours.isAssociateVideoPossible()&&(t=live.MEDIADIRECTION.SENDONLY)),console.log("remoteStreamOptions: audio="+e+", video="+t),live.StreamInfo.createStreamOptions(e,t)}startCallAudioVideoStream(e,t,i,n,o){console.log("startCallAudioVideoStream: associateUri="+this._associateUri),n&&console.log("Overriding local stream profile: ",n),this._conversation.withParticipant(this._associateUri,t,o),this._av.start(e,n,i)}startCallScreenShareStream(e,t){console.log("LiveControllerImpl::startScreensharing: associateUri="+this._associateUri),this._conversation.withParticipant(this._associateUri,e,t,live.STREAMTYPE.SCREEN),this._screen.startSendingScreenShare()}onCallEstablished(e){!0!==this._callEstablished&&(this._callEstablished=!0,clearTimeout(this.connectionTimer),this.dispatchEvent(s.LiveConnected),this.checkPostCallRating(),this.stopReconnectionTimer(),e&&this._behaviours&&"SCREEN_SHARE"===this._behaviours.endUserInitialMedia&&this.dispatchEvent(s.LiveLocalScreenStarted))}onCallStreamStateError(){!0!==this._reconnectingLocal&&(this.dispatchEvent(s.LiveReconnectingLocal),this.sendNetworkStatus("network_disconnect"),this.startReconnectionTimer())}onCallEnded(){clearTimeout(this._connectionTimer),this.dispatchEvent(s.LiveEnded)}onScreenShareEnded(){this._behaviours.isStartWithEndUserScreenShare()&&(clearTimeout(this._connectionTimer),this.dispatchEvent(s.LiveEnded))}detectWhenCallHasFailed(e){console.log("LiveControllerImpl::detectWhenCallHasFailed: ",JSON.stringify(e,null,2)),this.dispatchEvent(s.LiveCanceled)}detectWhenParticipantsChange(e,t,i){switch(console.log("LiveControllerImpl::detectWhenParticipantsChange change="+t,i),t){case live.CONVERSATIONSTATE.STREAM_ADDED:console.log("TRANSFER: Stream_Added: transferState="+this._buttonState.transferState),this._buttonState.isTransferring()&&this._av.createAVStreamForNewAssociate(e,i),i.initCallbacks(this.detectWhenParticipantStateChanges.bind(this,i),this.detectWhenAddLocalStreamRequested.bind(this),this.detectWhenAddRemoteStreamRequested.bind(this));break;case live.CONVERSATIONSTATE.STREAM_LEFT:case live.CONVERSATIONSTATE.STREAM_REMOVED:case live.CONVERSATIONSTATE.STREAM_REJECTED:this.dispatchEvent(s.LiveParticipantLeft,i)}}addQualityMonitor(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.AUDIOVIDEO);e&&(console.log("addQualityMonitor: AV",e),this._networkQualityMonitor.monitor(e,!1));const t=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);t&&(console.log("addQualityMonitor: SS",t),this._networkQualityMonitor.monitor(t,!1));const i=this.getLocalStreamInfo(live.STREAMTYPE.AUDIOVIDEO);i&&(console.log("addQualityMonitor: AV",i),this._networkQualityMonitor.monitor(i,!0));const n=this.getLocalStreamInfo(live.STREAMTYPE.SCREENSHARE);n&&(console.log("addQualityMonitor: SS",n),this._networkQualityMonitor.monitor(n,!0))}detectWhenParticipantStateChanges(e,t,i){const n=e.getUri(),o=i.getType();console.log("LiveControllerImpl::detectWhenParticipantStateChanges: state="+t+", uri="+n+", streamType="+o,e,i);const a=i.getStreamProfile();console.log("Incoming stream profile=",JSON.stringify(a,null,2));const r=i.getStreamOptions();console.log("Incoming stream options=",JSON.stringify(r,null,2));const c=r.shouldSendVideo();switch(t){case live.CONVERSATIONSTATE.STREAM_ACTIVE:this._connection.logEventTimestamp((o===live.STREAMTYPE.AUDIOVIDEO?"av":"ss")+(n===this.service.userID?"Local":"Remote")+"ParticipantStateToSTREAM_ACTIVE"),n===this._associateUri&&this.addQualityMonitor(),o===live.STREAMTYPE.AUDIOVIDEO&&(this.dispatchEvent(s.LiveStreamActive),this.reconnectedLocal()),n===this.service.userID&&o===live.STREAMTYPE.SCREENSHARE&&this._screen.maybeSelectRemoteSS(),n===this._associateUri&&o===live.STREAMTYPE.SCREENSHARE&&c&&this.dispatchEvent(s.LiveRemoteScreenActive);break;case live.CONVERSATIONSTATE.STREAM_JOINED:n===this._associateUri&&o===live.STREAMTYPE.SCREENSHARE?(console.log("Screen share STREAM_JOINED!",i,JSON.stringify(r,null,2)),"sendonly"===i.streamOptions.videoConfig?(console.log("streamJoined: The associate is sending us a screen share"),this._screen.startReceivingScreenShare(i)):this._screen.streamJoined(i)):n===this._associateUri&&o===live.STREAMTYPE.AUDIOVIDEO&&this._av.isActive()&&this._av.streamJoined(i);break;case live.CONVERSATIONSTATE.STREAM_REMOVED:n===this._associateUri&&o===live.STREAMTYPE.SCREENSHARE?this._screen.stopReceivingScreenShare():n===this._associateUri&&o===live.STREAMTYPE.AUDIOVIDEO&&this._av.stopRemote(i);break;case live.CONVERSATIONSTATE.STREAM_CHANGED:n===this._associateUri&&o===live.STREAMTYPE.AUDIOVIDEO&&"resume"===a.pauseResume.video&&(console.log("Remote participant changed: upgraded="+a.upgraded+", paused="+a.paused+", video_paused="+a.pauseResume.video),!a.upgraded||r.videoConfig!==live.MEDIADIRECTION.SENDRECV&&r.videoConfig!==live.MEDIADIRECTION.SENDONLY?i&&i.streamId&&this._myStreams.includes(i.streamId)?this._av.disableRemoteVideo():console.log("Ignoring PROFILE_UPDATED for streamId: "+(i&&i.streamId?i.streamId:"(invalid streamId)")):this._av.enableRemoteVideo());break;case live.CONVERSATIONSTATE.PROFILE_UPDATED:n===this._associateUri&&o===live.STREAMTYPE.AUDIOVIDEO&&(console.log("Remote participant changed: upgraded="+a.upgraded+", paused="+a.paused+", video_paused="+a.pauseResume.video),!a.upgraded||r.videoConfig!==live.MEDIADIRECTION.SENDRECV&&r.videoConfig!==live.MEDIADIRECTION.SENDONLY?i&&i.streamId&&this._myStreams.includes(i.streamId)?this._av.disableRemoteVideo():console.log("Ignoring PROFILE_UPDATED for streamId: "+(i&&i.streamId?i.streamId:"(invalid streamId)")):this._av.enableRemoteVideo());break;case live.CONVERSATIONSTATE.SIDEBAR_CREATED:console.log("Sidebar created"),this._conversation.addRemainingStreams()}}detectWhenAddRemoteStreamRequested(e,t,i,n,o){console.log("LiveControllerImpl::detectWhenAddRemoteStreamRequested: conversation:",e),console.log(".. participant:",t),console.log(".. streamRequest:",i),console.log(".. streamType:",n),console.log(".. streamOptions:",o),this._upgradeRequest=i,this._upgradeRequestStreamType=n,this._upgradeRequestForUser="associate",n===live.STREAMTYPE.SCREENSHARE&&this.dispatchEvent(s.LiveRemoteScreenShareRequested)}detectWhenAddLocalStreamRequested(e,t,i,n,o){console.log("LiveControllerImpl::detectWhenAddLocalStreamRequested: conversation:",e),console.log(".. participant:",t),console.log(".. streamRequest:",i),console.log(".. streamType:",n),console.log(".. streamOptions:",o),this._upgradeRequest=i,this._upgradeRequestStreamType=n,this._upgradeRequestForUser="user",this.dispatchEvent(s.LiveStartScreenShareRequested)}upgradeRequestIsAssociateScreenShare(){return this._upgradeRequestStreamType===live.STREAMTYPE.SCREENSHARE&&"associate"===this._upgradeRequestForUser}upgradeRequestIsUserScreenShare(){return this._upgradeRequestStreamType===live.STREAMTYPE.SCREENSHARE&&"user"===this._upgradeRequestForUser}upgradeRequestIsUserVideo(){return this._upgradeRequestStreamType===live.STREAMTYPE.AUDIOVIDEO&&"user"===this._upgradeRequestForUser}reconnectedLocal(){if(console.log("reconnectedLocal: reconnecting="+this._reconnectingLocal),this._reconnectingLocal&&(this.dispatchEvent(s.LiveReconnectedLocal),this.stopReconnectionTimer(),this.sendNetworkStatus("network_recover")),this._conversation){const e=this._conversation.getRemoteParticipant(),t=this._conversation.getLocalParticipant();(e&&e.isRecording()||t&&t.isRecording()||this._conversation.isRecording())&&this.dispatchEvent(s.LiveRecordingStarted)}}detectWhenRelayCommandIsReceived(e,t,i,n,o){switch(console.log("detectWhenRelayCommandIsReceived: command="+n,o),n){case"network_disconnect":this.dispatchEvent(s.LiveReconnectingRemote),this.startReconnectionTimer();break;case"network_recover":this.dispatchEvent(s.LiveReconnectedRemote),this.stopReconnectionTimer();break;case"upgrade_downgrade":this._av.isActive()&&this._av.detectStreamPauseResumeRequest(e,t,i,o[0]),this._screen.isActive()&&this._screen.detectStreamPauseResumeRequest(e,t,i,o[0]);break;case"cancel":this.cancelUpgradeRequest(o[0].original_directive);break;case"annotate_start":this.dispatchEvent(s.LiveAssociateAnnotationStarted);break;case"annotate_stop":this.dispatchEvent(s.LiveAssociateAnnotationStopped);break;case"video_annotate_start":this.dispatchEvent(s.LiveAssociateVideoAnnotationStarted);break;case"video_annotate_stop":this.dispatchEvent(s.LiveAssociateVideoAnnotationStopped);break;case"freeze_customer_stream":$("body").css("visibility","hidden"),$(".oracle-live").css("visibility","visible"),this.dispatchEvent(s.LiveAssociateFreezeCustomerStream,o);break;case"unfreeze_customer_stream":$("body").css("visibility","visible"),this.dispatchEvent(s.LiveAssociateUnfreezeCustomerStream);break;case"hidden_screen_share":console.log("hidden_screen_share received on stream:",t),this.setPermanentTwoWayScreenShare(!0),this.startDummyScreenShareIfNecessary();break;case"show_screen_share":console.log("show_screen_share received on stream:",t),this._screen.showIncomingScreenShare();break;case"hide_screen_share":this._screen.hideIncomingScreenShare();break;case"stop_screen_share":this._screen.stopSendingScreenShare();break;case"transfer_started":console.log("TRANSFER: transfer_started"),this._isMeeting&&this._meet._isPstnUpgrade&&(console.log("Received a transfer during PSTN upgrade, ending meeting leg"),this.endCallWithAssociate()),this._transferringAssociateUri=this._associateUri,this._buttonState.transferState="Started",this.dispatchEvent(s.LiveAssociateTransferStarted,o);break;case"transfer_start_stream":this._transferringAssociateUri=this._associateUri,o.length>0&&o[0].target&&o[0].target.length>0&&(this._associateUri=o[0].target,this._buttonState.transferState="AssociateObtained",this._rest.getAssociateInfo().then(()=>{this.reloadAssociateAvatar(this._associateUri)}),console.log("TRANSFER: Received transfer_start_steam"),console.log("          Transferring associate: "+this._transferringAssociateUri),console.log("           Transfer-to associate: "+this._associateUri),this.dispatchEvent(s.LiveAssociateTransferStartStream,o));break;case"transfer_completed":console.log("TRANSFER: transfer_complete"),this._buttonState.transferState="RemoveOriginalAssociate",this.dispatchEvent(s.LiveAssociateTransferCompleted,o);break;case"transfer_failed":console.log("TRANSFER: transfer_failed"),this._buttonState.transferState="None",this.dispatchEvent(s.LiveAssociateTransferFailed,o);break;case"transfer_stopped":console.log("TRANSFER: transfer_stopped"),this._buttonState.transferState="None",this.dispatchEvent(s.LiveAssociateTransferStopped,o);break;case"annotate_customer_stream":{let e=o&&o[0]&&o[0].annotation_type?o[0].annotation_type:void 0;console.log("annotationType: ",e),void 0===e?(console.log("annotate_customer_screen missing annotation_type"),this.dispatchEvent(s.LiveAssociateAnnotationReceived,o)):"screen_share"===e?this.dispatchEvent(s.LiveAssociateAnnotationReceived,o):"video"===e&&this.dispatchEvent(s.LiveAssociateVideoAnnotationReceived,o);break}default:console.log("Ignoring directive: ",n,", args: ",o)}}detectWhenRecordingStateChanges(e,t){console.log("Conversation "+(t?"IS":"is NOT")+" being recorded"),t?this.dispatchEvent(s.LiveRecordingStarted):this.dispatchEvent(s.LiveRecordingStopped)}setPermanentTwoWayScreenShare(e){console.log("setPermanentTwoWayScreenShare => "+e),this._permanentTwoWayScreenShare=e}installChromeScreenSharePlugin(){this.dispatchEvent(s.LiveScreenSharePluginInstalling),this._screen.installChromeScreenSharePlugin()}cancelChromeScreenSharePluginInstall(){this.declineUpgradeRequest(),this._screen.cancelChromeScreenSharePluginInstall()}acceptUpgradeRequest(){this._upgradeRequest&&(console.log("Accepting request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),this._upgradeRequest.accept(),this._upgradeRequest=null,console.log("Accepted remote upgrade request"),this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null)}declineUpgradeRequest(){this._upgradeRequest&&(console.log("Declining request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),this._upgradeRequest.decline(),this._upgradeRequest=null,this._av._upgradePauseResume=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null)}cancelUpgradeRequest(e){console.log("Associate has cancelled request: "+e),this._upgradeRequestStreamType&&this._upgradeRequestForUser&&console.log("Pending request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),"add_stream"===e?this.upgradeRequestIsAssociateScreenShare()?this.dispatchEvent(s.LiveRemoteScreenShareCancelled):this.upgradeRequestIsUserScreenShare()?this.dispatchEvent(s.LiveStartScreenShareRequestCancelled):this.upgradeRequestIsUserVideo()&&this.dispatchEvent(s.LiveStartVideoRequestCancelled):"pause_resume_stream"===e&&(this.upgradeRequestIsUserScreenShare()?this.dispatchEvent(s.LiveStartScreenShareRequestCancelled):this.upgradeRequestIsUserVideo()&&this.dispatchEvent(s.LiveStartVideoRequestCancelled)),this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this._av._upgradePauseResume=null}upgradeLocalVideo(){this._av.startVideo()}downgradeLocalVideo(){this._av.stopVideo()}startVideoPreview(){console.log("LiveControllerImpl.startVideoPreview"),this._isRehydratingNonMeetingCall()||this._isRehydratingMeetingCall()?console.log("LiveControllerImpl.startVideoPreview: rehydrating so not starting preview"):(this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),console.log("LiveControllerImpl.startVideoPreview: call LiveAudioVideo.startVideoPreview"),this._haveRequestedVideoPreview=!0,this._av.startVideoPreview())}stopVideoPreview(e){this._av.stopVideoPreview(),this.hasClass(".oracle-live","oracle-live-preCallIDCheck-call-associate")&&(this.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error")),e&&(this._buttonState.isPreCallIDCheck()?this.netVerificationCancelled(s.LiveCanceled):this.dispatchEvent(s.LiveCanceled))}sendScreenShare(e){console.log("LiveControllerImpl::sendScreenShare",!0===e),e?this._screen.startSendingScreenShare():this._screen.stopSendingScreenShare()}detectWhenConnectionHasChanged(e){switch(console.log("LiveControllerImpl::detectWhenConnectionHasChanged: state=",e),e){case live.CONNECTIONSTATE.FAILED:console.log("LiveControllerImpl::detectWhenConnectionHasChanged FAILED"),this._conversation?this.dispatchEvent(s.LiveStreamError):(console.error("Failed to connect to server"),this._connectionId=null,this.dispatchEvent(s.LiveLoginError),this.reset(),this._connection=null);break;case live.CONNECTIONSTATE.RECONNECTING:this._reconnectingLocal=!0,this.dispatchEvent(s.LiveReconnectingLocal),this.sendNetworkStatus("network_disconnect"),this.startReconnectionTimer();break;case live.CONNECTIONSTATE.CONNECTED:this.reconnectedLocal()}}detectIncomingStream(e,t,i){console.log("detectIncomingStream: streamOptions="+JSON.stringify(i,null,2),t),t.getType()===live.STREAMTYPE.AUDIOVIDEO?(console.log("incomingAV: ",t),this._av.incomingAV(t,i)):console.log("incomingSS: ",t)}sendNetworkStatus(e){this._conversation&&(console.log("sendNetworkStatus: "+e),this._conversation.relayCommandTo(null,"*",e,[{target:this._conversation.getLocalParticipantUri()}]))}sendUpdatedContextAttribute(e,t){if(this._conversation&&this._av.isActive()){const i={};i[e]=t,console.log("sendUpdatedContextAttribute: "+JSON.stringify(i,null,2)),this._conversation.relayCommandTo(null,"*","context_updated",[i])}}sendAnnotationStart(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);if(e){const t=e.getId();if(t)return void this._conversation.relayCommandTo(t,"*","annotate_start",[{}])}console.log("sendAnnotationStart: failed to send annotationStart relay message")}sendAnnotationStop(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);if(e){const t=e.getId();if(t)return void this._conversation.relayCommandTo(t,"*","annotate_stop",[{}])}console.log("sendAnnotationStop: failed to send annotationStop relay message")}startReconnectionTimer(){this._reconnectionTimer?console.log("Reconnection timer already running"):(console.log("Starting the reconnection timer"),this._reconnectingLocal=!0,this._reconnectionTimer=setTimeout(()=>{console.log("Reconnection timer expired, assume that remote participant has left"),this.dispatchEvent(s.LiveParticipantLeft)},this._reconnectionTimeout),this.stopStatusCheckTimer())}stopReconnectionTimer(){this._reconnectionTimer&&(console.log("Stopped the reconnection timer"),clearTimeout(this._reconnectionTimer),this._reconnectingLocal=!1,this._reconnectionTimer=null,this._conversation&&this.startStatusCheckTimer())}startStatusCheckTimer(){this._statusCheckTimer?console.log("StatusCheck timer already running"):(console.log("Starting the StatusCheck timer"),this._statusCheckTimer=setTimeout(()=>{console.log("StatusCheck timer, checking the status of the call"),this._conversation?this._conversation.checkStatus(()=>{console.log("Status check successful")},e=>{console.log("Status check failed: "+e),this.dispatchEvent(s.LiveParticipantLeft)}):this.dispatchEvent(s.LiveParticipantLeft)},this._statusCheckTimeout))}stopStatusCheckTimer(){this._statusCheckTimer&&(console.log("Stopped the StatusCheck timer"),clearTimeout(this._statusCheckTimer),this._statusCheckTimer=null)}generateCode(){const e={},t=window.location.search.substring(1).split("&");for(let i=0;i<t.length;i++){const n=t[i].split("=");void 0===e[n[0]]?e[n[0]]=decodeURIComponent(n[1]):"string"==typeof e[n[0]]?e[n[0]]=[e[n[0]],decodeURIComponent(n[1])]:e[n[0]].push(decodeURIComponent(n[1]))}let i={};const n=e.meeting_id;return n?(i.id=n,i.type="meetingCode"):sessionStorage.getItem("Code")?i=JSON.parse(sessionStorage.getItem("Code")):(i.id=this.generateShortCode(),i.type="shortCode"),sessionStorage.setItem("Code",JSON.stringify(i)),console.log("Generated code: "+i.id+","+i.type),i}generateShortCode(){let e="23456789ABCDEFGHJKLMNPQRSTUVWXYZ",t=Math.ceil(1),i=Math.floor(e.length),n=window.crypto||window.msCrypto,o="";for(let s=0;s<6;s++){let s=new Uint32Array(1);n.getRandomValues(s);let a=s[0]/4294967296;o+=e[Math.floor(a*(i-t+1))+t-1]}return console.log("Generated short-code: "+o),o}refreshConnection(e){console.log("LiveControllerImpl::refreshConnection ",e),this._conversation=e,this._reconnectingLocal=!0,this._conversation.withCallbacks(this.detectWhenRecordingStateChanges.bind(this),this.detectWhenParticipantsChange.bind(this),this.detectWhenCallHasFailed.bind(this),this.detectWhenRelayCommandIsReceived.bind(this)),this._conversation.getParticipants().forEach(e=>{e.initCallbacks(this.detectWhenParticipantStateChanges.bind(this,e),this.detectWhenAddLocalStreamRequested.bind(this),this.detectWhenAddRemoteStreamRequested.bind(this))});const t=this._conversation.getLocalParticipantUri(),i=this._conversation.getParticipants().find(e=>e.getUri()!==t);i&&(console.log("Found remote participant: "+JSON.stringify(i,null,2)),this._associateUri=i.getUri()),e.getStreams().forEach(e=>{e.getType()===live.STREAMTYPE.AUDIOVIDEO?this._av.resume(e):(console.log("LiveControllerImpl::refreshConnection screenshare stream ",e),this._screen.resume(e)),this._screen.setConnectionRestored()}),this.sendUpdatedContextAttribute("url",this.contextAttributes.get("url"))}setPositionInQueue(e){console.log(`positionInQueue: ${e}`),this._positionInQueue=e,this.dispatchEvent(s.LiveCallQueuePositionUpdate)}getPositionInQueue(){console.log("getPositionInQueue");let e="";return this._positionInQueue&&(e+=this._positionInQueue),e.endsWith("1")&&"11"!==e?e+="st":e.endsWith("2")&&"12"!==e?e+="nd":e.endsWith("3")&&"13"!==e?e+="rd":e+="th",e}setAssociateName(e){this._buttonState.associateName=e}setAssociatePhoto(e){this._buttonState.associatePhotoURL=e}getAssociateStreamInfo(e){return this._conversation.getParticipant(this._associateUri).getStreamInfos().find(t=>t.getType()===e)}getLocalStreamInfo(e){return this._conversation.getLocalParticipant().getStreamInfos().find(t=>t.getType()===e)}startDummyScreenShareIfNecessary(){this._dummyScreenShareCreated||this._behaviours&&this._behaviours.isEndUserScreenSharePossible()&&(console.log("End user can share screen - creating a dummy screen share stream for faster on/off"),this._dummyScreenShareCreated=!0,console.log("adding dummy screen share"),this._screen.startDummyScreenShare())}netVerificationCancelled(e=s.LivePreCallIDCheckError){this.dispatchEvent(e),this._rest.deleteIdentityVerificationTransaction(this.service,this._transactionReference).then(e=>console.log("netVerificationCancelled: got response: "+e)).catch(e=>console.error("netVerificationCancelled: failed to delete transaction: "+e.message,e.response))}waitForVerificationStatus(e,t=1e4,i=6e5){console.log("LiveControllerImpl::waitForVerificationStatus  transactionReference: ",e);const n=Number(new Date)+i;let o="PENDING",s="FAILURE";const a=e=>{e&&console.log("LiveControllerImpl::rejectCallback: received response: ",e),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.netVerificationCancelled()},r=i=>{i&&(o=i.status,s=i.lxResult),console.log("LiveControllerImpl::resolveCallback received response: ",i),"DONE"!==o||"SUCCESS"!==s&&"UNSURE"!==s?"ERROR"===o||"FAILURE"===s?(console.log("LiveControllerImpl::resolveCallback error received"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.netVerificationCancelled()):"PENDING"===o&&(console.log("LiveControllerImpl::resolveCallback: about to call poll"),setTimeout(()=>{c()},t)):(console.log("LiveControllerImpl::resolveCallback we have a successful verification"),this.contextAttributes.set("preCallCheckId",e),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-verified"))},c=()=>{const t=Number(new Date);console.log("LiveControllerImpl::poll status: "+o+"  endTime: "+n+" now: "+t),"PENDING"===o?t<n?(console.log("LiveControllerImpl::poll:  waiting"),console.log("LiveControllerImpl::poll:  polling"),this._rest.getPreCallIDCheckStatus(this.service,e,r,a)):(console.log("Polling timeout occurred - verification failed"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.netVerificationCancelled()):console.log("LiveControllerImpl::poll: stop polling: ")};c()}startPreCallIDCheck(e){console.log("LiveControllerImpl::startPreCallIDCheck"),this.dispatchEvent(s.LivePreCallIDCheckStarted);const t=this,i=n=>{if(console.log("LiveControllerImpl::jumioMessageHandler origin: ",n.origin),this._autoTest||"https://netverify.com"===n.origin){let o=JSON.parse(n.data);if(console.log("LiveControllerImpl::jumioMessageHandler data: ",JSON.stringify(o,null,2)),o.payload){const n=o.payload.value;"loaded"===n?console.log("LiveControllerImpl::jumioMessageHandler received 'loaded' message"):"success"===n?(console.log("LiveControllerImpl::jumioMessageHandler We have success!"),e.removeEventListener("message",i,!1),this.addClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),t._transactionReference=o.transactionReference,t._transactionReference&&t.waitForVerificationStatus(t._transactionReference)):"error"===n&&(this._transactionReference=o.transactionReference,this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.netVerificationCancelled())}}else console.log("LiveControllerImpl::jumioMessageHandler with an invalid origin - ignoring")};this._rest.sendContext(()=>{const t=this._rest.createInitiatePreCallCheckPayload();console.log("LiveControllerImpl::startPreCallIDCheck: data: ",t),this._rest.initiatePreCallIDCheck(this.service,t,t=>{console.log("LiveControllerImpl::startPreCallIDCheck received response: ",t);let n="",o="";t.redirectUrl&&(n=t.redirectUrl,o=t.transactionReference,console.log("LiveControllerImpl::startPreCallIDCheck redirectUrl",n),console.log("LiveControllerImpl::startPreCallIDCheck transactionRef",o),e.addEventListener("message",i,!1),$(".kyc-jumio-iframe").attr("src",n),this.addClass(".oracle-live","oracle-live-preCallIDCheck-in-progress"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-enabled"))})})}continueVerification(){console.log("LiveControllerImpl::continueVerification"),this._rest.updatePreCallIdCheck(this.service,this._transactionReference,null,e=>{e&&console.log("LiveControllerImpl::rejectCallback: received response: ",e)}),this.addClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.addClass(".oracle-live","oracle-live-video-enduser-maximized"),this.dispatchEvent(s.LiveStartVerificationCall)}getVerificationResult(e){console.log("LiveControllerImpl::getVerificationResult: conversationKey: ",e);let t="Failure";return this._rest.getPreCallIDCheckResult(this.service,e).then(e=>{console.log("LiveRestHelper::getPreCallIDCheckResult: got response: "+e),console.log("LiveControllerImpl::getVerificationResult: received response: ",e),e&&(t=e.result),"Success"===t?(console.log("resolveCallback: result: Success"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-success")):(console.log("resolveCallback: result: Failure"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"))}).catch(e=>{console.log("LiveRestHelper::getPreCallIDCheckResult: failed to getPreCallIDCheckResult, Error: "+e.message,e.response),e.response&&console.log("LiveControllerImpl::rejectCallback: received response: ",e.response),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.netVerificationCancelled()})}resetPreCallIDCheckState(){console.log("LiveControllerImpl::resetPreCallIDCheckState"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-success"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this._transactionReference=null,this.contextAttributes.remove("preCallCheckId"),$(".kyc-jumio-iframe").attr("src",null)}removeClass(e,t){e&&t?$(e).removeClass(t):console.log("LiveControllerImpl::removeClass: unable to remove class - invalid parameters")}addClass(e,t){e&&t?$(e).addClass(t):console.log("LiveControllerImpl::removeClass: unable to add class - invalid parameters")}hasClass(e,t){if(e&&t)return $(e).hasClass(t);console.log("LiveControllerImpl::removeClass: unable to remove class - invalid parameters")}}}),define("LiveMeeting",[],function(){"use strict";return class{constructor(e){this._impl=e,console.log("Resetting pstn upgrade indicator to false"),this._isPstnUpgrade=!1}addComponent(e){this._impl.addComponent(e)}event(e){this._impl.event(e)}getNetworkStatus(e,t){this._impl.getNetworkStatus(e,t)}getMetaScenario(e){this._impl._rest.getMetaScenario(e)}overrideBehaviours(e){this._impl.overrideBehaviours(e)}setPstnOverride(e){return console.log("setPstnOverride.."),this._isPstnUpgrade=!0,null===e?null:this.applyPossiblePstnOverride(e)}applyPossiblePstnOverride(e){return console.log("applyPossiblePstnOverride.."),this._isPstnUpgrade&&(console.log("applyPossiblePstnOverride knows this meeting is a PSTN upgrade."),e=this.removeAudio(e),this.overrideBehaviours(e.behaviours)),console.log("applyPossiblePstnOverride returning config:",e),e}removeAudio(e){return console.log("Removing audio from configuration behaviours: "+JSON.stringify(e.behaviours,null,2)),"AUDIO_ONLY"===e.behaviours.endUserInitialMedia?e.behaviours.endUserInitialMedia="NONE":"AUDIO_VIDEO"===e.behaviours.endUserInitialMedia&&(e.behaviours.endUserInitialMedia="VIDEO_ONLY"),"AUDIO_ONLY"===e.behaviours.associateInitialMedia?e.behaviours.associateInitialMedia="NONE":"AUDIO_VIDEO"===e.behaviours.associateInitialMedia&&(e.behaviours.associateInitialMedia="VIDEO_ONLY"),e.behaviours.endUserCanAddAudio=!1,e.behaviours.associateCanAddAudio=!1,e.behaviours.associateCanRequestEndUserAudio=!1,console.log("Configuration behaviours is now: "+JSON.stringify(e.behaviours,null,2)),e}}}),define("LiveController",["LiveControllerImpl","LiveEvents","LiveMeeting"],function(e,t,i){"use strict";return class{constructor(){console.log("construct LiveController"),this._impl=new e,this._meet=new i(this._impl),this._impl._meet=this._meet}get service(){return this._impl.service}get contextAttributes(){return this._impl.contextAttributes}get settings(){return this._impl.settings}get version(){return this._impl.version}get events(){return t}addComponent(){this._impl.addComponent()}updateComponent(){this._impl.updateComponent()}}}),define("oracle.live.api",["LiveController"],function(e){"use strict";return console.log("Oracle Live Experience loaded"),{controller:new e}});